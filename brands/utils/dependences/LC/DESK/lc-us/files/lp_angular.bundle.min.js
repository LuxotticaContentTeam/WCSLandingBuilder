/*! lux-b2c-csr - v0.0.1 - 2023-06-14 */
var appLensPanel=angular.module("LensPanelApp",["ngCookies","ngSanitize","mgo-angular-wizard","duScroll","lcInsuranceModule"]);function wizardButtonDirective(action){angular.module("mgo-angular-wizard").directive(action,(function(){return{restrict:"A",replace:!1,require:"^wizard",link:function($scope,$element,$attrs,wizard){$element.on("click",(function(e){e.preventDefault(),$scope.$apply((function(){$scope.$eval($attrs[action]),wizard[action.replace("wz","").toLowerCase()]()}))}))}}}))}appLensPanel.value("lpConstants",{WIZARD_NAME:"wizardLensPanel",LENS_CATEGORY:{EYE:"EYEGLASSES",SUN:"SUNGLASSES"},BRANDS:{OUR_LENSES:"LENSCRAFTERS_LENSES",RAYBAN:"RAY-BAN_LENSES",OAKLEY:"OAKLEY_LENSES",COSTA:"COSTA_LENSES"},ESPOT:{"RAY-BAN_LENSES":"RAY-BAN_AUTHENTICS",OAKLEY_LENSES:"OAKLEY_AUTHENTICS",COSTA_LENSES:"COSTA_AUTHENTICS"},ANALYTICS:{BRANDS:{LENSCRAFTERS_LENSES:"standard","RAY-BAN_LENSES":"Ray-Ban",OAKLEY_LENSES:"Oakley",COSTA_LENSES:"Costa"}},LOCALE:"en-US",CURRENCY_SYMBOL:"$  ",BASE_PATH:"/wcsstore/LensCraftersStorefrontAssetStore/LensPanel/",URL_LOCAL:"webapp/wcs/stores/servlet/"}),appLensPanel.value("lpLabels",{footer:{frameOnly:"Frame only",frameOnlyPrice:"Frame only price:",save:"Save and continue shopping",ask:"Weâ€™ll ask for your prescription during checkout.",add:"Add to bag",apply:"Apply"},insurance:{loading:"Insurance benefits syncing (could take up to 45 seconds)",loaded:"Insurance benefits active",error:"We are sorry, we encountered a problem retrieving insurance benefit"},stepLens:{title:"Choose your lens",banner:"Don't worry! We will take care of your prescription for you after the check-out.",moreInfo:"Discover the lens"},stepTreatment:{title:"Choose your lens treatment"},stepColor:{title:"Choose your lens color",polarized:"Polarized",standard:"Add polarized",allPolarized:"All lenses are polarized",prePolarPrice:"(+ ",postPolarPrice:")"},stepReview:{title:"Review your selection",frame:"Frame",size:"Size",lenses:"Lenses",edit:"edit",total:"Frame + Lenses",subtotal:"Subtotal",gvp:"GREAT VALUE PACKAGE",warranty:"Add One Year"}}),appLensPanel.filter("orderByPrice",(function(lpDataset){return function(input,priceAttr){if(!angular.isObject(input))return input;var array=[];for(var objectKey in input){var obj=input[objectKey];obj.key=objectKey,array.push(obj)}return array.sort((function(obj1,obj2){var price1=parseFloat(obj1[priceAttr]),price2=parseFloat(obj2[priceAttr]);return(price1-=lpDataset.insurance.discounts[obj1.baseLensUPC]?parseFloat(lpDataset.insurance.discounts[obj1.baseLensUPC]):0)-(price2-=lpDataset.insurance.discounts[obj2.baseLensUPC]?parseFloat(lpDataset.insurance.discounts[obj2.baseLensUPC]):0)})),array}})),appLensPanel.filter("underscore",(function(){return function(input,charToChange){var ch=charToChange||" ";return(input=input||"").split(ch).join("_")}})),appLensPanel.directive("lpAnalyticsPush",(function($log){return{restrict:"A",scope:{},link:function(scope,el,attr,ctrl){var elementid=attr.elementId,description=attr.description,id=attr.id,element=el[0];element.addEventListener("click",(function(e){try{elementid?tealium_data2track.push({id:"Click",Click_FocusElement:element,Tracking_Type:"link",data_element_id:elementid,data_description:description||elementid}):id&&tealium_data2track.push({id:id,Click_FocusElement:element})}catch(err){$log.error(err)}})),element.addEventListener("keyUp",(function(e){try{13==e.keyCode&&(elementid?tealium_data2track.push({id:"KeyUp",Click_FocusElement:element,Tracking_Type:"link",data_element_id:id,data_description:description||""}):id&&tealium_data2track.push({id:id,Click_FocusElement:element}))}catch(err){$log.error(err)}}))}}})),appLensPanel.directive("lpLensColor",(function(lpConstants,lpDataset,WizardHandler){return{restrict:"E",templateUrl:lpConstants.BASE_PATH+"app/templates/lensColor.htm",scope:{color:"=",index:"=",length:"="},link:function(scope,iElement,iAttributes,ctrl){scope.wizard=WizardHandler.wizard(lpConstants.WIZARD_NAME),scope.constants=lpConstants,scope.selectColor=function(){lpDataset.insurance.isLoading||(scope.wizard.context.selectedColorType=scope.color.type,scope.wizard.context.selectedColor=scope.color.key,scope.wizard.next())}}}})),appLensPanel.directive("lpLensTreatmentType",(function(lpConstants,lpDataset,lpScroll,WizardHandler){return{restrict:"E",templateUrl:lpConstants.BASE_PATH+"app/templates/lensTreatmentType.htm",scope:{code:"=",lensTypeName:"=",treatmentType:"=",index:"=",twocols:"="},link:function(scope,iElement,iAttributes,ctrl){scope.wizard=WizardHandler.wizard(lpConstants.WIZARD_NAME),scope.constants=lpConstants,scope.treatmentsNumber=scope.treatmentType.treatments?Object.keys(scope.treatmentType.treatments).length:0,scope.dataset=lpDataset,scope.isTreatmentVisible=function(){return scope.treatmentType.transition||scope.treatmentsNumber>1},scope.isSelected=function(){return scope.wizard.context.selectedTreatmentType==scope.code},scope.selectType=function(){lpDataset.insurance.isLoading||0!=scope.treatmentsNumber&&(scope.wizard.context.selectedTreatmentType=scope.code,scope.isTreatmentVisible()?lpScroll.bottom():(scope.wizard.context.selectedTreatment=Object.keys(scope.treatmentType.treatments)[0],scope.wizard.next()))},scope.getPrice=function(){var price=scope.treatmentType.basePrice;return lpDataset.insurance.isEnabled&&void 0!==lpDataset.insurance.discounts[scope.treatmentType.baseLensUPC]&&(price=Math.max(0,scope.treatmentType.baseOfferPrice-lpDataset.insurance.discounts[scope.treatmentType.baseLensUPC])),price}}}})).directive("lpLensTreatment",(function(lpConstants,lpDataset,WizardHandler){return{restrict:"E",templateUrl:lpConstants.BASE_PATH+"app/templates/lensTreatment.htm",scope:{code:"=",treatment:"="},link:function(scope,iElement,iAttributes,ctrl){for(colorTypeKey in scope.wizard=WizardHandler.wizard(lpConstants.WIZARD_NAME),scope.constants=lpConstants,scope.labels={selectColor:"Select a color:",confirm:"Confirm"},scope.hasColors=function(){return Object.keys(scope.colors).length>0},scope.numberOfColors=function(){return Object.keys(scope.colors).length},scope.getOfferPrice=function(){return scope.hasColors()?scope.colors[Object.keys(scope.colors)[0]].lens.offerPrice:scope.treatment.lens.offerPrice},scope.getPrice=function(){var price=scope.hasColors()?scope.colors[Object.keys(scope.colors)[0]].lens.price:scope.treatment.lens.price;if(lpDataset.insurance.isEnabled){var partNumber=null,priceWithInsurance=null,currentPriceWithInsurance=null;if(scope.hasColors()){for(var colorKey in scope.colors)partNumber=scope.colors[colorKey].lens.partNumber,void 0!==lpDataset.insurance.discounts[partNumber]&&(currentPriceWithInsurance=Math.max(0,scope.colors[colorKey].lens.offerPrice-lpDataset.insurance.discounts[partNumber]),(null==priceWithInsurance||currentPriceWithInsurance<priceWithInsurance)&&(priceWithInsurance=currentPriceWithInsurance));price=priceWithInsurance}else price=Math.max(0,scope.treatment.lens.offerPrice-lpDataset.insurance.discounts[scope.treatment.lens.partNumber])}return price},scope.colors={},scope.treatment.colorTypes){var colorType=scope.treatment.colorTypes[colorTypeKey];angular.forEach(colorType.colors,(function(color){color.type=colorTypeKey})),angular.merge(scope.colors,colorType.colors)}scope.selectTreatment=function(){lpDataset.insurance.isLoading||scope.wizard.next()},scope.onClick=function(){scope.hasColors()||(scope.wizard.context.selectedTreatment=scope.code,scope.selectTreatment())},scope.selectColor=function(colorKey,typeKey){scope.wizard.context.selectedTreatment=scope.code,scope.wizard.context.selectedColorType=typeKey,scope.wizard.context.selectedColor=colorKey},scope.isColorSelected=function(colorKey){var _ctx=scope.wizard.context;return _ctx.selectedTreatment==scope.code&&_ctx.selectedColor==colorKey},scope.isConfirmVisible=function(){var _ctx=scope.wizard.context;if(_ctx.selectedTreatment!=scope.code)return!1;var _colors=Object.keys(scope.colors);return _colors.length>0&&-1!=_colors.indexOf(_ctx.selectedColor)}}}})).directive("lpTreatmentLearnMore",(function(lpConstants,$window){return{restrict:"E",templateUrl:lpConstants.BASE_PATH+"app/templates/lensTreatmentLearnMore.htm",scope:{treatment:"="},link:function(scope,iElement,iAttributes,ctrl){scope.labels={learnMore:"Learn more"},scope.isVisible=!1,scope.onMouseover=function(){$window.isMobile||(this.isVisible=!0)},scope.onMouseleave=function(){$window.isMobile||(this.isVisible=!1)},scope.show=function(){this.isVisible=!0},scope.hide=function(){this.isVisible=!1}}}})),appLensPanel.directive("lpLensType",(function(lpConstants,lpDataset,WizardHandler){return{restrict:"E",templateUrl:lpConstants.BASE_PATH+"app/templates/lensType.htm",scope:{code:"=",type:"=",index:"=",twocols:"="},link:function(scope,iElement,iAttributes,ctrl){var _keyType;if(scope.wizard=WizardHandler.wizard(lpConstants.WIZARD_NAME),scope.constants=lpConstants,scope.labels={lensColor:"Lens color:",range:"Suggested range: "},scope.name=scope.type.name.replace(/EYE|SUN/,"").trim(),-1!=scope.name.indexOf("Costa")&&(scope.name=scope.name.replace(/Polarized/,"")),scope.colors=[],scope.type.colorTypes)for(_keyType in scope.type.colorTypes){var _keyColor,_colorType=scope.type.colorTypes[_keyType];if(_colorType.colors)for(_keyColor in _colorType.colors){var _color=_colorType.colors[_keyColor];scope.colors.push({type:_keyType,key:_keyColor,name:_color.name,url:_color.imageUrl,isPolarized:_color.polarized,lens:_color.lens})}}scope.isSelected=function(){return scope.wizard.context.selectedLensType==scope.code},scope.selectType=function(){lpDataset.insurance.isLoading||(scope.wizard.context.selectedLensType=scope.code,scope.wizard.context.selectedColorSet=scope.colors,scope.wizard.next())},scope.getPrice=function(){var price=scope.type.basePrice;return lpDataset.insurance.isEnabled&&void 0!==lpDataset.insurance.discounts[scope.type.baseLensUPC]&&(price=Math.max(0,scope.type.baseOfferPrice-lpDataset.insurance.discounts[scope.type.baseLensUPC])),price}}}})),appLensPanel.directive("lpMainModal",(function(lpConstants,lpModalService){return{restrict:"E",templateUrl:lpConstants.BASE_PATH+"app/templates/mainModal.htm",scope:{}}})),appLensPanel.directive("lpInsuranceProgressbar",(function(lpLabels,lpDataset){return{restrict:"E",template:'<div class="progress" ng-show="insurance.isEnabled"><div class="progress-bar" role="progressbar" ng-class="{\'progress-bar-striped progress-bar-animated\': insurance.isLoading, \'bg-danger\': insurance.isLoadingError}"style="width: 100%" >{{insurance.isLoading ? labels.loading : (insurance.isLoadingError ? labels.error : labels.loaded)}}</div></div>',scope:{},link:function(scope,el,attr,ctrl){scope.labels=lpLabels.insurance,scope.insurance=lpDataset.insurance}}})).directive("lpInsurancePrice",(function(lpConstants,lpDataset){return{restrict:"EA",template:'<div class="price-wrapper" ng-hide="insurance.isLoading"><span class="starting-from" ng-if="startingfrom && !gvp()" ng-class="{\'insurance\': insurance.isEnabled}">Lens starting at </span><span class="offer-price" ng-if="!gvp() && !insurance.isEnabled && (offerprice - price) > 0" ng-class="{\'strike-through\': (offerprice - price) > 0}">{{offerprice | currency:constants.CURRENCY_SYMBOL}}</span><span class="price" ng-if="price > 0 && !gvp()" ng-class="{\'insurance\': insurance.isEnabled}">{{price | currency:constants.CURRENCY_SYMBOL}}</span><span class="price" ng-if="price <= 0 && !gvp()" ng-class="{\'insurance\': insurance.isEnabled}">FREE</span><span class="gvp-price" ng-if="gvp()">Complete pair (frame + lenses) {{starting}} at {{price | currency:constants.CURRENCY_SYMBOL}}</span></div><div class="step-loader" ng-show="insurance.isLoading"><em class="fa fa-spinner fa-spin"></em></div>',scope:{startingfrom:"=",offerprice:"=",price:"="},link:function(scope,el,attr,ctrl){scope.constants=lpConstants,scope.insurance=lpDataset.insurance,scope.starting=angular.isDefined(attr.istreatment)&&"true"==attr.istreatment&&!scope.startingfrom?"":"starting ",scope.gvp=function(){return!lpDataset.insurance.isEnabled&&lpDataset.isGvp()}}}})).directive("lpInsuranceFramePrice",(function(lpConstants,lpDataset){return{restrict:"EA",template:'<div class="price-wrapper" ng-hide="insurance.isLoading"><span class="offer-price" ng-if="!insurance.isEnabled && (offerprice - price) > 0" ng-class="{\'strike-through\': (offerprice - price) > 0}">{{offerprice | currency:constants.CURRENCY_SYMBOL}}</span><span class="price frame" ng-if="price > 0" ng-class="{\'insurance\': insurance.isEnabled}">{{price | currency:constants.CURRENCY_SYMBOL}}</span><span class="price frame" ng-if="price <= 0" ng-class="{\'insurance\': insurance.isEnabled}">FREE</span></div><div class="step-loader" ng-show="insurance.isLoading"><em class="fa fa-spinner fa-spin"></em></div>',scope:{startingfrom:"=",offerprice:"=",price:"="},link:function(scope,el,attr,ctrl){scope.constants=lpConstants,scope.insurance=lpDataset.insurance}}})).directive("lpReviewPrice",(function(lpConstants){return{restrict:"EA",template:'<div class="price-wrapper"><span class="offer-price" ng-if="(offerprice - price) > 0" ng-class="{\'strike-through\': (offerprice - price) > 0}">{{offerprice | currency:constants.CURRENCY_SYMBOL}}</span><span class="price" ng-class="{\'gvp-recap-price\': gvp, \'total-price\': total}" ng-if="price > 0">{{price | currency:constants.CURRENCY_SYMBOL}}</span><span class="price" ng-class="{\'gvp-recap-price\': gvp, \'total-price\': total}" ng-if="price <= 0">FREE</span></div>',scope:{offerprice:"=",price:"=",gvp:"=?",total:"=?"},link:function(scope,el,attr,ctrl){scope.constants=lpConstants,scope.gvp=scope.gvp||!1}}})).directive("lpGvpBanner",(function(){return{restrict:"EA",template:'<div class="col justify-content-center gvp-banner-layout"><span class="gvp-banner-text" ng-bind="gvpBannerText"></span></div>',scope:{},link:function(scope,el,attr,ctrl){scope.gvpBannerText="Great value package"}}})),appLensPanel.directive("lpWarrantyTooltip",(function(lpConstants,lpUrl,$window){return{restrict:"E",templateUrl:lpConstants.BASE_PATH+"app/templates/warrantyTooltip.htm",scope:{},link:function(scope,iElement,iAttributes,ctrl){scope.labels={warrantyName:"Eyewear Protection Plan",title:"Includes",item1:"Accidental damage from handling",item2:"Protection from normal wear and tear",item3:"Unlimited use during the term",link:"Discover more"},scope.isVisible=!1,scope.onMouseover=function(){$window.isMobile||(this.isVisible=!0)},scope.onMouseleave=function(){$window.isMobile||(this.isVisible=!1)},scope.toggleShow=function(event){$window.isMobile&&(event.preventDefault(),event.stopPropagation(),this.isVisible=!this.isVisible)},scope.openDetail=function(){var url=lpUrl("/lc-us/purchase-care/details");$window.open(url,"_blank")};var _container=document.getElementById("lpStepReview");_container&&_container.addEventListener("click",(function(event){scope.$apply((function(){scope.isVisible=!1}))}))}}})),appLensPanel.controller("lensPanelController",(function($rootScope,$scope,lpModalService,lpConstants,lpLabels,lpDataset,lpRest,lpScroll,lpAnalytics,lcInsurance,$q,$timeout,$window,$httpParamSerializerJQLike,$log,WizardHandler){$scope.constants=lpConstants,$scope.labels=lpLabels,$scope.dataset=lpDataset,$scope.isVisible=function(){return lpModalService.isVisible},$scope.exit=function(action,data){lpScroll.enable(),$scope.wizardHandler.goToFirstStep(),lpModalService.close(action,data)},$scope.save=function(){var _ctx=$scope.wizardHandler.context,_lens=lpDataset.getLens(_ctx);$scope.exit(lpModalService.CLOSE_ACTION_SAVE,_lens)},$scope.addToCart=function(){if(!lpModalService.isAddingToCart){var _ctx=$scope.wizardHandler.context,_lens=lpDataset.getLens(_ctx);if($scope.callerId&&-1!=$scope.callerId.indexOf(lpModalService.CALLERID_CART))$scope.exit(lpModalService.CLOSE_ACTION_APPLY,_lens);else{var _params={storeId:lpDataset.storeId,catalogId:lpDataset.catalogId,langId:lpDataset.langId,orderId:lpDataset.currentOrderId,frameCatentryId:lpDataset.frameData.id,URL:"",lensCatentryId:_lens.productCatEntryId,lensColor:_lens.color,lens:_lens.catEntryId,addOns:"",includeLens:!0,tah:!1,addWarranty:_ctx.addWarranty};lpDataset.selectedPerkCode&&(_params.promoCode=lpDataset.selectedPerkCode),lpModalService.addToCart(_params).then((function(data){incrementShopCartCounter();var orderItemCount=angular.element(document.getElementById("tah-quantity-header")).text().trim();try{var _obj={id:"AddToCart",site_events:{add_to_cart:"true"}};void 0!==orderItemCount&&parseInt(orderItemCount)<=1&&(_obj.site_events.cart_start="true");var _products=lpAnalytics.getProducts(lpDataset.frameData,_lens);_obj.Products=_products,tealium_data2track.push(_obj)}catch(err){$log.error("error in tracking analytics of add to cart: "+err.stack);_obj={id:"WCS-D-Pdp-Prod-AddToCart-Error",Error_Source:"Server",Error_Code:"utag_data syntax - "+err.message};tealium_data2track.push(_obj)}$timeout((function(){var toCartParams={storeId:data.storeId[0],catalogId:data.catalogId[0],langId:data.langId[0],URL:"AjaxOrderItemDisplayView",errorViewName:"AjaxOrderItemDisplayView",orderId:".",updatePrices:"1",calculationUsageId:"-1",chooseBenefit:lpDataset.insurance.isEnabled};$window.location.href=getAbsoluteURL()+"OrderCalculate?"+$httpParamSerializerJQLike(toCartParams)}),500)}),(function(error){$log.error(error)}))}}};$scope.closeLensPanelPopup={isVisible:!1,open:function(redirect){this.isVisible||(this.redirect=redirect||!1,this.isVisible=!0,angular.element(document.getElementById("close-lens-panel--")).focus(),lpScroll.disable("lensPanelId"))},close:function(){this.isVisible=!1,lpScroll.enable("lensPanelId")},exit:function(){if(this.close(),$scope.exit(),this.redirect){var _url=$window.location.hostname;_url=-1!=_url.indexOf("localhost")?"https://localhost/webapp/wcs/stores/servlet":"https://"+_url;var _country=10852==lpDataset.storeId?"/en-ca":"/lc-us";$window.location=_url+_country}}},$scope.$on("lenspanel:opened",(function(event,_params,_callerId,_context){if(!_params.lensCategory)throw"Undefined lensCategory property";if(!_params.lensData)throw"Undefined lens data";$scope.callerId=_callerId,lpScroll.disable();var resetLensData=!1;if(-1!=_callerId.indexOf(lpModalService.CALLERID_CART)){document.getElementById("header_wrapper").style.zIndex=30;var _el=document.getElementById("skipToMainContent");_el&&(_el.style.display="none"),angular.element(document.getElementById("cart-section")).addClass("hidden"),resetLensData=!0}!function(resetLensData){resetLensData&&(lpDataset.lensData={}),$scope.wizardHandler&&null!=$scope.wizardHandler&&$scope.wizardHandler.reset()}(resetLensData),angular.merge(lpDataset,_params),angular.merge(lpDataset.frameData,lpDataset.lensData.frame),delete lpDataset.lensData.frame,lpModalService.selectedPerkCode&&(lpDataset.selectedPerkCode=lpModalService.selectedPerkCode),lpDataset.insurance.isEnabled=lcInsurance.isEnabled(),_context&&angular.merge($scope.wizardHandler.context,_context),$scope.stepLens.initialize(),$timeout((function(){lpScroll.top(),angular.element(document.getElementById("wcag-start")).focus(),angular.element(document.getElementById("footer_wrapper")).addClass("hidden"),angular.element(document.getElementById("header_wrapper")).addClass("hidden"),angular.element(document.getElementById("pdp-wrapper")).addClass("hidden"),angular.element(document.getElementById("site-breadcrumb")).addClass("hidden"),angular.element(document.getElementById("main-navigation")).addClass("hidden"),angular.element(document.getElementById("main-content-comp")).addClass("hidden")}))})),$scope.$on("wizard:created",(function(event){$timeout((function(){$scope.wizardHandler=WizardHandler.wizard(lpConstants.WIZARD_NAME),event.targetScope.brandStyle=function(){var _wizard=$scope.wizardHandler;return _wizard&&"Review"==_wizard.currentStepTitle()?"":lpDataset.getBrandStyle(this.context.selectedBrand)},event.targetScope.backLabel=function(step){switch(step){case"Treatment":case"Color":return"Back".concat(" to Lens Selection");case"Review":return"Back".concat(lpDataset.lensCategory==lpConstants.LENS_CATEGORY.EYE?" to Treatment Selection":" to Color Selection")}return"Back"},event.targetScope.closeLensPanelPopup={isVisible:!1,open:function(){this.isVisible||(this.isVisible=!0,lpScroll.disable("lensPanelId"))},close:function(){this.isVisible=!1,lpScroll.enable("lensPanelId")},exit:function(){this.close(),$scope.exit()}}}))}));var _detect=function(){var _md=new MobileDetect($window.navigator.userAgent);$window.isMobile=null!=_md.mobile(),$window.isPhone=null!=_md.phone()};$scope.init=function(_params){_detect(),$window.addEventListener("resize",(function(event){_detect(),$scope.$digest()}))},$scope.brandStyle=function(){return $scope.wizardHandler&&"Review"==$scope.wizardHandler.currentStepTitle()?"":lpDataset.getBrandStyle($scope.stepLens.tabSelected)},$scope.getFramePrice=function(){var framePrice=lpDataset.frameData.price?lpDataset.frameData.price:lpDataset.frameData.offerPrice;return lpDataset.insurance.isEnabled&&(framePrice=lpDataset.frameData.offerPrice-lpDataset.insurance.discounts[lpDataset.frameData.partNumber]),framePrice},$scope.editFromCart=function(){return $scope.callerId&&-1!=$scope.callerId.indexOf("CART_")},$scope.wizard={template:lpConstants.BASE_PATH+"app/templates/wizard.htm",cancelled:function(){},finished:function(context){console.log("Finished")}};var analyticsEnterStep=function(_pageType){tealium_data2track.push({id:"LensPanel-View",Page_Type:_pageType,Page_Section1:lpDataset.lensCategory==lpConstants.LENS_CATEGORY.EYE?"LensPanel":"SunLensPanel"})};$scope.stepLens={constants:lpConstants,labels:lpLabels.stepLens,dataset:lpDataset,initialize:function(){for(var key in this.isDesktop=function(){return!$window.isMobile},this.showBanner=!1,this.sortedLensBrands=[],lpDataset.lensData.lensBrands)this.sortedLensBrands.push(key);this.sortedLensBrands.sort((function(key1,key2){return lpDataset.lensData.lensBrands[key2].sequence-lpDataset.lensData.lensBrands[key1].sequence})),$scope.wizardHandler&&(this.tabSelected=$scope.wizardHandler.context&&$scope.wizardHandler.context.selectedBrand?$scope.wizardHandler.context.selectedBrand:this.sortedLensBrands[0],this.tabChanged(),analyticsEnterStep("LensType"))},canEnter:function(context){return context.selectedBrand&&null!=context.selectedBrand&&(this.wzData.tabSelected=context.selectedBrand,this.wzData.tabChanged()),analyticsEnterStep("LensType"),!0},canExit:function(context){var _this=this.wzData;return!(!_this.tabSelected||!context.selectedLensType)&&(context.selectedBrand=_this.tabSelected,!0)},tabsHidden:function(){return!this.dataset.lensData.lensBrands||Object.keys(this.dataset.lensData.lensBrands).length<2&&null!=this.dataset.lensData.lensBrands[lpConstants.BRANDS.OUR_LENSES]},tabChanged:function(){if(this.dataset.lensData.lensBrands&&!lpDataset.insurance.isLoading)if(this.backgroundImage={"background-image":"url("+this.dataset.lensData.lensBrands[this.tabSelected].bgImageUrl+")"},this.lensTypes=this.dataset.lensData.lensBrands[this.tabSelected].lensTypes,this.lensTypesNumber=Object.keys(this.lensTypes).length,lpDataset.insurance.isEnabled&&this.getInsuranceForTab(),this.tabSelected!=lpConstants.BRANDS.OUR_LENSES){var lensCategory=$scope.dataset.lensCategory==lpConstants.LENS_CATEGORY.SUN?"Sun":"Eye",espotname="DESK_"+lpConstants.ESPOT[this.tabSelected]+"_HEADER_"+lensCategory,_this=this;lpRest.getBrandEspot(espotname).then((function(data){_this.htmlContent=data}),(function(error){console.log(error+" ["+espotname+"]")}))}else this.htmlContent=""},selectTab:function(code){this.dataset.insurance.isLoading||($scope.wizardHandler.context.selectedBrand=code,this.tabSelected=code,this.tabChanged())},getInsuranceForTab:function(){var _defer=$q.defer();if(lpDataset.insurance.isLoading)return _defer.reject(),_defer.promise;lpDataset.insurance.isLoading=!0,lpDataset.insurance.isLoadingError=!1;var data={storeId:lpDataset.storeId,catalogId:lpDataset.catalogId,langId:lpDataset.langId,pricingEntries:[]};return angular.forEach(lpDataset.lensData.lensBrands[this.tabSelected].lensTypes,(function(lensType,lensTypeKey){void 0===lpDataset.insurance.discounts[lensType.baseLensUPC]&&data.pricingEntries.push({frame:{price:lpDataset.frameData.offerPrice,upc:lpDataset.frameData.partNumber,quantity:"1",type:"f"},lens:{price:lensType.basePrice,upc:lensType.baseLensUPC,quantity:"1",type:"l"}})})),0==data.pricingEntries.length?(lpDataset.insurance.isLoading=!1,_defer.reject(),_defer.promise):(lcInsurance.getDiscounts(data).then((function(response){response&&response.length>0&&(angular.forEach(response,(function(value,key){lpDataset.insurance.discounts[value.frame.upc]=value.frameDiscount,lpDataset.insurance.discounts[value.lens.upc]=value.lensDiscount})),lpDataset.insurance.isLoading=!1,_defer.resolve())}),(function(error){lpDataset.insurance.isLoading=!1,lpDataset.insurance.isLoadingError=!0,_defer.reject()})),_defer.promise)},moreInfoPopup:{isVisible:!1,lpRest:lpRest,htmlContent:null,open:function(){if(!this.isVisible){var espotname="DESK_Lens_Panel_Eye_Choose_Lenses";if($scope.dataset.lensCategory){if($scope.dataset.lensCategory==lpConstants.LENS_CATEGORY.SUN)espotname="DESK_Lens_Panel_Sun_Choose_Lenses";var lensCategory="Eye",isChromance=!1;$scope.dataset.lensCategory==lpConstants.LENS_CATEGORY.SUN&&(lensCategory="Sun",$scope.stepLens.tabSelected==lpConstants.BRANDS.RAYBAN&&(isChromance=$scope.dataset.isChromance(lpConstants.BRANDS.RAYBAN))),$scope.stepLens.tabSelected!==lpConstants.BRANDS.OUR_LENSES&&(espotname=isChromance?"DESK_Lens_Panel_Sun_RAY-BAN_CHROMANCE":"DESK_Lens_Panel_"+lensCategory+"_"+lpConstants.ESPOT[$scope.stepLens.tabSelected]),$scope.dataset.isGvp()&&(espotname=$scope.dataset.lensCategory==lpConstants.LENS_CATEGORY.SUN?"DESK_Lens_Panel_Sun_Choose_Lenses_GVP":"DESK_Lens_Panel_Eye_Choose_Lenses_GVP");var _this=this;this.lpRest.getMoreInfoEspot(espotname).then((function(data){_this.backLabel=$window.isMobile?"Back":"Back To Lenses Selection",_this.htmlContent=data,_this.isVisible=!0,lpScroll.disable("lensPanelId")}),(function(error){$log.error(error+" "+espotname)}))}}},close:function(){this.isVisible=!1,lpScroll.enable("lensPanelId")}}},$scope.stepTreatment={labels:lpLabels.stepTreatment,dataset:lpDataset,canEnter:function(context){this.wzData.isDesktop=function(){return!$window.isMobile},this.wzData.brandStyle=lpDataset.getBrandStyle(context.selectedBrand),this.wzData.lensTypeName=lpDataset.lensData.lensBrands[context.selectedBrand].lensTypes[context.selectedLensType].name.replace(/EYE|SUN/,"").trim(),this.wzData.treatments=lpDataset.lensData.lensBrands[context.selectedBrand].lensTypes[context.selectedLensType].treatmentTypes,this.wzData.treatmentsNumber=Object.keys(this.wzData.treatments).length,this.wzData.backgroundImage={"background-image":"url("+lpDataset.lensData.lensBrands[context.selectedBrand].bgImageUrl+")"};var _this=this.wzData;if(context.selectedBrand!=lpConstants.BRANDS.OUR_LENSES){var espotname="DESK_"+lpConstants.ESPOT[context.selectedBrand]+"_HEADER_TREATMENT";lpRest.getBrandEspot(espotname).then((function(data){_this.htmlContent=data}),(function(error){console.log(error)}))}return lcInsurance.isEnabled()&&this.wzData.getInsuranceForStep(context),analyticsEnterStep("LensTreatment"),!0},canExit:function(context){return!0},getInsuranceForStep:function(context){var _defer=$q.defer();if(lpDataset.insurance.isLoading)return _defer.reject(),_defer.promise;lpDataset.insurance.isLoading=!0,lpDataset.insurance.isLoadingError=!1;var data={storeId:lpDataset.storeId,catalogId:lpDataset.catalogId,langId:lpDataset.langId,pricingEntries:[]};return angular.forEach(lpDataset.lensData.lensBrands[context.selectedBrand].lensTypes[context.selectedLensType].treatmentTypes,(function(treatmentType,treatmentTypeKey){angular.forEach(treatmentType.treatments,(function(treatment,treatmentKey){treatment.colorTypes?angular.forEach(treatment.colorTypes,(function(colorType,colorTypeKey){colorType.colors&&angular.forEach(colorType.colors,(function(color,colorKey){void 0===lpDataset.insurance.discounts[color.lens.partNumber]&&data.pricingEntries.push({frame:{price:lpDataset.frameData.offerPrice,upc:lpDataset.frameData.partNumber,quantity:"1",type:"f"},lens:{price:color.lens.offerPrice,upc:color.lens.partNumber,quantity:"1",type:"l"}})}))})):void 0===lpDataset.insurance.discounts[treatment.lens.partNumber]&&data.pricingEntries.push({frame:{price:lpDataset.frameData.offerPrice,upc:lpDataset.frameData.partNumber,quantity:"1",type:"f"},lens:{price:treatment.lens.offerPrice,upc:treatment.lens.partNumber,quantity:"1",type:"l"}})}))})),0==data.pricingEntries.length?(lpDataset.insurance.isLoading=!1,_defer.reject(),_defer.promise):(lcInsurance.getDiscounts(data).then((function(response){response&&response.length>0&&(angular.forEach(response,(function(value,key){lpDataset.insurance.discounts[value.frame.upc]=value.frameDiscount,lpDataset.insurance.discounts[value.lens.upc]=value.lensDiscount})),lpDataset.insurance.isLoading=!1,_defer.resolve())}),(function(error){lpDataset.insurance.isLoading=!1,lpDataset.insurance.isLoadingError=!0,_defer.reject()})),_defer.promise)}},$scope.stepColor={labels:lpLabels.stepColor,dataset:lpDataset,standard:[],polarized:[],canEnter:function(context){if(!context.selectedColorSet)return!1;if(this.wzData.isMobile=function(){return $window.isMobile},this.wzData.brandStyle=lpDataset.getBrandStyle(context.selectedBrand),this.polarizedMode=!1,this.wzData.polarized=context.selectedColorSet.filter((function(color){return color.isPolarized})),this.wzData.standard=context.selectedColorSet.filter((function(color){return!color.isPolarized})),this.wzData.backgroundImage={"background-image":"url("+lpDataset.lensData.lensBrands[context.selectedBrand].bgImageUrl+")"},this.wzData.standard.length>0?this.wzData.colors=this.wzData.standard:this.wzData.colors=this.wzData.polarized,this.wzData.isMixed()){var _pLens=this.wzData.polarized[0].lens,_sLens=this.wzData.standard[0].lens;_pLens&&_sLens&&(this.wzData.polarDeltaPrice=parseFloat(_pLens.offerPrice)-parseFloat(_sLens.offerPrice))}var _this=this.wzData;if(context.selectedBrand!=lpConstants.BRANDS.OUR_LENSES){var espotname="DESK_"+lpConstants.ESPOT[context.selectedBrand]+"_HEADER_COLOR";lpRest.getBrandEspot(espotname).then((function(data){_this.htmlContent=data}),(function(error){console.log(error)}))}return lcInsurance.isEnabled()&&this.wzData.getInsuranceForStep(context),analyticsEnterStep("LensColor"),!0},canExit:function(context){return!(!context.selectedColorType||!context.selectedColor)},isMixed:function(){return this.standard.length>0&&this.polarized.length>0},togglePolarized:function(){this.polarizedMode=!this.polarizedMode,this.colors=this.polarizedMode?this.polarized:this.standard},polarizedText:function(){return this.polarizedMode?this.labels.polarized:this.labels.standard},getInsuranceForStep:function(context){var _defer=$q.defer();if(lpDataset.insurance.isLoading)return _defer.reject(),_defer.promise;lpDataset.insurance.isLoading=!0,lpDataset.insurance.isLoadingError=!1;var data={storeId:lpDataset.storeId,catalogId:lpDataset.catalogId,langId:lpDataset.langId,pricingEntries:[]};return angular.forEach(lpDataset.lensData.lensBrands[context.selectedBrand].lensTypes[context.selectedLensType].colorTypes,(function(colorType,colorTypeKey){colorType.colors&&angular.forEach(colorType.colors,(function(color,colorKey){void 0===lpDataset.insurance.discounts[color.lens.partNumber]&&data.pricingEntries.push({frame:{price:lpDataset.frameData.offerPrice,upc:lpDataset.frameData.partNumber,quantity:"1",type:"f"},lens:{price:color.lens.offerPrice,upc:color.lens.partNumber,quantity:"1",type:"l"}})}))})),0==data.pricingEntries.length?(lpDataset.insurance.isLoading=!1,_defer.reject(),_defer.promise):(lcInsurance.getDiscounts(data).then((function(response){response&&response.length>0&&(angular.forEach(response,(function(value,key){lpDataset.insurance.discounts[value.frame.upc]=value.frameDiscount,lpDataset.insurance.discounts[value.lens.upc]=value.lensDiscount})),lpDataset.insurance.isLoading=!1,_defer.resolve())}),(function(error){lpDataset.insurance.isLoading=!1,lpDataset.insurance.isLoadingError=!0,_defer.reject()})),_defer.promise)}},$scope.stepReview={labels:lpLabels.stepReview,dataset:lpDataset,canEnter:function(context){var _brand=lpDataset.lensData.lensBrands[context.selectedBrand];if(!_brand||!_brand.lensTypes)return!1;var _lensType=_brand.lensTypes[context.selectedLensType];if(!_lensType)return!1;var _treatmentType=_lensType.treatmentTypes?_lensType.treatmentTypes[context.selectedTreatmentType]:null,_treatment=_treatmentType&&_treatmentType.treatments?_treatmentType.treatments[context.selectedTreatment]:null,_colorType=null;_lensType.colorTypes?_colorType=_lensType.colorTypes[context.selectedColorType]:_treatment&&_treatment.colorTypes&&(_colorType=_treatment.colorTypes[context.selectedColorType]);var _color=_colorType&&_colorType.colors?_colorType.colors[context.selectedColor]:null,_lens=lpDataset.getLens(context);this.wzData.frame=lpDataset.frameData,null!==_lens.framePrice&&void 0!==_lens.framePrice&&(this.wzData.frame.price=_lens.framePrice),this.wzData.lens={brand:_brand.name,type:_lensType.name.replace(/EYE|SUN/,"").trim(),treatmentType:_treatmentType?_treatmentType.name:null,colorType:_colorType?_colorType.name:null,treatment:_treatment?_treatment.name:null,color:_color?_color.name:null,partNumber:_lens.partNumber,material:_lens.material,promotions:_lens.promotions,offerPrice:_lens.offerPrice,price:_lens.price},this.wzData.insurance=lpDataset.insurance;try{var _frameOfferPrice=parseFloat(this.wzData.frame.offerPrice),_lensOfferPrice=parseFloat(this.wzData.lens.offerPrice),_framePrice=_frameOfferPrice,_lensPrice=_lensOfferPrice,_insuranceSaving=0,_perkSaving=0;if(this.wzData.insurance.isEnabled){var _frameInsuranceDiscount=this.wzData.insurance.discounts[this.wzData.frame.partNumber];void 0!==_frameInsuranceDiscount&&(_framePrice=Math.max(0,_framePrice-_frameInsuranceDiscount),_insuranceSaving+=_frameInsuranceDiscount);var _lensInsuranceDiscount=this.wzData.insurance.discounts[this.wzData.lens.partNumber];void 0!==_lensInsuranceDiscount&&(_lensPrice=Math.max(0,_lensPrice-_lensInsuranceDiscount),_insuranceSaving+=_lensInsuranceDiscount)}else null!=this.wzData.frame.price&&void 0!==this.wzData.frame.price&&(_framePrice=parseFloat(this.wzData.frame.price),this.wzData.frame.promotions&&this.wzData.frame.promotions.perksAvailable&&(_perkSaving+=Math.max(0,_frameOfferPrice-_framePrice))),null!=this.wzData.lens.price&&void 0!==this.wzData.lens.price&&(_lensPrice=parseFloat(this.wzData.lens.price),this.wzData.lens.promotions&&this.wzData.lens.promotions.perksAvailable&&(_perkSaving+=Math.max(0,_lensOfferPrice-_lensPrice)));var _this=this.wzData,_isGvp=function(){return(!_this.insurance||!_this.insurance.isEnabled)&&(_this.lens&&_this.lens.promotions&&_this.lens.promotions.completePairAvailable)};this.wzData.frameOfferPrice=_frameOfferPrice,this.wzData.lensOfferPrice=_lensOfferPrice,this.wzData.framePrice=_framePrice,this.wzData.lensPrice=_lensPrice,this.wzData.insuranceSaving=_insuranceSaving,this.wzData.perkSaving=_perkSaving,this.wzData.totalPrice=Math.max(0,_framePrice+_lensPrice),this.wzData.totalOfferPrice=_isGvp()?_frameOfferPrice+_lensOfferPrice:this.wzData.totalPrice,this.wzData.gvp=_isGvp(),this.wzData.addWarranty=context.addWarranty||!1,this.wzData.warrantyChange=function(){context.addWarranty=this.addWarranty;var warrantyPrice=parseFloat(this.dataset.warrantyPrice);this.addWarranty?this.totalPrice+=warrantyPrice:this.totalPrice-=warrantyPrice,context.totalPrice=this.totalPrice},context.totalPrice=this.wzData.totalPrice}catch(err){$log.error(err)}return analyticsEnterStep("LensReview"),!0},canExit:function(context){return!0},edit:function(){$scope.wizardHandler.goToFirstStep()}}})),appLensPanel.factory("lpDataset",(function(lpConstants,$q){return{getBrandStyle:function(brand){return this.isGvp()?"gvp":brand==lpConstants.BRANDS.RAYBAN?"rayban":brand==lpConstants.BRANDS.OAKLEY?"oakley":brand==lpConstants.BRANDS.COSTA?"costa":"our-lenses"},isChromance:function(brand){if(!this.lensData.lensBrands)return!1;var _brand=this.lensData.lensBrands[brand];if(!_brand)return!1;var check=!1;return angular.forEach(_brand.lensTypes,(function(value,key){if(check)return check;angular.forEach(value.colorTypes,(function(value2,key2){"CHROMANCE"!=key2||(check=!0)}))})),check},isGvp:function(){return this.frameData.promotions&&this.frameData.promotions.completePairAvailable},getLens:function(context){var _lens={context:{}};if(!this.lensData.lensBrands)return _lens;var _brand=this.lensData.lensBrands[context.selectedBrand];if(!_brand)throw"Undefined brand: "+context.selectedBrand;var _lensType=_brand.lensTypes[context.selectedLensType];if(!_lensType)throw"Undefined lens type: "+context.selectedLensType;switch(this.lensCategory){case lpConstants.LENS_CATEGORY.EYE:var _treatmentType=_lensType.treatmentTypes[context.selectedTreatmentType];if(!_treatmentType)throw"Undefined treatment type: "+context.selectedTreatmentType;var _treatment=_treatmentType.treatments[context.selectedTreatment];if(!_treatment)throw"Undefined treatment: "+context.selectedTreatment;if(_treatment.colorTypes){if(!(_colorType=_treatment.colorTypes[context.selectedColorType]))throw"Undefined color type: "+context.selectedColorType;if(!(_color=_colorType.colors[context.selectedColor]))throw"Undefined color: "+context.selectedColor;angular.merge(_lens,_color.lens),_lens.color=_color.name}else angular.merge(_lens,_treatment.lens);break;case lpConstants.LENS_CATEGORY.SUN:var _colorType,_color;if(!(_colorType=_lensType.colorTypes[context.selectedColorType]))throw"Undefined color type: "+context.selectedColorType;if(!(_color=_colorType.colors[context.selectedColor]))throw"Undefined color: "+context.selectedColor;angular.merge(_lens,_color.lens),_lens.color=_color.name;break;default:throw"Invalid lens category: "+this.lensCategory}return _lens.category=this.lensCategory,angular.merge(_lens.context,context),_lens},getLensPath:function(lensId,data){var lensData=data||this.lensData,lensPath={},lensFound=!1;function getLensColorPath(parentObj){for(var colorTypeKey in parentObj.colorTypes){if(lensFound)break;var currentColorType=parentObj.colorTypes[colorTypeKey];for(var colorKey in currentColorType.colors){if(lensFound)break;var currentColor=currentColorType.colors[colorKey];currentColor.lens&&currentColor.lens.catEntryId==lensId?(lensPath.color=colorKey,lensFound=!0):delete lensPath.color}lensFound?lensPath.colorType=colorTypeKey:delete lensPath.colorType}}if(lensData.lensBrands)for(var lensBrandKey in lensData.lensBrands){if(lensFound)break;var currentLensBrand=lensData.lensBrands[lensBrandKey];for(var lensTypeKey in currentLensBrand.lensTypes){if(lensFound)break;var currentLensType=currentLensBrand.lensTypes[lensTypeKey];if(currentLensType.treatmentTypes)for(var treatmentTypeKey in currentLensType.treatmentTypes){if(lensFound)break;var currentTreatmentType=currentLensType.treatmentTypes[treatmentTypeKey];for(var treatmentKey in currentTreatmentType.treatments){if(lensFound)break;var currentTreatment=currentTreatmentType.treatments[treatmentKey];currentTreatment.colorTypes?getLensColorPath(currentTreatment):currentTreatment.lens&&currentTreatment.lens.catEntryId==lensId?(lensPath.treatment=treatmentKey,lensFound=!0):delete lensPath.treatment}lensFound?lensPath.treatmentType=treatmentTypeKey:delete lensPath.treatmentType}else currentLensType.colorTypes&&getLensColorPath(currentLensType);lensFound?lensPath.lensType=lensTypeKey:delete lensPath.lensType}lensFound?lensPath.lensBrand=lensBrandKey:delete lensPath.lensBrand}return lensPath},frameData:{},lensData:{},insurance:{isEnabled:!1,isLoading:!1,isLoadingError:!1,discounts:{}}}})),appLensPanel.factory("lpModalService",(function($rootScope,$http,$httpParamSerializerJQLike,$q,$log){return{CALLERID_PDP:"PDP",CALLERID_CART:"CART",CLOSE_ACTION_CANCEL:"cancel",CLOSE_ACTION_SAVE:"save",CLOSE_ACTION_ADDTOCART:"addtocart",CLOSE_ACTION_APPLY:"apply",isVisible:!1,isAddingToCart:!1,callerId:null,selectedPerkCode:null,open:function(_params,_callerId,_context){$rootScope.$broadcast("lenspanel:opened",_params,_callerId,_context),this.callerId=_callerId,this.isVisible=!0},close:function(_action,_params){this.isVisible=!1,$rootScope.$broadcast("lenspanel:closed",this.callerId,_action||this.CLOSE_ACTION_CANCEL,_params),this.callerId=null},addToCart:function(_params){var _defer=$q.defer();if(this.isAddingToCart)return _defer.reject(),_defer;this.isAddingToCart=!0;var _this=this;return $http.post(getAbsoluteURL()+"LCOrderItemAddGlassesCmd",$httpParamSerializerJQLike(_params),{headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then((function(response){var _data=response.data;"string"==typeof _data&&(_data=_data?_data.replace("/*","").replace("*/",""):{},_data=JSON.parse(_data)),_this.isAddingToCart=!1,_data.errorMessage?_defer.reject(_data.errorMessage):_defer.resolve(response.data)}),(function(error){$log.error(error),_this.isAddingToCart=!1,_defer.reject("Cannot add to cart")})),_defer.promise},genericAddToCart:function(_selectedFrame,_selectedLens,_selectedWarranty){var _params={frameCatentryId:_selectedFrame.catEntryId,lensColor:_selectedLens.lensPackage.color||"",lens:""+_selectedLens.lensPackage.catEntryId,orderId:".",URL:"",addOns:"",includeLens:!0,tah:!1};_selectedWarranty&&(_params.warrantyCatentryId=_selectedWarranty.id,_params.addWarranty=!0);var _defer=$q.defer();if(this.isAddingToCart)return _defer.reject(),_defer;this.isAddingToCart=!0;var _this=this;return $http.post(getAbsoluteURL()+"LCOrderItemAddGlassesCmd",$httpParamSerializerJQLike(_params),{headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then((function(response){var _data=response.data;if("string"==typeof _data&&(_data=_data?_data.replace("/*","").replace("*/",""):{},_data=JSON.parse(_data)),_this.isAddingToCart=!1,_data.errorMessage)_defer.reject(_data.errorMessage);else{_defer.resolve(response.data);var _cartParams="storeId="+constants.ajaxParams.storeId+"&catalogId="+constants.ajaxParams.catalogId+"&langId="+(constants.ajaxParams.langId||"-1")+"&URL=AjaxOrderItemDisplayView&errorViewName=AjaxOrderItemDisplayView&orderId=.&updatePrices=1&calculationUsageId=-1&chooseBenefit=false";window.location=getAbsoluteURL()+"OrderCalculate?"+_cartParams}}),(function(error){$log.error(error),_this.isAddingToCart=!1,_defer.reject("Cannot add to cart")})),_defer.promise},genericSaveLensSelection:function(_selectedFrame,_selectedLens,_selectedWarranty,_selectedFrameBrandImage){$rootScope.$apply((function(){$rootScope.rxc.selectedLens=_selectedLens,$rootScope.rxc.selectedWarranty=_selectedWarranty,$rootScope.rxc.selectedFrame=_selectedFrame,$rootScope.rxc.selectedFrameBrandImage=_selectedFrameBrandImage,$rootScope.genericCalculatePrices()}))},genericExit:function(){document.getElementById("header_wrapper").style.zIndex="",$rootScope.$apply((function(){delete $rootScope.rxc.rxcWidget}))},genericSaveEditFromCart:function(_selectedFrame,_selectedLens,_selectedWarranty,_cartData){var params={orderId:".",lensCatentryId:""+_selectedLens.lensPackage.catEntryId,lensColor:_selectedLens.lensPackage.color||"",lens:""+_selectedLens.lensPackage.catEntryId,addOns:"",URL:"",includeLens:!0,orderItemId:_cartData.orderItemId,fromPage:"ShopCart",addRxLenses:!0};_selectedWarranty&&(params.addWarranty=!0,params.warrantyCatentryId=_selectedWarranty.id),$.ajax({type:"POST",url:getAbsoluteURL()+"LCUpdateOrderItemLensDataCmd",traditional:!0,data:params,success:function(data,textStatus,jqXHR){var toCartParams=$.param({storeId:constants.ajaxParams.storeId,catalogId:constants.ajaxParams.catalogId,langId:constants.ajaxParams.langId,URL:"AjaxOrderItemDisplayView",errorViewName:"AjaxOrderItemDisplayView",orderId:".",updatePrices:"1",calculationUsageId:"-1"});window.location=getAbsoluteURL()+"OrderCalculate?"+toCartParams},error:function(xhr,text,error){console.log(xhr)}})},loadContent:function(contentName){var _defer=$q.defer(),urlPrefix="";return-1!=window.location.href.indexOf("127.0.0.1")&&(urlPrefix="https://localhost:8000"),$http.get(urlPrefix+"/wcs/resources/store/"+constants.ajaxParams.storeId+"/espot/"+contentName).then((function(res){res.data.MarketingSpotData&&res.data.MarketingSpotData.length>0&&res.data.MarketingSpotData[0].baseMarketingSpotActivityData&&res.data.MarketingSpotData[0].baseMarketingSpotActivityData.length>0&&res.data.MarketingSpotData[0].baseMarketingSpotActivityData[0].marketingContentDescription&&res.data.MarketingSpotData[0].baseMarketingSpotActivityData[0].marketingContentDescription.length>0&&res.data.MarketingSpotData[0].baseMarketingSpotActivityData[0].marketingContentDescription[0].marketingText&&_defer.resolve(res.data.MarketingSpotData[0].baseMarketingSpotActivityData[0].marketingContentDescription[0].marketingText)})),_defer.promise},loadLearnMoreContent:function(contentName){return this.loadContent(contentName)}}})),appLensPanel.factory("lpRest",(function($http,$q,$log,$window,$timeout){return{getUrlPrefix:function(){var urlPrefix="";return-1!=$window.location.href.indexOf("127.0.0.1")&&(urlPrefix="https://localhost:8000"),urlPrefix},getBrandEspot:function(espotName){var _defer=$q.defer(),urlPrefix=this.getUrlPrefix();return $http.get(urlPrefix+"/wcs/resources/store/"+storeId+"/espot/"+espotName).then((function(response){response.data.MarketingSpotData&&response.data.MarketingSpotData.length>0&&response.data.MarketingSpotData[0].baseMarketingSpotActivityData&&response.data.MarketingSpotData[0].baseMarketingSpotActivityData.length>0&&response.data.MarketingSpotData[0].baseMarketingSpotActivityData[0].marketingContentDescription&&response.data.MarketingSpotData[0].baseMarketingSpotActivityData[0].marketingContentDescription.length>0&&response.data.MarketingSpotData[0].baseMarketingSpotActivityData[0].marketingContentDescription[0].marketingText?_defer.resolve(response.data.MarketingSpotData[0].baseMarketingSpotActivityData[0].marketingContentDescription[0].marketingText):_defer.reject("Espot not found")}),(function(error){_defer.reject(error)})),_defer.promise},getMoreInfoEspot:function(espotName){var _defer=$q.defer(),urlPrefix=this.getUrlPrefix();return $http.get(urlPrefix+"/wcs/resources/store/"+storeId+"/espot/"+espotName).then((function(response){response.data.MarketingSpotData&&response.data.MarketingSpotData.length>0&&response.data.MarketingSpotData[0].baseMarketingSpotActivityData&&response.data.MarketingSpotData[0].baseMarketingSpotActivityData.length>0&&response.data.MarketingSpotData[0].baseMarketingSpotActivityData[0].marketingContentDescription&&response.data.MarketingSpotData[0].baseMarketingSpotActivityData[0].marketingContentDescription.length>0&&response.data.MarketingSpotData[0].baseMarketingSpotActivityData[0].marketingContentDescription[0].marketingText?_defer.resolve(response.data.MarketingSpotData[0].baseMarketingSpotActivityData[0].marketingContentDescription[0].marketingText):($log.error("Error getting espot"),_defer.reject("Error getting espot"))}),(function(error){$log.error(error),_defer.reject(error)})),_defer.promise},getLenses:function(storeId,catalogId,frameId,selectedPerkCode){var _defer=$q.defer(),urlPrefix=this.getUrlPrefix(),url="/wcs/resources/store/"+storeId+"/catalog/"+catalogId+"/lenspanel/frameId/"+frameId+"/lenses";return selectedPerkCode&&(url+="?selectedPerkCode="+selectedPerkCode),$http.get(urlPrefix+url).then((function(response){response&&response.data&&response.data.response&&"ok"==response.data.response.status?_defer.resolve(response.data.response.data):($log.error(response.data.response.messages),_defer.reject(response.data.response.messages))}),(function(error){$log.error(error),_defer.reject(error)})),_defer.promise}}})),appLensPanel.factory("lpAnalytics",(function(lpConstants,lpDataset){return{getProducts:function(frame,lens){var _category=lpDataset.lensCategory==lpConstants.LENS_CATEGORY.EYE?"OPTICS":"SUN",_products={},_glass={},_upc=frame.partNumber;_glass.Status="Available",_glass.Sku=_upc,_glass.Price=frame.price||frame.offerPrice,_glass.Category=_category,_glass.Type="99"!=lens.partNuber?"RX":"STD",_glass.Brand=frame.brand,_glass.ModelName=frame.name,_glass.LensUPC=lens.partNumber,_glass.Lens=lens.productPartNumber,_glass.LensColor=lens.color;var _lens={};return _lens.id=lens.partNumber,_lens.reg_price=lens.price||lens.offerPrice,_lens.category=_category,_glass.applied_lenses=_lens,_products[_upc]=_glass,_products}}})).factory("lpUrl",(function($window){return function(uri){var _url=$window.location.hostname;return _url=-1!=_url.indexOf("localhost")?"https://localhost/webapp/wcs/stores/servlet/lc-us":"https://"+_url,uri?_url+uri:_url}})).factory("lpScroll",(function($timeout){return{containerId:"lensPanelId",top:function(){var _this=this;$timeout((function(){angular.element(document.getElementById(_this.containerId)).scrollTop(0)}))},bottom:function(){var _this=this;$timeout((function(){var _container=angular.element(document.getElementById(_this.containerId));_container.scrollTo(0,_container[0].scrollHeight)}))},scrollTo:function(_id){var _this=this;$timeout((function(){var _container=angular.element(document.getElementById(_this.containerId)),_element=angular.element(document.getElementById(_id));_container.scrollToElement(_element,0)}))},disable:function(_id){if(_id){var _el=document.getElementById(_id);_el&&(_el.style.overflow="hidden")}else{var i,_els=document.querySelectorAll("html,body");for(i=0;i<_els.length;i++)_els[i].style.overflow="hidden"}},enable:function(_id){if(_id){var _el=document.getElementById(_id);_el&&(_el.style.overflow="")}else{var i,_els=document.querySelectorAll("html,body");for(i=0;i<_els.length;i++)_els[i].style.overflow=""}}}})).factory("lpLoader",(function(){function _create(){var _div=document.createElement("div");_div.id="loader",_div.className="wait-loader hidden",_div.addEventListener("click",(function(event){event.preventDefault(),event.stopImmediatePropagation()}));var _spin=document.createElement("em");_spin.className="fa fa-spinner fa-spin",_div.appendChild(_spin);var _container=document.getElementById("page-container");return angular.isUndefined(_container)||_container.appendChild(_div),_div}return{_loader:null,show:function(){null==this._loader&&(this._loader=_create()),this._loader.classList.remove("hidden")},hide:function(){null==this._loader&&(this._loader=_create()),this._loader.classList.add("hidden")}}})),
/**
 * Easy to use Wizard library for Angular JS
 * @version v1.1.1 - 2017-06-07 * @link https://github.com/mgonto/angular-wizard
 * @author Martin Gontovnikas <martin@gon.to>
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
angular.module("templates-angularwizard",["step.html","wizard.html"]),angular.module("step.html",[]).run(["$templateCache",function($templateCache){$templateCache.put("step.html",'<section ng-show="selected" ng-class="{current: selected, done: completed}" class="step" ng-transclude>\n</section>')}]),angular.module("wizard.html",[]).run(["$templateCache",function($templateCache){$templateCache.put("wizard.html",'<div>\n    <h2 ng-show="selectedStep.wzHeadingTitle != \'\'">{{ selectedStep.wzHeadingTitle }}</h2>\n\n    <div class="steps" ng-if="indicatorsPosition === \'bottom\'" ng-transclude></div>\n    <ul class="steps-indicator steps-{{getEnabledSteps().length}}" ng-if="!hideIndicators">\n      <li ng-class="{default: !step.completed && !step.selected, current: step.selected && !step.completed, done: step.completed && !step.selected, editing: step.selected && step.completed}" ng-repeat="step in getEnabledSteps()">\n        <a ng-click="goTo(step)">{{step.title || step.wzTitle}}</a>\n      </li>\n    </ul>\n    <div class="steps" ng-if="indicatorsPosition === \'top\'" ng-transclude></div>\n</div>\n')}]),angular.module("mgo-angular-wizard",["templates-angularwizard"]),angular.module("mgo-angular-wizard").directive("wzStep",(function(){return{restrict:"EA",replace:!0,transclude:!0,scope:{wzTitle:"@",wzHeadingTitle:"@",canenter:"=",canexit:"=",disabled:"@?wzDisabled",description:"@",wzData:"=",wzOrder:"@?"},require:"^wizard",templateUrl:function(element,attributes){return attributes.template||"step.html"},link:function($scope,$element,$attrs,wizard){$attrs.$observe("wzTitle",(function(value){$scope.title=$scope.wzTitle})),$scope.title=$scope.wzTitle,wizard.addStep($scope),$scope.$on("$destroy",(function(){wizard.removeStep($scope)}))}}})),angular.module("mgo-angular-wizard").directive("wizard",(function(){return{restrict:"EA",replace:!0,transclude:!0,scope:{currentStep:"=",onCancel:"&",onFinish:"&",hideIndicators:"=",editMode:"=",name:"@",indicatorsPosition:"@?"},templateUrl:function(element,attributes){return attributes.template||"wizard.html"},controller:["$scope","$element","$log","WizardHandler","$q","$timeout",function($scope,$element,$log,WizardHandler,$q,$timeout){null==$scope.indicatorsPosition&&($scope.indicatorsPosition="bottom");var firstRun=!0;WizardHandler.addWizard($scope.name||WizardHandler.defaultName,this),$scope.$on("$destroy",(function(){WizardHandler.removeWizard($scope.name||WizardHandler.defaultName)})),$scope.steps=[];var stepIdx=function(step){var idx=0,res=-1;return angular.forEach($scope.getEnabledSteps(),(function(currStep){currStep===step&&(res=idx),idx++})),res},stepByTitle=function(titleToFind){var foundStep=null;return angular.forEach($scope.getEnabledSteps(),(function(step){step.wzTitle===titleToFind&&(foundStep=step)})),foundStep},handleEditModeChange=function(){var editMode=$scope.editMode;if(!angular.isUndefined(editMode)&&null!==editMode&&(angular.forEach($scope.steps,(function(step){step.completed=editMode})),!editMode)){var completedStepsIndex=$scope.currentStepNumber()-1;angular.forEach($scope.getEnabledSteps(),(function(step,stepIndex){stepIndex<completedStepsIndex&&(step.completed=!0)}))}};function canEnterStep(step){var defer,canEnter;if(void 0===step.canenter)return!0;if("boolean"==typeof step.canenter)return step.canenter;if("string"==typeof step.canenter){var splitFunction=step.canenter.split("(");canEnter=eval("$scope.$parent."+splitFunction[0]+"($scope.context"+splitFunction[1])}else canEnter=step.canenter($scope.context);return angular.isFunction(canEnter.then)?(defer=$q.defer(),canEnter.then((function(response){defer.resolve(response)})),defer.promise):!0===canEnter}function canExitStep(step,stepTo){var defer,canExit;if(void 0===step.canexit||$scope.getStepNumber(stepTo)<$scope.currentStepNumber())return!0;if("boolean"==typeof step.canexit)return step.canexit;if("string"==typeof step.canexit){var splitFunction=step.canexit.split("(");canExit=eval("$scope.$parent."+splitFunction[0]+"($scope.context"+splitFunction[1])}else canExit=step.canexit($scope.context);return angular.isFunction(canExit.then)?(defer=$q.defer(),canExit.then((function(response){defer.resolve(response)})),defer.promise):!0===canExit}function unselectAll(){angular.forEach($scope.getEnabledSteps(),(function(step){step.selected=!1})),$scope.selectedStep=null}$scope.context={},$scope.$watch("currentStep",(function(step){if(step){var stepTitle=$scope.selectedStep.wzTitle;$scope.selectedStep&&stepTitle!==$scope.currentStep&&$scope.goTo(stepByTitle($scope.currentStep))}})),$scope.$watch("[editMode, steps.length]",(function(){handleEditModeChange()}),!0),this.addStep=function(step){var wzOrder=step.wzOrder>=0&&!$scope.steps[step.wzOrder]?step.wzOrder:$scope.steps.length;$scope.steps[wzOrder]=step,$scope.getEnabledSteps()[0]===step&&$scope.goTo($scope.getEnabledSteps()[0])},this.removeStep=function(step){var index=$scope.steps.indexOf(step);index>0&&$scope.steps.splice(index,1)},this.context=$scope.context,$scope.getStepNumber=function(step){return stepIdx(step)+1},$scope.goTo=function(step){var thisStep;firstRun?(unselectAll(),$scope.selectedStep=step,angular.isUndefined($scope.currentStep)||($scope.currentStep=step.wzTitle),step.selected=!0,$scope.$emit("wizard:stepChanged",{step:step,index:stepIdx(step)}),firstRun=!1):($scope.currentStepNumber()>0?thisStep=$scope.currentStepNumber()-1:0===$scope.currentStepNumber()&&(thisStep=0),$q.all([canExitStep($scope.getEnabledSteps()[thisStep],step),canEnterStep(step)]).then((function(data){data[0]&&data[1]?(unselectAll(),$scope.selectedStep=step,angular.isUndefined($scope.currentStep)||($scope.currentStep=step.wzTitle),step.selected=!0,$scope.$emit("wizard:stepChanged",{step:step,index:stepIdx(step)})):$scope.$emit("wizard:stepChangeFailed",{step:step,index:stepIdx(step)})})))},$scope.currentStepNumber=function(){return stepIdx($scope.selectedStep)+1},$scope.getEnabledSteps=function(){return $scope.steps.filter((function(step){return step&&"true"!==step.disabled}))},$scope.getProgressPercentual=function(steps,zeroBased){return zeroBased?Math.ceil(($scope.currentStepNumber()-1)/steps*100)+"%":Math.ceil($scope.currentStepNumber()/steps*100)+"%"},this.currentStepTitle=function(){return $scope.selectedStep?$scope.selectedStep.wzTitle:""},this.currentStepDescription=function(){return $scope.selectedStep?$scope.selectedStep.description:""},this.currentStep=function(){return $scope.selectedStep},this.totalStepCount=function(){return $scope.getEnabledSteps().length},this.getEnabledSteps=function(){return $scope.getEnabledSteps()},this.currentStepNumber=function(){return $scope.currentStepNumber()},this.next=function(callback){var enabledSteps=$scope.getEnabledSteps(),index=stepIdx($scope.selectedStep);if(angular.isFunction(callback)){if(!callback())return;index===enabledSteps.length-1?this.finish():$scope.goTo(enabledSteps[index+1])}callback||($scope.selectedStep.completed=!0),index===enabledSteps.length-1?this.finish():$scope.goTo(enabledSteps[index+1])},this.goTo=function(step){$timeout((function(){var stepTo,enabledSteps=$scope.getEnabledSteps();stepTo=angular.isNumber(step)?enabledSteps[step]:stepByTitle(step),$scope.goTo(stepTo)}))},this.finish=function(){$scope.onFinish&&$scope.onFinish()},this.previous=function(){var index=stepIdx($scope.selectedStep);if(0===index)throw new Error("Can't go back. It's already in step 0");$scope.goTo($scope.getEnabledSteps()[index-1])},this.goToFirstStep=function(){$scope.goTo($scope.getEnabledSteps()[0])},this.cancel=function(){if($scope.onCancel)$scope.onCancel();else{if(0===stepIdx($scope.selectedStep))throw new Error("Can't go back. It's already in step 0");$scope.goTo($scope.getEnabledSteps()[0])}},this.reset=function(){angular.forEach($scope.getEnabledSteps(),(function(step){step.completed=!1})),firstRun=!0,this.goTo(0)},this.setEditMode=function(mode){$scope.editMode=mode,handleEditModeChange()},$scope.$emit("wizard:created")}]}})),wizardButtonDirective("wzNext"),wizardButtonDirective("wzPrevious"),wizardButtonDirective("wzFinish"),wizardButtonDirective("wzCancel"),wizardButtonDirective("wzReset"),angular.module("mgo-angular-wizard").factory("WizardHandler",(function(){var service={},wizards={};return service.defaultName="defaultWizard",service.addWizard=function(name,wizard){wizards[name]=wizard},service.removeWizard=function(name){delete wizards[name]},service.wizard=function(name){var nameToUse=name;return name||(nameToUse=service.defaultName),wizards[nameToUse]},service}));var duScrollDefaultEasing=function(x){"use strict";return x<.5?Math.pow(2*x,2)/2:1-Math.pow(2*(1-x),2)/2},duScroll=angular.module("duScroll",["duScroll.scrollspy","duScroll.smoothScroll","duScroll.scrollContainer","duScroll.spyContext","duScroll.scrollHelpers"]).value("duScrollDuration",350).value("duScrollSpyWait",100).value("duScrollSpyRefreshInterval",0).value("duScrollGreedy",!1).value("duScrollOffset",0).value("duScrollEasing",duScrollDefaultEasing).value("duScrollCancelOnEvents","scroll mousedown mousewheel touchmove keydown").value("duScrollBottomSpy",!1).value("duScrollActiveClass","active");"undefined"!=typeof module&&module&&module.exports&&(module.exports=duScroll),angular.module("duScroll.scrollHelpers",["duScroll.requestAnimation"]).run(["$window","$q","cancelAnimation","requestAnimation","duScrollEasing","duScrollDuration","duScrollOffset","duScrollCancelOnEvents",function($window,$q,cancelAnimation,requestAnimation,duScrollEasing,duScrollDuration,duScrollOffset,duScrollCancelOnEvents){"use strict";var scrollAnimation,deferred,proto={},isDocument=function(el){return"undefined"!=typeof HTMLDocument&&el instanceof HTMLDocument||el.nodeType&&el.nodeType===el.DOCUMENT_NODE},isElement=function(el){return"undefined"!=typeof HTMLElement&&el instanceof HTMLElement||el.nodeType&&el.nodeType===el.ELEMENT_NODE},unwrap=function(el){return isElement(el)||isDocument(el)?el:el[0]};proto.duScrollTo=function(left,top,duration,easing){var aliasFn;if(angular.isElement(left)?aliasFn=this.duScrollToElement:angular.isDefined(duration)&&(aliasFn=this.duScrollToAnimated),aliasFn)return aliasFn.apply(this,arguments);var el=unwrap(this);if(isDocument(el))return $window.scrollTo(left,top);el.scrollLeft=left,el.scrollTop=top},proto.duScrollToAnimated=function(left,top,duration,easing){duration&&!easing&&(easing=duScrollEasing);var startLeft=this.duScrollLeft(),startTop=this.duScrollTop(),deltaLeft=Math.round(left-startLeft),deltaTop=Math.round(top-startTop),startTime=null,progress=0,el=this,cancelScrollAnimation=function($event){(!$event||progress&&$event.which>0)&&(duScrollCancelOnEvents&&el.unbind(duScrollCancelOnEvents,cancelScrollAnimation),cancelAnimation(scrollAnimation),deferred.reject(),scrollAnimation=null)};if(scrollAnimation&&cancelScrollAnimation(),deferred=$q.defer(),0===duration||!deltaLeft&&!deltaTop)return 0===duration&&el.duScrollTo(left,top),deferred.resolve(),deferred.promise;var animationStep=function(timestamp){null===startTime&&(startTime=timestamp);var percent=(progress=timestamp-startTime)>=duration?1:easing(progress/duration);el.scrollTo(startLeft+Math.ceil(deltaLeft*percent),startTop+Math.ceil(deltaTop*percent)),percent<1?scrollAnimation=requestAnimation(animationStep):(duScrollCancelOnEvents&&el.unbind(duScrollCancelOnEvents,cancelScrollAnimation),scrollAnimation=null,deferred.resolve())};return el.duScrollTo(startLeft,startTop),duScrollCancelOnEvents&&el.bind(duScrollCancelOnEvents,cancelScrollAnimation),scrollAnimation=requestAnimation(animationStep),deferred.promise},proto.duScrollToElement=function(target,offset,duration,easing){var el=unwrap(this);angular.isNumber(offset)&&!isNaN(offset)||(offset=duScrollOffset);var top=this.duScrollTop()+unwrap(target).getBoundingClientRect().top-offset;return isElement(el)&&(top-=el.getBoundingClientRect().top),this.duScrollTo(0,top,duration,easing)},proto.duScrollLeft=function(value,duration,easing){if(angular.isNumber(value))return this.duScrollTo(value,this.duScrollTop(),duration,easing);var el=unwrap(this);return isDocument(el)?$window.scrollX||document.documentElement.scrollLeft||document.body.scrollLeft:el.scrollLeft},proto.duScrollTop=function(value,duration,easing){if(angular.isNumber(value))return this.duScrollTo(this.duScrollLeft(),value,duration,easing);var el=unwrap(this);return isDocument(el)?$window.scrollY||document.documentElement.scrollTop||document.body.scrollTop:el.scrollTop},proto.duScrollToElementAnimated=function(target,offset,duration,easing){return this.duScrollToElement(target,offset,duration||duScrollDuration,easing)},proto.duScrollTopAnimated=function(top,duration,easing){return this.duScrollTop(top,duration||duScrollDuration,easing)},proto.duScrollLeftAnimated=function(left,duration,easing){return this.duScrollLeft(left,duration||duScrollDuration,easing)},angular.forEach(proto,(function(fn,key){angular.element.prototype[key]=fn;var unprefixed=key.replace(/^duScroll/,"scroll");angular.isUndefined(angular.element.prototype[unprefixed])&&(angular.element.prototype[unprefixed]=fn)}))}]),angular.module("duScroll.polyfill",[]).factory("polyfill",["$window",function($window){"use strict";var vendors=["webkit","moz","o","ms"];return function(fnName,fallback){if($window[fnName])return $window[fnName];for(var key,suffix=fnName.substr(0,1).toUpperCase()+fnName.substr(1),i=0;i<vendors.length;i++)if($window[key=vendors[i]+suffix])return $window[key];return fallback}}]),angular.module("duScroll.requestAnimation",["duScroll.polyfill"]).factory("requestAnimation",["polyfill","$timeout",function(polyfill,$timeout){"use strict";var lastTime=0;return polyfill("requestAnimationFrame",(function(callback,element){var currTime=(new Date).getTime(),timeToCall=Math.max(0,16-(currTime-lastTime)),id=$timeout((function(){callback(currTime+timeToCall)}),timeToCall);return lastTime=currTime+timeToCall,id}))}]).factory("cancelAnimation",["polyfill","$timeout",function(polyfill,$timeout){"use strict";return polyfill("cancelAnimationFrame",(function(promise){$timeout.cancel(promise)}))}]),angular.module("duScroll.spyAPI",["duScroll.scrollContainerAPI"]).factory("spyAPI",["$rootScope","$timeout","$interval","$window","$document","scrollContainerAPI","duScrollGreedy","duScrollSpyWait","duScrollSpyRefreshInterval","duScrollBottomSpy","duScrollActiveClass",function($rootScope,$timeout,$interval,$window,$document,scrollContainerAPI,duScrollGreedy,duScrollSpyWait,duScrollSpyRefreshInterval,duScrollBottomSpy,duScrollActiveClass){"use strict";var contexts={},createContext=function($scope){var id=$scope.$id,context={spies:[]};return context.handler=function(context){var timer=!1,queued=!1,handler=function(){queued=!1;var bottomReached,containerEl=context.container[0],containerOffset=0;if("undefined"!=typeof HTMLElement&&containerEl instanceof HTMLElement||containerEl.nodeType&&containerEl.nodeType===containerEl.ELEMENT_NODE)containerOffset=containerEl.getBoundingClientRect().top,bottomReached=Math.round(containerEl.scrollTop+containerEl.clientHeight)>=containerEl.scrollHeight;else{var documentScrollHeight=$document[0].body.scrollHeight||$document[0].documentElement.scrollHeight;bottomReached=Math.round($window.pageYOffset+$window.innerHeight)>=documentScrollHeight}var i,currentlyActive,toBeActive,spies,spy,pos,compareProperty=duScrollBottomSpy&&bottomReached?"bottom":"top";for(spies=context.spies,currentlyActive=context.currentlyActive,toBeActive=void 0,i=0;i<spies.length;i++)(pos=(spy=spies[i]).getTargetPosition())&&spy.$element&&(duScrollBottomSpy&&bottomReached||pos.top+spy.offset-containerOffset<20&&(duScrollGreedy||-1*pos.top+containerOffset)<pos.height)&&(!toBeActive||toBeActive[compareProperty]<pos[compareProperty])&&((toBeActive={spy:spy})[compareProperty]=pos[compareProperty]);toBeActive&&(toBeActive=toBeActive.spy),currentlyActive===toBeActive||duScrollGreedy&&!toBeActive||(currentlyActive&&currentlyActive.$element&&(currentlyActive.$element.removeClass(duScrollActiveClass),$rootScope.$broadcast("duScrollspy:becameInactive",currentlyActive.$element,angular.element(currentlyActive.getTargetElement()))),toBeActive&&(toBeActive.$element.addClass(duScrollActiveClass),$rootScope.$broadcast("duScrollspy:becameActive",toBeActive.$element,angular.element(toBeActive.getTargetElement()))),context.currentlyActive=toBeActive)};return duScrollSpyWait?function(){timer?queued=!0:(handler(),timer=$timeout((function(){timer=!1,queued&&handler()}),duScrollSpyWait,!1))}:handler}(context),contexts[id]=context,$scope.$on("$destroy",(function(){destroyContext($scope)})),id},destroyContext=function($scope){var id=$scope.$id,context=contexts[id],container=context.container;context.intervalPromise&&$interval.cancel(context.intervalPromise),container&&container.off("scroll",context.handler),delete contexts[id]},defaultContextId=createContext($rootScope),getContextForScope=function(scope){return contexts[scope.$id]?contexts[scope.$id]:scope.$parent?getContextForScope(scope.$parent):contexts[defaultContextId]},getContextForSpy=function(spy){var context,contextId,scope=spy.$scope;if(scope)return getContextForScope(scope);for(contextId in contexts)if(-1!==(context=contexts[contextId]).spies.indexOf(spy))return context};return{addSpy:function(spy){var context=getContextForSpy(spy);context&&(context.spies.push(spy),context.container&&function(element){for(;element.parentNode;)if((element=element.parentNode)===document)return!0;return!1}(context.container)||(context.container&&context.container.off("scroll",context.handler),context.container=scrollContainerAPI.getContainer(spy.$scope),duScrollSpyRefreshInterval&&!context.intervalPromise&&(context.intervalPromise=$interval(context.handler,duScrollSpyRefreshInterval,0,!1)),context.container.on("scroll",context.handler).triggerHandler("scroll")))},removeSpy:function(spy){var context=getContextForSpy(spy);spy===context.currentlyActive&&($rootScope.$broadcast("duScrollspy:becameInactive",context.currentlyActive.$element),context.currentlyActive=null);var i=context.spies.indexOf(spy);-1!==i&&context.spies.splice(i,1),spy.$element=null},createContext:createContext,destroyContext:destroyContext,getContextForScope:getContextForScope}}]),angular.module("duScroll.scrollContainerAPI",[]).factory("scrollContainerAPI",["$document",function($document){"use strict";var containers={},getContainerId=function(scope){return containers[scope.$id]?scope.$id:scope.$parent?getContainerId(scope.$parent):void 0};return{getContainerId:getContainerId,getContainer:function(scope){var id=getContainerId(scope);return id?containers[id]:$document},setContainer:function(scope,element){var id=scope.$id;return containers[id]=element,id},removeContainer:function(scope){var id=getContainerId(scope);id&&delete containers[id]}}}]),angular.module("duScroll.smoothScroll",["duScroll.scrollHelpers","duScroll.scrollContainerAPI"]).directive("duSmoothScroll",["duScrollDuration","duScrollOffset","scrollContainerAPI",function(duScrollDuration,duScrollOffset,scrollContainerAPI){"use strict";return{link:function($scope,$element,$attr){$element.on("click",(function(e){if($attr.href&&-1!==$attr.href.indexOf("#")||""!==$attr.duSmoothScroll){var id=$attr.href?$attr.href.replace(/.*(?=#[^\s]+$)/,"").substring(1):$attr.duSmoothScroll,target=document.getElementById(id)||document.getElementsByName(id)[0];if(target&&target.getBoundingClientRect){e.stopPropagation&&e.stopPropagation(),e.preventDefault&&e.preventDefault();var offset=$attr.offset?parseInt($attr.offset,10):duScrollOffset,duration=$attr.duration?parseInt($attr.duration,10):duScrollDuration;scrollContainerAPI.getContainer($scope).duScrollToElement(angular.element(target),isNaN(offset)?0:offset,isNaN(duration)?0:duration)}}}))}}}]),angular.module("duScroll.spyContext",["duScroll.spyAPI"]).directive("duSpyContext",["spyAPI",function(spyAPI){"use strict";return{restrict:"A",scope:!0,compile:function(tElement,tAttrs,transclude){return{pre:function($scope,iElement,iAttrs,controller){spyAPI.createContext($scope)}}}}}]),angular.module("duScroll.scrollContainer",["duScroll.scrollContainerAPI"]).directive("duScrollContainer",["scrollContainerAPI",function(scrollContainerAPI){"use strict";return{restrict:"A",scope:!0,compile:function(tElement,tAttrs,transclude){return{pre:function($scope,iElement,iAttrs,controller){iAttrs.$observe("duScrollContainer",(function(element){angular.isString(element)&&(element=document.getElementById(element)),element=angular.isElement(element)?angular.element(element):iElement,scrollContainerAPI.setContainer($scope,element),$scope.$on("$destroy",(function(){scrollContainerAPI.removeContainer($scope)}))}))}}}}}]),angular.module("duScroll.scrollspy",["duScroll.spyAPI"]).directive("duScrollspy",["spyAPI","duScrollOffset","$timeout","$rootScope",function(spyAPI,duScrollOffset,$timeout,$rootScope){"use strict";var Spy=function(targetElementOrId,$scope,$element,offset){angular.isElement(targetElementOrId)?this.target=targetElementOrId:angular.isString(targetElementOrId)&&(this.targetId=targetElementOrId),this.$scope=$scope,this.$element=$element,this.offset=offset};return Spy.prototype.getTargetElement=function(){return!this.target&&this.targetId&&(this.target=document.getElementById(this.targetId)||document.getElementsByName(this.targetId)[0]),this.target},Spy.prototype.getTargetPosition=function(){var target=this.getTargetElement();if(target)return target.getBoundingClientRect()},Spy.prototype.flushTargetCache=function(){this.targetId&&(this.target=void 0)},{link:function($scope,$element,$attr){var targetId,href=$attr.ngHref||$attr.href;if(href&&-1!==href.indexOf("#")?targetId=href.replace(/.*(?=#[^\s]+$)/,"").substring(1):$attr.duScrollspy?targetId=$attr.duScrollspy:$attr.duSmoothScroll&&(targetId=$attr.duSmoothScroll),targetId){var timeoutPromise=$timeout((function(){var spy=new Spy(targetId,$scope,$element,-($attr.offset?parseInt($attr.offset,10):duScrollOffset));spyAPI.addSpy(spy),$scope.$on("$locationChangeSuccess",spy.flushTargetCache.bind(spy));var deregisterOnStateChange=$rootScope.$on("$stateChangeSuccess",spy.flushTargetCache.bind(spy));$scope.$on("$destroy",(function(){spyAPI.removeSpy(spy),deregisterOnStateChange()}))}),0,!1);$scope.$on("$destroy",(function(){$timeout.cancel(timeoutPromise)}))}}}}]);