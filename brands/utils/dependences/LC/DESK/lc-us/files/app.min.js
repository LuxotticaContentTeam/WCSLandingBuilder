/*! lux-b2c-lenscrafters - v0.0.1 - 2023-06-14 */var app=angular.module("LensCraftersApp",["ngSidebarJS","ngCookies","angularMoment","lcInsuranceModule","lcPrescriptionModule","lcActionsModule","angularMask","vcRecaptcha","ngMagnify","headerModule","selectize","frameAdvisorModule"]);app.config(["$httpProvider",function($httpProvider){$httpProvider.defaults.headers.get||($httpProvider.defaults.headers.get={}),$httpProvider.defaults.headers.get["If-Modified-Since"]="Mon, 26 Jul 1997 05:00:00 GMT",$httpProvider.defaults.headers.get["Cache-Control"]="no-cache",$httpProvider.defaults.headers.get.Pragma="no-cache"}]),app.config(["$provide",function($provide){$provide.decorator("$browser",["$delegate",function($delegate){return $delegate.onUrlChange=function(){},$delegate.url=function(){return""},$delegate}])}]);var tealium_data2track=tealium_data2track||[];app.controller("accountController",(function($scope,$rootScope,$window,$timeout,$q,$log,$http,lpModalService,lpRest,lcInsurance,lcPrescription,$compile){$scope.logoutFB=function(){FB.logout((function(response){}))},FB.Event.subscribe("auth.statusChange",(function(response){"connected"===response.status&&$scope.testAPI()})),$scope.testAPI=function(){console.log("Welcome!  Fetching your information.... "),FB.api("/me?fields=name,email",(function(response){alert("Successful login for: "+response.name),alert("Successful login for: "+response.email),console.log(response)}))}})),app.controller("pdpController",(function($scope,$rootScope,$window,$timeout,$q,$log,$http,lcActionsModule,lcInsurance,lcPrescription,$compile){$scope.showModalImage=!1,$scope.thisImage="",$scope.lcInsurance=lcInsurance,$scope.zoomImageVar=!1,$scope.closeModalImage=function(){$scope.showModalImage=!1,$scope.thisImage="",angular.element(".image-modal.slick-active img").removeClass("image-fullscreen-double"),angular.element(".image-modal.slick-active").removeClass("image-overflow"),$(".container-image-fullscreen").slick("slickSetOption","swipe",!0,!0),$scope.zoomImageVar=!1,angular.element("#header_wrapper").removeAttr("style"),angular.element(document).find("body").removeAttr("style"),$(".container-image-fullscreen").slick("unslick")},$scope.zoomImage=function(id){$scope.zoomImageVar?(angular.element(".image-modal.slick-active img").removeClass("image-fullscreen-double"),angular.element(".image-modal.slick-active").removeClass("image-overflow"),angular.element(".container-image-fullscreen").removeClass("container-image-fullscreen-db"),$scope.zoomImageVar=!1,$(".container-image-fullscreen").slick("slickSetOption","swipe",!0,!0)):($(".container-image-fullscreen").on("beforeChange",(function(event,slick,currentSlide,nextSlide){angular.element(".image-modal.slick-active img").removeClass("image-fullscreen-double"),angular.element(".image-modal.slick-active").removeClass("image-overflow"),angular.element(".container-image-fullscreen").removeClass("container-image-fullscreen-db"),$(".container-image-fullscreen").slick("slickSetOption","swipe",!0,!0),$scope.zoomImageVar=!1})),$(".container-image-fullscreen").slick("slickSetOption","swipe",!1,!1),angular.element(".image-modal.slick-active img").addClass("image-fullscreen-double"),angular.element(".image-modal.slick-active").addClass("image-overflow"),angular.element(".container-image-fullscreen").addClass("container-image-fullscreen-db"),$scope.zoomImageVar=!0)},$scope.openImageFullScreen=function(image,id,isMobile){if($scope.showModalImage=!0,$scope.thisImage=image,"true"===isMobile){$(".container-image-fullscreen").slick({dots:!0,infinite:!0,fade:!0,cssEase:"linear",initialSlide:id}),angular.element(document).find("body").css("overflow","hidden");var element=angular.element(".image-full-mobile");element.on("touchstart",touchstartHandler),element.on("touchmove",touchmoveHandler),element.on("touchend",touchendHandler)}else angular.element("#header_wrapper").css("z-index","9"),$(".container-image-fullscreen").slick({dots:!0,infinite:!0,fade:!0,cssEase:"linear",initialSlide:id});angular.element(".container-image-fullscreen .slick-dots .slick-active").click()};var mode="",distance=0,initialDistance=0,scale=1,initialScale=1;function touchstartHandler(evt){evt.originalEvent?evt.originalEvent.touches:evt.touches}function touchmoveHandler(evt){var touches=evt.originalEvent?evt.originalEvent.touches:evt.touches;""===mode&&2===touches.length&&(mode="pinch",initialScale=scale,initialDistance=getDistance(touches)),"pinch"===mode&&(evt.preventDefault(),distance=getDistance(touches),scale=distance/initialDistance*initialScale)}function touchendHandler(evt){var touches=evt.originalEvent?evt.originalEvent.touches:evt.touches;""===mode||touches.length>0||(scale<1?$scope.zoomImageVar&&(angular.element(".image-modal.slick-active img").removeClass("image-fullscreen-double"),angular.element(".image-modal.slick-active").removeClass("image-overflow"),angular.element(".container-image-fullscreen").removeClass("container-image-fullscreen-db"),$scope.zoomImageVar=!1,$(".container-image-fullscreen").slick("slickSetOption","swipe",!0,!0)):scale>1&&($scope.zoomImageVar||($(".container-image-fullscreen").on("beforeChange",(function(event,slick,currentSlide,nextSlide){angular.element(".image-modal.slick-active img").removeClass("image-fullscreen-double"),angular.element(".image-modal.slick-active").removeClass("image-overflow"),angular.element(".container-image-fullscreen").removeClass("container-image-fullscreen-db"),$(".container-image-fullscreen").slick("slickSetOption","swipe",!0,!0),$scope.zoomImageVar=!1})),$(".container-image-fullscreen").slick("slickSetOption","swipe",!1,!1),angular.element(".image-modal.slick-active img").addClass("image-fullscreen-double"),angular.element(".image-modal.slick-active").addClass("image-overflow"),angular.element(".container-image-fullscreen").addClass("container-image-fullscreen-db"),$scope.zoomImageVar=!0)),mode="")}function getDistance(touches){var d=Math.sqrt(Math.pow(touches[0].clientX-touches[1].clientX,2)+Math.pow(touches[0].clientY-touches[1].clientY,2));return parseInt(d,10)}$rootScope.rxc=null,$scope.isLoadingLens=!1,$scope.isLoadingInsurance=lcInsurance.isLoading(),$scope.isCalculatingPrices=!1,$scope.hasLenses=!1,$scope.lensData={},$scope.selectedPerkCode=null,$scope.selectedLens=null,$scope.prices={framePrice:0,frameSaving:0,lensPrice:0,lensSaving:0,totalSaving:0,insuranceSaving:0,perkSaving:0,warrantyPrice:0,total:0,full:0},$scope.frameRXValues=null,$scope.BFPercentage=null,$scope.BFClass=null,$scope.init=function(_params){$scope.params=_params,lcPrescription&&$scope.params.isPrescriptionEnabled&&(lcPrescription.init($scope.params.storeId,$scope.params.catalogId),$scope.frameRXValues=lcPrescription.getFrameRXValues(_params.frameMinTotalPower,_params.frameMaxTotalPower)),lcActionsModule.selectedPerkCode=$scope.selectedPerkCode=getSelectedPerkCode(),$scope.isLoadingLens=!0,$timeout((function(){$rootScope.rxc={},$http.get("/wcs/resources/store/"+$scope.params.storeId+"/catalog/"+$scope.params.catalogId+"/rxc/frameId/"+$scope.params.frameId+"/lenses").then((function(response){if(response&&response.data&&response.data.response&&"ok"==response.data.response.status){angular.merge($scope.lensData,response.data.response.data);var planoPackage=null;if($scope.lensData&&$scope.lensData.packages&&$scope.lensData.packages.length>0){planoPackage=$scope.lensData.packages.filter((function(currentPackage){if(currentPackage.lensPackage.upc==$scope.params.frameOnlyLensUPC)return currentPackage}));var listGVPPairs=$scope.lensData.packages.filter((function(currentPackage){return"GVP"==currentPackage.frame.promoType}));$scope.params.isGVPFrameAndLens=listGVPPairs.length>0,$scope.params.isFrameAndLensDetailGVP=$scope.lensData.packages.filter((function(currentPackage){return"GVP"==currentPackage.frame.promoTypeDetail})).length>0,$scope.params.isFrameAndLensDetailAEO=$scope.lensData.packages.filter((function(currentPackage){return"AEO"==currentPackage.frame.promoTypeDetail})).length>0,$scope.params.isFrameAndLensDetailBOM=$scope.lensData.packages.filter((function(currentPackage){return"BOM"==currentPackage.frame.promoTypeDetail})).length>0,$rootScope.isGVPFrameAndLens=$scope.params.isGVPFrameAndLens,$scope.params.isStellaProduct&&($scope.lensData.warrantyOptions=null),planoPackage&&1==planoPackage.length?(planoPackage=planoPackage[0],$rootScope.rxc.selectedFrame=planoPackage.frame,$rootScope.rxc.selectedLens=planoPackage.lensPackage,lensSelected=!0,includeLens=!0,frameCatentryId=$scope.params.frameId,currentOrderId=$scope.params.currentOrderId?$scope.params.currentOrderId:"",$scope.hasLenses=$scope.lensData.packages.length-1>0):$scope.hasLenses=!0,$("head").append(document.getElementById("rxcCssUrl").value)}else $scope.hasLenses=!1}else $scope.hasLenses=!1}),(function(error){$log.error(error),tealium_data2track.push({id:"Error",Error_Code:"RXC service error",Error_Source:"Client"}),$scope.hasLenses=!1})).finally((function(){$scope.isLoadingLens=!1,$scope.genericCalculatePrices().then((function(response){$scope.isGVPFrame&&$scope.genericCalculateGvpPrice()}))}))})),initCarousel()};var getSelectedPerkCode=function(){for(var queryParams=$window.location.search.substring(1).split("&"),i=0;i<queryParams.length;i++)if(queryParam=queryParams[i].split("="),"selectedPerkCode"==queryParam[0])return queryParam[1];return null};$scope.resetPrices=function(){$scope.prices={framePrice:0,frameSaving:0,lensPrice:0,lensSaving:0,totalSaving:0,insuranceSaving:0,perkSaving:0,warrantyPrice:0,total:0}},$scope.isGVPFrame=function(){return!!($scope.lensData.frame&&$scope.lensData.frame.promotions&&$scope.lensData.frame.promotions.completePairAvailable)},$scope.isGVPLens=function(){return!!($scope.selectedLens&&$scope.selectedLens.promotions&&$scope.selectedLens.promotions.completePairAvailable)},$scope.isBFEnabled=function(){return bfEnabled($scope.params.framePartNumber)},$scope.getBFClass=function(){return $scope.BFClass},$rootScope.genericCalculatePrices=function(){var _defer=$q.defer(),_isResolved=!1,_rejectError=null;if($scope.isCalculatingPrices)return _defer.reject(),_defer.promise;if(!$scope.params.frameOfferPrice)return _defer.reject(),_defer.promise;var updateWarrantyTotals=function(_startingPrice,_finalPrice){$rootScope.rxc.selectedWarranty&&($scope.prices.warrantyPrice=parseFloat($rootScope.rxc.selectedWarranty.price),_finalPrice+=$scope.prices.warrantyPrice),$scope.prices.totalSaving=_startingPrice-_finalPrice,$scope.prices.total=_finalPrice,$scope.prices.full=parseFloat($scope.prices.total)+parseFloat($scope.prices.totalSaving);var affirmProductElem=document.getElementById("affirm-product");affirmProductElem&&"function"==typeof affirm.ui.refresh&&(affirmProductElem.setAttribute("data-amount",100*_finalPrice),affirm.ui.refresh()),$scope.isCalculatingPrices=!1};$scope.isCalculatingPrices=!0,$scope.resetPrices();try{$scope.prices.framePrice=parseFloat($scope.params.frameOfferPrice);var _startingPrice=$scope.prices.framePrice,_finalPrice=$scope.prices.framePrice;if(lcInsurance.isEnabled()){var data={storeId:$scope.params.storeId,catalogId:$scope.params.catalogId,langId:$scope.params.langId,pricingEntries:[]};!$rootScope.rxc.selectedFrame||$rootScope.rxc.selectedFrame&&null==$rootScope.rxc.selectedFrame.insPrice?(data.pricingEntries[0]={},data.pricingEntries[0].frame={price:$scope.params.frameOfferPrice,upc:$scope.params.framePartNumber,quantity:"1",type:"f"}):$rootScope.rxc.selectedFrame&&null!==$rootScope.rxc.selectedFrame.insPrice&&($scope.prices.framePrice=parseFloat($rootScope.rxc.selectedFrame.insPrice),$scope.prices.frameSaving=Math.max(0,parseFloat($scope.params.frameOfferPrice)-$scope.prices.framePrice),$scope.prices.insuranceSaving+=$scope.prices.frameSaving),$rootScope.rxc.selectedLens&&(_startingPrice+=parseFloat($rootScope.rxc.selectedLens.listPrice),!1!==$rootScope.rxc.selectedLens.insurable&&null==$rootScope.rxc.selectedLens.insPrice&&$rootScope.rxc.selectedLens.upc!==$scope.params.frameOnlyLensUPC?data.pricingEntries[0].lens={price:$rootScope.rxc.selectedLens.listPrice,upc:$rootScope.rxc.selectedLens.upc,quantity:"1",type:"l"}:!1!==$rootScope.rxc.selectedLens.insurable&&null!==$rootScope.rxc.selectedLens.insPrice&&($scope.prices.lensPrice=parseFloat($rootScope.rxc.selectedLens.insPrice),$scope.prices.lensSaving=Math.max(0,parseFloat($rootScope.rxc.selectedLens.listPrice)-$scope.prices.lensPrice),$scope.prices.insuranceSaving+=$scope.prices.lensSaving)),data.pricingEntries.length>0?lcInsurance.getDiscounts(data).then((function(response){response[0].frame&&null!==response[0].frameDiscount&&void 0!==response[0].frameDiscount&&($scope.prices.framePrice=Math.max(0,parseFloat($scope.params.frameOfferPrice)-response[0].frameDiscount),$scope.prices.frameSaving=response[0].frameDiscount,$scope.prices.insuranceSaving+=response[0].frameDiscount),response[0].lens&&null!==response[0].lensDiscount&&void 0!==response[0].lensDiscount&&($scope.prices.lensPrice=Math.max(0,parseFloat($rootScope.rxc.selectedLens.listPrice)-response[0].lensDiscount),$scope.prices.lensSaving=response[0].lensDiscount,$scope.prices.insuranceSaving+=response[0].lensDiscount),_isResolved=!0}),(function(error){tealium_data2track.push({id:"Error",Error_Code:"Error getting insurance discount",Error_Source:"Client"}),_isResolved=!1,_rejectError=error})).finally((function(){_finalPrice=$scope.prices.framePrice+$scope.prices.lensPrice,updateWarrantyTotals(_startingPrice,_finalPrice),_isResolved?_defer.resolve():_defer.reject(_rejectError)})):(_finalPrice=$scope.prices.framePrice+$scope.prices.lensPrice,updateWarrantyTotals(_startingPrice,_finalPrice),_defer.resolve())}else bfEnabled($scope.params.framePartNumber)&&bf.inclusion&&null!=bf.inclusion&&bf.inclusion[$scope.params.framePartNumber]&&($scope.BFPercentage=100*bf.inclusion[$scope.params.framePartNumber]+"% Off",$scope.BFClass="badge_"+100*bf.inclusion[$scope.params.framePartNumber]+" badge-bf"),$rootScope.rxc.selectedFrame&&($scope.prices.framePrice=parseFloat($rootScope.rxc.selectedFrame.offerPrice),$scope.prices.frameSaving=Math.max(0,parseFloat($scope.params.frameOfferPrice)-$scope.prices.framePrice),_finalPrice=$scope.prices.framePrice),$rootScope.rxc.selectedLens&&(_startingPrice+=parseFloat($rootScope.rxc.selectedLens.listPrice),$scope.prices.lensPrice=parseFloat($rootScope.rxc.selectedLens.offerPrice),$scope.prices.lensSaving=Math.max(0,parseFloat($rootScope.rxc.selectedLens.listPrice)-$scope.prices.lensPrice),_finalPrice+=$scope.prices.lensPrice),updateWarrantyTotals(_startingPrice,_finalPrice),_defer.resolve()}catch(error){$scope.isCalculatingPrices=!1;tealium_data2track.push({id:"Error",Error_Code:"Error during calculate price",Error_Source:"Client"}),$log.error(error),_defer.reject(error)}return _defer.promise},$scope.getLensAttributeContent=function(_attrName,_attrValue){var _content=null;if($scope.lensData&&$scope.lensData.content&&_attrName&&_attrValue)try{_content=$scope.lensData.content[_attrName][_attrValue]}catch(e){console.warn("Unable to get content for attribute "+_attrName+" and value "+_attrValue)}return _content},$scope.genericCalculateGvpPrice=function(){$scope.lensData&&$scope.lensData.packages?$scope.prices.gvpBasePrice=function(node){var minPrice;const nodeGVP=node.filter((function(pack){return"GVP"===pack.frame.promoType}));if(nodeGVP.length){minPrice=parseFloat(nodeGVP[0].lensPackage.offerPrice)+parseFloat(nodeGVP[0].frame.offerPrice);for(var i=1;i<nodeGVP.length;i++)parseFloat(nodeGVP[i].lensPackage.offerPrice)+parseFloat(nodeGVP[i].frame.offerPrice)<minPrice&&(minPrice=parseFloat(nodeGVP[i].lensPackage.offerPrice)+parseFloat(nodeGVP[i].frame.offerPrice))}else minPrice=$scope.prices.total;return minPrice}($scope.lensData.packages,$scope.prices.total):$scope.prices.gvpBasePrice=$scope.prices.total};$scope.toggleInsurance=function(){!function(){try{tealium_data2track.push({id:"Click",Click_FocusElement:document.getElementById("insurance-switch"),Tracking_Type:"link",data_element_id:"X_Pdp_Prod_UseInsurance",data_description:"X_Pdp_Prod_UseInsurance"})}catch(err){$log.error(err)}}(),lcInsurance.toggleInsurance()},$scope.$on(lcInsurance.getEvents().INSURANCE_ENABLED,(function(){try{tealium_data2track.push({id:"Click",Click_FocusElement:document.getElementById("insurance-switch"),Tracking_Type:"link",data_element_id:"X_Pdp_Prod_UseInsurance",data_description:"X_Pdp_Prod_UseInsurance"})}catch(err){$log.error(err)}null===$scope.selectedPerkCode||""===$scope.selectedPerkCode?$timeout((function(){$rootScope.rxc.rxcWidget||$scope.genericCalculatePrices().then((function(response){$scope.isGVPFrame&&$scope.genericCalculateGvpPrice()}))})):$window.location.href=$window.location.origin+$window.location.pathName})),$scope.$on(lcInsurance.getEvents().INSURANCE_DISABLED,(function(){$window.location.reload()})),$scope.genericEditLens=function(){var paymentInstallmentTypes=[],multiplePaymentInstallmentValue=!1,singleTypeOnly="",espotContentIdentifier="X_PDP_Installments_All";$scope.params.isAffirmEnabled&&$scope.params.isAfterpayEnabled&&$scope.params.isKlarnaEnabled&&(paymentInstallmentTypes=["klarna","affirm","afterpay"],multiplePaymentInstallmentValue=!0,espotContentIdentifier="X_PDP_Installments_All"),$scope.params.isAfterpayEnabled||$scope.params.isKlarnaEnabled||!$scope.params.isAffirmEnabled||(paymentInstallmentTypes=["affirm"],multiplePaymentInstallmentValue=!1,singleTypeOnly="affirm"),$scope.params.isAffirmEnabled||$scope.params.isKlarnaEnabled||!$scope.params.isAfterpayEnabled||(paymentInstallmentTypes=["afterpay"],multiplePaymentInstallmentValue=!1,singleTypeOnly="afterpay"),$scope.params.isAffirmEnabled||$scope.params.isAfterpayEnabled||!$scope.params.isKlarnaEnabled||(paymentInstallmentTypes=["klarna"],multiplePaymentInstallmentValue=!1,singleTypeOnly="klarna"),$scope.params.isAffirmEnabled&&!$scope.params.isAfterpayEnabled&&$scope.params.isKlarnaEnabled&&(paymentInstallmentTypes=["klarna","affirm"],multiplePaymentInstallmentValue=!0,espotContentIdentifier="X_PDP_Installments_Affirm_Klarna"),$scope.params.isAffirmEnabled&&$scope.params.isAfterpayEnabled&&!$scope.params.isKlarnaEnabled&&(paymentInstallmentTypes=["affirm","afterpay"],multiplePaymentInstallmentValue=!0,espotContentIdentifier="X_PDP_Installments_Affirm_Afterpay"),!$scope.params.isAffirmEnabled&&$scope.params.isAfterpayEnabled&&$scope.params.isKlarnaEnabled&&(paymentInstallmentTypes=["klarna","afterpay"],multiplePaymentInstallmentValue=!0,espotContentIdentifier="X_PDP_Installments_Afterpay_Klarna");var config={selector:"#rxcApp",currencyFormat:{thousandSeparator:",",decimalSeparator:".",prefix:"$"},insuranceModule:$scope.params.isRiaEnabled?lcInsurance:null,prescriptionModule:$scope.params.isPrescriptionEnabled?lcPrescription:null,actionsModule:lcActionsModule,lensesData:$scope.params.lensData,data:{langId:$scope.params.langId,frame:{catEntryId:$scope.params.frameId,name:$scope.params.frameName,upc:$scope.params.framePartNumber,model:$scope.params.frameModel,color:$scope.params.frameColor,listPrice:$scope.params.frameOfferPrice,brand:$scope.params.frameBrand,category:$scope.params.frameCategory,imageUrl:$scope.params.frameImage.replace("_001","_002").replace("imwidth=200","imwidth=680"),brandImageUrl:"https://assets.lenscrafters.com/extra/image/LensCrafters/brands/LC_"+$scope.params.frameBrand.replace(/ /g,"_")+"_Logo.png",rxValues:$scope.frameRXValues},frameOnlyLensUPC:$scope.params.frameOnlyLensUPC,showFrameOnly:"SUNGLASSES"!==$scope.params.frameCategory.toUpperCase()},learnMoreBaseEndpoint:"/wcs/resources/store/"+$scope.params.storeId+"/espot/",linksData:{warrantyLearnMore:"10851"===$scope.params.storeId?"/lc-us/our-guarantee?section=protectionPlan":"/en-ca/our-guarantee?section=protectionPlan"},layoutSettings:{enableDigitalOptometry:"true"==$scope.params.isOpthyEnabled,enableLargeIcons:"true"==$scope.params.isLargeIconsEnabled,enableGrayout:$scope.params.isGrayOut,enableBrandLastStep:"true"==$scope.params.enableBrandLastStep},paymentInstallment:{type:singleTypeOnly,installments:4,multiplePaymentInstallment:multiplePaymentInstallmentValue,types:paymentInstallmentTypes,contentIdentifier:espotContentIdentifier}};$rootScope.rxc.selectedLens&&(config.data.lens={catEntryId:$rootScope.rxc.selectedLens.catEntryId}),$rootScope.rxc.selectedWarranty&&!$scope.params.isStellaProduct&&(config.data.warranty={catEntryId:$rootScope.rxc.selectedWarranty.id});var chatButtonElem=document.getElementsByClassName("cx-side-button-group");chatButtonElem&&chatButtonElem.length&&!/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)&&(chatButtonElem=chatButtonElem[0]).style.setProperty("right","50%","important"),$rootScope.oldHistoryLength=window.history.length,$rootScope.rxc.rxcWidget=RXC.rxcWidget.new(config),$rootScope.rxc.rxcWidget.render()},$scope.genericRemoveLens=function(){$rootScope.rxc.selectedLens=null,$rootScope.rxc.selectedWarranty=null,$scope.genericCalculatePrices()};var initCarouselElement=function(entry,imgCount){var imageUrl="https://assets.lenscrafters.com/is/image/LensCrafters/"+$scope.params.framePartNumber+"_FILE_KEY.png";imageUrl=imageUrl.replace("FILE_KEY",entry),divPDPElement=document.createElement("div"),divPDPElement.setAttribute("class","image");var color=document.querySelector(".frame-color.description").innerHTML;imgPDPElement=angular.element('<img itemprop="image" ng-click="openImageFullScreen(\''+imageUrl+"','"+imgCount+"','"+/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)+'\')" tabindex="0" class="PDPproductImage hidden" escapexml="false" title="'+$scope.params.gender+" "+$scope.params.glasses+" - "+$scope.params.frameBrand+" "+$scope.params.frameName+'" src="'+imageUrl+'" alt="'+$scope.params.frameBrand+" "+$scope.params.frameName+" "+color+" "+$scope.params.glasses+" "+(1*imgCount+1)+'"></img>'),/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)?(imgFullScreenContainer=angular.element('<div class="image image-modal"><img class="image-full-mobile" on-double-click="zoomImage(\''+imgCount+'\')" ng-src="'+imageUrl+'"></img></div>'),angular.element(document.getElementsByClassName("container-image-fullscreen")).append(imgFullScreenContainer)):(imgFullScreenContainer=document.createElement("div"),imgFullScreenContainer.setAttribute("class","image"),divFullScreenElement=angular.element('<div class="image"><div data-ng-magnify data-glass-width="300" data-glass-height="300" data-image-src="'+imageUrl+'"></div></div>'),angular.element(imgFullScreenContainer).append(divFullScreenElement),document.getElementsByClassName("container-image-fullscreen")[0].appendChild(imgFullScreenContainer)),angular.element(divPDPElement).append(imgPDPElement),document.getElementsByClassName("pdp-image-items")[0].appendChild(divPDPElement),$compile(divPDPElement)($scope),$compile(imgFullScreenContainer)($scope)},initCarousel=function(){null==window.orderImagePDP&&(window.orderImagePDP=[["_STD__shad__fr","shad_fr"],["_STD__shad__qt","shad_qt"],["_STD__shad__lt","_090A"],["_STD__shad__cfr","_180A"],["_STD__shad__bk"],["_STD__shad__al2"],["_STD__shad__alN"],["_STD__shad__fld"]]);var url,callback,xhr,availableImages=[],imgCount=0;url="https://assets.lenscrafters.com/is/image/LensCrafters/"+$scope.params.framePartNumber+"_manifest_2.json",callback=function(err,data){null!==err?console.error("Unable to load manifest_2.json"):data&&data.items?(data.items.forEach((function(entry){availableImages.push(entry.file_key)})),window.orderImagePDP.forEach((function(entry){availableImages.indexOf(entry[0])>-1?(initCarouselElement(entry[0],imgCount),imgCount+=1):entry.length>1&&availableImages.indexOf(entry[1])>-1&&(initCarouselElement(entry[1],imgCount),imgCount+=1)})),$(".pdp-image-items").slick({dots:!0,infinite:!0,fade:!0,cssEase:"linear",lazyLoad:"ondemand",variableWidth:!0}),$(".PDPproductImage").removeClass("hidden")):console.error("Unable to load data for manifest_2.json")},(xhr=new XMLHttpRequest).open("GET",url,!0),xhr.responseType="json",xhr.onload=function(){var status=xhr.status;callback(200===status?null:status,xhr.response)},xhr.send()}})),app.controller("HomePageController",["$scope","$window","headerModule","$http","$timeout",function($scope,$window,headerModule,$http,$timeout){var CONTACT_BRAND_FACET="ads_f42001_ntk_cs";$scope.contactsProducts={},$scope.currentContactsBrand="",$scope.cartItemsNum=0,$scope.serviceCardTexts=null,$scope.serviceCardImages=null,$scope.serviceCardHref=null,$scope.serviceCardCTA=null,$scope.selectedMenu=0,$scope.mobileMenuStatus=0,$scope.selectedCard=0,$scope.userType="G",$window.serviceCardTexts&&($scope.serviceCardTexts=$window.serviceCardTexts),$window.serviceCardImages&&($scope.serviceCardImages=$window.serviceCardImages),$window.serviceCardHref&&($scope.serviceCardHref=$window.serviceCardHref),$window.serviceCardCTA&&($scope.serviceCardCTA=$window.serviceCardCTA),$scope.init=function(_params){$scope.params=_params,$scope.selectedCategory="eyeglasses",$scope.selectedFilter=1,$scope.searchOpen=!1,headerModule.getCartItems().then((function(response){$scope.cartItemsNum=response})),headerModule.getWishListItems().then((function(response){$rootScope.wishlistCount=response.count,$rootScope.wishlistItems=response.catentryIds})),headerModule.getUserType().then((function(response){$scope.userType=response}))},$scope.stopScrolling=function(){$("body").addClass("stop-scrolling")},$scope.enableScrolling=function(){$("body").removeClass("stop-scrolling")},$scope.retreiveContacts=function(brand){-1!=location.hostname.indexOf("developer")&&(CONTACT_BRAND_FACET="ads_f26001_ntk_cs"),null==$scope.contactsProducts[brand]?$http.get("/wcs/resources/store/10851/productview/bySearchTerm/*?facet=#FACET#%3A%22#BRAND#%22&pageSize=7&pageNumber=1".replace("#BRAND#",brand).replace("#FACET#",CONTACT_BRAND_FACET)).then((function(response){response&&response.data.CatalogEntryView&&($scope.contactsProducts[brand]=[],response.data.CatalogEntryView.forEach((function(entry){$scope.contactsProducts[brand].push({name:entry.name,upc:entry.partNumber})})),$scope.currentContactsBrand=brand)}),(function(error){$log.error(error),tealium_data2track.push({id:"Error",Error_Code:"DDM Contacts error",Error_Source:"Client"}),$scope.hasLenses=!1})):$scope.currentContactsBrand=brand},$scope.showIt=function(index){$timeout((function(){$scope.selectedCard=index}),500)},$scope.leaveIt=function(){$timeout((function(){$scope.selectedCard=0}),500)}}]),app.controller("cartItemController",(function($scope,$rootScope,$http,$timeout,$log,lcActionsModule,lcInsurance,lcPrescription){$rootScope.rxc={},$scope.frameRXValues=null,$scope.init=function(_params){$scope.params=_params,lcPrescription&&$scope.params.isPrescriptionEnabled&&($scope.frameRXValues=lcPrescription.getFrameRXValues(_params.frameMinTotalPower,_params.frameMaxTotalPower)),$scope.callerId=lcActionsModule.CALLERID_CART+"_"+_params.orderItemId},$scope.deleteLoaderVisible=!1,$scope.editLens=function(){if(!$scope.params.lensId){return tealium_data2track.push({id:"Error",Error_Code:"Undefined Lens Id",Error_Source:"Client"}),void $log.error("Undefined Lens Id")}var paymentInstallmentTypes=[],multiplePaymentInstallmentValue=!1,singleTypeOnly="",espotContentIdentifier="X_PDP_Installments_All";$scope.params.isAffirmEnabled&&$scope.params.isAfterpayEnabled&&$scope.params.isKlarnaEnabled&&(paymentInstallmentTypes=["klarna","affirm","afterpay"],multiplePaymentInstallmentValue=!0,espotContentIdentifier="X_PDP_Installments_All"),$scope.params.isAfterpayEnabled||$scope.params.isKlarnaEnabled||!$scope.params.isAffirmEnabled||(paymentInstallmentTypes=["affirm"],multiplePaymentInstallmentValue=!1,singleTypeOnly="affirm"),$scope.params.isAffirmEnabled||$scope.params.isKlarnaEnabled||!$scope.params.isAfterpayEnabled||(paymentInstallmentTypes=["afterpay"],multiplePaymentInstallmentValue=!1,singleTypeOnly="afterpay"),$scope.params.isAffirmEnabled||$scope.params.isAfterpayEnabled||!$scope.params.isKlarnaEnabled||(paymentInstallmentTypes=["klarna"],multiplePaymentInstallmentValue=!1,singleTypeOnly="klarna"),$scope.params.isAffirmEnabled&&!$scope.params.isAfterpayEnabled&&$scope.params.isKlarnaEnabled&&(paymentInstallmentTypes=["klarna","affirm"],multiplePaymentInstallmentValue=!0,espotContentIdentifier="X_PDP_Installments_Affirm_Klarna"),$scope.params.isAffirmEnabled&&$scope.params.isAfterpayEnabled&&!$scope.params.isKlarnaEnabled&&(paymentInstallmentTypes=["affirm","afterpay"],multiplePaymentInstallmentValue=!0,espotContentIdentifier="X_PDP_Installments_Affirm_Afterpay"),!$scope.params.isAffirmEnabled&&$scope.params.isAfterpayEnabled&&$scope.params.isKlarnaEnabled&&(paymentInstallmentTypes=["klarna","afterpay"],multiplePaymentInstallmentValue=!0,espotContentIdentifier="X_PDP_Installments_Afterpay_Klarna");var _config={selector:"#rxcApp",currencyFormat:{thousandSeparator:",",decimalSeparator:".",prefix:"$"},insuranceModule:$scope.params.isRiaEnabled?lcInsurance:null,prescriptionModule:$scope.params.isPrescriptionEnabled?lcPrescription:null,actionsModule:lcActionsModule,lensesData:$scope.params.lensData,data:{langId:$scope.params.langId,frame:{catEntryId:$scope.params.frameId,name:$scope.params.frameName,upc:$scope.params.framePartNumber,model:$scope.params.frameModel,color:$scope.params.frameColor,listPrice:$scope.params.frameOfferPrice,brand:$scope.params.frameBrand,category:$scope.params.frameCategory,imageUrl:$scope.params.frameImage.replace("shad_fr","shad_qt").replace("imwidth=200","imwidth=680"),brandImageUrl:"https://assets.lenscrafters.com/extra/image/LensCrafters/brands/LC_"+$scope.params.frameBrand.replace(/ /g,"_")+"_Logo.png",rxValues:$scope.frameRXValues},frameOnlyLensUPC:$scope.params.frameOnlyLensUPC,showFrameOnly:"SUNGLASSES"!==$scope.params.frameCategory.toUpperCase(),lens:{catEntryId:$scope.params.lensId}},learnMoreBaseEndpoint:"/wcs/resources/store/"+$scope.params.storeId+"/espot/",linksData:{warrantyLearnMore:"10851"===$scope.params.storeId?"/lc-us/purchase-care/details":"/en-ca/purchase-care/details"},paymentInstallment:{type:singleTypeOnly,installments:4,multiplePaymentInstallment:multiplePaymentInstallmentValue,types:paymentInstallmentTypes,contentIdentifier:espotContentIdentifier}};"checked"==angular.element(document.getElementById("warranty_"+$scope.params.orderItemId)).attr("checked")&&(_config.data.warranty={catEntryId:angular.element(document.getElementById("warranty_"+$scope.params.orderItemId)).val()}),$http.get("/wcs/resources/store/"+$scope.params.storeId+"/catalog/"+$scope.params.catalogId+"/rxc/frameId/"+$scope.params.frameId+"/lenses").then((function(response){response&&response.data&&response.data.response&&"ok"==response.data.response.status?(_config.lensesData=response.data.response.data,_config.cartMode={orderItemId:$scope.params.orderItemId,orderIndex:$scope.params.orderIndex},$scope.params.isStellaProduct&&(_config.lensesData.warrantyOptions=null),$scope.genericEditLens(_config)):$scope.hasLenses=!1,$("head").append(document.getElementById("rxcCssUrl").value)}),(function(error){$log.error(error),tealium_data2track.push({id:"Error",Error_Code:"Error while calling RXC lens service",Error_Source:"Client"}),$scope.hasLenses=!1})).finally((function(){$scope.isLoadingLens=!1}))},$scope.$on("lenspanel:closed",(function(event,callerId,action,lens){if($scope.callerId==callerId){showHiddenElement(),document.getElementById("header_wrapper").style.zIndex="";var _el=document.getElementById("skipToMainContent");if(_el&&(_el.style.display=""),action&&action!=lcActionsModule.CLOSE_ACTION_CANCEL){if(!lens){return tealium_data2track.push({id:"Error",Error_Code:"Missing lens data",Error_Source:"Client"}),void $log.error("Missing lens data")}lensCatentryId=lens.catEntryId,addOns="",$scope.lensInfo.catentryId=lens.catEntryId,$scope.lensInfo.skuId=lens.partNumber,$timeout((function(){cartPageEditPrescription($scope.params.orderItemId,$scope.params.orderIndex)}))}}}));var showHiddenElement=function(){angular.element(document.getElementById("footer_wrapper")).removeClass("hidden"),angular.element(document.getElementById("header_wrapper")).removeClass("hidden"),angular.element(document.getElementById("pdp-wrapper")).removeClass("hidden"),angular.element(document.getElementById("site-breadcrumb")).removeClass("hidden"),angular.element(document.getElementById("footer_wrapper")).removeClass("hidden"),angular.element(document.getElementById("header_wrapper")).removeClass("hidden"),angular.element(document.getElementById("pdp-wrapper")).removeClass("hidden"),angular.element(document.getElementById("site-breadcrumb")).removeClass("hidden"),angular.element(document.getElementById("main-navigation")).removeClass("hidden"),angular.element(document.getElementById("main-content-comp")).removeClass("hidden"),angular.element(document.getElementById("cart-section")).removeClass("hidden")};$scope.genericEditLens=function(_config){if(!_config){var paymentInstallmentTypes=[],multiplePaymentInstallmentValue=!1,singleTypeOnly="",espotContentIdentifier="X_PDP_Installments_All";$scope.params.isAffirmEnabled&&$scope.params.isAfterpayEnabled&&$scope.params.isKlarnaEnabled&&(paymentInstallmentTypes=["klarna","affirm","afterpay"],multiplePaymentInstallmentValue=!0,espotContentIdentifier="X_PDP_Installments_All"),$scope.params.isAfterpayEnabled||$scope.params.isKlarnaEnabled||!$scope.params.isAffirmEnabled||(paymentInstallmentTypes=["affirm"],multiplePaymentInstallmentValue=!1,singleTypeOnly="affirm"),$scope.params.isAffirmEnabled||$scope.params.isKlarnaEnabled||!$scope.params.isAfterpayEnabled||(paymentInstallmentTypes=["afterpay"],multiplePaymentInstallmentValue=!1,singleTypeOnly="afterpay"),$scope.params.isAffirmEnabled||$scope.params.isAfterpayEnabled||!$scope.params.isKlarnaEnabled||(paymentInstallmentTypes=["klarna"],multiplePaymentInstallmentValue=!1,singleTypeOnly="klarna"),$scope.params.isAffirmEnabled&&!$scope.params.isAfterpayEnabled&&$scope.params.isKlarnaEnabled&&(paymentInstallmentTypes=["klarna","affirm"],multiplePaymentInstallmentValue=!0,espotContentIdentifier="X_PDP_Installments_Affirm_Klarna"),$scope.params.isAffirmEnabled&&$scope.params.isAfterpayEnabled&&!$scope.params.isKlarnaEnabled&&(paymentInstallmentTypes=["affirm","afterpay"],multiplePaymentInstallmentValue=!0,espotContentIdentifier="X_PDP_Installments_Affirm_Afterpay"),!$scope.params.isAffirmEnabled&&$scope.params.isAfterpayEnabled&&$scope.params.isKlarnaEnabled&&(paymentInstallmentTypes=["klarna","afterpay"],multiplePaymentInstallmentValue=!0,espotContentIdentifier="X_PDP_Installments_Afterpay_Klarna");_config={selector:"#rxcApp",currencyFormat:{thousandSeparator:",",decimalSeparator:".",prefix:"$"},insuranceModule:$scope.params.isRiaEnabled?lcInsurance:null,prescriptionModule:$scope.params.isPrescriptionEnabled?lcPrescription:null,actionsModule:lcActionsModule,lensesData:$scope.params.lensData,data:{langId:$scope.params.langId,frame:{catEntryId:$scope.params.frameId,name:$scope.params.frameName,upc:$scope.params.framePartNumber,model:$scope.params.frameModel,color:$scope.params.frameColor,listPrice:$scope.params.frameOfferPrice,brand:$scope.params.frameBrand,category:$scope.params.frameCategory,imageUrl:$scope.params.frameImage.replace("_001","_002").replace("imwidth=200","imwidth=680"),brandImageUrl:"https://assets.lenscrafters.com/extra/image/LensCrafters/brands/LC_"+$scope.params.frameBrand.replace(/ /g,"_")+"_Logo.png",rxValues:$scope.frameRXValues},frameOnlyLensUPC:$scope.params.frameOnlyLensUPC,showFrameOnly:"SUNGLASSES"!==$scope.params.frameCategory.toUpperCase()},learnMoreBaseEndpoint:"/wcs/resources/store/"+$scope.params.storeId+"/espot/",linksData:{warrantyLearnMore:"10851"===$scope.params.storeId?"/lc-us/our-guarantee?section=protectionPlan":"/en-ca/our-guarantee?section=protectionPlan"},layoutSettings:{enableDigitalOptometry:"true"==$scope.params.isOpthyEnabled,enableLargeIcons:"true"==$scope.params.isLargeIconsEnabled,enableGrayout:$scope.params.isGrayOut,enableBrandLastStep:"true"==$scope.params.enableBrandLastStep},paymentInstallment:{type:singleTypeOnly,installments:4,multiplePaymentInstallment:multiplePaymentInstallmentValue,types:paymentInstallmentTypes,contentIdentifier:espotContentIdentifier}};$rootScope.rxc.selectedLens&&(_config.data.lens={catEntryId:$rootScope.rxc.selectedLens.catEntryId}),$rootScope.rxc.selectedWarranty&&!$scope.params.isStellaProduct&&(_config.data.warranty={catEntryId:$rootScope.rxc.selectedWarranty.id})}document.getElementById("header_wrapper").style.zIndex="30";var chatButtonElem=document.getElementsByClassName("cx-side-button-group");chatButtonElem&&chatButtonElem.length&&!/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)&&(chatButtonElem=chatButtonElem[0]).style.setProperty("right","50%","important"),$rootScope.oldHistoryLength=window.history.length,$rootScope.rxc.rxcWidget=RXC.rxcWidget.new(_config),$rootScope.rxc.rxcWidget.render()};for(var isTrueProgressive=!1,cookies=document.cookie.split(";"),i=0;i<cookies.length;i++)cookies[i].includes("isTrueProgressive")&&(isTrueProgressive=!!cookies[i].split("=")[1].trim().includes("true"));var lens=document.querySelectorAll(".lens-type span");for(i=0;i<lens.length;i++){if(document.getElementById("tab2"))if(lens[i].innerText.includes("Progressive")&&document.getElementsByClassName("lc-tabs-header hide").length<1&&!isTrueProgressive&&null!=document.getElementById("tab2")&&document.getElementById("tab2").click(),lens[i].innerText.includes("Progressive")&&document.getElementsByClassName("lc-tabs-header hide").length<1)angular.element(document.querySelectorAll("#tab2")).on("click",(function(){document.cookie="isTrueProgressive=false"})),angular.element(document.querySelectorAll("#tab1")).on("click",(function(){document.cookie="isTrueProgressive=true"})),angular.element(document.querySelectorAll(".shipping-type-container input.ng-pristine")).on("click",(function(){document.cookie="isTrueProgressive=true"}))}}));var _lensPanelLensSelectDirective=function(_name,_template){app.directive(_name,(function($rootScope,lcActionsModule,lcInsurance,lcPrescription){return{restrict:"E",template:_template,scope:{isLoadingLens:"=",isLoadingInsurance:"=",lensData:"=data"},link:function(scope,elem,attrs,ctrl){scope.title=attrs.title,scope.lensCategory=attrs.lenscategory,scope.storeId=attrs.storeid,scope.catalogId=attrs.catalogid,scope.langId=attrs.langid,scope.frameId=attrs.frameid,scope.framePartNumber=attrs.framepartnumber,scope.frameBrand=attrs.framebrand,scope.frameBrandImage=attrs.framebrandimage,scope.frameCategory=attrs.framecategory,scope.frameName=attrs.framename,scope.frameOfferPrice=attrs.frameofferprice,scope.frameListPrice=attrs.framelistprice,scope.frameSize=attrs.framesize,scope.frameImage=attrs.frameimage,scope.frameColor=attrs.framecolor,scope.frameModel=attrs.framemodel,scope.frameOnlyLensUPC=attrs.frameonlylensupc,scope.frameMinTotalPower=attrs.framemintotalpower,scope.frameMaxTotalPower=attrs.framemaxtotalpower,scope.currentOrderId=attrs.currentorderid,scope.partType=attrs.parttype,scope.isSunglasses="true"==attrs.sunglasses,scope.isBuyable="true"==attrs.buyable,scope.warrantyPrice=attrs.warrantyprice||"0.00",scope.warrantyId=attrs.warrantyid||null,scope.isPrescriptionEnabled="true"==attrs.isprescriptionenabled,scope.isAfterpayEnabled=attrs.isafterpayenabled,scope.isAffirmEnabled=attrs.isaffirmenabled,scope.isKlarnaEnabled=attrs.isklarnaenabled,scope.open=function(){try{if(scope.isLoadingLens||scope.isLoadingInsurance)return;var frameRXValues=null;lcPrescription&&scope.isPrescriptionEnabled&&(frameRXValues=lcPrescription.getFrameRXValues(scope.frameMinTotalPower,scope.frameMaxTotalPower));var paymentInstallmentTypes=[],multiplePaymentInstallmentValue=!1,singleTypeOnly="",espotContentIdentifier="X_PDP_Installments_All";$scope.params.isAffirmEnabled&&$scope.params.isAfterpayEnabled&&$scope.params.isKlarnaEnabled&&(paymentInstallmentTypes=["klarna","affirm","afterpay"],multiplePaymentInstallmentValue=!0,espotContentIdentifier="X_PDP_Installments_All"),$scope.params.isAfterpayEnabled||$scope.params.isKlarnaEnabled||!$scope.params.isAffirmEnabled||(paymentInstallmentTypes=["affirm"],multiplePaymentInstallmentValue=!1,singleTypeOnly="affirm"),$scope.params.isAffirmEnabled||$scope.params.isKlarnaEnabled||!$scope.params.isAfterpayEnabled||(paymentInstallmentTypes=["afterpay"],multiplePaymentInstallmentValue=!1,singleTypeOnly="afterpay"),$scope.params.isAffirmEnabled||$scope.params.isAfterpayEnabled||!$scope.params.isKlarnaEnabled||(paymentInstallmentTypes=["klarna"],multiplePaymentInstallmentValue=!1,singleTypeOnly="klarna"),$scope.params.isAffirmEnabled&&!$scope.params.isAfterpayEnabled&&$scope.params.isKlarnaEnabled&&(paymentInstallmentTypes=["klarna","affirm"],multiplePaymentInstallmentValue=!0,espotContentIdentifier="X_PDP_Installments_Affirm_Klarna"),$scope.params.isAffirmEnabled&&$scope.params.isAfterpayEnabled&&!$scope.params.isKlarnaEnabled&&(paymentInstallmentTypes=["affirm","afterpay"],multiplePaymentInstallmentValue=!0,espotContentIdentifier="X_PDP_Installments_Affirm_Afterpay"),!$scope.params.isAffirmEnabled&&$scope.params.isAfterpayEnabled&&$scope.params.isKlarnaEnabled&&(paymentInstallmentTypes=["klarna","afterpay"],multiplePaymentInstallmentValue=!0,espotContentIdentifier="X_PDP_Installments_Afterpay_Klarna");var config={selector:"#rxcApp",currencyFormat:{thousandSeparator:",",decimalSeparator:".",prefix:"$"},insuranceModule:$scope.params.isRiaEnabled?lcInsurance:null,prescriptionModule:scope.isPrescriptionEnabled?lcPrescription:null,actionsModule:lcActionsModule,lensesData:scope.lensData,data:{langId:scope.langId,frame:{catEntryId:scope.frameId,name:scope.frameName,upc:scope.framePartNumber,model:scope.frameModel,color:scope.frameColor,offerPrice:scope.frameOfferPrice,listPrice:scope.frameListPrice,brand:scope.frameBrand,category:scope.frameCategory,imageUrl:scope.frameImage.replace("_001","_002").replace("imwidth=200","imwidth=680"),brandImageUrl:"https://assets.lenscrafters.com/extra/image/LensCrafters/brands/LC_"+scope.frameBrand.replace(/ /g,"_")+"_Logo.png",rxValues:frameRXValues},frameOnlyLensUPC:scope.frameOnlyLensUPC,showFrameOnly:"SUNGLASSES"!==scope.frameCategory.toUpperCase()},learnMoreBaseEndpoint:"/wcs/resources/store/"+$scope.params.storeId+"/espot/",linksData:{warrantyLearnMore:"10851"===$scope.params.storeId?"/lc-us/our-guarantee?section=protectionPlan":"/en-ca/our-guarantee?section=protectionPlan"},layoutSettings:{enableDigitalOptometry:"true"==$scope.params.isOpthyEnabled,enableLargeIcons:"true"==$scope.params.isLargeIconsEnabled,enableGrayout:$scope.params.isGrayOut,enableBrandLastStep:"true"==$scope.params.enableBrandLastStep},paymentInstallment:{type:singleTypeOnly,installments:4,multiplePaymentInstallment:multiplePaymentInstallmentValue,types:paymentInstallmentTypes,contentIdentifier:espotContentIdentifier}},chatButtonElem=document.getElementsByClassName("cx-side-button-group");chatButtonElem&&chatButtonElem.length&&!/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)&&(chatButtonElem=chatButtonElem[0]).style.setProperty("right","50%","important"),$rootScope.oldHistoryLength=window.history.length,$rootScope.rxc.rxcWidget=RXC.rxcWidget.new(config),$rootScope.rxc.rxcWidget.render()}catch(error){tealium_data2track.push({id:"Error",Error_Code:"Cannot add lenses",Error_Source:"Client"})}}}}}))},_tmplDesktop='<a href="#" class="st-button st-button-small select-edit-lens new-lens-selection-text edit-lens-selection button-big-black-fill" data-parttype="{{partType}}" data-catentryid="{{frameId}}" data-rxable="true" rel="#select-a-lens-type" data-productname="{{frameName}}" data-price="{{frameOfferPrice}}" data-is_sunglasses="{{isSunglasses}}" data-element-id="X_X_Prod_AddLens" data-description="{{frameModel}}_{{framePartNumber}}" ng-show="isBuyable || isLoadingLens" ng-class="{\'disabled\': isLoadingLens}" ng-click="open()"> {{!isLoadingLens ? title : \'\'}}<div class="wait-loader" ng-if="isLoadingLens"><div class="fa fa-spinner fa-spin"></div></div></a>',_tmplMobile='<a href="#" class="st-button st-button-big lens-selection-popup lp-font-medium" rel="#select-a-lens-type" tabindex="0" data-element-id="X_X_Prod_AddLens" data-description="{{frameModel}}_{{framePartNumber}}" ng-class="{\'disabled\': isLoadingLens}" ng-click="open()"> {{title}}</a>';_lensPanelLensSelectDirective("lensPanelLensSelect",_tmplDesktop),_lensPanelLensSelectDirective("lensPanelLensSelectMobile",_tmplMobile),app.factory("$loader",(function(){var _previousContent,_container;function _create(element){var _div=document.createElement("div");_div.id="loader",_div.className="wait-loader hidden",_div.addEventListener("click",(function(event){event.preventDefault(),event.stopImmediatePropagation()}));var _spin=document.createElement("em");return _spin.className="fa fa-spinner fa-spin",_div.appendChild(_spin),null==element&&(element="page-container"),_container=document.getElementById(element),angular.isUndefined(_container)||("A"==_container.tagName&&(_previousContent=_container.innerHTML,_div.classList.add("white"),_container.classList.add("no-underline"),_container.innerHTML=""),_container.appendChild(_div)),_div}return{_loader:null,show:function(element){this._loader=_create(element),this._loader.classList.remove("hidden")},hide:function(){null==this._loader&&(this._loader=_create()),this._loader.classList.add("hidden"),_container.classList.remove("no-underline"),null!=_previousContent&&(_container.innerHTML=_previousContent)}}})),app.component("insurancePanel",{templateUrl:"/wcsstore/LensCraftersStorefrontAssetStore/angular/insurance/insurancePanel.html",controller:async function($rootScope,$http,$compile,$scope){var ESPOT_URL="/wcs/resources/store/#STOREID#/espot/#ESPOTNAME#";await $http.get(ESPOT_URL.replace("#ESPOTNAME#","X_Insurance_Providers").replace("#STOREID#","10851")).then((function(response){if(response.data.MarketingSpotData&&response.data.MarketingSpotData.length>0&&response.data.MarketingSpotData[0].baseMarketingSpotActivityData&&response.data.MarketingSpotData[0].baseMarketingSpotActivityData.length>0&&response.data.MarketingSpotData[0].baseMarketingSpotActivityData[0].marketingContentDescription&&response.data.MarketingSpotData[0].baseMarketingSpotActivityData[0].marketingContentDescription.length>0&&response.data.MarketingSpotData[0].baseMarketingSpotActivityData[0].marketingContentDescription[0].marketingText){var html=response.data.MarketingSpotData[0].baseMarketingSpotActivityData[0].marketingContentDescription[0].marketingText,e=$compile(html)($scope),elementHtml=document.createElement("script");elementHtml.append(e.html()),document.body.append(elementHtml)}}),(function(error){$log.error(error),tealium_data2track.push({id:"Error",Error_Code:"Error loading espot "+setup.espotName,Error_Source:"Client"})})),$scope.$ctrl.insuranceProviders=window.insuranceProviders,$scope.$ctrl.defaultLink=window.defaultLink}}),app.directive("ngTouchClick",[function(){return function(scope,elem,attrs){elem.bind("touchstart click",(function(e){e.preventDefault(),e.stopPropagation(),scope.$apply(attrs.ngTouchClick)}))}}]),app.directive("onDoubleClick",(function($timeout){return{restrict:"A",link:function($scope,$elm,$attrs){var clicks=0,lastClick=new Date;$elm.bind("click",(function(evt){new Date-lastClick>300&&(clicks=0),lastClick=new Date,1==++clicks&&$timeout((function(){1==clicks||$scope.$apply((function(){$scope.$eval($attrs.onDoubleClick)}))}),300)}))}}})),app.directive("slickSlider",(function($timeout,$window){return{restrict:"A",link:function(scope,element,attrs){$timeout((function(){$(element).on("lazyloaded",(function(e,slick){$(e.target).closest(".image-holder").find("svg").remove()})),$(element).on("init",(function(e,slick){document.addEventListener("visibilitychange",(function(){document.hidden||slick.refresh()})),setTimeout((function(){$(".bestseller-carousel")&&$(".bestseller-carousel").removeClass("slick-hidden"),$(".bestseller-skelethon")&&$(".bestseller-skelethon").hide()}),1500)}));var ob=scope.$eval(attrs.slickSlider);if(null!=ob&&null!=ob.model)scope.$watch(ob.model,(function(){void 0!==ob.model&&""!=ob.model&&$timeout((function(){$(element).hasClass("slick-initialized")?($(element).slick("slickUnfilter"),$(element).slick("slickFilter",".active")):$(element).slick(ob).slick("slickFilter",".active")}))}));else if(null!=ob&&null!=ob.square)try{document.querySelectorAll(ob.square).forEach((function(elem){angular.element(elem)[0].clientWidth>0&&(elem.style.height=angular.element(elem)[0].clientWidth+"px",elem.style.minHeight=angular.element(elem)[0].clientWidth+"px"),angular.element($window).bind("resize",(function(){elem.style.height=angular.element(elem)[0].clientWidth+"px",elem.style.minHeight=angular.element(elem)[0].clientWidth+"px"}))})),$(element).slick(ob)}catch(e){console.log("No element found for: "+ob.square)}else null!=ob&&null!=ob.events?(Object.keys(ob.events).forEach((function(event){$(element).on(event,ob.events[event])})),$(element).slick(ob)):$(element).slick(ob);null!=ob&&!0===ob.dynamic&&new MutationObserver((function(mutationsList,observer){for(const mutation of mutationsList)if("childList"===mutation.type)return observer.disconnect(),element[0].slick.refresh(),void observer.observe(element[0],{childList:!0})})).observe(element[0],{childList:!0})}))}}})),app.directive("ngAjaxCompile",(function($compile){return{link:function(scope,element,attrs){new MutationObserver((function(mutationsList,observer){for(const mutation of mutationsList)if("childList"===mutation.type)return observer.disconnect(),void $compile(element.contents())(scope)})).observe(element[0],{childList:!0})}}})),app.directive("stickyBar",(function($window,$timeout){return{restrict:"A",link:function(scope,element,attrs){$timeout((function(){var moreResizeHappened=!1,containerPadding=0,elementHeight=0,options=scope.$eval(attrs.stickyBar),sticky=0,pElement=angular.element(element)[0],lastScrollTop=0,isHeader=!(null==options||!options.header);isHeader||element.addClass("stickable"),angular.element($window).bind("resize",(function(){for(element.hasClass("sticky")&&(element.removeClass("sticky"),moreResizeHappened=!0),elementHeight=element[0].offsetHeight;pElement;)sticky+=angular.element(pElement)[0].offsetTop,pElement=angular.element(pElement)[0].offsetParent;"D"==scope.deviceType&&null!=options&&null!=options.offset.D&&(sticky+=options.offset.D),"T"!=scope.deviceType&&"M"!=scope.deviceType||null==options||null==options.offset.M||(sticky+=options.offset.M);var parentEl=$(element.parent()[0]);parentEl.attr("data-pad")||(containerPadding=""!=element.parent()[0].style.paddingTop?element.parent()[0].style.paddingTop:0,parentEl.attr("data-pad",containerPadding)),moreResizeHappened&&(moreResizeHappened=!1,window.pageYOffset>=sticky&&element.addClass("sticky"))})),angular.element($window).bind("scroll",(function(){var st=window.pageYOffset;window.pageYOffset>=sticky&&!$("#menu_search_nav_links").hasClass("opened")?(element.addClass("sticky").removeClass("top-auto"),element.parent()[0].style.paddingTop=parseInt(containerPadding)+elementHeight+"px"):(element.removeClass("sticky").addClass("top-auto"),element.parent()[0].style.paddingTop=parseInt(containerPadding)+"px"),isHeader&&(st>lastScrollTop&&st>elementHeight&&!$("#menu_search_nav_links").hasClass("opened")?(element.removeClass("nav-down").addClass("nav-up"),$(".stickable:not(#header-sticky-wrapper)").removeClass("sticky-header")):st+$(window).height()<$(document).height()&&(element.removeClass("nav-up").addClass("nav-down"),$(".sticky:not(#header-sticky-wrapper)").addClass("sticky-header"))),lastScrollTop=st})),angular.element($window).triggerHandler("resize")}))}}})),app.directive("backTop",(function($window,$timeout){return{restrict:"A",link:function(scope,element,attrs){$timeout((function(){angular.element($window).bind("scroll",(function(){el=document.getElementById("btt_button"),window.pageYOffset>10?el.style.display="block":el.style.display="none"}))}))}}})),app.directive("stopScroll",(function($timeout){return{restrict:"A",link:function(scope,element,attrs){$timeout((function(){var scrollRules=scope.$eval(attrs.stopScroll);scope.$watch(scrollRules.model.name,(function(v){var enable=scope.$eval(""+v+scrollRules.condition);function clipPage(){document.querySelectorAll("html,body").forEach((function(elem){elem.style.overflow=enable?"hidden":"",elem.style.position=enable?"fixed":"",elem.style.height=enable?"100vh":"",elem.style.maxWidth=enable?"100%":""}))}var html=$("html");if(enable){var scrollPosition=self.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop;if(html.attr("scroll-position"))return;html.attr("scroll-position",scrollPosition),$timeout((function(){clipPage()}))}else{if(!(scrollPosition=html.attr("scroll-position")))return;clipPage(),window.scrollTo(0,scrollPosition),html.removeAttr("scroll-position")}}))}))}}})),app.directive("dynamicSquare",(function($window,$timeout){return{restrict:"A",link:function(scope,element,attrs){angular.element(element)[0].clientWidth>0&&(element.css("height",angular.element(element)[0].clientWidth+"px"),element.css("min-height",angular.element(element)[0].clientWidth+"px")),angular.element($window).bind("resize",(function(){element.css("height",angular.element(element)[0].clientWidth+"px"),element.css("min-height",angular.element(element)[0].clientWidth+"px")}))}}})),app.directive("dynamicHorizontalBanner",(function($window,$timeout){return{restrict:"A",link:function(scope,element,attrs){var wrappedQueryResult=document.getElementsByClassName("image-holder");angular.element(element)[0].clientWidth>0&&(element.css("height",wrappedQueryResult[0].clientWidth+"px"),element.css("min-height",wrappedQueryResult[0].clientWidth+"px")),angular.element($window).bind("resize",(function(){element.css("height",wrappedQueryResult[0].clientWidth+"px"),element.css("min-height",wrappedQueryResult[0].clientWidth+"px")}))}}})),app.directive("dynamicVerticalBanner",(function($window,$timeout){return{restrict:"A",link:function(scope,element,attrs){var isMobile=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),wrappedQueryResult=document.getElementsByClassName("image-holder"),wrappedQueryResultPS=document.getElementsByClassName("product-square");angular.element(element)[0].clientWidth>0&&(element.css("width",wrappedQueryResult[0].clientWidth+"px"),element.css("min-width",wrappedQueryResult[0].clientWidth+"px"),isMobile||element.css("height",wrappedQueryResultPS[0].clientHeight+wrappedQueryResult[0].clientHeight+"px")),angular.element($window).bind("resize",(function(){element.css("width",wrappedQueryResult[0].clientWidth+"px"),element.css("min-width",wrappedQueryResult[0].clientWidth+"px"),isMobile||element.css("height",wrappedQueryResultPS[0].clientHeight+wrappedQueryResult[0].clientHeight+"px")}))}}})),app.directive("resetField",["$compile","$timeout",function($compile,$timeout){return{require:"ngModel",scope:{},link:function(scope,el,attrs,ctrl){if("INPUT"!==el[0].nodeName)throw new Error("resetField is limited to input elements");if(!/text|search|tel|url|email|password|date/i.test(attrs.type))throw new Error("Invalid input type for resetField: "+attrs.type);var template=$compile('<a ng-show="enabled" class="clear-input-icon" ng-mousedown="reset()"><svg class="icon close"><use xlink:href="#clear-input"></use></svg></a>')(scope);el.after(template);scope.reset=function(){ctrl.$setViewValue(null),ctrl.$render(),scope.enabled=!1,scope.$parent[el.attr("name")+"_resetenabled"]=scope.enabled,scope.$parent[el.attr("name")+"_focused"]=!0,$timeout((function(){el[0].focus()}),0,!1)},scope.$watch(attrs.ngModel,(function(newValue,oldValue){newValue!==oldValue&&(scope.enabled=!ctrl.$isEmpty(el.val()),scope.$parent[el.attr("name")+"_resetenabled"]=scope.enabled)})),el.bind("focus",(function(){scope.enabled=!ctrl.$isEmpty(el.val()),scope.$parent[el.attr("name")+"_resetenabled"]=scope.enabled,scope.$parent[el.attr("name")+"_focused"]=!0,scope.$apply()})).bind("blur",(function(){scope.enabled=!1,scope.$parent[el.attr("name")+"_resetenabled"]=scope.enabled,scope.$parent[el.attr("name")+"_focused"]=!1,scope.$apply()})).bind("keyup",(function(){scope.enabled=!ctrl.$isEmpty(el.val()),scope.$parent[el.attr("name")+"_resetenabled"]=scope.enabled,scope.$parent[el.attr("name")+"_focused"]=!0,scope.$apply()}))}}}]),app.directive("phoneValidation",[function(){return{require:"ngModel",link:function(scope,iElement,iAttribute,ngModelController){function formatPhoneNumber(inputValue){var viewValue="";try{var cleanInputValue=inputValue.replace(/\D/g,"");if(""!==cleanInputValue){viewValue="("+cleanInputValue.slice(0,3).padEnd(3," ")+") "+cleanInputValue.slice(3,6).padEnd(3," ")+" - "+cleanInputValue.slice(6,10).padEnd(4," ");var match=/(\d)(?!.*\d)/.exec(viewValue);match&&(viewValue=viewValue.slice(0,match.index+1))}}catch(e){console.error(e)}return ngModelController.$setViewValue(viewValue),ngModelController.$render(),viewValue}ngModelController.$validators.isPhoneNumber=function(modelValue,viewValue){var value=modelValue||viewValue;return!!value&&10==value.replace(/\D/g,"").length},ngModelController.$parsers.push(formatPhoneNumber),ngModelController.$formatters.push(formatPhoneNumber)}}}]),app.directive("lcDatepicker",(function(){return{restrict:"E",transclude:!0,template:'<div ng-transclude></div><button type="button" ng-show="showToggle" class="calendar-toggle" ng-click="toggleCalendar()">Toggle calendar</button><div class="underlay" ng-show="showCalendar" ng-click="toggleCalendar()"></div><div class="lc-datepicker" ng-show="showCalendar" ng-switch on="currentPage" data-analytics_available_call="0">  <div class="year-page" ng-switch-when="yearPage">    <div class="header">      <span>{{yearsPage[0]}} - {{yearsPage[yearsPage.length - 1]}}</span>      <div class="buttons">        <button type="button" class="prev" ng-class="{\'disabled\': prevYearsPageInvalid()}" ng-disabled="prevYearsPageInvalid()" ng-click="goToPrevYearsPage()"> < </button>        <button type="button" class="next" ng-class="{\'disabled\': nextYearsPageInvalid()}" ng-disabled="nextYearsPageInvalid()" ng-click="goToNextYearsPage()"> > </button>      </div>    </div>    <div class="years-list">      <span class="year" ng-class="{\'selected\': selectedDate.getFullYear() === y, \'invalid\': yearIsInvalid(y)}"  ng-repeat="y in yearsPage" ng-click="selectYear(y)">{{y}}</span>    </div>  </div>  <div class="month-page" ng-switch-when="monthPage">    <div class="header">      <span class="header-control" ng-click="goToYearPage()">{{year}}</span>      <div class="buttons">        <button type="button" class="prev" ng-class="{\'disabled\': yearIsInvalid(year - 1)}" ng-disabled="yearIsInvalid(year - 1)" ng-click="goToPrevYear()"> < </button>        <button type="button" class="next" ng-class="{\'disabled\': yearIsInvalid(year + 1)}" ng-disabled="yearIsInvalid(year + 1)" ng-click="goToNextYear()"> > </button>      </div>    </div>    <div class="months-list">      <span class="month" ng-class="{\'selected\': m === selectedDate.getMonth() && selectedDate.getFullYear() === year, \'invalid\': monthIsInvalid(m)}" ng-repeat="m in months" ng-click="selectMonth(m)">{{ formatMonthNumber(m) }}</span>    </div>  </div>  <div class="date-page" ng-switch-when="datePage">    <div class="header">      <span class="header-control" ng-click="goToMonthPage()">{{monthNames[month]}}</span>      <span class="header-control" ng-click="goToYearPage()">{{year}}</span>      <div class="buttons">        <button type="button" class="prev" ng-class="{\'disabled\': prevMonthIsInvalid()}" ng-disabled="prevMonthIsInvalid()" ng-click="goToPrevMonth()"> < </button>        <button type="button" class="next" ng-class="{\'disabled\': nextMonthIsInvalid()}" ng-disabled="nextMonthIsInvalid()" ng-click="goToNextMonth()"> > </button>      </div>    </div>    <div class="weekdays">      <span class="weekday" ng-repeat="day in week">{{day.slice(0,3)}}</span>    </div>    <div class="dates-list">      <span class="date pastMonth" ng-class="{\'selected\': selectedDate.getTime() === date.getTime(), \'invalid\': dateIsInvalid(date)}" ng-repeat="date in pastMonth" ng-click="selectDate(date)">        {{date.getDate()}}      </span>      <span class="date currentMonth" ng-class="{\'selected\': selectedDate.getTime() === date.getTime(), \'invalid\': dateIsInvalid(date)}" ng-repeat="date in currentMonth" ng-click="selectDate(date)">        {{date.getDate()}}      </span>      <span class="date nextMonth" ng-class="{\'selected\': selectedDate.getTime() === date.getTime(), \'invalid\': dateIsInvalid(date)}" ng-repeat="date in nextMonth" ng-click="selectDate(date)">        {{date.getDate()}}      </span>    </div>  </div></div>',scope:{format:"@?",selector:"@?",showCalendar:"=?",startDate:"<?",minDate:"<?",maxDate:"<?"},link:function($scope,elem,attr){attr.selector?$scope.input=angular.element(elem[0].querySelector(attr.selector)):$scope.input=angular.element(elem[0].querySelector("input")),$scope.showToggle=void 0===attr.showCalendar,$scope.format=attr.format||"dd/MM/yyyy"},controller:function($scope,$filter){function updateCalendarDays(){$scope.pastMonth=function(month,year){var first=new Date(year,month,1),days=[];for(date=new Date(first),date.setDate(date.getDate()-first.getDay());date.getMonth()!==month;)days.push(new Date(date)),date.setDate(date.getDate()+1);return days}($scope.month,$scope.year),$scope.currentMonth=function(month,year){for(var date=new Date(year,month,1),days=[];date.getMonth()===month;)days.push(new Date(date)),date.setDate(date.getDate()+1);return days}($scope.month,$scope.year),$scope.nextMonth=function(month,year){var first=new Date(year,month+1,1),days=[];for(date=new Date(first);0!==date.getDay();)days.push(new Date(date)),date.setDate(date.getDate()+1);return days}($scope.month,$scope.year)}function getYearsPage(startYear){for(var years=[],i=0;i<12;i++)years.push(startYear+i);return years}var baseDate,start,now=new Date;function yearsPageInvalid(years){for(var y of years)if(!$scope.yearIsInvalid(y))return!1;return!0}baseDate=$scope.startDate?$scope.startDate:$scope.minDate?$scope.minDate:$scope.maxDate?$scope.maxDate:now,$scope.currentPage="datePage",$scope.selectedDate=$scope.startDate,$scope.week=function(){var date=new Date,names=[];date.setDate(date.getDate()-date.getDay());for(var day=0;day<7;day++)names.push(date.toLocaleString("default",{weekday:"long"})),date.setDate(date.getDate()+1);return names}(),$scope.months=(start=0,Array(12-start).join(0).split(0).map((function(_,id){return id+start}))),$scope.monthNames=function(){for(var names=[],month=0;month<12;month++){var date=new Date(2021,month,1);names.push(date.toLocaleString("default",{month:"long"}))}return names}(),$scope.month=baseDate.getMonth(),$scope.year=baseDate.getFullYear(),$scope.startYearPage=baseDate.getFullYear(),$scope.yearsPage=getYearsPage(baseDate.getFullYear()),updateCalendarDays(),$scope.dateIsInvalid=function(date){return!!($scope.minDate&&date.getTime()<$scope.minDate.getTime())||!!($scope.maxDate&&date.getTime()>$scope.maxDate.getTime())},$scope.monthIsInvalid=function(month){var firstOfMonth=new Date($scope.year,month),lastOfMonth=new Date($scope.year,month+1,1,0,0,-1);return!!($scope.minDate&&lastOfMonth.getTime()<$scope.minDate.getTime())||!!($scope.maxDate&&firstOfMonth.getTime()>$scope.maxDate.getTime())},$scope.yearIsInvalid=function(year){var firstOfYear=new Date(year,0),lastOfYear=new Date(year+1,0,1,0,0,-1);return!!($scope.minDate&&lastOfYear.getTime()<$scope.minDate.getTime())||!!($scope.maxDate&&firstOfYear.getTime()>$scope.maxDate.getTime())},$scope.prevMonthIsInvalid=function(){var first=$scope.currentMonth[0],prevMonth=new Date(first);return prevMonth.setDate(first.getDate()-1),!!($scope.minDate&&prevMonth.getTime()<$scope.minDate.getTime())},$scope.nextMonthIsInvalid=function(){var last=$scope.currentMonth[$scope.currentMonth.length-1],nextMonth=new Date(last);return nextMonth.setDate(last.getDate()+1),!!($scope.maxDate&&nextMonth.getTime()>$scope.maxDate.getTime())},$scope.formatMonthNumber=function(m){return("0"+(m+1).toString()).slice(-2)},$scope.toggleCalendar=function(){$scope.showCalendar=!$scope.showCalendar},$scope.goToDayPage=function(){$scope.currentPage="datePage"},$scope.goToMonthPage=function(){$scope.currentPage="monthPage"},$scope.goToYearPage=function(){$scope.currentPage="yearPage"},$scope.goToNextMonth=function(){11===$scope.month?($scope.month=0,$scope.year++):$scope.month++,updateCalendarDays()},$scope.goToPrevMonth=function(){0===$scope.month?($scope.month=11,$scope.year--):$scope.month--,updateCalendarDays()},$scope.goToPrevYear=function(){$scope.year--},$scope.goToNextYear=function(){$scope.year++},$scope.selectMonth=function(month){$scope.month=month,$scope.goToDayPage(),updateCalendarDays()},$scope.selectYear=function(year){$scope.year=year,$scope.goToMonthPage()},$scope.goToPrevYearsPage=function(){$scope.startYearPage-=12,$scope.yearsPage=getYearsPage($scope.startYearPage)},$scope.goToNextYearsPage=function(){$scope.startYearPage+=12,$scope.yearsPage=getYearsPage($scope.startYearPage)},$scope.prevYearsPageInvalid=function(){return yearsPageInvalid(getYearsPage($scope.startYearPage-12))},$scope.nextYearsPageInvalid=function(){return yearsPageInvalid(getYearsPage($scope.startYearPage+12))},$scope.selectDate=function(date){$scope.selectedDate=date,date.getMonth()!==$scope.month&&$scope.selectMonth(date.getMonth()),$scope.input.val($filter("date")($scope.selectedDate,$scope.format)),$scope.input.triggerHandler("input"),$scope.input.triggerHandler("change"),$scope.toggleCalendar()}}}})),app.directive("espot",(function($window,$timeout,$http,$compile){return{restrict:"A",link:function(scope,element,attrs){var setup=scope.$eval(attrs.espot),ESPOT_URL="/wcs/resources/store/#STOREID#/espot/#ESPOTNAME#";setup.productId&&(ESPOT_URL=ESPOT_URL+"/product/"+setup.productId),$timeout((function(){$http.get(ESPOT_URL.replace("#ESPOTNAME#",setup.espotName).replace("#STOREID#",setup.storeId)).then((function(response){if(response.data.MarketingSpotData&&response.data.MarketingSpotData.length>0&&response.data.MarketingSpotData[0].baseMarketingSpotActivityData&&response.data.MarketingSpotData[0].baseMarketingSpotActivityData.length>0&&response.data.MarketingSpotData[0].baseMarketingSpotActivityData[0].marketingContentDescription&&response.data.MarketingSpotData[0].baseMarketingSpotActivityData[0].marketingContentDescription.length>0&&response.data.MarketingSpotData[0].baseMarketingSpotActivityData[0].marketingContentDescription[0].marketingText){var html=response.data.MarketingSpotData[0].baseMarketingSpotActivityData[0].marketingContentDescription[0].marketingText,e=$compile(html)(scope);element.replaceWith(e)}}),(function(error){$log.error(error),tealium_data2track.push({id:"Error",Error_Code:"Error loading espot "+setup.espotName,Error_Source:"Client"})}))}))}}})),app.controller("HeaderController",["$scope","$rootScope","$compile","$window","headerModule","$http","$timeout","$httpParamSerializer","$log",function($scope,$rootScope,$compile,$window,headerModule,$http,$timeout,$httpParamSerializer,$log){$rootScope.deviceType="D";var CONTACTS_ITEMS_URL="/search/resources/store/#STOREID#/productview/byCategory/#CATEGORYID#?facet=#FACET#%3A%22#BRAND#%22&pageSize=10&pageNumber=1&catalogId=#SALESCATALOGID#&profileName=RONA_findProductsByCategory_CL";$scope.params={},$scope.contactsProducts={},$scope.currentContactsBrand="",$scope.currentContactsBrandLink="",$scope.cartItemsNum=0,$scope.selectedMenu=0,$scope.desktopMenuStatus=!1,$scope.mobileMenuStatus=0,$scope.userType="G",$scope.errorMessage=null,$scope.searchOpen=!1,$scope.contactImageBaseURL="",$scope.searchInputHasGainFocus=!1,$scope.emptySearchField=!0,$rootScope.wishlistCount=0,$rootScope.wishlistItems=[],headerModule.getDeviceType($window.screen.width),angular.element($window).bind("resize",(function(event){headerModule.getDeviceType(event.target.screen.width)})),$scope.init=function(_params){$scope.params=_params,$scope.selectedCategory="eyeglasses",$scope.selectedFilter=1,$scope.searchOpen=!1,$scope.contactImageBaseURL=_params.contactImageBaseURL,headerModule.init($scope.params),headerModule.getUserType().then((function(response){$scope.userType=response.data.basicInfo.registerType,-1002!=response.data.basicInfo.callerId&&headerModule.getCartItems().then((function(response){$scope.cartItemsNum=response}))})),headerModule.getWishListItems().then((function(response){$rootScope.wishlistCount=response.count,$rootScope.wishlistItems=response.catentries})),ocr.init()},$scope.resetSearchField=function(){document.getElementById("SimpleSearchForm_SearchTerm").value=document.getElementById("searchTextHolder").innerHTML.trim(),$("#SimpleSearchForm_SearchTerm").addClass("blur"),"undefined"==typeof autoSuggestHover||autoSuggestHover||showAutoSuggest(!1)},$scope.hideSearch=function(){document.getElementById("header_search_wrapper").style.display="none",document.getElementById("menu_search_nav_links").style.top=null,document.getElementById("menu_search_nav_links").style.height=null},$scope.showSearch=function(){document.getElementById("header_search_wrapper").style.display="flex",document.getElementById("menu_search_nav_links").style.top="0",document.getElementById("menu_search_nav_links").style.height="100%",$scope.searchInputHasGainFocus=!0,document.getElementById("SimpleSearchForm_SearchTerm").focus()},$scope.showCloseIcon=function(event){""!=event.target.value&&"Search for..."!=event.target.value||"M"!=$scope.deviceType?$scope.emptySearchField=!1:$scope.emptySearchField=!0},$scope.switchMenu=function(menuId){$(".nav-links").animate({scrollTop:0},"ease"),0==menuId&&($scope.desktopMenuStatus=!1,$scope.selectedMenu=menuId),menuId==$scope.selectedMenu?($scope.desktopMenuStatus=!1,$scope.selectedMenu=0):0==$scope.selectedMenu?($scope.selectedMenu=menuId,$timeout((function(){$scope.desktopMenuStatus=!0}),500)):$scope.selectedMenu=menuId,window.innerWidth>480&&($(".contacts-list-fill").mCustomScrollbar({scrollInertia:200,scrollButtons:{enable:!0},mouseWheel:{preventDefault:!0}}),$(".ct_menu__main.mCustomScrollJs").mCustomScrollbar({scrollInertia:200,scrollButtons:{enable:!0},mouseWheel:{preventDefault:!0}}))},$scope.stopScrolling=function(){$("body").addClass("stop-scrolling")},$scope.enableScrolling=function(){$("body").removeClass("stop-scrolling")},$rootScope.wrapAngular=function(elementFunc){$compile(elementFunc)($scope)},$scope.retreiveContacts=function(contactsCategoryId,brand,brandFacet,salesCatalogId,link){null==$scope.contactsProducts[brand]?(CONTACTS_ITEMS_URL="Acuvue"==brand?"/search/resources/store/10851/productview/byCategory/#CATEGORYID#?facet=&pageSize=10&pageNumber=1&catalogId=#SALESCATALOGID#&profileName=RONA_findProductsByCategory_CL":"/search/resources/store/10851/productview/byCategory/#CATEGORYID#?facet=#FACET#%3A%22#BRAND#%22&pageSize=10&pageNumber=1&catalogId=#SALESCATALOGID#&profileName=RONA_findProductsByCategory_CL",$http.get(CONTACTS_ITEMS_URL.replace("#CATEGORYID#",contactsCategoryId).replace("#BRAND#",brand).replace("#FACET#",brandFacet).replace("#SALESCATALOGID#",salesCatalogId)).then((function(response){response&&response.data.catalogEntryView&&($scope.contactsProducts[brand]=[],response.data.catalogEntryView.forEach((function(entry){var contactLensName="";entry.attributes.forEach((function(attr){"MODEL_NAME"==attr.name&&(contactLensName=attr.values[0].value)})),window.contactsSEOURLs={},$scope.contactsProducts[brand].push({name:contactLensName,upc:entry.partNumber,url:link+"/"+entry.keyword})})),$scope.currentContactsBrand=brand,$scope.currentContactsBrandLink=link,window.innerWidth>480&&$(".ct_menu__main.mCustomScrollJs").mCustomScrollbar({scrollInertia:200,scrollButtons:{enable:!0},mouseWheel:{preventDefault:!0}}))}),(function(error){$log.error(error),tealium_data2track.push({id:"Error",Error_Code:"DDM Contacts error",Error_Source:"Client"}),$scope.hasLenses=!1}))):($scope.currentContactsBrand=brand,$scope.currentContactsBrandLink=link)}}]),app.controller("FooterController",["$scope","$rootScope","lcActionsModule","PromoPopupService","$http","$httpParamSerializer","$window","$log","$cookies",function($scope,$rootScope,lcActionsModule,PromoPopupService,$http,$httpParamSerializer,$window,$log,$cookies){$scope.selectOtherBrandVal=0,$scope.langselection=0,$scope.selectedLang="",$scope.errorMessage=null,$scope.subscribe={},$rootScope.backdropOn=!1,$scope.submitEmailSubscription=function(){$scope.errorMessage=null,$scope.subscribeDone=null;var submitURL=getAbsoluteURL()+"LCEmailSubscription",data={preregister:$scope.subscribe.preregister,addressType:$scope.subscribe.addressType,canAddOrigin:$scope.subscribe.canAddOrigin,optinStatus:$scope.subscribe.optinStatus,URL:$scope.subscribe.URL,storeId:$scope.subscribe.storeId,langId:$scope.subscribe.langId,emailType:$scope.subscribe.emailType,showRegister:$scope.subscribe.showRegister,email:$scope.subscribe.enteredEmail};data["lcGeneralEmailOptIn_"+$scope.subscribe.storeId+"_r_1"]=$scope.subscribe.lcGeneralEmailOptIn,data["ageCheck_"+$scope.subscribe.storeId+"_r_1"]=$scope.subscribe.ageCheck,$scope.subscribe.enteredEmail?$http.post(submitURL,$httpParamSerializer(data),{headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then((function(response){if(200==response.status&&300==response.data.status)$log.log(response.data.message),errorMessage=response.data.message,$scope.errorMessage="The email address you provided is already subscribed.";else if(200==response.status&&"Success"==response.data.message){var trimmedLowerMail="";data.email&&(trimmedLowerMail=data.email.trim().toLowerCase()),tealium_data2track.push({id:"SignupForm",User_Email_MD5:MD5(data.email),User_Email_SHA256:sha256(trimmedLowerMail)});try{var eaactivityCookie=$cookies.get("eaactivity");$window.eaaccess&&!0===$window.eaaccess&&!eaactivityCookie&&(document.cookie="eaactivity=true; max-age=2592000; path=/",PromoPopupService.removeMinimizedPopup(),$window.location.reload())}catch(e){$log.info("eaaccess is disabled")}$log.log(response.statusText),$scope.subscribeDone="Thank you for signing up for emails!"}else 200==response.status&&400==response.data.status&&"Invalid email address supplied."==response.data.message?($log.log(response.data.message),$scope.errorMessage="Please enter a valid e-mail address"):null!=$scope.subscribe.enteredEmail&&($log.log(response.data.message),$scope.errorMessage="Email Subscription Error")})):$scope.errorMessage="Please enter an email address."},$scope.selectOtherBrand=function(){$scope.selectOtherBrandVal=0==$scope.selectOtherBrandVal?1:0,$scope.selectOtherBrandVal&&$("html, body").animate({scrollTop:$(document).height()},300)},$scope.initLanguageSwitcher=function(){var currLanguageLi=null,host=window.location.host;-1!==host.indexOf("lenscrafters.com")?"www.lenscrafters.com"==host?($scope.selectedLang="UNITED STATES (English)",currLanguageLi=0):"es.lenscrafters.com"==host?($scope.selectedLang="UNITED STATES (Espa&ntilde;ol)",currLanguageLi=1):($scope.selectedLang="UNITED STATES (English)",currLanguageLi=0):-1!==host.indexOf("lenscrafters.ca")?"www.lenscrafters.ca"==host?($scope.selectedLang="CANADA (English)",currLanguageLi=2):"fr.lenscrafters.ca"==host||"fr-uat.lenscrafters.ca"==host?($scope.selectedLang="CANADA (Fran&ccedil;aise)",currLanguageLi=3):($scope.selectedLang="CANADA (English)",currLanguageLi=2):($scope.selectedLang="UNITED STATES (English)",currLanguageLi=0),$(".lang-pop ul li").eq(currLanguageLi).find("a").addClass("selected")},$scope.initLanguageSwitcher(),$scope.langselectionFn=function(){$scope.langselection=0==$scope.langselection?1:0,$scope.langselection&&$("html, body").animate({scrollTop:$(document).height()},300)},$scope.asyncSVGLoader=function(){var isLocalStorage="localStorage"in window&&null!==window.localStorage,insertIT=function(data){document.body.insertAdjacentHTML("beforeend",data)};lcActionsModule.loadContent("X_SVG_Icons").then((function(data){!function(data){document.body?insertIT(data):document.addEventListener("DOMContentLoaded",insertIT)}(data),isLocalStorage&&(localStorage.setItem("inlineSVGdata",data),localStorage.setItem("inlineSVGrev",1))}))},angular.element(document).ready((function(){$scope.asyncSVGLoader()}))}]),app.controller("FindAStoreController",["$scope","$rootScope","$http","$window","$cookies","$filter","$log","$timeout","moment",function($scope,$rootScope,$http,$window,$cookies,$filter,$log,$timeout,moment){$scope.params={},$rootScope.currentStep=1,$rootScope.locationEntry="",$rootScope.stores=[],$rootScope.geoLocate=!1,$rootScope.locationWrongCountry=0,$scope.currentLocation=null,$scope.currentLocationEntry="",$scope.invalidateStoreCards=!1,$scope.noResults=!1,$scope.offset=0,$scope.moreInfoStoreIndex=-1,$scope.eyeExamInCalifornia=-1,$scope.eyeExamInTexasOrOklahoma=-1,$scope.selectedStoreIndex=-1,$scope.currentTimeOffset=0,$scope.seeMore=!1,$scope.lastLocation=null,$scope.defaultLanguage="English",$scope.storesLoading=!1,$scope.moreInfoLoading=-1,$scope.locationWrongCountryUrl=null,$scope.storeFavouriteLoading=-1,$scope.favouriteStoresAdded=0,$scope.fullscreenControlCreated=!1,$scope.isFullScreen=!1,$scope.areFiltersOpen=!1,$scope.isSortByOpen=!1,$scope.insuranceProviderInput="",$scope.insuranceProviderSelected=!1,$scope.insuranceProviderListVisible=!1,$scope.filters={openings:[{id:1,value:"Open today",selected:!1},{id:2,value:"Open weekends",selected:!1}],insuranceProviders:[],languages:[]},$scope.appliedFilters={},$scope.sortBy={selected:0,options:["Distance","Availability"]},$scope.map=null,$scope.markers=[],$scope.storeCards={collapsed:!1,slickCarousel:null,elem:null,wrapperElem:null,expandedPosition:0,collapsedPosition:0},$scope.specialCharsRegex=/^[^!@#$%^&*()_+\-=\[\]{};':"\\|.<>\/?]*$/,$scope.markerShape={coords:[0,0,36,36],type:"rect"},$scope.zoomLevel={disabled:10,group:13,store:15},$scope.defaultLocation=new google.maps.LatLng({lat:39.358056,lng:-84.311944}),$scope.disabledMapOptions={center:$scope.defaultLocation,zoom:$scope.zoomLevel.disabled,disableDefaultUI:!0,draggable:!1,scrollwheel:!1,gestureHandling:"none"},$scope.mapOptions={zoom:$scope.zoomLevel.group,disableDefaultUI:!1,zoomControl:!0,mapTypeControl:!1,fullscreenControl:!1,streetViewControl:!1,draggable:!0,clickableIcons:!1,scrollwheel:!0,gestureHandling:"greedy"},$scope.init=function(params){if($scope.params=angular.copy(params),$scope.params.isMobile)$scope.mapOptions.zoomControl=!1;else{var map=document.getElementsByClassName("map")[0];1==$rootScope.currentStep?$scope.map=new google.maps.Map(map,$scope.disabledMapOptions):$scope.map=new google.maps.Map(map,$scope.mapOptions)}var locationEntry=null;null!==(locationEntry=!$scope.params.fromHeader&&"HomePage"!=$scope.params.fromEspot||""===$scope.params.locationEntry?$scope.getLocationEntryCookie():$scope.params.locationEntry)&&($rootScope.locationEntry=locationEntry,$scope.submitCurrentForm()),angular.element(document.getElementById("storeFiltersForm")).on("click",(function(){$scope.areFiltersOpen&&$scope.insuranceProviderListVisible&&$scope.$apply((function(){$scope.insuranceProviderListVisible=!1}))}))},$scope.getLocationEntryCookie=function(){var locationEntry=null,cookieLocationEntry=$cookies.get("lc_location_entry");return cookieLocationEntry&&""!==cookieLocationEntry&&(locationEntry=cookieLocationEntry),locationEntry},$scope.setLocationEntryCookie=function(locationEntry){$cookies.put("lc_location_entry",locationEntry)},$scope.clearLocationEntryCookie=function(){$cookies.remove("lc_location_entry")},$scope.geolocate=function(){var geolocation=navigator.geolocation;geolocation?($scope.resetStores(),$rootScope.geolocateWatchId=geolocation.getCurrentPosition((function(position){$scope.currentLocation=new google.maps.LatLng({lat:parseFloat(position.coords.latitude),lng:parseFloat(position.coords.longitude)}),$scope.params.isMobile||($scope.map.center.latitude=$scope.currentLocation.lat(),$scope.map.center.longitude=$scope.currentLocation.lng()),$scope.findStores()}),(function(error){switch(error.code){case error.PERMISSION_DENIED:$log.warn("User denied the request for Geolocation");break;case error.POSITION_UNAVAILABLE:$log.error("Location information is unavailable");break;case error.TIMEOUT:$log.error("The request to get user location timed out");break;case error.UNKNOWN_ERROR:$log.error("An unknown error occurred")}}))):alert("Geolocation is not supported by this browser")},$scope.$watch("locationEntry",(function(newValue,oldValue){$scope.noResults&&newValue!==oldValue&&($scope.noResults=!1)})),$scope.performGeocode=function(callback){if(callback&&"function"==typeof callback){var geocoder=new google.maps.Geocoder;"10851"==$scope.params.storeId?geocoder.geocode({address:$scope.currentLocationEntry+"|country:US"},callback):geocoder.geocode({address:$scope.currentLocationEntry},callback)}},$scope.resetStores=function(){$scope.offset=0,$scope.totalCount=0,$rootScope.stores.length=0},$scope.findStores=function(form){if(form){if(form.$valid)$scope.currentLocationEntry=$rootScope.locationEntry,sessionStorage.setItem("Store_Search_Type","text"),sessionStorage.setItem("Store_Search_Keyword",$rootScope.locationEntry);else if(form.$invalid)return}else""==$scope.currentLocationEntry&&($scope.currentLocationEntry=$rootScope.locationEntry,sessionStorage.setItem("Store_Search_Type","geolocalized"),sessionStorage.setItem("Store_Search_Keyword","geolocalized"));0==$scope.seeMore&&$scope.resetStores(),null==$scope.currentLocation?($rootScope.geoLocate=!1,$scope.performGeocode((function(response,status){if("OK"==status&&response.length){if($scope.currentLocation=new google.maps.LatLng({lat:response[0].geometry.location.lat(),lng:response[0].geometry.location.lng()}),"10852"==$scope.params.storeId)for(i in response[0].address_components)if($rootScope.locationWrongCountry=0,"US"==response[0].address_components[i].short_name&&response[0].address_components[i].types.includes("country")){$rootScope.locationWrongCountry=1,locationWrongCountryUrl=$scope.getWrongCountryUrl(!0),$scope.currentLocation=null,$(".wrongCountryError").html(locationWrongCountryUrl),$(".wrongCountryError").removeClass("hide");break}null!=$rootScope.locationWrongCountry&&0==$rootScope.locationWrongCountry&&($(".wrongCountryError").addClass("hide"),$scope.loadStores())}else $scope.$apply((function(){$scope.noResults=!0})),obj={id:"Exam-Funnel-FindStore",Store_Search_Keyword:sessionStorage.Store_Search_Keyword,Store_Search_Type:sessionStorage.Store_Search_Type,Store_Search_ResultItemsQnt:"0"},tealium_data2track.push(obj)}))):($(".wrongCountryError").addClass("hide"),sessionStorage.setItem("Store_Search_Type","geolocalized"),sessionStorage.setItem("Store_Search_Keyword","geolocalized"),$rootScope.geoLocate=!0,$scope.loadStores())},$scope.createFavouriteStoreTip=function(event){$scope.cancelFavouriteStoreTip();var el=angular.element(event.srcElement||event.target)[0],tooltipWrap=document.createElement("div");tooltipWrap.className="tooltip",tooltipWrap.appendChild(document.createTextNode("My favourite store"));var firstChild=document.body.firstChild;firstChild.parentNode.insertBefore(tooltipWrap,firstChild);var linkBounds=el.getBoundingClientRect(),tooltipBounds=tooltipWrap.getBoundingClientRect(),topPos=linkBounds.top+$window.scrollY-(tooltipBounds.height+5);tooltipWrap.setAttribute("style","top:"+topPos+"px; left:"+linkBounds.left+"px;")},$scope.cancelFavouriteStoreTip=function(){var tooltip=document.querySelector(".tooltip");tooltip&&tooltip.remove()},$scope.loadStores=function(){$scope.storesLoading=!0;var data={selectedOpeningFilters:getSelectedOpeningFilters(),selectedInsuranceFilters:getSelectedInsuranceFilters(),selectedLanguageFilters:getSelectedLanguageFilters()};$http.post("/wcs/resources/store/"+$scope.params.storeId+"/storelocator/filtered/latitude/"+$scope.currentLocation.lat()+"/longitude/"+$scope.currentLocation.lng()+"?pageSize="+$scope.params.pageSize+"&offset="+$scope.offset,data).then((function(response){if(null!=response&&null!=response.data&&null!=response.data.PhysicalStore){var stores=angular.copy($rootScope.stores);$scope.favouriteStoresAdded=0;for(var i=0;i<response.data.PhysicalStore.length;i++){var physicalStore=response.data.PhysicalStore[i];physicalStore.scheduleURL=decodeURIComponent($scope.scheduleBaseURL).replace("#storeNumber#",physicalStore.storeName),physicalStore.showUniqueAppointmentAction=$scope.showUniqueAppointmentAction(),physicalStore.eyeExamOnline=$scope.isOnlineExamAvailable(physicalStore),physicalStore.appointmentOnline=$scope.isOnlineAppointmentAvailable(physicalStore),physicalStore.storeHours=$scope.getStoreHours(physicalStore),physicalStore.storeStatusClass=$scope.getStoreStatusClass(physicalStore),physicalStore.doctorInfo={},physicalStore.doctorInfo.doctors=[],physicalStore.x_userId&&$scope.favouriteStoresAdded++,0!=i||!areFiltersEmpty($scope.filters)&&$scope.currentLocationEntry===$scope.getLocationEntryCookie()||populateAvailableFilters(physicalStore),stores.push(physicalStore)}$rootScope.stores=angular.copy(stores),areFiltersEmpty($scope.appliedFilters)||($scope.filters=angular.copy($scope.appliedFilters)),$scope.totalCount=response.data.recordSetTotal,sessionStorage.setItem("Store_Search_ResultItemsQnt",$scope.totalCount),obj={id:"Exam-Funnel-FindStore",Store_Search_Keyword:sessionStorage.Store_Search_Keyword,Store_Search_Type:sessionStorage.Store_Search_Type,Store_Search_ResultItemsQnt:sessionStorage.Store_Search_ResultItemsQnt},tealium_data2track.push(obj),$scope.noResults=!1,$scope.storesLoading=!1,$scope.params.isMobile?($scope.seeMore||$scope.currentLocationEntry!==$scope.getLocationEntryCookie()||2==$scope.storeResultsTab?$scope.invalidateStoreCards=!0:$scope.invalidateStoreCards=!1,$scope.storeResultsTab&&2==$scope.storeResultsTab?($scope.reinitStoreCards(),$scope.setMarkers(),$scope.map.panTo($scope.currentLocation)):$scope.storeResultsTab=1):($scope.map.setOptions($scope.mapOptions),$scope.createFullscreenControl(),$scope.setMarkers(),$scope.map.panTo($scope.currentLocation)),$scope.setLocationEntryCookie($scope.currentLocationEntry),$scope.seeMore&&($scope.seeMore=!1),$scope.lastLocation=$scope.currentLocation,$scope.currentLocation=null,$rootScope.currentStep=2,$scope.params.isMobile&&($(".store-results-tabs").removeClass("hidden"),$(".store-results-tabs-content").removeClass("hidden"))}else $scope.currentLocation=null,$scope.noResults=!0,$scope.params.isMobile&&($scope.setStoreResultTab(1),$(".store-results-tabs").addClass("hidden"),$(".store-results-tabs-content").addClass("hidden")),obj={id:"Exam-Funnel-FindStore",Store_Search_Keyword:sessionStorage.Store_Search_Keyword,Store_Search_Type:sessionStorage.Store_Search_Type,Store_Search_ResultItemsQnt:"0"},tealium_data2track.push(obj)}),(function(error){$log.error(error)}))},$scope.toggleStoreFavourite=function(storeIndex){var store=$rootScope.stores[storeIndex],path="/wcs/resources/store/"+$scope.params.storeId+"/favouritestore/addfavourite";$scope.storeFavouriteLoading=storeIndex,void 0===store.x_userId?$http.post(path,{storeLocId:store.uniqueID,storeNickName:""},storeIndex).then((function(response){response.data&&($rootScope.stores[storeIndex].x_userId=response.data.user,$scope.storeFavouriteLoading=-1,$scope.favouriteStoresAdded++)}),(function(error){$log.error(error)})):(path="/wcs/resources/store/"+$scope.params.storeId+"/favouritestore/removefavourite/storelocid/"+store.uniqueID,$http.delete(path,storeIndex).then((function(response){response.data&&(delete $rootScope.stores[storeIndex].x_userId,$scope.storeFavouriteLoading=-1,$scope.favouriteStoresAdded--)}),(function(error){$log.error(error)})))};var populateAvailableFilters=function(store){if(store&&(store.x_availableInsuranceFilters||store.x_availableLanguageFilters)){if($scope.filters={openings:[{id:1,value:"Open today",selected:!1},{id:2,value:"Open weekends",selected:!1}],insuranceProviders:[],languages:[]},store.x_availableInsuranceFilters)for(var availableInsuranceFilters=store.x_availableInsuranceFilters.split(","),i=0;i<availableInsuranceFilters.length;i++){var availableInsuranceFilter=availableInsuranceFilters[i].trim();0!==availableInsuranceFilter.length&&$scope.filters.insuranceProviders.push({id:i+1,value:availableInsuranceFilter,selected:!1})}if(store.x_availableLanguageFilters){var availableLanguageFilters=store.x_availableLanguageFilters.split(",");for(i=0;i<availableLanguageFilters.length;i++){var availableLanguageFilter=availableLanguageFilters[i].trim();0!==availableLanguageFilter.length&&$scope.filters.languages.push({id:i+1,value:availableLanguageFilter,selected:!1})}}}},areFiltersEmpty=function(filters){return!(void 0!==filters.insuranceProviders&&0!=filters.insuranceProviders.length||void 0!==filters.languages&&0!=filters.languages.length)};$scope.toggleInsuranceProvider=function(oldInsuranceProvider){$scope.insuranceProviderSelected=!1;for(var i=0;i<$scope.filters.insuranceProviders.length;i++)$scope.filters.insuranceProviders[i].id!==oldInsuranceProvider.id?$scope.filters.insuranceProviders[i].selected=!1:($scope.filters.insuranceProviders[i].selected=!oldInsuranceProvider.selected,$scope.filters.insuranceProviders[i].selected&&($scope.insuranceProviderInput=$scope.filters.insuranceProviders[i].value,$scope.insuranceProviderSelected=!0));$scope.insuranceProviderListVisible=!1},$scope.clearFilters=function(){for(var i=0;i<$scope.filters.openings.length;i++)$scope.filters.openings[i].selected=!1;for(var j=0;j<$scope.filters.insuranceProviders.length;j++)$scope.filters.insuranceProviders[j].selected=!1;for(var k=0;k<$scope.filters.languages.length;k++)$scope.filters.languages[k].selected=!1},$scope.applyFilters=function(){$scope.appliedFilters=angular.copy($scope.filters),$log.info($scope.appliedFilters),$scope.areFiltersOpen=!1,$scope.findStores()};var getSelectedOpeningFilters=function(){var selectedOpeningFilters=[];return $scope.appliedFilters.openings&&(selectedOpeningFilters=$scope.appliedFilters.openings.filter((function(opening){return opening.selected})).map((function(opening){return opening.value}))),selectedOpeningFilters},getSelectedInsuranceFilters=function(){var selectedInsuranceFilters=[];return $scope.appliedFilters.insuranceProviders&&(selectedInsuranceFilters=$scope.appliedFilters.insuranceProviders.filter((function(insuranceProvider){return insuranceProvider.selected})).map((function(insuranceProvider){return insuranceProvider.value}))),selectedInsuranceFilters},getSelectedLanguageFilters=function(){var selectedLanguageFilters=[];return $scope.appliedFilters.languages&&(selectedLanguageFilters=$scope.appliedFilters.languages.filter((function(language){return language.selected})).map((function(language){return language.value}))),selectedLanguageFilters};$scope.isOnlineExamAvailable=function(store){var available=!1;return store.Attribute.forEach((function(attribute){"onlineAppt"==attribute.name&&"Y"==attribute.value&&(available=!0)})),available},$scope.isOnlineAppointmentAvailable=function(store){var available=!1;return store.Attribute.forEach((function(attribute){"bookingAppt"==attribute.name&&"Y"==attribute.value&&(available=!0)})),available},$scope.showUniqueAppointmentAction=function(store){var uniqueButton=$.cookie("lc_bte_uniqueappointment");return uniqueButton&&"true"===uniqueButton},$scope.storeBookingPreConf=function(store){var uniqueButton=$.cookie("lc_bte_uniqueappointment");if(uniqueButton&&"true"===uniqueButton)$(".store-booking-content_option-right > .store-booking-content_options-rectangle").attr("href","/BookingDisplayView?storeNumber="+store.storeName),$("#popupStoreBooking").show();else{var urlRedirect="/BookingDisplayView?storeNumber="+store.storeName;location.href=urlRedirect}},$scope.createFullscreenControl=function(){if(!$scope.fullscreenControlCreated){$scope.fullscreenControlCreated=!0;var fullscreenControlElem=document.createElement("button");fullscreenControlElem.classList.add("fullscreen-button");var findAStoreWrapperElem=document.getElementsByClassName("find-a-store")[0];angular.element(findAStoreWrapperElem).on("webkitfullscreenchange mozfullscreenchange fullscreenchange",(function(event){event=event||window.event,$log.info(event),$scope.isFullScreen||document.fullscreenElement&&document.mozFullScreenElement&&document.webkitFullscreenElement&&document.msFullscreenElement?(fullscreenControlElem.classList.remove("expanded"),$scope.$apply((function(){$scope.isFullScreen=!1}))):(fullscreenControlElem.classList.add("expanded"),$scope.$apply((function(){$scope.isFullScreen=!0})))})),fullscreenControlElem.addEventListener("click",(function(event){toggleFullscreen()})),$scope.map.controls[google.maps.ControlPosition.TOP_RIGHT].push(fullscreenControlElem)}};var toggleFullscreen=function(){if(!$scope.params.isMobile){var findAStoreWrapperElem=document.getElementsByClassName("find-a-store")[0];$scope.isFullScreen||document.fullscreenElement&&document.mozFullScreenElement&&document.webkitFullscreenElement&&document.msFullscreenElement?document.exitFullscreen?document.exitFullscreen():document.msExitFullscreen?document.msExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen():findAStoreWrapperElem.requestFullscreen?findAStoreWrapperElem.requestFullscreen():findAStoreWrapperElem.mozRequestFullScreen?findAStoreWrapperElem.mozRequestFullScreen():findAStoreWrapperElem.webkitRequestFullscreen?findAStoreWrapperElem.webkitRequestFullscreen():findAStoreWrapperElem.msRequestFullscreen&&findAStoreWrapperElem.msRequestFullscreen()}};$scope.toggleFilters=function($event){$event.preventDefault(),$scope.areFiltersOpen=!$scope.areFiltersOpen,$scope.insuranceProviderListVisible=!1},$scope.toggleSortBy=function($event){$event.preventDefault(),$scope.isSortByOpen=!0},$scope.changeSortBy=function(index){$scope.sortBy.selected=index,$scope.isSortByOpen=!1},$scope.setStoreResultTab=function(tabIndex){if($scope.params.isMobile&&$scope.storeResultsTab!==tabIndex){function validateStoreCards(){$scope.currentLocationEntry!==$scope.getLocationEntryCookie()?$scope.invalidateStoreCards=!0:$scope.invalidateStoreCards=!1}if($scope.storeResultsTab=tabIndex,1==tabIndex)$scope.setScrollLock(!1),validateStoreCards();else if(2==tabIndex){if($scope.setScrollLock(!0),!$scope.map){var map=document.getElementsByClassName("map")[0];if($scope.map=new google.maps.Map(map,$scope.mapOptions),null==$scope.map)return $scope.currentLocation=null,$scope.noResults=!0,$scope.setStoreResultTab(1),$(".store-results-tabs").addClass("hidden"),void $(".store-results-tabs-content").addClass("hidden");$scope.map.addListener("click",(function(){$scope.toggleStoreCards(!1)})),$scope.map.addListener("dragstart",(function(){$scope.toggleStoreCards(!1)}))}$scope.reinitStoreCards(),angular.element($window).off("resize.findastore"),angular.element($window).on("resize.findastore",(function(){validateStoreCards(),google.maps.event.trigger($scope.map,"resize"),$scope.reinitStoreCards()})),$scope.setMarkers(),$scope.map.setOptions($scope.mapOptions)}}},$scope.reinitStoreCards=function(){return $timeout((function(){if($scope.params.isMobile){$scope.storeCards.elem=angular.element(document.getElementsByClassName("store-cards")[0]),$scope.storeCards.wrapperElem=angular.element(document.getElementsByClassName("store-cards-wrapper")[0]),$scope.storeCards.slickCarousel&&($scope.storeCards.elem.off("afterChange touchstart touchmove touchend"),$scope.storeCards.elem.slick("unslick"),$scope.storeCards.elem.off("destroy"),$scope.storeCards.slickCarousel=null),$scope.storeCards.slickCarousel=$scope.storeCards.elem.slick({centerMode:!0,centerPadding:"25px",arrows:!1,infinite:!1}),$scope.moveToStore(0),$scope.storeCards.elem.on("afterChange",(function(slick,currentSlide,nextSlide){$scope.moveToStore(currentSlide.currentSlide)})),$scope.storeCards.elem.on("destroy",(function(event,slick){$scope.invalidateStoreCards&&slick.$slides.remove()}));var mapContainerTop=$scope.storeCards.wrapperElem[0].parentElement.offsetTop,mapContainerHeight=$scope.storeCards.wrapperElem[0].parentElement.clientHeight,storeCardsWrapperTop=mapContainerTop+$scope.storeCards.wrapperElem[0].offsetTop,storeCardsWrapperBottom=document.documentElement.clientHeight,storeCardsWrapperHeight=$scope.storeCards.wrapperElem[0].clientHeight,collapsedBottomOffset=Math.round(.3*storeCardsWrapperHeight),collapsedThreshold=storeCardsWrapperTop+Math.round(.5*storeCardsWrapperHeight);$scope.storeCards.expandedPosition=Math.round(.5*Math.min(mapContainerHeight,storeCardsWrapperBottom-mapContainerTop)),$scope.storeCards.collapsedPosition=storeCardsWrapperBottom-collapsedBottomOffset-mapContainerTop;var touchData={distXThreshold:10,distYThreshold:25,distTimeThreshold:200,startX:null,startY:null,startTime:null,endX:null,endY:null,endTime:null,distX:null,dirX:null,distY:null,dirY:null,distTime:null};$scope.storeCards.elem.on("touchstart",(function(e){var touches=e.originalEvent.changedTouches;if(1==touches.length){var touch=touches[0];$scope.storeCards.wrapperElem.stop(),touchData.startX=touch.clientX,touchData.startY=touch.clientY,touchData.startTime=(new Date).getTime()}})),$scope.storeCards.elem.on("touchmove",(function(e){e.preventDefault();var touches=e.originalEvent.changedTouches;if(1==touches.length){var touch=touches[0],currentDistX=Math.abs(touch.clientX-touchData.startX);Math.abs(touch.clientY-touchData.startY)>currentDistX&&touch.clientY>=storeCardsWrapperTop&&touch.clientY<=storeCardsWrapperBottom-collapsedBottomOffset&&($scope.storeCards.wrapperElem[0].style.top=touch.clientY-mapContainerTop+"px")}})),$scope.storeCards.elem.on("touchend",(function(e){var touches=e.originalEvent.changedTouches;if(1==touches.length){var touch=touches[0];touchData.endX=touch.clientX,touchData.endY=touch.clientY,touchData.endTime=(new Date).getTime(),touchData.distX=Math.abs(touchData.endX-touchData.startX),touchData.distY=Math.abs(touchData.endY-touchData.startY),touchData.dirX=Math.sign(touchData.endX-touchData.startX),touchData.dirY=Math.sign(touchData.endY-touchData.startY),touchData.distTime=touchData.endTime-touchData.startTime,touchData.distY>touchData.distX?touchData.distTime<=touchData.distTimeThreshold&&touchData.distY>=touchData.distYThreshold?touchData.dirY<0?$scope.toggleStoreCards(!0,touchData.distTime):touchData.dirY>=0&&$scope.toggleStoreCards(!1,touchData.distTime):touchData.endY<collapsedThreshold?$scope.toggleStoreCards(!0,touchData.distTime):touchData.endY>=collapsedThreshold&&$scope.toggleStoreCards(!1,touchData.distTime):touchData.endY>collapsedThreshold&&touchData.distX<touchData.distXThreshold&&$scope.toggleStoreCards(!0)}})),$scope.toggleStoreCards(!1,1)}}))},$scope.toggleStoreCards=function(open,delay,callback){if($scope.params.isMobile&&$scope.storeCards.slickCarousel){delay||(delay=500),$scope.storeCards.wrapperElem.animate({top:open?$scope.storeCards.expandedPosition:$scope.storeCards.collapsedPosition+"px"},delay,(function(){$scope.storeCards.collapsed=!open,callback&&"function"==typeof callback&&callback()}))}},$scope.moveToStore=function(index){$scope.storesLoading||($scope.currentLocation=new google.maps.LatLng({lat:parseFloat($rootScope.stores[index].latitude),lng:parseFloat($rootScope.stores[index].longitude)}),$scope.toggleMarkerIcon(index),$scope.map.setZoom($scope.zoomLevel.store),$scope.map.panTo($scope.currentLocation),$scope.selectedStoreIndex=index,$scope.currentLocation=null)},$scope.scrollToStore=function(id){var storeElem=document.getElementById("store-"+id),storeList=storeElem.parentElement;$scope.$apply((function(){$scope.selectedStoreIndex=id-1})),$scope.toggleMarkerIcon(id-1),$(storeList).animate({scrollTop:storeElem.offsetTop-storeList.offsetTop})},$scope.scrollToStoreCard=function(id){$scope.params.isMobile&&$scope.storeCards.elem.slick("slickGoTo",id-1)},$scope.clearMarkers=function(){for(var i=0;i<$scope.markers.length;i++)$scope.markers[i].setMap(null);$scope.markers.length=0},$scope.setMarkers=function(){$scope.clearMarkers();for(var bounds=new google.maps.LatLngBounds,image={url:$scope.storeLocationIcon,size:new google.maps.Size(36,36),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(0,36)},i=0;i<$rootScope.stores.length;i++){var store=$rootScope.stores[i],marker=new google.maps.Marker({position:{lat:parseFloat(store.latitude),lng:parseFloat(store.longitude)},map:$scope.map,icon:image,shape:$scope.markerShape,title:store.Description.displayStoreName,zIndex:0,storeIndex:i+1});marker.addListener("click",(function(){$scope.params.isMobile?$scope.scrollToStoreCard(this.storeIndex):$scope.scrollToStore(this.storeIndex)})),google.maps.event.addListener(marker,"highlight",(function(highlight){highlight?(this.setIcon($scope.storeLocationIconHighlight),this.setShape($scope.markerShape),this.setZIndex(1)):(this.setIcon($scope.storeLocationIcon),this.setShape($scope.markerShape),this.setZIndex(0))})),$scope.markers.push(marker),bounds.extend(marker.getPosition())}$scope.map.fitBounds(bounds)},$scope.toggleMarkerIcon=function(index){for(i=0;i<$scope.markers.length;i++)google.maps.event.trigger($scope.markers[i],"highlight",i==index)},$scope.getDirections=function(index){var directionsUrl="https://www.google.com/maps/dir/?api=1&destination=",selectedStore=$rootScope.stores[index];selectedStore&&(directionsUrl+=encodeURIComponent(selectedStore.addressLine[0].trim()+","+selectedStore.city.trim()+","+selectedStore.stateOrProvinceName.trim()+","+selectedStore.postalCode.trim()),$window.open(directionsUrl,"_blank"))},$scope.showMoreInfo=function(index){function populateMoreInfo(){$rootScope.stores[index].storeServices||($rootScope.stores[index].storeServices=$scope.getStoreServices(index)),$rootScope.stores[index].featuredBrands||($rootScope.stores[index].featuredBrands=$scope.getFeaturedBrands(index)),$scope.params.isMobile&&$scope.setScrollLock(!0),$scope.moreInfoStoreIndex=index,$scope.moreInfoLoading=-1}$scope.moreInfoTab=1,$scope.examStoreServices=1,$scope.doctorInfo={},$scope.doctorInfo.doctors=[],0==$rootScope.stores[index].doctorInfo.doctors?($scope.moreInfoLoading=index,$scope.getStoreDoctorInfo(index).then((function(response){response.data&&($rootScope.stores[index].doctorInfo=response.data.response.data,$rootScope.stores[index].doctorInfo.examServicies=$scope.decodeServices($rootScope.stores[index].doctorInfo.examServicies)),$scope.getPracticeHours(index).then((function(response){if(response.data&&response.data.doctors&&response.data.doctors.length>0)for(i=0;i<$rootScope.stores[index].doctorInfo.doctors.length;i++){var doctorFound=response.data.doctors.find((item=>item.doctorId==$rootScope.stores[index].doctorInfo.doctors[i].doctorId));doctorFound&&($rootScope.stores[index].doctorInfo.doctors[i].stateLicense=doctorFound.stateLicense?doctorFound.stateLicense:"",$rootScope.stores[index].doctorInfo.doctors[i].npi=doctorFound.npi?doctorFound.npi:"","Y"===doctorFound.newPatients?$rootScope.stores[index].doctorInfo.doctors[i].newPatients="Yes":$rootScope.stores[index].doctorInfo.doctors[i].newPatients="No")}response.data&&response.data.examHours&&response.data.examHours.length>0&&($rootScope.stores[index].practiceHours=response.data.examHours),populateMoreInfo()}),(function(error){populateMoreInfo(),$log.warn("Unable to retrieve practice hours"),$scope.moreInfoLoading=-1}))}),(function(error){$log.warn("Unable to retrieve doctor info"),$scope.moreInfoLoading=-1}))):populateMoreInfo()},$scope.calculateMoreInfoTabsTopPos=function(){var timerCounts=1,moreInfoContainerIsVisible=setInterval((function(){if((timerCounts+=1)>10&&clearInterval(moreInfoContainerIsVisible),$(".more-info-container").is(":visible")){clearInterval(moreInfoContainerIsVisible);var topElement=$(".more-info-modal .more-info-row").eq(1),topElementBottomPosition=topElement.position().top+topElement.outerHeight(!0)+10;$(".more-info-modal .more-info-row  .store-hours .more-info-store-same-week-hours-container").length>0?(topElementBottomPosition+=90,$(".more-info-row.more-info-tabs-content").css("margin-top",0)):$(".more-info-row.more-info-tabs-content").css("margin-top",50),$(".more-info-row.more-info-tabs").css("top",topElementBottomPosition)}}),1e3)},$scope.hideMoreInfo=function(){$scope.moreInfoTab=1,$scope.params.isMobile&&$scope.setScrollLock(!1),$scope.moreInfoStoreIndex=-1,document.querySelector("#tab1").click()},$scope.getStoreHours=function(store){var storeHours=[];if(store)return angular.forEach(store.Attribute,(function(value,key){if("StoreHours"==value.displayName&&""!==value.displayValue)for(var days=value.displayValue.split(";"),i=0;i<days.length;i++){var hours=days[i].split("-");this.push([]);for(var j=0;j<hours.length;j++)this[i].push(hours[j].trim())}}),storeHours),storeHours},$scope.getStoreServices=function(index){var storeServices=[],selectedStore=$rootScope.stores[index];return selectedStore&&angular.forEach(selectedStore.Attribute,(function(value,key){value.displayName.startsWith("Service")&&""!==value.displayValue&&this.push(value.displayValue)}),storeServices),storeServices},$scope.getFeaturedBrands=function(index){var featuredBrands=[],selectedStore=$rootScope.stores[index];return selectedStore&&angular.forEach(selectedStore.Attribute,(function(value,key){"FrameBrands"==value.displayName&&angular.copy(value.displayValue.split(";"),this)}),featuredBrands),featuredBrands},$scope.getStoreStatusClass=function(store){var storeStatus=null,lastRemodel=null,openDate=null,reopenDate=null,lastMovedDate=null,storeStatusClass="";if(store){if(angular.forEach(store.Attribute,(function(value,key){"StoreStatus"==value.displayName&&null==storeStatus&&(storeStatus=value.displayValue),"LastRemodel"==value.displayName&&null==lastRemodel&&(lastRemodel=value.displayValue),"OpenDate"==value.displayName&&null==openDate&&(openDate=value.displayValue),"ReOpenDate"==value.displayName&&null==reopenDate&&(reopenDate=value.displayValue),"LastMoveDate"==value.displayName&&null==lastMovedDate&&(lastMovedDate=value.displayValue)}),storeStatus),null!==storeStatus)switch(storeStatus){case"U":storeStatusClass="coming-soon";break;case"T":storeStatusClass="temporary-closed";break;case"C":storeStatusClass="store-closed";break;case"O":storeStatusClass=function(initOpenStatusClass){var openStatusClass=initOpenStatusClass;function checkTimeDiff(dateString,daysDiff,checkNow){var valid=!1,now=moment(),date=moment(dateString.trim(),"MM/DD/YYYY"),diff=now.diff(date,"days");return(checkNow?diff>=0:diff>0)&&diff<=daysDiff&&(valid=!0),valid}return null!==lastRemodel&&""!==lastRemodel&&checkTimeDiff(lastRemodel,180,!1)?openStatusClass="new-look":null!==openDate&&""!==openDate&&checkTimeDiff(openDate,180,!1)?openStatusClass="now-open":null!==lastMovedDate&&""!==lastMovedDate&&checkTimeDiff(lastMovedDate,365,!0)&&(openStatusClass="recently-moved"),openStatusClass}()}}return storeStatusClass},$scope.getStoreDoctorInfo=function(index){return $http.get("/wcs/resources/store/"+$scope.params.storeId+"/eappointment/"+$rootScope.stores[index].storeName+"/doctors")},$scope.getPracticeHours=function(index){return $http.get($scope.params.doctorPracticeURL+$rootScope.stores[index].storeName)},$scope.checkStoreOpen=function(now,dayIndex,store){if(now=now.utcOffset($scope.currentTimeOffset).format("HH:mm"),store.storeHours.length>0&&store.storeHours[dayIndex]){var open=moment(store.storeHours[dayIndex][0],"hh:mm a").format("HH:mm"),close=moment(store.storeHours[dayIndex][1],"hh:mm a").format("HH:mm");if(now>open&&now<close)return!0}return!1},$scope.getClosingTime=function(store){var dayIndex=moment().isoWeekday()-1,closingTime="";return store&&store.storeHours.length>0&&store.storeHours[dayIndex]&&(closingTime=store.storeHours[dayIndex][1]),closingTime},$scope.isEmpty=function(obj){for(var key in obj)if(obj.hasOwnProperty(key))return!1;return!0},$scope.getStoreAttributeDisplayValue=function(moreInfoStoreIndex,attrName){var selectedStore=$rootScope.stores[moreInfoStoreIndex];return $scope.isEmpty(selectedStore)?"":selectedStore.Attribute.find((a=>a.name===attrName))?selectedStore.Attribute.find((a=>a.name===attrName)).displayValue:""},$scope.parsePhoneNumber=function(phoneNumber){var parsedPhoneNumber="";return phoneNumber&&(parsedPhoneNumber=phoneNumber.replace("()","").replace(" ","-")),parsedPhoneNumber},$scope.showMoreLocations=function(){$scope.offset=$scope.offset+$scope.params.pageSize,$scope.seeMore=!0,$scope.currentLocation=$scope.lastLocation,$scope.findStores()},$scope.showStoreHours=function(store,dayIndex){var dayHours="Closed";if(store&&store.storeHours.length>0&&store.storeHours[dayIndex]){var open=store.storeHours[dayIndex][0],close=store.storeHours[dayIndex][1];open&&close&&(dayHours=open+" - "+close)}return dayHours},$scope.checkWeekHours=function(store){if(store)for(var dayIndex=0;dayIndex<5;dayIndex++)if(!angular.equals($scope.showStoreHours(store,dayIndex),$scope.showStoreHours(store,dayIndex+1)))return!0;return!1},$scope.parseDoctorsLanguages=function(languages){return null!==languages&&""!==languages?languages.toString().replace(/,/g,", "):$scope.defaultLanguage},$scope.setStoreDistance=function(store){sessionStorage.setItem("storeDistance",store.distance)},$scope.setEyeExamInCaliforniaIndex=function(index){$scope.eyeExamInCalifornia=index},$scope.setEyeExamInTexasOrOklahomaIndex=function(index){$scope.eyeExamInTexasOrOklahoma=index},$scope.EyeExamInCaliforniaRedirect=function(){var californiaURL=document.getElementsByName("californiaURL")[0].value;californiaURL=californiaURL.concat($scope.stores[$scope.eyeExamInCalifornia].storeName),$window.open(californiaURL),$scope.setEyeExamInCaliforniaIndex(-1)},$scope.EyeExamInTexasRedirect=function(){var texasURL=document.getElementsByName("texasURL")[0].value;texasURL=texasURL.concat($scope.stores[$scope.eyeExamInTexasOrOklahoma].storeName),$window.open(texasURL),$scope.setEyeExamInTexasOrOklahomaIndex(-1)},$scope.scrollToDoctorInfo=function(e){var selector="#doctorID_"+e.doctorId;0==$(selector).parent().parent().siblings().closest(".infoFocus").length&&$(".more-info-container-mobile").animate({scrollTop:$(selector).offset().top+300})},$scope.decodeServices=function(servicies){var decodedServices=servicies;for(service in servicies){var tempArea=document.createElement("textarea");tempArea.innerHTML=servicies[service].serviceName,decodedServices[service].serviceName=tempArea.value}return decodedServices},$scope.getWrongCountryUrl=function(fromCA){window.location.href;return fromCA?'Did you mean to go to <a href="'+window.location.href.substring(0,window.location.href.indexOf("en-ca")).concat("lc-us/eye-exam").replace(".ca",".com")+'">LensCrafters.com</a>?':'Did you mean to go to <a href="'+window.location.href.substring(0,window.location.href.indexOf("lc-us")).concat("en-ca/eye-exam").replace(".com",".ca")+'">LensCrafters.ca</a>?'},$scope.submitCurrentForm=function(){var currentForm=null;1==$rootScope.currentStep?currentForm=angular.element(document.getElementsByName("storeSearchForm")[0]):2==$rootScope.currentStep&&(currentForm=angular.element(document.getElementsByName("storeResultsSearchForm")[0])),null!==currentForm&&$timeout((function(){currentForm.triggerHandler("submit")}))},$scope.setScrollLock=function(lock){if($scope.params.isMobile){var htmlBodyElems=angular.element(document.querySelectorAll("html, body"));lock?htmlBodyElems.css({overflow:"hidden",position:"fixed",width:"100%",height:"100%"}):htmlBodyElems.css({overflow:"",position:"",width:"",height:""})}}}]),app.controller("FormComponentsController",["$scope","$rootScope",function($scope,$rootScope){}]),app.controller("InsuranceStepsCtrl",["$scope","$rootScope","$cookies","$log","lcInsurance",function($scope,$rootScope,$cookies,$log,lcInsurance){function personalFormFilled(){var data=$scope.loginData;return!!(data.firstname&&data.lastname&&data.dob&&data.zipcode&&$rootScope.selectedInsurancesProvider)}function planFormFilled(){var data=$scope.loginData;return!!data.memberid&&!!data.planid}function updateEligibility(){$rootScope.eligibility.frames=lcInsurance.checkSingleBenefit(lcInsurance.getBenefitCategories().FRAMES)||lcInsurance.checkSingleBenefit(lcInsurance.getBenefitCategories().FRAMES_ADD),$rootScope.eligibility.lenses=lcInsurance.checkSingleBenefit(lcInsurance.getBenefitCategories().LENSES)||lcInsurance.checkSingleBenefit(lcInsurance.getBenefitCategories().LENSES_ADD),$rootScope.eligibility.contacts=lcInsurance.checkSingleBenefit(lcInsurance.getBenefitCategories().CONTACT_LENSES),$rootScope.eligibility.exams=lcInsurance.checkSingleBenefit(lcInsurance.getBenefitCategories().EXAMS)}$rootScope.insuranceStep=1,$rootScope.insuranceLoginMod=1,$rootScope.documentMinSwipeX=10,$rootScope.documentSwipeRange=100,$rootScope.selectedInsurancesProvider=void 0,$rootScope.isUnselected=!1,$scope.isPresent=!1,$scope.loginData={firstname:"",lastname:"",dob:"",zipcode:"",memberid:"",planid:"",certifyage:!1},window.screen.width<=1024&&($rootScope.documentMinSwipeX=200,$rootScope.documentSwipeRange=0),$rootScope.eligibility={},$rootScope.isLoadingInsurance=!1,$rootScope.onSidebarOpen=function(){document.body.classList.add("hidden-overflow"),document.querySelector("html").classList.add("hidden-overflow")},$rootScope.onSidebarClose=function(){document.body.classList.remove("hidden-overflow"),document.querySelector("html").classList.remove("hidden-overflow")},lcInsurance.isLogged()&&(updateEligibility(),$rootScope.insuranceStep=4),$scope.validateInsuranceForm=function(){if($rootScope.insuranceStep=1)return!1;if($rootScope.insuranceStep=2){if(""!=insuranceLoginForm.planid.value&&""!=insuranceLoginForm.memberid.value&&insuranceLoginForm.planid.$valid&&insuranceLoginForm.memberid.$valid)return!0;obj={id:"Insurance-Tentative",Events_InsuranceTentative:"1",Order_InsuranceCode:$scope.$ctrl.insuranceProviders[$rootScope.selectedInsurancesProvider],Order_InsuranceMethod:insuranceMethod,Error_Source:"User",Error_Code:"Insurance - Invalid form",Error_Message:"Invalid form"},tealium_data2track.push(obj)}},$scope.personalFormRequired=function(){return!planFormFilled()},$scope.planFormRequired=function(){return!personalFormFilled()},$scope.submitInsuranceLogin=function(insuranceLoginFormController){if($log.info("Submit login"),$rootScope.isLoadingInsurance=!0,insuranceLoginFormController&&insuranceLoginFormController.$invalid&&($log.warn("insuranceLoginForm not valid",insuranceLoginFormController),$rootScope.isLoadingInsurance=!1,angular.forEach(insuranceLoginFormController.$error,(function(field){angular.forEach(field,(function(errorField){errorField.$setTouched()}))}))),$rootScope.isUnselected=!$rootScope.selectedInsurancesProvider,$scope.loginData.certifyage&&(personalFormFilled()||planFormFilled())){$rootScope.insuranceStep=2;var infoForm=planFormFilled()?"plan":"personal",data={planID:insuranceLoginForm.planid?insuranceLoginForm.planid.value:null,memberID:insuranceLoginForm.memberid?insuranceLoginForm.memberid.value:null,firstName:insuranceLoginForm.firstname.value,lastName:insuranceLoginForm.lastname.value,birth_month:insuranceLoginForm.dob.value.substring(0,2),birth_date:insuranceLoginForm.dob.value.substring(3,5),birth_year:insuranceLoginForm.dob.value.substring(6),zip:insuranceLoginForm.zipcode.value,infoForm:infoForm,provider:$rootScope.selectedInsurancesProvider?$scope.$ctrl.insuranceProviders[$rootScope.selectedInsurancesProvider].value:"EYEMED",storeId:10851};"AETNA"===data.provider&&(data.infoForm=null),"UHC"===data.provider&&(data.infoForm="personal"),$log.info("Insurance login call"),lcInsurance.login(data).then((function(response){$rootScope.isLoadingInsurance=!1,updateEligibility(),constants.ajaxParams.insuranceCheckEligibility=!0,$rootScope.insuranceStep=4;var benefits="",insuranceMethod="";$rootScope.eligibility.frames&&(benefits+="frames"),$rootScope.eligibility.lenses&&(""!=benefits&&(benefits+=","),benefits+="lenses"),$rootScope.eligibility.contacts&&(""!=benefits&&(benefits+=","),benefits+="contact"),$rootScope.eligibility.exams&&(""!=benefits&&(benefits+=","),benefits+="eye exam"),insuranceMethod=1==$rootScope.insuranceLoginMod?"standard":"memberid",sessionStorage.getItem("InsuranceMethod")||(sessionStorage.setItem("InsuranceMethod",insuranceMethod),obj={id:"Insurance-Applied",Events_InsuranceApplied:"1",Order_InsuranceCode:data.provider,Order_InsuranceMethod:insuranceMethod,Order_InsuranceBenefits:benefits},window.turnInsuranceOn(),tealium_data2track.push(obj))}),(function(error){var errorCode;if($rootScope.isLoadingInsurance=!1,error==lcInsurance.getErrors().INSURANCE_TENTATIVE_LIMIT_REACHED){errorCode="Insurance - Insurance account locked";try{(_dlCopy=$.extend(!0,{},null)).site_events={insurance_account_locked:"true",insurance_sync_failure:"true"},1==$rootScope.insuranceLoginMod?(_dlCopy.sync_method="personal information",_dlCopy.zip_code=$scope.loginData.zipcode):_dlCopy.sync_method="insurance information",callTrackAnalytics(_dlCopy)}catch(err){$log.error(err)}$rootScope.insuranceStep=5}else{errorCode="Insurance - User entered wrong data";try{var _dlCopy;(_dlCopy=$.extend(!0,{},null)).site_events={insurance_sync_failure:"true"},_dlCopy.failure_try_count=$cookies.get("tentative_user"),_dlCopy.failure_reason="user entered wrong data",1==$rootScope.insuranceLoginMod?(_dlCopy.sync_method="personal information",_dlCopy.zip_code=$scope.loginData.zipcode):_dlCopy.sync_method="insurance information";var orderInsuranceCode="Unknown";$scope.$ctrl.insuranceProviders[$rootScope.selectedInsurancesProvider].value&&(orderInsuranceCode=$scope.$ctrl.insuranceProviders[$rootScope.selectedInsurancesProvider].value);var insuranceMethod="Standard form";3==$rootScope.insuranceStep&&(insuranceMethod="MemberId form");$cookies.get("tentative_user");callTrackAnalytics(_dlCopy),obj={id:"Error",Events_Error:"1",Error_Source:"User",Error_Code:"Insurance",Error_Message:"Cannot find user profile ",Error_Details:"Cannot find user profile ",Order_InsuranceCode:orderInsuranceCode,Events_InsuranceTentative:3-$cookies.get("tentative_user"),Order_InsuranceMethod:insuranceMethod},tealium_data2track.push(obj)}catch(err){$log.error(err)}$rootScope.insuranceStep=3,$rootScope.insuranceLoginMod=2,setTimeout((function(){document.querySelector(".login-data-title").scrollIntoView({behavior:"smooth",block:"center"})}),1e3)}constants.ajaxParams.insuranceCheckEligibility=!1,obj={id:"Insurance-Tentative",Events_InsuranceTentative:"1",Order_InsuranceCode:data.provider,Order_InsuranceMethod:insuranceMethod,Error_Source:"User",Error_Code:errorCode,Error_Message:"We're having trouble finding you."},tealium_data2track.push(obj)}))}else $rootScope.isLoadingInsurance=!1,$log.warn("Invalid form"),2==$rootScope.insuranceLoginMod?(insuranceLoginForm.certifyage.focus(),insuranceLoginForm.planid.focus(),insuranceLoginForm.memberid.focus(),insuranceLoginForm.submitplaninfobutton.focus()):1==$rootScope.insuranceLoginMod&&(insuranceLoginForm.certifyage.focus(),insuranceLoginForm.firstname.focus(),insuranceLoginForm.lastname.focus(),insuranceLoginForm.dob.focus(),insuranceLoginForm.zipcode.focus(),insuranceLoginForm.submitplaninfobutton.focus())},$scope.trySyncAgain=function(mode){null==mode?$rootScope.insuranceStep=1:"plan-mode"==mode?($rootScope.insuranceLoginMod=2,$rootScope.insuranceStep=1):"personal-mode"==mode&&($rootScope.insuranceLoginMod=1,$rootScope.insuranceStep=1)},$scope.logoutInsurance=function(){lcInsurance.logout()&&($rootScope.insuranceStep=3)},$scope.openChat=function(){document.getElementsByClassName("close-ins")[0].click(),_genesys.widgets.bus.command("WebChat.open")},$rootScope.closeMobileInsuranceSidebar=function(){RiaHelper.isInsuranceOn()&&(0==document.getElementsByClassName("pdp-container").length?chooseInsurance(!0):0==document.getElementById("rxcApp").children.length&&document.getElementById("insurance-switch").click())},$scope.singleConfig={openOnFocus:!0,valueField:"key",maxItems:1,onChange:function(value){$scope.selectizeIsFocused=!1,$rootScope.selectedInsurancesProvider=value,$rootScope.isUnselected=""===value,$scope.$ctrl.insuranceProviders[$rootScope.selectedInsurancesProvider]&&!$scope.$ctrl.insuranceProviders[$rootScope.selectedInsurancesProvider].network&&$scope.oldSelectizeIsFocused!=$rootScope.selectedInsurancesProvider&&(obj={id:"Error",Error_Source:"User",Error_Code:"Insurance",Error_Message:"Out-of-network plan"},tealium_data2track.push(obj)),$scope.oldSelectizeIsFocused=$rootScope.selectedInsurancesProvider},onDropdownOpen:function(){$scope.$apply((function(){$scope.selectizeIsFocused=!0}))},onDropdownClose:function(){$scope.$apply((function(){$scope.selectizeIsFocused=!1}))},plugins:{no_results:{},clear_button:{className:"selectize-clear-button",label:'<svg class="icon close"><use xlink:href="#clear-input"></use></svg>'},input_label:{label:"Insurance provider"}}};var unregister=$scope.$watch((function(){return window.insuranceProviders}),(function(value){void 0!==value&&($rootScope.defaultLink=window.defaultLink,$rootScope.insuranceProviders=window.insuranceProviders,unregister(),favoriteProviders=["EyeMed","Aetna","Humana Vision","UnitedHealthcare Vision (UHC)","Cigna"],$rootScope.favoriteProviders=Object.values($rootScope.insuranceProviders).filter((v=>-1!=favoriteProviders.indexOf(v.text))).reduce(((m,p)=>(m[p.text]=p.key,m)),{}))}));$scope.maxDate=new Date,$scope.dateSet=void 0,$scope.dobDatePickerToggle=!1,$scope.dobDatePickerToggleFn=function(value=null){$scope.dobDatePickerToggle=null===value?!$scope.dobDatePickerToggle:value},$scope.isUHCProviderSelected=function(){var isUHC=!1;return $scope.$ctrl.insuranceProviders&&$rootScope.selectedInsurancesProvider&&$scope.$ctrl.insuranceProviders[$rootScope.selectedInsurancesProvider]&&"UHC"===$scope.$ctrl.insuranceProviders[$rootScope.selectedInsurancesProvider].value&&(isUHC=!0),isUHC}}]),app.directive("dobValidation",(function(){return{require:"ngModel",link:function(scope,element,attr,mCtrl){element.on("keydown",(function(e){e.keyCode;this.value.length>10?this.value=this.value.substr(0,10):10==this.value.length&&(e.keyCode>=48&&e.keyCode<=57||e.keyCode>=96&&e.keyCode)})),mCtrl.$parsers.push((function(value){var myDate=new Date(value),currDate=new Date;return 10==value.length&&"Invalid Date"!=myDate.toString()&&myDate<currDate?(mCtrl.$setValidity("dob",!0),scope.dobDatePickerToggleFn(!1)):(mCtrl.$setValidity("dob",!1),value.length>10&&(value=value.substr(0,10))),value}))}}})),app.controller("MyPaymentMethodsController",["$scope","$rootScope","$http","$window","$cookies","$log","$timeout","moment",function($scope,$rootScope,$http,$window,$cookies,$log,$timeout,moment){$scope.params={},$scope.hovering=!1,$scope.showAddPayment=!1,$scope.ccinfo={},$scope.invalidCard=!1,$scope.index=0,$scope.paymentLoaded=!1,$rootScope.paymentMethods=[],$rootScope.defaultPaymentMethod,$rootScope.expiredCard=!1,$rootScope.addingPayment=!1,$rootScope.removingPayment=!1,$scope.init=function(params){$scope.params=angular.copy(params),$scope.loadPaymentMethods()},$scope.loadPaymentMethods=function(){$http.get("/wcs/resources/store/"+$scope.params.storeId+"/mypayments/list/").then((function(response){null!=response.data.payments&&($rootScope.paymentMethods=response.data.payments,$rootScope.defaultPaymentMethod=response.data.defaultPayment,$scope.paymentLoaded=!0)}),(function(error){$log.error("Unable to load payment methods:"+error)}))},$scope.addCard=function(validCard){if(validCard&&!$rootScope.expiredCard){$rootScope.addingPayment=!0;var cc=$scope.ccinfo.number;null!=cc&&(cc=cc.replace(/\s/g,""));var expirationMonth=$scope.ccinfo.expiration.substring(0,2),expirationYear=$scope.ccinfo.expiration.substring(3,7),ccBrand=$scope.cardBrand(cc);if(null!=ccBrand&&null!=ccBrand&&""!=ccBrand){var data={billTo_city:$scope.ccinfo.city,billTo_country:$scope.ccinfo.country,billTo_email:$scope.ccinfo.email,billTo_firstName:$scope.ccinfo.firstname,billTo_lastName:$scope.ccinfo.lastname,billTo_postalCode:$scope.ccinfo.zip,billTo_state:$scope.ccinfo.state,billTo_street1:$scope.ccinfo.address,card_accountNumber:cc,card_cardType:ccBrand,card_expirationMonth:expirationMonth,card_expirationYear:expirationYear,cc_cvc:$scope.ccinfo.securityCode,recaptchaResponse:$scope.recaptchaResponse};$http.put("/wcs/resources/store/"+$scope.params.storeId+"/mypayments",data).then((function(response){"200"==response.status&&"100"==response.data.ccAuthReply_reasonCode?($rootScope.addingPayment=!1,$scope.loadPaymentMethods(),$scope.closePaymentModal(),$log.info("Payment method added")):($log.info("Payment method error"),$scope.invalidCard=!0,$rootScope.addingPayment=!1,$scope.checkCybersourceError(response.data.invalidField_0))}),(function(error){$log.error("Unable to add the payment method:"+error),$scope.invalidCard=!0,$rootScope.addingPayment=!1}))}else $log.info("Payment method error"),$scope.paymentForm.cardNumber.$setValidity("brand",!1),$rootScope.addingPayment=!1}else validCard||($log.info("Payment method error"),$rootScope.addingPayment=!1)},$scope.cardBrand=function(cardNum){var cardBrand;return/^4[0-9]{12}(?:[0-9]{3})?$/.test(cardNum)?$scope.params.visaEnabled&&(cardBrand="Visa"):/^(5[1-5][0-9]{14}|2(22[1-9][0-9]{12}|2[3-9][0-9]{13}|[3-6][0-9]{14}|7[0-1][0-9]{13}|720[0-9]{12}))$/.test(cardNum)?$scope.params.mastercardEnabled&&(cardBrand="Master Card"):/^3[47][0-9]{13}$/.test(cardNum)?$scope.params.amexEnabled&&(cardBrand="Amex"):/^(?:6011\d{12})|(?:65\d{14})$/.test(cardNum)?$scope.params.discoverEnabled&&(cardBrand="Discover"):/^(?:2131|1800|35[0-9]{3})[0-9]{11}$/.test(cardNum)&&$scope.params.jcbEnabled&&(cardBrand="JCB"),cardBrand},$scope.removeCard=function(index){0==$rootScope.removingPayment&&($rootScope.removingPayment=!0,index==$rootScope.defaultPaymentMethod&&$scope.setDefault(0),$http.delete("/wcs/resources/store/"+$scope.params.storeId+"/mypayments/"+index).then((function(response){"ACCEPT"==response.data.response.decision?($scope.loadPaymentMethods(),$log.info("Payment method removed"),$rootScope.removingPayment=!1):($log.warn("Unable to remove the payment method"),$rootScope.removingPayment=!1)}),(function(error){$log.error("Unable to remove the payment method:"+error),$rootScope.removingPayment=!1})))},$scope.setDefault=function(index){$http.post("/wcs/resources/store/"+$scope.params.storeId+"/mypayments/setdefault/"+index).then((function(response){"200"==response.status?($scope.loadPaymentMethods(),$log.info("Default payment updated")):$log.warn("Unable to update the default payment method")}),(function(error){$log.error("Unable to update the default payment method:"+error)}))},$scope.isExpiredCard=function(expiration){if(/^(0\d|1[0-2])\/\d{4}$/.test(expiration)){var expirationMonth=expiration.substring(0,2),expirationYear=expiration.substring(3,7),currentDate=new Date,currentMonth=String(currentDate.getMonth()+1).padStart(2,"0"),currentYear=currentDate.getFullYear().toString();$rootScope.expiredCard=!(expirationYear>currentYear)&&!(expirationYear==currentYear&&expirationMonth>=currentMonth)}else $rootScope.expiredCard=!0},$scope.closePaymentModal=function(){0==$rootScope.addingPayment&&($scope.invalidCard=!1,$scope.resetForm())},$scope.formatCardNumber=function(event,creditCard){var blocks;null!=creditCard&&(null!=event&&null!=event.keyCode&&(event.keyCode>=48&&event.keyCode<=57||event.keyCode>=96&&event.keyCode<=105)?creditCard.length<19?(blocks=creditCard.replace(/\W/gi,"").replace(/(.{4})/g,"$1 "),$scope.ccinfo.number=blocks):(blocks=creditCard.replace(/\W/gi,"").replace(/(.{4})/g,"$1 "),$scope.ccinfo.number=blocks.substring(0,19)):8!=event.keyCode&&(blocks=creditCard.replace(/\D/g,""),$scope.ccinfo.number=blocks.replace(/\W/gi,"").replace(/(.{4})/g,"$1 ")))},$scope.formatExpiration=function(event,expiration){var blocks;null!=expiration&&(null!=event&&null!=event.keyCode&&(event.keyCode>=48&&event.keyCode<=57||event.keyCode>=96&&event.keyCode<=105)?2==expiration.length&&(blocks=expiration.concat("/"),$scope.ccinfo.expiration=blocks):8==event.keyCode?$scope.ccinfo.expiration="":((blocks=expiration.replace(/\D/g,"")).length>1&&(blocks=[blocks.slice(0,2),"/",blocks.slice(2)].join("")),$scope.ccinfo.expiration=blocks))},$scope.formatCVV=function(CVV){null!=CVV&&($scope.ccinfo.securityCode=CVV.replace(/\D/g,""))},$scope.formatZIP=function(ZIP){null!=ZIP&&($scope.ccinfo.zip=ZIP.replace(/\D/g,""))},$scope.resetForm=function(){$scope.showAddPayment=!1,$scope.paymentForm.submitAttempt=!1,$scope.ccinfo={},$scope.ccinfo.firstname=null,$scope.ccinfo.lastname=null,$scope.ccinfo.number=null,$scope.ccinfo.expiration=null,$scope.ccinfo.securityCode=null,$scope.ccinfo.email=null,$scope.ccinfo.country=null,$scope.ccinfo.state=null,$scope.ccinfo.zip=null,$scope.ccinfo.city=null,$scope.ccinfo.address=null,$scope.paymentForm.$setPristine()},$scope.checkCybersourceError=function(error){switch(error){case"billTo_city":$scope.paymentForm.$setValidity("cybersource",!1),$scope.paymentForm.city.$setValidity("cybersource",!1);break;case"billTo_country":$scope.paymentForm.$setValidity("cybersource",!1),$scope.paymentForm.country.$setValidity("cybersource",!1);break;case"billTo_email":$scope.paymentForm.$setValidity("cybersource",!1),$scope.paymentForm.email.$setValidity("cybersource",!1);break;case"billTo_firstName":$scope.paymentForm.$setValidity("cybersource",!1),$scope.paymentForm.firstname.$setValidity("cybersource",!1);break;case"billTo_lastName":$scope.paymentForm.$setValidity("cybersource",!1),$scope.paymentForm.lastname.$setValidity("cybersource",!1);break;case"billTo_postalCode":$scope.paymentForm.$setValidity("cybersource",!1),$scope.paymentForm.zip.$setValidity("cybersource",!1);break;case"billTo_state":$scope.paymentForm.$setValidity("cybersource",!1),$scope.paymentForm.state.$setValidity("cybersource",!1);break;case"billTo_street1":$scope.paymentForm.$setValidity("cybersource",!1),$scope.paymentForm.address.$setValidity("cybersource",!1);break;case"card_accountNumber":case"card_cardType":default:$scope.paymentForm.$setValidity("cybersource",!1),$scope.paymentForm.cardNumber.$setValidity("cybersource",!1);break;case"card_expirationMonth":case"card_expirationYear":$scope.paymentForm.$setValidity("cybersource",!1),$scope.paymentForm.expiration.$setValidity("cybersource",!1);break;case"cc_cvc":$scope.paymentForm.$setValidity("cybersource",!1),$scope.paymentForm.securityCode.$setValidity("cybersource",!1)}},$scope.clearCybersourceError=function(field){switch(field){case"city":$scope.paymentForm.$setValidity("cybersource",!0),$scope.paymentForm.city.$setValidity("cybersource",!0);break;case"country":$scope.paymentForm.$setValidity("cybersource",!0),$scope.paymentForm.country.$setValidity("cybersource",!0);break;case"email":$scope.paymentForm.$setValidity("cybersource",!0),$scope.paymentForm.email.$setValidity("cybersource",!0);break;case"firstName":$scope.paymentForm.$setValidity("cybersource",!0),$scope.paymentForm.firstname.$setValidity("cybersource",!0);break;case"lastName":$scope.paymentForm.$setValidity("cybersource",!0),$scope.paymentForm.lastname.$setValidity("cybersource",!0);break;case"zip":$scope.paymentForm.$setValidity("cybersource",!0),$scope.paymentForm.zip.$setValidity("cybersource",!0);break;case"state":$scope.paymentForm.$setValidity("cybersource",!0),$scope.paymentForm.state.$setValidity("cybersource",!0);break;case"address":$scope.paymentForm.$setValidity("cybersource",!0),$scope.paymentForm.address.$setValidity("cybersource",!0);break;case"cardNumber":$scope.paymentForm.$setValidity("cybersource",!0),$scope.paymentForm.cardNumber.$setValidity("cybersource",!0),$scope.paymentForm.cardNumber.$setValidity("brand",!0);break;case"expiration":$scope.paymentForm.$setValidity("cybersource",!0),$scope.paymentForm.expiration.$setValidity("cybersource",!0);break;case"cc_cvc":$scope.paymentForm.$setValidity("cybersource",!0),$scope.paymentForm.securityCode.$setValidity("cybersource",!0)}}}]),app.controller("PrescriptionPageController",["$scope","$rootScope","$http","$window","$cookies","$log","$timeout","$filter","moment","$anchorScroll",function($scope,$rootScope,$http,$window,$cookies,$log,$timeout,$filter,moment,$anchorScroll){$scope.params={storeId:"",userId:0,langId:"",catalogId:"",framesImageURL:"",contactsImageURL:"",orderId:"",nextStepUrl:""},$scope.states=[],$scope.errors={missingPrescriptionData:{msg:"You need to choose a submission method",value:!1},missingDoctorData:{msg:"You need to choose a doctor",value:!1},invalidPatientForm:{msg:"You need to add the missing information",value:!1},uploadError:{value:!1},uploadNoFileUploadedError:{msg:"You need to upload your prescription",value:!1},uploadFileSizeError:{msg:"FILE IS TOO BIG",subMsg:"Your file size is too big. Maximum upload 10 MB"},uploadFileFormatError:{msg:"Incorrect file type",subMsg:"We accept: pdf/png/gif/jpeg/tiff/doc/docx/bmp/pages"},uploadFileError:{msg:"Oops! Something went wrong.",subMsg:"Please try again."},invalidAddDoctorForm:{msg:"Oops! You need to add the missing information",value:!1},submitPrescriptionError:{msg:"Oops! Something went wrong. Please try again.",value:!1}},$scope.maxSize=10485760,$scope.allowedContentTypes=["image/png","image/gif","image/jpeg","image/tiff","image/bmp","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/pdf","application/x-iwork-pages-sffpages"],$scope.allowedPreviewContentTypes=["image/png","image/gif","image/jpeg","image/jpg","image/bmp"],$scope.isRedirecting=!1,$scope.currentItemId=0,$scope.setupItemsLength=0,$scope.setupFrames=0,$scope.setupContact=0,$scope.loadingDoctors=!1,$scope.doctors=[],$scope.searchTentative=0,$scope.prevChosenDoctor={},$scope.allPrescriptionProvided=!1,$scope.firstItemPrescriptionFrame=0,$scope.firstItemPrescriptionContact=0,$scope.items={},$scope.pupillaryDistance=!1,$scope.fileEditMode=!1,$scope.showPrescription=!1,$scope.backdropPrescriptionPreviewOn=!1,$scope.showPrism=!0,$scope.isPrescriptionDetailsModalOpen=!1,$scope.prescriptionValueModal={},$scope.prescriptionClicked=-1,$scope.prescriptionSaved=[],$scope.showPrescriptionSaved=function(){$scope.showPrescription=!0},$scope.clickPrescription=function(prescriptionId){$scope.prescriptionClicked=prescriptionId,$scope.items[$scope.currentItemId].prescriptionProvided=!0},$scope.getFormattedDate=function(date){if(null!==date){let dateFormat=new Date(Date.parse(date)),year=dateFormat.getFullYear();return(1+dateFormat.getMonth()).toString().padStart(2,"0")+"/"+dateFormat.getDate().toString().padStart(2,"0")+"/"+year}return""},$scope.isToday=function(date){if(null!==date){const today=new Date;let dateFormat=new Date(Date.parse(date));if(today.toDateString()===dateFormat.toDateString())return!0}return!1},$scope.isYesterday=function(date){if(null!==date){const yesterday=new Date;yesterday.setDate(yesterday.getDate()-1);let dateFormat=new Date(Date.parse(date));if(yesterday.toDateString()===dateFormat.toDateString())return!0}return!1},$scope.isOneHourAgo=function(date){if(null!==date){const oneHourAgo=new Date;if(oneHourAgo.setHours(oneHourAgo.getHours()-1),oneHourAgo<new Date(Date.parse(date)))return!0}return!1},$scope.oneYearAgo=function(date){if(null!==date){const oneYearAgo=new Date;if(oneYearAgo.setFullYear(oneYearAgo.getFullYear()-1),oneYearAgo>new Date(Date.parse(date)))return!0}return!1},$scope.hidePrescriptionSaved=function(){$scope.showPrescription=!1,$scope.prescriptionClicked=-1},$scope.showPrescriptionClicked=function(prescription){$scope.isPrescriptionDetailsModalOpen=!0,$scope.backdropPrescriptionPreviewOn=!0,$scope.prescriptionValueModal={rightSphere:prescription.rightSphere,leftSphere:prescription.leftSphere,rightCyl:prescription.rightCyl,leftCyl:prescription.leftCyl,rightAxis:null===prescription.rightAxis?"-":prescription.rightAxis,leftAxis:null===prescription.leftAxis?"-":prescription.leftAxis,rightAdd:null===prescription.rightAdd?"-":prescription.rightAdd,leftAdd:null===prescription.leftAdd?"-":prescription.leftAdd,pupillaryDistance:prescription.pupillaryDistance,rpDistance:prescription.rpDistance,lpDistance:prescription.lpDistance,prismEnable:"true"===prescription.prismEnable,odVPrism:null===prescription.odVPrism?"-":prescription.odVPrism,osVPrism:null===prescription.osVPrism?"-":prescription.osVPrism,odVPrismBaseDir:null===prescription.odVPrismBaseDir?"-":prescription.odVPrismBaseDir,osVPrismBaseDir:null===prescription.osVPrismBaseDir?"-":prescription.osVPrismBaseDir,odHPrism:null===prescription.odHPrism?"-":prescription.odHPrism,osHPrism:null===prescription.osHPrism?"-":prescription.osHPrism,odHPrismBaseDir:null===prescription.odHPrismBaseDir?"-":prescription.odHPrismBaseDir,osHPrismBaseDir:null===prescription.osHPrismBaseDir?"-":prescription.osHPrismBaseDir}},$scope.closePrescriptionClicked=function(){$scope.isPrescriptionDetailsModalOpen=!1,$scope.backdropPrescriptionPreviewOn=!1},$scope.resetErrors=function(){$scope.errors.missingPrescriptionData.value=!1,$scope.errors.missingDoctorData.value=!1,$scope.errors.invalidPatientForm.value=!1,$scope.errors.uploadError.value=!1,$scope.errors.uploadNoFileUploadedError.value=!1,$scope.errors.invalidAddDoctorForm.value=!1,$scope.errors.submitPrescriptionError.value=!1},$scope.singlePDProvider=[];var i=0;for(i=51;i<=77.5;i+=.5)$scope.singlePDProvider.push({text:i,value:i});for($scope.doublePDProvider=[],i=25;i<=38.5;i+=.5)$scope.doublePDProvider.push({text:i,value:i});$rootScope.getPupillaryProvider=function(){return $scope.doublePD?$scope.doublePDProvider:$scope.singlePDProvider},$scope.singleConfig={openOnFocus:!1,sortField:"text",maxItems:1,onInitialize:function(selectize){!function(selectize){selectize.$control.off("mousedown"),selectize.$control_input.off("mousedown"),selectize.$control.on("mousedown",(function(){return selectize.isFocused=!1,selectize.onMouseDown.apply(selectize,arguments),selectize.isFocused=!0,selectize.onMouseDown.apply(selectize,arguments)})),selectize.$control_input.on("mousedown",(function(e){e.stopPropagation(),"single"===selectize.settings.mode&&(selectize.isOpen?selectize.close():selectize.open())}))}(selectize)}},$scope.setupPrescriptionData=function(){$scope.items[$scope.currentItemId].prescriptionData={prescriptionMode:"",chosenDoctor:{},uploadFileInput:{},editFile:{},patient:{firstName:"",lastName:"",dateOfBirth:""},pupillaryDistance:{rightPD:"",leftPD:""}},console.log("prescription data setup")},$scope.setupExistingPrescriptionData=function(itemId,prescriptionData){console.log("prescriptionData is ",prescriptionData);var allowedPreviewContentTypes=["png","gif","jpeg","jpg","bmp"];switch(prescriptionData.prescriptionType_p){case"uploadPrescription":$http.get($scope.downloadImageURL+$scope.params.userId.toString()+"/"+prescriptionData.fileName,{responseType:"blob"}).then((function(response){var blob=response.data;$scope.fileLoading=!1,$scope.items[itemId].prescriptionProvided=!0,$scope.items[itemId].prescriptionData={prescriptionMode:prescriptionData.prescriptionType_p,chosenDoctor:{},uploadFileInput:{previewAllowed:-1!=allowedPreviewContentTypes.indexOf(prescriptionData.fileName.split(".").pop()),files:[{name:prescriptionData.fileName}],savedFilename:prescriptionData.fileName,path:window.URL.createObjectURL(blob)},editFile:{},patient:{firstName:"",lastName:"",dateOfBirth:""},pupillaryDistance:{rightPD:"",leftPD:""}},"contact"==$scope.items[itemId].itemType&&($scope.items[itemId].prescriptionData.patient={firstName:prescriptionData.firstName,lastName:prescriptionData.lastName,dateOfBirth:prescriptionData.dob_p.split("-").reverse().join("/")},$scope.items[itemId].prescriptionData.chosenDoctor={doctorAddress:{address1:prescriptionData.doctorAddress_p,address2:"",city:prescriptionData.doctorCity_p,country:"US",stateProvince:prescriptionData.doctorState_p,zipPostalCode:prescriptionData.doctorZip_p},doctorFaxNumber:prescriptionData.doctorFax_p,doctorName:prescriptionData.doctor,doctorOfficeNumber:prescriptionData.telephone,doctorPhoneNumber:prescriptionData.telephone,officeName:prescriptionData.officeeName,isValidDoctor:!0})}));break;case"callDoctor":$scope.fileLoading=!1,$scope.items[itemId].prescriptionProvided=!0,$scope.items[itemId].prescriptionData={prescriptionMode:prescriptionData.prescriptionType_p,chosenDoctor:{doctorAddress:{address1:prescriptionData.doctorAddress_p,address2:"",city:prescriptionData.doctorCity_p,country:"US",stateProvince:prescriptionData.doctorState_p,zipPostalCode:prescriptionData.doctorZip_p},doctorFaxNumber:prescriptionData.doctorFax_p,doctorName:prescriptionData.doctor,doctorOfficeNumber:prescriptionData.telephone,doctorPhoneNumber:prescriptionData.telephone,officeName:prescriptionData.officeeName,isValidDoctor:!0},uploadFileInput:{},editFile:{},patient:{firstName:"",lastName:"",dateOfBirth:""},pupillaryDistance:{rightPD:"",leftPD:""}},"contact"==$scope.items[itemId].itemType&&($scope.items[itemId].prescriptionData.patient={firstName:prescriptionData.firstName,lastName:prescriptionData.lastName,dateOfBirth:prescriptionData.dob_p.split("-").reverse().join("/")})}console.log("itemId ",itemId,$scope.items[itemId])},$scope.currentlyEditing=null,$scope.useSamePrescriptionFrame=!0,$scope.disableSamePrescriptionOption=!1,$scope.useSamePrescriptionContact=!0,$scope.previousSavedFileName=null,$scope.haveSamePrescriptionFrames=!1,$scope.haveSamePrescriptionFramesMode=null,$scope.haveSamePrescriptionFramesArr=[],$scope.haveSamePrescriptionContact=!1,$scope.haveSamePrescriptionContactMode=null,$scope.haveSamePrescriptionContactArr=[],$scope.nextProductButtonLabel="CONTINUE",$scope.init=function(initParams){angular.merge($scope.params,initParams),$log.info($scope.params),$scope.providePrescriptionBaseURL="/wcs/resources/store/"+$scope.params.storeId+"/provideprescription",$scope.setupURL=$scope.providePrescriptionBaseURL+"/setup",$scope.searchDoctorURL=$scope.providePrescriptionBaseURL+"/searchdoctor",$scope.prescriptionUploadURL=$scope.providePrescriptionBaseURL+"/upload",$scope.prescriptionSubmitURL=$scope.providePrescriptionBaseURL+"/submit",$scope.downloadImageURL=$scope.providePrescriptionBaseURL+"/download/",$scope.prescriptionSavedUrl="/wcs/resources/store/"+$scope.params.storeId+"/wcs/prescription/user/@self?nocache="+(new Date).getTime().toString(),"R"===$scope.params.userType&&$http.get($scope.prescriptionSavedUrl).then((function(response){response.data&&response.data.resultList&&response.data.resultList.length>0&&($scope.prescriptionSaved=response.data.resultList)}),(function(error){$log.error("Error getting list of prescription saved "+error)})),$scope.projectImageUrl=$scope.params.projectImagesUrl+"202005-rxreview/",10852==$scope.params.storeId?$scope.states=["AB","BC","MB","NB","NL","NT","NS","NU","ON","PE","QC","SK","YT"]:$scope.states=["AL","AK","AS","AZ","AR","CA","CO","CT","DE","DC","FM","FL","GA","GU","HI","ID","IL","IN","IA","KS","KY","LA","ME","MH","MD","MA","MI","MN","MS","MO","MT","NE","NV","NH","NJ","NM","NY","NC","ND","MP","OH","OK","OR","PW","PA","PR","RI","SC","SD","TN","TX","UT","VT","VI","VA","WA","WV","WI","WY"],$http.get($scope.setupURL+"/"+$scope.params.orderId).then((function(response){if(response.data&&"Success"==response.data.response.data.status){$scope.prescriptions=response.data.response.data.dataContent.rxDataContent;var items={};for(var key in items=response.data.response.data.dataContent.itemNamesMap)items.hasOwnProperty(key)&&null!=items[key].prescriptionId&&delete items[key];$scope.items=items;var itemIndex=1,currentLensType=null;if(angular.forEach($scope.items,(function(itemData,itemId){itemData.backendSavedPrescription=null,angular.forEach($scope.prescriptions,(function(prescriptionData,prescriptionId){itemData.backendSavedPrescription||itemData.prescriptionId!=prescriptionId||(itemData.backendSavedPrescription=prescriptionData.prescriptionType_p,$scope.setupExistingPrescriptionData(itemData.itemId,prescriptionData))}));try{null!=itemData.itemLensAttributes&&itemData.itemLensAttributes.length>0&&(null!=currentLensType&&currentLensType!=itemData.itemLensAttributes[0].toUpperCase()?($scope.useSamePrescriptionFrame=!1,$scope.disableSamePrescriptionOption=!0,$($("#provide-prescription-ctrl .use-same-prescription-checkbox label")[0]).addClass("disabled")):currentLensType=itemData.itemLensAttributes[0].toUpperCase())}catch(e){}if(0==$scope.currentItemId&&($scope.currentItemId=itemId,$scope.currentlyEditing=itemData.itemType),"frame"==itemData.itemType){if(itemData.itemUrl=$scope.params.framesImageURL.replace("{0}",itemData.itemUPC).replace("{1}","_002").replace("{2}","200"),itemData.gridModel&&itemData.gridColor&&itemData.itemLensAttributes[1]&&itemData.itemLensAttributes[3]&&itemData.itemLensAttributes[4]){var cartImageURL="https://assets.lenscrafters.com/extra/image/rxc/frames/{0}__{1}__RXP__FRAME__qt.png?impolicy={4}&Lenses=https://assets.lenscrafters.com/extra/image/rxc/lenses/{0}__RXP__{2}__qt.png",cartImageLogoURL="&Logo=https://assets.lenscrafters.com/extra/image/rxc/logo/{0}__RXP__{3}__qt.png",frameGridModel=itemData.gridModel,frameGridColor=itemData.gridColor,rxcLensBrand=itemData.itemLensAttributes[1],rxcLensColorCode=itemData.itemLensAttributes[3];itemData.itemLensAttributes[4];cartImageURL=(cartImageURL=(cartImageURL=cartImageURL.replace("{0}",frameGridModel)).replace("{1}",frameGridColor)).replace("{2}",rxcLensColorCode);var brandLogo="";rxcLensBrand.indexOf("Costa Del Mar")>-1?brandLogo="LOGO01":rxcLensBrand.indexOf("Ray-Ban")>-1?(brandLogo="LOGO04",rxcLensBrand.indexOf("Polar")>-1&&(brandLogo="LOGO03")):rxcLensBrand.indexOf("Oakley")>-1&&(brandLogo="LOGO05"),""===brandLogo?cartImageURL=cartImageURL.replace("{4}","CompositeNoLogo"):(cartImageURL=cartImageURL.replace("{4}","CompositeLogo"),cartImageLogoURL=(cartImageLogoURL=cartImageLogoURL.replace("{0}",frameGridModel)).replace("{3}",brandLogo),cartImageURL=cartImageURL.concat(cartImageLogoURL)),itemData.itemUrl=cartImageURL}}else itemData.itemUrl=$scope.params.contactsImageURL+itemData.itemUPC+"_fr.png?imwidth=200";itemData.itemIndex=itemIndex,itemIndex++})),console.log("$scope.items",$scope.items),$scope.setupItemsLength=Object.keys($scope.items).length,$scope.setupFrames=$filter("isFrame")($scope.items),$scope.setupFrames.length>1){for(i=0;i<$scope.setupFrames.length;i++){(itemData=$scope.setupFrames[i]).backendSavedPrescription&&-1==$scope.haveSamePrescriptionFramesArr.indexOf(itemData.backendSavedPrescription)&&(console.log("pusho",itemData.backendSavedPrescription),$scope.haveSamePrescriptionFramesArr.push(itemData.backendSavedPrescription))}1==$scope.haveSamePrescriptionFramesArr.length&&($scope.haveSamePrescriptionFrames=!0,$scope.haveSamePrescriptionFramesMode=$scope.haveSamePrescriptionFramesArr[0])}if($scope.setupContact=$filter("isContact")($scope.items),$scope.setupContact.length>1){for(i=0;i<$scope.setupContact.length;i++){var itemData;(itemData=$scope.setupContact[i]).backendSavedPrescription&&-1==!$scope.haveSamePrescriptionContactArr.indexOf(itemData.backendSavedPrescription)&&$scope.haveSamePrescriptionContactArr.push(itemData.backendSavedPrescription)}1==$scope.haveSamePrescriptionContactArr.length&&($scope.haveSamePrescriptionContact=!0,$scope.haveSamePrescriptionContactMode=$scope.haveSamePrescriptionContactArr[0])}0==$scope.setupItemsLength&&($scope.isRedirecting=!0,window.location.href="AjaxOrderItemDisplayView?storeId="+$scope.params.storeId+"&catalogId="+$scope.params.catalogId+"&langId=&URL=AjaxOrderItemDisplayView1&orderId=."),$scope.items[$scope.currentItemId].backendSavedPrescription||$scope.setupPrescriptionData(),$scope.allPrescriptionProvided=$scope.allRXProvided(!1),$log.info("rx setup completed")}else $log.error("Error getting order item data from service")}),(function(error){$log.error("Error getting order item data from service.\n"+error)}))},$scope.carouselUpdateCurrentProduct=function(event,slick,oldIndex,newIndex){oldIndex!=newIndex&&slick.$slides[newIndex].click()},$scope.$watch("useSamePrescriptionFrame",(function(newVal,oldVal){if(newVal!=oldVal&&1==newVal){var frames=$filter("isFrame")($scope.items);$scope.currentItemId=frames[0].itemId,$scope.currentlyEditing="frame",$scope.nextProductButtonLabel="CONTINUE"}else newVal||($scope.currentlyEditing="frame",$scope.nextProductButtonLabel="NEXT PRODUCT")})),$scope.$watch("useSamePrescriptionContact",(function(newVal,oldVal){if(newVal!=oldVal&&1==newVal){var contacts=$filter("isContact")($scope.items);$scope.currentItemId=contacts[0].itemId,$scope.currentlyEditing="contact",$scope.nextProductButtonLabel="CONTINUE"}else newVal||($scope.currentlyEditing="contact",$scope.nextProductButtonLabel="NEXT PRODUCT")})),$scope.nextProduct=function(nextItemId){if(null==nextItemId||nextItemId!=$scope.currentItemId)if(null==nextItemId)$scope.confirmPrescription(!1);else{if($scope.items[$scope.currentItemId].itemType==$scope.items[nextItemId].itemType&&"frame"==$scope.currentlyEditing&&1==$scope.useSamePrescriptionFrame)return;if($scope.items[$scope.currentItemId].itemType==$scope.items[nextItemId].itemType&&"contact"==$scope.currentlyEditing&&1==$scope.useSamePrescriptionContact)return;$scope.currentlyEditing=$scope.items[nextItemId].itemType,$scope.nextProductButtonLabel=$scope.useSamePrescriptionFrame&&"frame"==$scope.items[$scope.currentItemId].itemType||$scope.useSamePrescriptionContact&&"contact"==$scope.items[$scope.currentItemId].itemType?"CONTINUE":"NEXT PRODUCT",null==$scope.items[$scope.currentItemId].prescriptionId?$scope.items[$scope.currentItemId].prescriptionProvided=!1:($scope.items[$scope.currentItemId].prescriptionData&&"callDoctor"==$scope.items[$scope.currentItemId].prescriptionData.prescriptionMode||"contact"==$scope.items[$scope.currentItemId].itemType)&&null!=$scope.prevChosenDoctor.doctorName&&angular.merge($scope.items[$scope.currentItemId].prescriptionData.chosenDoctor,$scope.prevChosenDoctor),$scope.items[nextItemId].prescriptionSkipped&&($scope.items[nextItemId].prescriptionSkipped=!1),$scope.currentItemId=nextItemId,null==$scope.items[nextItemId].prescriptionId&&$scope.setupPrescriptionData(),$scope.resetField(),window.scrollTo(0,0)}},$scope.skipProduct=function(){null!=$scope.items[$scope.currentItemId].prescriptionId&&($scope.items[$scope.currentItemId].prescriptionProvided=!0,($scope.items[$scope.currentItemId].prescriptionData&&"callDoctor"==$scope.items[$scope.currentItemId].prescriptionData.prescriptionMode||"contact"==$scope.items[$scope.currentItemId].itemType)&&($scope.items[$scope.currentItemId].prescriptionData.chosenDoctor=$scope.prevChosenDoctor));var nextItemId=0,rxNeededItems=$filter("rxNeededPerType")($scope.items,$scope.items[$scope.currentItemId].itemType);if(0==rxNeededItems.length)if(console.log("ALTRI",$scope.items[$scope.currentItemId].itemType,"NON TROVATI"),(otherPossibileItemType=$filter("rxNeededPerType")($scope.items,"frame"==$scope.items[$scope.currentItemId].itemType?"contact":"frame")).length){for(i=0;i<otherPossibileItemType.length;i++)if(1!=(itemData=otherPossibileItemType[i]).prescriptionSkipped&&itemData.itemId!=$scope.currentItemId&&null==itemData.prescriptionData){$scope.currentlyEditing=itemData.itemType,nextItemId=itemData.itemId;break}}else $scope.isRedirecting=!0,window.location.href=$scope.params.nextStepUrl;else if(1==$scope.useSamePrescriptionFrame&&"frame"==$scope.items[$scope.currentItemId].itemType||1==$scope.useSamePrescriptionContact&&"contact"==$scope.items[$scope.currentItemId].itemType){if(angular.forEach(rxNeededItems,(function(itemData,itemIndex){$scope.items[itemData.itemId].prescriptionSkipped=!0})),(otherPossibileItemType=$filter("rxNeededPerType")($scope.items,"frame"==$scope.items[$scope.currentItemId].itemType?"contact":"frame")).length){for(i=0;i<otherPossibileItemType.length;i++)if(1!=(itemData=otherPossibileItemType[i]).prescriptionSkipped&&itemData.itemId!=$scope.currentItemId&&null==itemData.prescriptionData){$scope.currentlyEditing=itemData.itemType,nextItemId=itemData.itemId;break}}else $scope.isRedirecting=!0,window.location.href=$scope.params.nextStepUrl}else{var otherPossibileItemType,i,itemData;for(i=0;i<rxNeededItems.length;i++)if(1!=(itemData=rxNeededItems[i]).prescriptionSkipped&&itemData.itemId!=$scope.currentItemId){nextItemId=itemData.itemId;break}if(0==nextItemId)if((otherPossibileItemType=$filter("rxNeededPerType")($scope.items,"frame"==$scope.items[$scope.currentItemId].itemType?"contact":"frame")).length)for(i=0;i<otherPossibileItemType.length;i++)if(1!=(itemData=otherPossibileItemType[i]).prescriptionSkipped&&itemData.itemId!=$scope.currentItemId&&null==itemData.prescriptionData){$scope.currentlyEditing=itemData.itemType,nextItemId=itemData.itemId;break}}0==nextItemId?($scope.isRedirecting=!0,window.location.href=$scope.params.nextStepUrl):($scope.resetErrors(),$scope.items[$scope.currentItemId].prescriptionSkipped=!0,$scope.currentItemId=nextItemId,$scope.setupPrescriptionData(),$scope.allPrescriptionProvided=$scope.allRXProvided(!1),window.scrollTo(0,0))},$scope.resetContactUpload=function(){$scope.items[$scope.currentItemId].prescriptionData.uploadFileInput={}},$scope.allRXProvided=function(edit){var prescrProvidedNum;return prescrProvidedNum=edit?0:1,angular.forEach($scope.items,(function(item,key){key!=$scope.currentItemId&&(item.prescriptionProvided&&null!=item.prescriptionData||item.prescriptionSkipped)&&prescrProvidedNum++})),Object.keys($scope.items).length==prescrProvidedNum},$scope.searchDoctors=function(){var searchQuery;$scope.loadingDoctors=!0,"docname"==$scope.doctorSearchType?searchQuery=(null!=$scope.docName?$scope.docName:"")+"!"+(null!=$scope.docState?$scope.docState:"")+"!"+(null!=$scope.docCity?$scope.docCity.replace(" ","_"):""):"docphonenumber"==$scope.doctorSearchType&&(searchQuery=$scope.docPhoneNumber.replace("(","").replace(")","").replace("-","").replace(" ","").replace("  ","")),$log.info(searchQuery);var scrollToSearchDoc=document.getElementById("search-doc-results");if(10852==$scope.params.storeId){var query={},options={};if("docphonenumber"==$scope.doctorSearchType)query={$and:[{phoneSearch:"'"+String($scope.docPhoneNumber.replace("(","").replace(")","").replace("-","").replace(" ","").replace("  ",""))}]},options={includeScore:!0,useExtendedSearch:!0,keys:["phoneSearch"]};else{var shortState="";switch(String($scope.docState)){case"Alberta":shortState="AB";break;case"British Columbia":shortState="BC";break;case"Manitoba":shortState="MB";break;case"New Brunswick":shortState="NB";break;case"Newfoundland":shortState="NL";break;case"Northwest Territory":shortState="NT";break;case"Nova Scotia":shortState="NS";break;case"Nunavut":shortState="NU";break;case"Ontario":shortState="ON";break;case"Prince Edward Island":shortState="PE";break;case"Quebec":shortState="QC";break;case"Saskatchewan":shortState="SK";break;case"Yukon":shortState="YT";break;default:shortState=String($scope.docState)}query={$and:[{$or:[{clinic:"'"+String(_requestObject.name)},{name:"'"+String(_requestObject.name)}]},{stateSearch:"'"+shortState},{citySearch:"'"+String(_requestObject.city)}]},options={includeScore:!0,useExtendedSearch:!0,keys:["name","clinic","stateSearch","citySearch"]}}$http.get($scope.searchDoctorURL+"/"+searchQuery).then((function(response){if(response.data&&"Success"==response.data.response.status){$scope.doctors=[];var allDoctors;allDoctors=response.data.response.data;const result=new Fuse(allDoctors,options).search(query);for(const item of result)$scope.doctors.push(item.item);setTimeout((function(){scrollToSearchDoc.scrollIntoView()}),200)}else $log.error("Error getting doctors from service: unsuccessful."),obj={id:"Error",Error_Source:"Server",Error_Code:"RX panel",Error_Message:"Unable to get doctor list"},tealium_data2track.push(obj);$scope.searchTentative++,$scope.loadingDoctors=!1}),(function(error){$log.error("Error getting doctors from service"),$scope.loadingDoctors=!1,$scope.searchTentative++,obj={id:"Error",Error_Source:"Server",Error_Code:"RX panel",Error_Message:"Unable to get doctor list"},tealium_data2track.push(obj)}))}else $http.get($scope.searchDoctorURL+"/"+searchQuery).then((function(response){response.data&&"Success"==response.data.response.status?($scope.doctors=[],angular.forEach(response.data.response.data,(function(doc,doctorId){0!=doc.doctorName.length&&0!=doc.doctorPhoneNumber.length&&0!=doc.doctorOfficeNumber.length&&$scope.doctors.push(doc)})),setTimeout((function(){scrollToSearchDoc.scrollIntoView()}),200)):($log.error("Error getting doctors from service: unsuccessful."),obj={id:"Error",Error_Source:"Server",Error_Code:"RX panel",Error_Message:"Unable to get doctor list"},tealium_data2track.push(obj)),$scope.searchTentative++,$scope.loadingDoctors=!1}),(function(error){$log.error("Error getting doctors from service"),$scope.loadingDoctors=!1,$scope.searchTentative++,obj={id:"Error",Error_Source:"Server",Error_Code:"RX panel",Error_Message:"Unable to get doctor list"},tealium_data2track.push(obj)}));scrollToSearchDoc.scrollIntoView()},$scope.chooseDoctor=function(index){$scope.items[$scope.currentItemId].prescriptionProvided=!0,$scope.openDoctorSearchModal=!1,$scope.items[$scope.currentItemId].prescriptionData=$scope.items[$scope.currentItemId].prescriptionData||{},$scope.items[$scope.currentItemId].prescriptionData.chosenDoctor={},$scope.items[$scope.currentItemId].prescriptionData.chosenDoctor=$scope.doctors[index],angular.forEach(document.querySelectorAll("body,html"),(function(elem){elem.classList.remove("hidden-overflow")}))},$scope.addDoctor=function(){$scope.resetErrors(),$scope.addDoctorForm.$valid&&""!=$scope.addDocPhoneNumber?($scope.items[$scope.currentItemId].prescriptionProvided=!0,$scope.openDoctorAddModal=!1,$scope.items[$scope.currentItemId].prescriptionData.chosenDoctor={},$scope.items[$scope.currentItemId].prescriptionData.chosenDoctor.doctorName=$scope.addDocName,$scope.items[$scope.currentItemId].prescriptionData.chosenDoctor.doctorPhoneNumber=$scope.addDocPhoneNumber.replace(/[- )(]/g,""),$scope.items[$scope.currentItemId].prescriptionData.chosenDoctor.doctorAddress={address1:"-",stateProvince:"",address2:"",zipPostalCode:"",city:"",country:""},angular.forEach(document.querySelectorAll("body,html"),(function(elem){elem.classList.remove("hidden-overflow")}))):$scope.errors.invalidAddDoctorForm.value=!0},$scope.uploadPrescriptionFile=function(){if($scope.resetErrors(),$scope.fileLoading=!0,$scope.items[$scope.currentItemId].prescriptionData.uploadFileInput.files[0].size<$scope.maxSize)if(-1!=$scope.allowedContentTypes.indexOf($scope.items[$scope.currentItemId].prescriptionData.uploadFileInput.files[0].type)||-1!=$scope.items[$scope.currentItemId].prescriptionData.uploadFileInput.files[0].name.indexOf(".pages")){$scope.fileEditMode=!1;var uploadParams={storeId:$scope.params.storeId.toString(),langId:$scope.params.langId.toString(),catalogId:$scope.params.catalogId.toString(),userId:$scope.params.userId.toString(),isItemFile:(!0).toString()};uploadParams.fileName=$filter("nospace")($scope.items[$scope.currentItemId].prescriptionData.uploadFileInput.files[0].name),uploadParams.fileData=$scope.items[$scope.currentItemId].prescriptionData.uploadFileInput.path.substring($scope.items[$scope.currentItemId].prescriptionData.uploadFileInput.path.indexOf(",")+1),"contact"==$scope.items[$scope.currentItemId].itemType?uploadParams.orderItemId=$scope.currentItemId:uploadParams.orderItemId=$scope.items[$scope.currentItemId].itemField1,$log.info("Start: file upload for item "+$scope.currentItemId),$http.post($scope.prescriptionUploadURL,uploadParams).then((function(response){response.data&&"Success"==response.data.status?($log.info("Prescription file uploaded for item "+$scope.currentItemId),$scope.items[$scope.currentItemId].prescriptionData.uploadFileInput.savedFilename=response.data.savedFileName,response.data.file_checksum&&($scope.items[$scope.currentItemId].prescriptionData.uploadFileInput.checksum=response.data.file_checksum),("frame"==$scope.items[$scope.currentItemId].itemType||"contact"==$scope.items[$scope.currentItemId].itemType&&"false"==$scope.params.callDoctorEnabled)&&($scope.items[$scope.currentItemId].prescriptionProvided=!0),-1==$scope.allowedPreviewContentTypes.indexOf($scope.items[$scope.currentItemId].prescriptionData.uploadFileInput.files[0].type)?$scope.items[$scope.currentItemId].prescriptionData.uploadFileInput.previewAllowed=!1:$scope.items[$scope.currentItemId].prescriptionData.uploadFileInput.previewAllowed=!0,$scope.resetErrors(),$scope.fileLoading=!1):(-1!=response.data.messages.toString().indexOf("extension")?($log.error(response.data.messages[0]),angular.merge($scope.errors.uploadError,$scope.errors.uploadFileFormatError),$scope.errors.uploadError.value=!0,$scope.items[$scope.currentItemId].prescriptionData.uploadFileInput={},tealium_data2track.push({id:"Error",Error_Code:response.data.messages[0],Error_Source:"User"})):-1!=response.data.messages.toString().indexOf("length")?($log.error(response.data.messages[0]),angular.merge($scope.errors.uploadError,$scope.errors.uploadFileSizeError),$scope.errors.uploadError.value=!0,$scope.items[$scope.currentItemId].prescriptionData.uploadFileInput={},tealium_data2track.push({id:"Error",Error_Code:response.data.messages[0],Error_Source:"User"})):(angular.merge($scope.errors.uploadError,$scope.errors.uploadFileError),$scope.errors.uploadError.value=!0,$scope.items[$scope.currentItemId].prescriptionData.uploadFileInput={},tealium_data2track.push({id:"Error",Error_Code:response.data.messages[0],Error_Source:"Server"})),$scope.fileLoading=!1)}),(function(error){$log.error("Error: no prescription uploaded for item "+$scope.currentItemId),angular.merge($scope.errors.uploadError,$scope.errors.uploadFileError),$scope.errors.uploadError.value=!0,$scope.items[$scope.currentItemId].prescriptionData.uploadFileInput={},tealium_data2track.push({id:"Error",Error_Code:$scope.errors.uploadError.msg,Error_Source:"Server"}),$scope.fileLoading=!1}))}else angular.merge($scope.errors.uploadError,$scope.errors.uploadFileFormatError),$scope.errors.uploadError.value=!0,$scope.items[$scope.currentItemId].prescriptionData.uploadFileInput={},tealium_data2track.push({id:"Error",Error_Code:$scope.errors.uploadError.msg,Error_Source:"User"}),$scope.fileLoading=!1;else angular.merge($scope.errors.uploadError,$scope.errors.uploadFileSizeError),$scope.errors.uploadError.value=!0,$scope.items[$scope.currentItemId].prescriptionData.uploadFileInput={},tealium_data2track.push({id:"Error",Error_Code:$scope.errors.uploadError.msg,Error_Source:"User"}),$scope.fileLoading=!1},$scope.confirmPrescription=function(goToNextStep){if($scope.resetErrors(),console.log($scope.items[$scope.currentItemId].itemType,$scope.useSamePrescriptionFrame,$scope.firstItemPrescriptionFrame),("frame"==$scope.items[$scope.currentItemId].itemType&&$scope.useSamePrescriptionFrame&&0!=$scope.firstItemPrescriptionFrame||"contact"==$scope.items[$scope.currentItemId].itemType&&$scope.useSamePrescriptionContact&&0!=$scope.firstItemPrescriptionContact)&&($scope.items[$scope.currentItemId].prescriptionProvided=!0),1==$scope.items[$scope.currentItemId].prescriptionProvided)if(console.log("A"),"frame"==$scope.items[$scope.currentItemId].itemType||$scope.callAuth&&$scope.patientForm.$valid){var submitParams={};if(console.log("B"),$scope.useSamePrescriptionFrame&&"frame"==$scope.items[$scope.currentItemId].itemType&&0!=$scope.firstItemPrescriptionFrame)console.log("B3 - copy prescription  true e siamo in un frame"),submitParams.cp_rx_oid=$scope.items[$scope.firstItemPrescriptionFrame].itemField1,submitParams.cp_rx_id=$scope.items[$scope.firstItemPrescriptionFrame].prescriptionId,submitParams.orderitemid=$scope.items[$scope.currentItemId].itemField1,$scope.haveSamePrescriptionFrames=!0,$scope.haveSamePrescriptionFramesMode=$scope.items[$scope.firstItemPrescriptionFrame].prescriptionData.prescriptionMode;else{console.log("new prescription"),$scope.haveSamePrescriptionFrames=!1,$scope.haveSamePrescriptionFramesMode=null,$scope.haveSamePrescriptionContact=!1,$scope.haveSamePrescriptionContactMode=null,$scope.useSamePrescriptionContact&&"contact"==$scope.items[$scope.currentItemId].itemType&&0!=$scope.firstItemPrescriptionContact&&($scope.items[$scope.currentItemId].prescriptionData={},angular.merge($scope.items[$scope.currentItemId].prescriptionData,$scope.items[$scope.firstItemPrescriptionContact].prescriptionData),$scope.haveSamePrescriptionContact=!0,$scope.haveSamePrescriptionContactMode=$scope.items[$scope.firstItemPrescriptionContact].prescriptionData.prescriptionMode,$scope.previousSavedFileName&&($scope.items[$scope.currentItemId].prescriptionData.uploadFileInput.savedFilename=$scope.previousSavedFileName));var chosenDoctor=$scope.items[$scope.currentItemId].prescriptionData.chosenDoctor,uploadedFile=$scope.items[$scope.currentItemId].prescriptionData.uploadFileInput,isMissingData=!1;if(console.log(chosenDoctor,uploadedFile),"frame"==$scope.items[$scope.currentItemId].itemType&&chosenDoctor&&uploadedFile&&0===Object.keys(chosenDoctor).length&&0===Object.keys(uploadedFile).length&&-1===$scope.prescriptionClicked?($scope.errors.missingPrescriptionData.value=!0,isMissingData=!0):"contact"==$scope.items[$scope.currentItemId].itemType&&chosenDoctor&&uploadedFile?(0===Object.keys(chosenDoctor).length?($scope.errors.missingDoctorData.value=!0,isMissingData=!0):"upload"==$scope.clPrescriptionMode&&0===Object.keys(uploadedFile).length&&($scope.errors.uploadError.value=!0,isMissingData=!0),$anchorScroll("patientForm")):(chosenDoctor||($scope.errors.missingDoctorData.value=!0,isMissingData=!0),uploadedFile||"contact"!=$scope.items[$scope.currentItemId].itemType||"upload"!=$scope.clPrescriptionMode||($scope.errors.uploadNoFileUploadedError.value=!0,isMissingData=!0)),isMissingData)return void $log.error("Error: no prescription submitted for item "+$scope.currentItemId);if(null!=$scope.items[$scope.currentItemId].prescriptionData.chosenDoctor&&null!=$scope.items[$scope.currentItemId].prescriptionData.chosenDoctor.doctorName&&($scope.items[$scope.currentItemId].prescriptionData.prescriptionMode="callDoctor",null!=$scope.items[$scope.currentItemId].prescriptionData.chosenDoctor.doctorAddress?angular.merge(submitParams,$scope.formatDoctorData($scope.items[$scope.currentItemId].prescriptionData.chosenDoctor)):angular.merge(submitParams,$scope.items[$scope.currentItemId].prescriptionData.chosenDoctor),submitParams.doctorNumber=$filter("formatPhoneNumber")($scope.items[$scope.currentItemId].prescriptionData.chosenDoctor.doctorPhoneNumber.split("-").join(""),"-")),null!=$scope.items[$scope.currentItemId].prescriptionData.uploadFileInput&&null!=$scope.items[$scope.currentItemId].prescriptionData.uploadFileInput.savedFilename&&$scope.items[$scope.currentItemId].prescriptionData.uploadFileInput.savedFilename.length>0&&("frame"==$scope.items[$scope.currentItemId].itemType||"contact"==$scope.items[$scope.currentItemId].itemType&&"upload"==$scope.clPrescriptionMode?($scope.items[$scope.currentItemId].prescriptionData.prescriptionMode="uploadPrescription",$scope.fileEditMode?(submitParams.fileName=$scope.items[$scope.currentItemId].prescriptionData.editFile.editFileName,submitParams.file=$scope.items[$scope.currentItemId].prescriptionData.editFile.editFilePath.substring($scope.items[$scope.currentItemId].prescriptionData.editFile.editFilePath.indexOf(",")+1)):(angular.merge(submitParams,$scope.items[$scope.currentItemId].prescriptionData.uploadFileInput),$scope.items[$scope.currentItemId].prescriptionData.editFile={})):($scope.items[$scope.currentItemId].prescriptionData.editFile={},$scope.items[$scope.currentItemId].prescriptionData.uploadFileInput={})),-1!==$scope.prescriptionClicked?submitParams.prescriptionIdMyAccountSelected=$scope.prescriptionClicked.toString():(submitParams.rx="doctor",submitParams.prescriptionMode=$scope.items[$scope.currentItemId].prescriptionData.prescriptionMode),"contact"==$scope.items[$scope.currentItemId].itemType){var patientDoB=$scope.items[$scope.currentItemId].prescriptionData.patient.dateOfBirth;-1==patientDoB.indexOf("/")&&($scope.items[$scope.currentItemId].prescriptionData.patient.dateOfBirth=patientDoB.substr(0,2)+"/"+patientDoB.substr(2,2)+"/"+patientDoB.substr(4,4)),angular.merge(submitParams,$scope.items[$scope.currentItemId].prescriptionData.patient);var dob=$scope.items[$scope.currentItemId].prescriptionData.patient.dateOfBirth.split("/");submitParams.dateOfBirth=[dob[2],dob[0],dob[1]].join("-"),submitParams.orderitemid=$scope.currentItemId}else submitParams.orderitemid=$scope.items[$scope.currentItemId].itemField1,$scope.pupillaryDistance&&-1===$scope.prescriptionClicked&&angular.merge(submitParams,$scope.items[$scope.currentItemId].prescriptionData.pupillaryDistance)}"true"==$scope.params.externalFlow&&(submitParams.itemStatusUpdate=(!0).toString()),console.log("submitParams are",submitParams),$http.post($scope.prescriptionSubmitURL,submitParams).then((function(response){if(response.data&&"Success"==response.data.status){$scope.items[$scope.currentItemId].prescriptionId=response.data.prescriptionId,$log.info("Prescription confirmed for item "+$scope.currentItemId),$scope.useSamePrescriptionFrame&&"frame"==$scope.items[$scope.currentItemId].itemType&&angular.forEach($scope.items,(function(itemData,id){itemData.itemField1==submitParams.cp_rx_oid&&($scope.items[$scope.currentItemId].prescriptionData={},angular.merge($scope.items[$scope.currentItemId].prescriptionData,$scope.items[id].prescriptionData),$scope.items[id].prescriptionData.uploadFileInput.files&&$scope.items[id].prescriptionData.uploadFileInput.files[0].name&&($scope.items[$scope.currentItemId].prescriptionData.uploadFileInput.files[0].name=$scope.items[id].prescriptionData.uploadFileInput.files[0].name,$scope.items[$scope.currentItemId].prescriptionData.uploadFileInput.files[0].type=$scope.items[id].prescriptionData.uploadFileInput.files[0].type,$scope.items[$scope.currentItemId].prescriptionData.uploadFileInput.files[0].size=$scope.items[id].prescriptionData.uploadFileInput.files[0].size))})),"uploadPrescription"==submitParams.prescriptionMode&&(console.log("$scope.fileEditMode",$scope.fileEditMode),$scope.fileEditMode?($scope.previousSavedFileName||($scope.previousSavedFileName=$scope.items[$scope.currentItemId].prescriptionData.uploadFileInput.savedFilename),$scope.items[$scope.currentItemId].prescriptionData.uploadFileInput.savedFilename=response.data.savedFileName,$scope.moveFileData(!0)):($scope.items[$scope.currentItemId].prescriptionData.uploadFileInput.savedFilename=$scope.items[$scope.currentItemId].prescriptionData.uploadFileInput.savedFilename.replace(submitParams.orderitemid+"_RX.",response.data.prescriptionId+"_RX."),$scope.previousSavedFileName||($scope.previousSavedFileName=$scope.items[$scope.currentItemId].prescriptionData.uploadFileInput.savedFilename)));submitParams.prescriptionMode;if(tealium_data2track.push({id:"Checkout-Order-PrescriptionOk",Order_PrescriptionMethod:void 0}),goToNextStep)$scope.isRedirecting=!0,window.location.href=$scope.params.nextStepUrl;else{$scope.resetField(),"frame"==$scope.items[$scope.currentItemId].itemType&&0==$scope.firstItemPrescriptionFrame&&(console.log("salvo $scope.firstItemPrescriptionFrame e setto le altre prescription id a null"),$scope.firstItemPrescriptionFrame=$scope.currentItemId,1==$scope.useSamePrescriptionFrame&&(angular.forEach($scope.items,(function(itemData,itemId){itemData.itemId!=$scope.currentItemId&&itemData.itemType==$scope.items[$scope.currentItemId].itemType&&(itemData.prescriptionId=null,itemData.prescriptionProvided=!1,console.log("setto a null la prescr dellitem",itemData.itemId))})),console.log("$scope.items",$scope.items))),"contact"==$scope.items[$scope.currentItemId].itemType&&0==$scope.firstItemPrescriptionContact&&(console.log("salvo $scope.firstItemPrescriptionContact e setto le altre prescription id a null"),$scope.firstItemPrescriptionContact=$scope.currentItemId,1==$scope.useSamePrescriptionContact&&(angular.forEach($scope.items,(function(itemData,itemId){itemData.itemId!=$scope.currentItemId&&itemData.itemType==$scope.items[$scope.currentItemId].itemType&&(itemData.prescriptionId=null,itemData.prescriptionProvided=!1,console.log("setto a null la prescr dellitem",itemData.itemId))})),console.log("$scope.items",$scope.items)));var rxNeededItems=$filter("rxNeededPerType")($scope.items,$scope.items[$scope.currentItemId].itemType);console.log("rxNeededItems",rxNeededItems);var nextItemId=0;if(0==rxNeededItems.length){$scope.previousSavedFileName=null,console.log("ALTRI ITEM TYPE NON TROVATI");var otherPossibileItemType=$filter("rxNeededPerType")($scope.items,"frame"==$scope.items[$scope.currentItemId].itemType?"contact":"frame");if(console.log("otherPossibleItemType",otherPossibileItemType),otherPossibileItemType.length){for(i=0;i<otherPossibileItemType.length;i++)if((itemData=otherPossibileItemType[i]).prescriptionData&&delete itemData.prescriptionData,1!=itemData.prescriptionSkipped&&itemData.itemId!=$scope.currentItemId&&null==itemData.prescriptionData){$scope.currentlyEditing=itemData.itemType,console.log("switching to item type",$scope.currentlyEditing),nextItemId=itemData.itemId;break}}else console.log("NON TROVO PIU ITEMS CON RX NEEDED"),$scope.isRedirecting=!0,window.location.href=$scope.params.nextStepUrl}else{if(1==$scope.useSamePrescriptionFrame&&"frame"==$scope.items[$scope.currentItemId].itemType||1==$scope.useSamePrescriptionContact&&"contact"==$scope.items[$scope.currentItemId].itemType)return nextItemId=rxNeededItems[0].itemId,$scope.currentItemId=nextItemId,console.log("Invio la prossima prescription per l'item id",nextItemId),void $scope.confirmPrescription(!1);var i;for(i=0;i<rxNeededItems.length;i++){var itemData;if(1!=(itemData=rxNeededItems[i]).prescriptionSkipped&&itemData.itemId!=$scope.currentItemId){nextItemId=itemData.itemId;break}}}$scope.currentItemId=nextItemId,$scope.setupPrescriptionData(),$scope.allPrescriptionProvided=$scope.allRXProvided(!1),console.log("ITEMS USERDATA",$scope.items),window.scrollTo(0,0)}}else $log.error("Error: no prescription submitted for item "+$scope.currentItemId),$scope.errors.submitPrescriptionError.value=!0,tealium_data2track.push({id:"Error",Error_Code:"No prescription submitted for item "+$scope.currentItemId,Error_Source:"Server"})}),(function(error){$log.error("Error: no prescription submitted for item "+$scope.currentItemId),$scope.errors.submitPrescriptionError.value=!0,tealium_data2track.push({id:"Error",Error_Code:"No prescription submitted for item "+$scope.currentItemId,Error_Source:"Server"})}))}else{console.log("C"),$scope.errors.invalidPatientForm.value=!0,$scope.patientForm.patientFirstName.$setTouched(),$scope.patientForm.patientLastName.$setTouched(),$scope.patientForm.patientDateOfBirth.$setTouched();chosenDoctor=$scope.items[$scope.currentItemId].prescriptionData?$scope.items[$scope.currentItemId].prescriptionData.chosenDoctor:null,uploadedFile=$scope.items[$scope.currentItemId].prescriptionData?$scope.items[$scope.currentItemId].prescriptionData.uploadFileInput:null;"contact"!=$scope.items[$scope.currentItemId].itemType||$scope.items[$scope.currentItemId].prescriptionData?"contact"==$scope.items[$scope.currentItemId].itemType&&chosenDoctor&&uploadedFile&&(0===Object.keys(chosenDoctor).length?$scope.errors.missingDoctorData.value=!0:"upload"==$scope.clPrescriptionMode&&0===Object.keys(uploadedFile).length&&($scope.errors.uploadError.value=!0),$anchorScroll("patientForm")):($scope.errors.missingDoctorData.value=!0,"upload"==$scope.clPrescriptionMode&&($scope.errors.uploadNoFileUploadedError.value=!0))}else if(console.log("D1 - la prescr provided  false"),null!=$scope.items[$scope.currentItemId].prescriptionId)if(console.log("D2 - ho una prescription id e setto prescr provided a true"),$scope.items[$scope.currentItemId].prescriptionProvided=!0,"callDoctor"!=$scope.items[$scope.currentItemId].prescriptionData.prescriptionMode&&"contact"!=$scope.items[$scope.currentItemId].itemType||null==$scope.prevChosenDoctor.doctorName||angular.merge($scope.items[$scope.currentItemId].prescriptionData.chosenDoctor,$scope.prevChosenDoctor),goToNextStep)$scope.isRedirecting=!0,window.location.href=$scope.params.nextStepUrl;else{$scope.resetField(),"frame"==$scope.items[$scope.currentItemId].itemType&&0==$scope.firstItemPrescriptionFrame&&(console.log("salvo il current item id in first item prescription e setto copyPrescription a true"),$scope.firstItemPrescriptionFrame=$scope.currentItemId,$scope.useSamePrescriptionFrame=!0);var rxNeededItems=$filter("rxNeeded")($scope.items);console.log("cerco il prossimo elemento");var nextItemId=0;angular.forEach(rxNeededItems,(function(itemData,itemIndex){1!=itemData.prescriptionSkipped&&itemData.itemId!=$scope.currentItemId&&(nextItemId=itemData.itemId)})),$scope.currentItemId=nextItemId,$scope.setupPrescriptionData(),$scope.allPrescriptionProvided=$scope.allRXProvided(!1)}else{if(console.log("E"),"frame"==$scope.items[$scope.currentItemId].itemType)$scope.errors.missingPrescriptionData.value=!0;else if("contact"==$scope.items[$scope.currentItemId].itemType){$scope.errors.missingDoctorData.value=!0,$anchorScroll("patientForm");uploadedFile=$scope.items[$scope.currentItemId].prescriptionData?$scope.items[$scope.currentItemId].prescriptionData.uploadFileInput:null;console.log(uploadedFile),uploadedFile&&0!==Object.keys(uploadedFile).length||"upload"!=$scope.clPrescriptionMode||($scope.errors.uploadNoFileUploadedError.value=!0)}"contact"==$scope.items[$scope.currentItemId].itemType&&$scope.patientForm.$invalid&&($scope.errors.invalidPatientForm.value=!0,$scope.patientForm.patientFirstName.$setTouched(),$scope.patientForm.patientLastName.$setTouched(),$scope.patientForm.patientDateOfBirth.$setTouched(),$anchorScroll("patientForm"))}},$scope.editPrescription=function(itemId){$scope.currentItemId!=itemId&&($scope.items[$scope.currentItemId].itemType==$scope.items[itemId].itemType&&"contact"==$scope.items[$scope.currentItemId].itemType&&1==$scope.useSamePrescriptionContact||($scope.currentlyEditing=$scope.items[itemId].itemType,null==$scope.items[$scope.currentItemId].prescriptionId&&($scope.items[$scope.currentItemId].prescriptionProvided=!1,$scope.setupPrescriptionData()),$scope.items[itemId].prescriptionProvided=!0,$scope.currentItemId=itemId,null!=$scope.items[itemId].prescriptionData&&("uploadPrescription"==$scope.items[itemId].prescriptionData.prescriptionMode?("frame"==$scope.items[itemId].itemType?$scope.items[itemId].prescriptionData.chosenDoctor={}:"contact"==$scope.items[itemId].itemType&&($scope.clPrescriptionMode="upload"),$scope.fileEditMode=!0,null==$scope.items[$scope.currentItemId].prescriptionData.editFile.editFilePath&&$scope.moveFileData(!1)):"callDoctor"==$scope.items[itemId].prescriptionData.prescriptionMode&&($scope.items[itemId].prescriptionData.editFile={},$scope.items[itemId].prescriptionData.uploadFileInput={},"contact"==$scope.items[itemId].itemType&&($scope.clPrescriptionMode="call-doctor"))),"frame"==$scope.items[itemId].itemType&&itemId==$scope.firstItemPrescriptionFrame&&($scope.firstItemPrescriptionFrame=0,$scope.useSamePrescriptionFrame=!1),"contact"==$scope.items[itemId].itemType&&itemId==$scope.firstItemPrescriptionContact&&($scope.firstItemPrescriptionContact=0,$scope.useSamePrescriptionContact=!1),$scope.allPrescriptionProvided=$scope.allRXProvided(!0)))},$scope.moveFileData=function(fromEdit){fromEdit?($scope.items[$scope.currentItemId].prescriptionData.uploadFileInput.path=$scope.items[$scope.currentItemId].prescriptionData.editFile.editFilePath,$scope.items[$scope.currentItemId].prescriptionData.uploadFileInput.files[0].name=$scope.items[$scope.currentItemId].prescriptionData.editFile.editFileName,$scope.items[$scope.currentItemId].prescriptionData.uploadFileInput.files[0].type=$scope.items[$scope.currentItemId].prescriptionData.editFile.editFileType,$scope.items[$scope.currentItemId].prescriptionData.uploadFileInput.files[0].size=$scope.items[$scope.currentItemId].prescriptionData.editFile.editFileSize,$scope.items[$scope.currentItemId].prescriptionData.uploadFileInput.previewAllowed=$scope.items[$scope.currentItemId].prescriptionData.editFile.editPreviewAllowed):($scope.items[$scope.currentItemId].prescriptionData.editFile.editFilePath=$scope.items[$scope.currentItemId].prescriptionData.uploadFileInput.path,$scope.items[$scope.currentItemId].prescriptionData.editFile.editFileName=$scope.items[$scope.currentItemId].prescriptionData.uploadFileInput.files[0].name,$scope.items[$scope.currentItemId].prescriptionData.editFile.editFileSize=$scope.items[$scope.currentItemId].prescriptionData.uploadFileInput.files[0].size,$scope.items[$scope.currentItemId].prescriptionData.editFile.editFileType=$scope.items[$scope.currentItemId].prescriptionData.uploadFileInput.files[0].type,$scope.items[$scope.currentItemId].prescriptionData.editFile.editPreviewAllowed=$scope.items[$scope.currentItemId].prescriptionData.uploadFileInput.previewAllowed)},$scope.resetField=function(){$scope.doctors=[],$scope.searchTentative=0,$scope.pupillaryDistance=!1,$scope.resetErrors(),$scope.prevChosenDoctor={},$scope.patientForm.$setUntouched(),$scope.addDoctorForm.$setUntouched(),$scope.fileEditMode=!1},$scope.formatDoctorData=function(chosenDoctor){var formattedDoctor={};return formattedDoctor.doctorAddress=chosenDoctor.doctorAddress.address1,formattedDoctor.doctorCity=chosenDoctor.doctorAddress.city,formattedDoctor.doctorState=chosenDoctor.doctorAddress.stateProvince,formattedDoctor.doctorZip=chosenDoctor.doctorAddress.zipPostalCode,formattedDoctor.doctorFax=chosenDoctor.doctorFaxNumber,formattedDoctor.doctorClinic=chosenDoctor.officeName,formattedDoctor.doctorName=chosenDoctor.doctorName,formattedDoctor},$scope.showFileDetails=function(){for(var rxFileName,rxFileNamePt1,$modal=$("#rx_modal_image"),rxFileNameSplitted=(rxFileName=null!=$scope.items[$scope.currentItemId].prescriptionData.uploadFileInput.files&&null!=$scope.items[$scope.currentItemId].prescriptionData.uploadFileInput.files[0].name?$filter("nospace")($scope.items[$scope.currentItemId].prescriptionData.uploadFileInput.files[0].name):$filter("nospace")($scope.items[$scope.currentItemId].prescriptionData.editFile.editFileName)).split("."),i=0;i<rxFileNameSplitted.length-1;i++)rxFileNamePt1=0==i?rxFileNameSplitted[i]:rxFileNamePt1+"."+rxFileNameSplitted[i];rxFileName="frame"==$scope.items[$scope.currentItemId].itemType?rxFileNamePt1+"_"+$scope.items[$scope.currentItemId].itemField1+"_RX."+rxFileNameSplitted[rxFileNameSplitted.length-1]:rxFileNamePt1+"_"+$scope.currentItemId+"_RX."+rxFileNameSplitted[rxFileNameSplitted.length-1],$http.get($scope.downloadImageURL+$scope.params.userId+"/"+rxFileName,{responseType:"blob"}).then((function(response){var blob=response.data;$modal.find(".rx-image").attr("src",window.URL.createObjectURL(blob)),$modal.toggleClass("hidden"),$("html,body").toggleClass("hidden-overflow")}),(function(error){$log.error("Error getting image from service"),obj={id:"Error",Error_Source:"Server",Error_Code:"RX panel",Error_Message:"Unable to load prescription details"},tealium_data2track.push(obj)}))},$scope.datepickerMaxDate=new Date;var startDate=new Date;startDate.setFullYear(startDate.getFullYear()-16),$scope.dateSet=startDate,console.log($scope.dateSet,$scope.datepickerMaxDate),$scope.dobDatePickerToggle=!1,$scope.dobDatePickerToggleFn=function(isVisible=null){$scope.dobDatePickerToggle=null===isVisible?!$scope.dobDatePickerToggle:isVisible}}]),app.filter("range",(function(){return function(input,from,to){to=parseInt(to,10);for(var i=from=parseInt(from,10);i<to;i++)input.push(i);return input}})),app.filter("rxNeeded",(function(){return function(items){var out=[];return angular.forEach(items,(function(item,itemId){null==item.prescriptionId&&out.push(item)})),out}})),app.filter("rxNeededPerType",(function(){return function(items,type){var out=[];return angular.forEach(items,(function(item,itemId){null==item.prescriptionId&&item.itemType==type&&out.push(item)})),out}})),app.filter("rxProvided",(function(){return function(items){var out=[];return angular.forEach(items,(function(item,itemId){null!=item.prescriptionId&&out.push(item)})),out}})),app.filter("isContact",(function(){return function(items){var out=[];return angular.forEach(items,(function(item,itemId){"contact"===item.itemType&&out.push(item)})),out}})),app.filter("isFrame",(function(){return function(items){var out=[];return angular.forEach(items,(function(item,itemId){"frame"===item.itemType&&out.push(item)})),out}})),app.directive("filesInput",(function(){return{require:"ngModel",link:function(scope,elem,attrs,ngModel){elem.on("change",(function(e){scope.fileLoading=!0;var files=elem[0].files,reader=new FileReader;reader.onload=(files[0],function(e){ngModel.$setViewValue({files:files,path:e.target.result})}),reader.readAsDataURL(files[0])}))}}})),app.filter("formatPhoneNumber",(function(){return function(number,filterElem){if(null!=number){var formattedNumber;switch(filterElem){case"()":formattedNumber="($1) $2-$3";break;case"-":formattedNumber="$1-$2-$3"}var phone1=number.substr(0,3),phone2=number.substr(3,3),phone3=number.substr(6);return formattedNumber.replace("$1",phone1).replace("$2",phone2).replace("$3",phone3)}}})),app.directive("dobValidation",(function(){return{require:"ngModel",link:function(scope,element,attr,mCtrl){element.on("keydown",(function(e){e.keyCode;this.value.length>10?(e.preventDefault(),this.value=this.value.substr(0,10)):10==this.value.length&&(e.keyCode>=48&&e.keyCode<=57||e.keyCode>=96&&e.keyCode<=105)&&e.preventDefault()})),mCtrl.$parsers.push((function(value){var myDate=new Date(value),currDate=new Date;return 10==value.length&&"Invalid Date"!=myDate.toString()&&myDate<currDate?(mCtrl.$setValidity("dob",!0),scope.dobDatePickerToggleFn(!1)):(mCtrl.$setValidity("dob",!1),value.length>10&&(value=value.substr(0,10))),value}))}}})),app.filter("nospace",(function(){return function(value){return value?value.replace(/ /g,""):""}})),app.controller("PLPController",["$scope","$rootScope","$window","lcPrescription","$cookies","$http","$location","$compile","$timeout","frameAdvisorFactory","$log",function($scope,$rootScope,$window,lcPrescription,$cookies,$http,$location,$compile,$timeout,frameAdvisorFactory,$log){$scope.storeId=null,$scope.langId=null,$scope.catalogId=null,$scope.categoryId=null,$scope.openFilters=null,$scope.openPrescriptionFilter=null,$scope.currentFilters={},$scope.appliedFilters=[],$scope.baseFiltersURL=location.pathname,$rootScope.brandText="",$scope.contactsPLP=!1,$scope.suggestedFilters={},$scope.labelsToRemove=["Goggles","Rox_lens","Rox_service"];var FILTERS_GENERATE_SEARCHPAGE_URL="/search/resources/store/#storeId#/productview/bySearchTerm/#searchTerm#?storeId=#storeId#&catalogId=#catalogId#&searchType=1&responseFormat=json&langId=#langId#&pageNumber=1&pageSize=1",FILTERS_GENERATE_PLP_URL="/search/resources/store/#storeId#/productview/byCategory/#categoryId#?storeId=#storeId#&catalogId=#catalogId#&searchType=1&responseFormat=json&langId=#langId#&pageNumber=1&pageSize=1";(window.location.href.indexOf("-sku")>-1||window.location.href.indexOf("searchType=101")>-1)&&(FILTERS_GENERATE_SEARCHPAGE_URL="/search/resources/store/#storeId#/productview/bySearchTerm/#searchTerm#?storeId=#storeId#&catalogId=#catalogId#&searchType=101&responseFormat=json&langId=#langId#&pageNumber=1&pageSize=1",FILTERS_GENERATE_PLP_URL="/search/resources/store/#storeId#/productview/byCategory/#categoryId#?storeId=#storeId#&catalogId=#catalogId#&searchType=101&responseFormat=json&langId=#langId#&pageNumber=1&pageSize=1");$scope.od={},$scope.os={},$scope.isModuleEnabled=!1,$scope.params=null,$scope.errorEmpty=!1,$scope.errorNoPrescription=!1,$scope.isFormVisible=!1,$scope.selectedSphOs=null,$scope.selectedSphOd=null,$scope.selectedCylOs=null,$scope.selectedCylOd=null,$scope.selectedCylOd=null,$scope.faPluginState=frameAdvisorFactory.state,$scope.openSizeAdv=function(){$scope.openFilters=!1,frameAdvisorFactory.openSizeAdvisor()},$scope.useMySizeOn=JSON.parse(sessionStorage.getItem("sa-use-my-size"))||!1,sessionStorage.removeItem("sa-use-my-size"),$scope.useMySize=function(){if(size=$scope.faPluginState.sa.sizeData.label,frameSizeFacet=$scope.currentFilters.facetView.find((f=>"FRAME_SIZE_DISPLAY"===f.name)),facetName=frameSizeFacet.value,frameSizeEntry=frameSizeFacet.entry.find((s=>s.label===size)),frameSizeEntry){if($scope.mySizeNotFound=!1,$scope.useMySizeOn||($scope.currentAppliedFacets[facetName]=[]),$scope.useMySizeOn=!$scope.useMySizeOn,sessionStorage.setItem("sa-use-my-size",$scope.useMySizeOn),$scope.updateFilter(frameSizeFacet,frameSizeEntry),$scope.useMySizeOn)try{tealium_data2track.push({id:"Event",Search_ResultItemsQnt:frameSizeEntry.count.toString(),Events_SearchFiltering:"1",Search_FacetValues_Type:"SizeGenius"})}catch(error){$log.error("Error during tealium_data2track push. "+error)}}else $scope.mySizeNotFound=!0},$scope.mobileTwoColumns=!1,$scope.setMobileTwoColumns=function(value){$scope.mobileTwoColumns=!!value,$timeout((function(){window.dispatchEvent(new Event("resize")),angular.element(document.querySelectorAll(".slick-slider")).slick("refresh")}),0)};$rootScope.wrapAngular=function(elementFunc){$compile(elementFunc)($scope)},$scope.init=function(params){$scope.storeId=params.storeId,$scope.langId=params.langId,$scope.catalogId=params.catalogId,$scope.categoryId=params.categoryId,$scope.searchTerm=params.searchTerm,$scope.lifecycleFacet=params.lifecycleFacet,$scope.inStockFacet=params.inStockFacet,$scope.inStoreOnlyFacet=params.inStoreOnlyFacet,$scope.openFilters=!1,$scope.openPrescriptionFilter=!1,$scope.contactsPLP=!!params.contactsPLP&&params.contactsPLP,$scope.prescriptionFilterEnabled=params.prescriptionFilterEnabled,$scope.isEA=!!params.isEA&&params.isEA,$scope.isEAOfferPriceEnabled=params.isEAOfferPriceEnabled,$scope.generatePrescriptionValues(),$scope.currentAppliedFacets=$scope.getUrlFacets()||[],$scope.getFilters();var prescriptionFlow=$cookies.get("prescriptionFlow");if($scope.prescriptionFilterEnabled&&prescriptionFlow&&"true"==prescriptionFlow&&($scope.isModuleEnabled=!0,$scope.params=params,lcPrescription.init($scope.params.storeId,$scope.params.catalogId),lcPrescription.loadPrescription().then((function(response){$scope.selectedCylOs=null,$scope.selectedCylOd=null,null!=response?($log.log("Prescription loaded"),$scope.isFormVisible=!1,$scope.selectedSphOd=response.SPH.OD>0?"+"+response.SPH.OD:response.SPH.OD,$scope.selectedSphOs=response.SPH.OS>0?"+"+response.SPH.OS:response.SPH.OS,response.CYL&&($scope.selectedCylOd=response.CYL.OD>0?"+"+response.CYL.OD:response.CYL.OD,$scope.selectedCylOs=response.CYL.OS>0?"+"+response.CYL.OS:response.CYL.OS)):null==response&&($log.log("No prescription data found"),$scope.isFormVisible=!0,$scope.selectedSphOs=null,$scope.selectedSphOd=null),$scope.$apply()}),(function(error){$log.error(error)}))),$(".slick-prod-thumb").on("init",(function(evt,slickObj){slickObj.slideCount>1&&($(slickObj.$nextArrow).on("mouseenter",(function(e){$(slickObj.$slides).each((function(index,item){angular.element($(this).find("a")[0]).triggerHandler("mouseenter")}))})),$(slickObj.$prevArrow).on("mouseenter",(function(e){$(slickObj.$slides).each((function(index,item){angular.element($(this).find("a")[0]).triggerHandler("mouseenter")}))})),$(slickObj.$prevArrow).add($(slickObj.$nextArrow)).on("click",(function(e){e.stopImmediatePropagation()})),$(slickObj.$slider[0]).on("afterChange",(function(event,slick,currentSlide,nextSlide){event.stopImmediatePropagation(),function(slickObj){$(slickObj.$slides).each((function(index,item){if($(this).hasClass("slick-active")){var nextSlickClasses=$(this).attr("class").split(" "),nextProductId=null;if($.each(nextSlickClasses,(function(index,value){value.indexOf("product-container-")>-1&&(nextProductId=value.replace("product-container-",""))})),nextProductId){var currProdId,nextProductListPrice=$("#"+nextProductId+"_list_price").val(),nextProductOfferPrice=$("#"+nextProductId+"_offer_price").val(),nextProductIsAmountOff=$("#"+nextProductId+"_amount_off").val(),nextProductAttributes=$("#"+nextProductId+"_attributes").val();nextProductAttributes=(nextProductAttributes=(nextProductAttributes=nextProductAttributes.replace(/[\r\t\n]/g,"")).replace(/ /g,"")).split("|");var sliderIdElements=$(slickObj.$slider[0]).attr("id").split("_"),indexDiv=sliderIdElements.indexOf("div");currProdId=sliderIdElements[indexDiv-1],$("#badges_"+currProdId),$("#sub-badges_"+currProdId);var MAX_VISIBLE_BADGES=$("#MAX_VISIBLE_BADGES").val();$("#badges_"+currProdId+" > span").each((function(index,item){item.setAttribute("style","display: none")})),0==$("#sub-badges_"+currProdId+" > .sub-badge-polarized.hide").length&&$("#sub-badges_"+currProdId+" > .sub-badge-polarized").addClass("hide");var badgeCount=0;for(let i=0;i<nextProductAttributes.length;i++){const el=nextProductAttributes[i];if(""!=el)if("prerelease"==el&&badgeCount<=MAX_VISIBLE_BADGES)$("#badges_"+currProdId+" > .badge-pre-release").removeAttr("style"),badgeCount+=1;else if("new"==el&&badgeCount<=MAX_VISIBLE_BADGES&&!nextProductAttributes.includes("best")){const indexprodType=nextProductAttributes.findIndex((element=>{if(element.includes("prodType"))return!0}));-1!=indexprodType?"Electronics"!=nextProductAttributes[indexprodType].split("=")[1]&&($("#badges_"+currProdId+" > .badge-new").removeAttr("style"),badgeCount+=1):($("#badges_"+currProdId+" > .badge-new").removeAttr("style"),badgeCount+=1)}else"instoreonly"==el&&badgeCount<=MAX_VISIBLE_BADGES?($("#badges_"+currProdId+" > .badge-in-store-only").removeAttr("style"),badgeCount+=1):"exclusive"==el&&badgeCount<=MAX_VISIBLE_BADGES?($("#badges_"+currProdId+" > .badge-exclusive").removeAttr("style"),badgeCount+=1):"limited"==el&&badgeCount<=MAX_VISIBLE_BADGES?($("#badges_"+currProdId+" > .badge-limited-availability").removeAttr("style"),badgeCount+=1):"best"==el&&badgeCount<=MAX_VISIBLE_BADGES?($("#badges_"+currProdId+" > .badge-best-seller").removeAttr("style"),badgeCount+=1):"polarized"==el&&$("#sub-badges_"+currProdId+" > .sub-badge-polarized").removeClass("hide")}var slickPriceDiv=$("#"+$(slickObj.$slider[0]).attr("id")+"0");if(nextProductListPrice===nextProductOfferPrice)slickPriceDiv.find(".price.listPrice").text(""),slickPriceDiv.find("span.price.offerprice").length>0?slickPriceDiv.find("span.price.offerprice").text(nextProductOfferPrice):slickPriceDiv.find("div.price.offerprice span.offer-price").length>0&&slickPriceDiv.find("div.price.offerprice span.offer-price").text(nextProductOfferPrice),slickPriceDiv.find(".badge-BF").text("");else{var nextProductListPriceValue=parseFloat(nextProductListPrice.replace("$","")),nextProductOfferPriceValue=parseFloat(nextProductOfferPrice.replace("$",""));if(nextProductListPriceValue>nextProductOfferPriceValue){var discountPercentage=100-nextProductOfferPriceValue/nextProductListPriceValue*100,amountOffDiscountPercentage=nextProductListPriceValue-nextProductOfferPriceValue;slickPriceDiv.find(".price.listPrice").length>0||slickPriceDiv.prepend("<span class='price listPrice'></span>"),slickPriceDiv.find(".price.listPrice").text(nextProductListPrice),slickPriceDiv.find("span.price.offerprice").length>0?slickPriceDiv.find("span.price.offerprice").text(nextProductOfferPrice):slickPriceDiv.find("div.price.offerprice span.offer-price").length>0&&slickPriceDiv.find("div.price.offerprice span.offer-price").text(nextProductOfferPrice),"true"==nextProductIsAmountOff?(slickPriceDiv.find(".badge-BF").length>0||slickPriceDiv.append("<span class='badge-BF'></span>"),slickPriceDiv.find(".badge-BF").text("$"+amountOffDiscountPercentage+" Off")):(slickPriceDiv.find(".badge-BF").length>0||slickPriceDiv.append("<span class='badge-BF'></span>"),slickPriceDiv.find(".badge-BF").text(discountPercentage+"% Off"))}}}}}))}(slickObj)})))})),window.innerWidth>480){var startX,scrollLeft,slider=document.querySelector(".dash-buttons-holder .row"),isDown=!1;null!=slider&&(slider.addEventListener("mousedown",(e=>{isDown=!0,slider.classList.add("active"),startX=e.pageX-slider.offsetLeft,scrollLeft=slider.scrollLeft})),slider.addEventListener("mouseleave",(()=>{isDown=!1,slider.classList.remove("active")})),slider.addEventListener("mouseup",(()=>{isDown=!1,slider.classList.remove("active")})),slider.addEventListener("mousemove",(e=>{if(isDown){e.preventDefault();var walk=e.pageX-slider.offsetLeft-startX;slider.scrollLeft=scrollLeft-walk}})))}if(window.localAppliedFilters&&window.localAppliedFilters.ELECTRONICS&&window.localAppliedFilters.ELECTRONICS.length>0&&window.localAppliedFilters.Glasses){var electronicsFacetEntry=window.localAppliedFilters.ELECTRONICS[0];window.localAppliedFilters.Glasses.push(electronicsFacetEntry),window.localAppliedFilters.ELECTRONICS.splice(0,1)}},$scope.submitPrescription=function(){if($scope.errorEmpty=!1,$scope.errorNoPrescription=!1,$log.log($scope.selectedSphOd),null==$scope.selectedSphOs||null==$scope.selectedSphOd){$scope.errorEmpty=!0;try{tealium_data2track.push({id:"Error",Error_Code:"Oops! You need to add your values",Error_Source:"User"})}catch(error){$log.error("Error during tealium_data2track push. "+error)}}else{var frame={category:$scope.params.category},prescriptionObject={SPH:{OD:parseFloat($scope.selectedSphOd),OS:parseFloat($scope.selectedSphOs)},ADD:!1};null!=$scope.selectedCylOd&&null!=$scope.selectedCylOs&&(prescriptionObject.CYL={OD:parseFloat($scope.selectedCylOd),OS:parseFloat($scope.selectedCylOs)});var selectedFacets=$scope.params.selectedFacets,searchType=$scope.params.searchType;lcPrescription.checkAvailableFramesWithCount(frame,prescriptionObject,selectedFacets,!0,searchType).then((function(response){if(void 0!==response.count&&response.count>0)$scope.$apply((function(){$scope.isFormVisible=!1})),lcPrescription.savePrescription(prescriptionObject),sessionStorage.setItem("prescriptionFilterUtag","prescription=true"),$window.location.reload();else{try{tealium_data2track.push({id:"Error",Error_Source:"User",Error_Code:"RX Configurator: prescription values",Error_Details:"SPHOD:"+prescriptionObject.SPH.OD+",SPHOS:"+prescriptionObject.SPH.OS+",CYLOD:"+prescriptionObject.CYL.OD+",CYLOS:"+prescriptionObject.CYL.OS,Error_Message:"Sorry! The frame you've chosen isn't compatible with your prescription"})}catch(error){$log.error("Error during tealium_data2track push. Check if tealium_data2track exists in the window.\n"+error)}$scope.$apply((function(){$scope.errorNoPrescription=!0}))}}),(function(error){$log.error(error);try{tealium_data2track.push({id:"Error",Error_Source:"User",Error_Code:"RX Configurator: prescription values",Error_Details:"SPHOD:"+prescriptionObject.SPH.OD+",SPHOS:"+prescriptionObject.SPH.OS+",CYLOD:"+prescriptionObject.CYL.OD+",CYLOS:"+prescriptionObject.CYL.OS,Error_Message:"Sorry! The frame you've chosen isn't compatible with your prescription"})}catch(error){$log.error("Error during tealium_data2track push. Check if tealium_data2track exists in the window.\n"+error)}$scope.$apply((function(){$scope.errorNoPrescription=!0}))}))}},$scope.generatePrescriptionValues=function(){for(j=-20,i=1;j<=20;)j,$scope.od[i]=j,j+=.25,i+=1;for(j=-20,i=1;j<=20;)j,$scope.os[i]=j,j+=.25,i+=1;for($scope.positive={},$scope.negative={},j=0,i=0;j<20;)j=1*j+.25,j+="",j.split(".")[1]?1===j.split(".")[1].length&&(j+="0"):j+=".00",$scope.positive[i]="+"+j,i+=1;for(j=0,i=0;j>-20;)j=1*j-.25,j+="",j.split(".")[1]?1===j.split(".")[1].length&&(j+="0"):j+=".00",$scope.negative[i]=j,i+=1},$scope.clearPrescription=function(){$scope.isFormVisible=!0,$scope.selectedCylOd=null,$scope.selectedCylOs=null,$scope.selectedSphOs=null,$scope.selectedSphOd=null,sessionStorage.getItem("prescriptionFilterUtag")&&sessionStorage.removeItem("prescriptionFilterUtag"),lcPrescription.clearPrescription(),$window.location.reload()},$scope.filterBrand=function(obj){return null==$rootScope.brandText||""==$rootScope.brandText||!!obj.label.toLowerCase().startsWith($rootScope.brandText.toLowerCase())},$scope.isSuggestedFilter=function(obj){var found=!1;return angular.forEach($scope.suggestedFilters,(function(filter,i){found||(found=-1!=filter.indexOf(obj.label))})),found},$scope.getFilters=function(){var url=FILTERS_GENERATE_PLP_URL.replaceAll("#storeId#",$scope.storeId).replace("#langId#",$scope.langId).replace("#catalogId#",$scope.catalogId).replace("#categoryId#",$scope.categoryId),profileNameVal=$scope.contactsPLP?"RONA_findProductsByCategory_CL":"RONA_findProductsByCategory_group";null!=$scope.searchTerm&&""!=$scope.searchTerm&&(url=FILTERS_GENERATE_SEARCHPAGE_URL.replaceAll("#storeId#",$scope.storeId).replace("#langId#",$scope.langId).replace("#catalogId#",$scope.catalogId).replace("#searchTerm#",$scope.searchTerm),profileNameVal=$scope.contactsPLP?"RONA_CL_findProductsBySearchTerm":"RONA_findProductsBySearchTerm"),null!=$scope.categoryId&&""!=$scope.categoryId&&(url=(url=url+"&categoryId="+$scope.categoryId)+"&profileName="+profileNameVal),$scope.inStockFacet&&!$scope.contactsPLP&&(url=url+"&facet="+$scope.inStockFacet+"%3A1"),$scope.inStoreOnlyFacet&&(url+="&facet=-"+$scope.inStoreOnlyFacet+"%3A1"),angular.forEach($scope.currentAppliedFacets,(function(facet,facetCode){angular.forEach(facet,(function(facetValue,i){url=url+"&facet="+facetCode+"%3A"+facetValue}))})),$http.get(url).then((function(response){if(response&&response.data.recordSetTotal>0){$scope.currentFilters=response.data;var filtersLabels={GENDER:"Gender",PRODUCT_TYPE:"Product Type",BRAND:"Brand",FRAME_SHAPE_FACET:"Frame shape",FRAME_MATERIAL_FACET:"Frame material",MATERIAL:"FRAME_MATERIAL_CLASS",FRONT_COLOR_FACET:"Frame color",OfferPrice_USD:"Price",OfferPrice_LC_EA_USD:"Price",OfferPrice_CAD:"Price",OfferPrice_LC_EA_CAD:"Price",CL_BRAND_FAMILY:"Brand",CL_MATERIAL_PATENTED:"FRAME_MATERIAL_CLASS",CL_SUPPLIER:"Manufacturer",CL_MODALITY:"Category",CL_CORRECTION_TYPE:"Type",FRAME_SIZE:"Fit",FRAME_FITTING:"Frame size",MACRO_AGE_RANGE:"Macro age range",FRAME_SIZE_DISPLAY:"Frame size",IS_NEW:"New",EXCLUSIVE:"Exclusive",POLARIZED:"Polarized sunglasses",LENS_TREATMENT_FACET:"Lens treatment",LENS_COLOR_FACET:"Lens Color",OnSale_USD:"On Sale",OnSale_CAD:"On Sale",OnSale_EA_USD:"On Sale",OnSale_EA_CAD:"On Sale",FRAME_FITTING:"Fitting",GEOFIT:"Bridge and nosepads",HIGH_PRESCRIPTION:"High prescription"};$scope.currentFilters.facetView.sort((function(facet1,facet2){return"OfferPrice_USD"==facet1.name||"OfferPrice_CAD"==facet1.name||"OfferPrice_EA_LC_USD"==facet1.name||"OfferPrice_EA_LC_CAD"==facet1.name?facet1.extendedData.attrsequence="3.0":"OfferPrice_USD"!=facet2.name&&"OfferPrice_CAD"!=facet2.name&&"OfferPrice_EA_LC_USD"!=facet2.name&&"OfferPrice_EA_LC_CAD"!=facet2.name||(facet2.extendedData.attrsequence="3.0"),null==facet1.extendedData.attrsequence&&(facet1.extendedData.attrsequence="99.0"),null==facet2.extendedData.attrsequence&&(facet2.extendedData.attrsequence="99.0"),parseFloat(facet1.extendedData.attrsequence)-parseFloat(facet2.extendedData.attrsequence)}));var productTypeFilterOn=!0,genderFilterOn=!0,brandFilterOn=!0,glassesIndex=-1,genderIndex=-1,electronicsEntry=null,polarizedFilterOn=!0,kidsEntry=null,highPrescriptionFilterOn=!0;if(window.location.href.indexOf("kids-")>-1)genderFilterOn=!1;$scope.currentFilters.facetView.forEach((function(facetView,indexFacetView){"MACRO_AGE_RANGE"==facetView.name&&facetView.entry.forEach((function(value,index){"Children"==facetView.entry[index].label&&(facetView.entry[index].label="Kids",kidsEntry=facetView.entry[index])}))})),$scope.currentFilters.facetView.forEach((function(facetView,indexFacetView){if(null!=filtersLabels[facetView.extendedData.attridentifier]){if($scope.currentFilters.facetView[indexFacetView].label=filtersLabels[facetView.extendedData.attridentifier],"BRAND"==facetView.name&&(window.location.href.indexOf("/brands/")>-1||facetView.entry.length<2?brandFilterOn=!1:facetView.entry.sort((function(a,b){return a.label<b.label?-1:a.label>b.label?1:0}))),"GENDER"==facetView.name){let removedUnisex;genderIndex=indexFacetView,null!=kidsEntry&&-1!=genderIndex&&$scope.currentFilters.facetView[genderIndex].entry.push(kidsEntry),facetView.entry.sort((function(a,b){return a.label<b.label?-1:a.label>b.label?1:0})),facetView.entry,removedUnisex=$scope.removeItemByLabel(facetView,"Unisex"),removedUnisex&&(facetView.entry=$scope.concatenateFilters(facetView,removedUnisex))}function aggregateEntries(entries,mappings,descriptions){const groups={};for(group of Object.values(mappings))groups[group]=[];entries.forEach((function(entry){mappings[entry.label]&&groups[mappings[entry.label]].push(entry)})),newEntries=[];for(const[group,entries]of Object.entries(groups))newEntry=entries.reduce(((accum,curr)=>(accum.value?accum.value+="OR"+curr.value:accum.value=curr.value,accum.count=+accum.count+ +curr.count,accum)),{count:0,value:""}),newEntry.label=group,descriptions&&descriptions[group]&&(newEntry.description=descriptions[group]),newEntries.push(newEntry);return newEntries}"PRODUCT_TYPE"==facetView.name&&(facetView.entry.length<2&&(productTypeFilterOn=!1),glassesIndex=indexFacetView,facetView.entry=$scope.removeFacetsEntry(facetView.entry)),"FRAME_SIZE_DISPLAY"==facetView.name&&facetView.entry.sort((function(a,b){return"XXS"===a.label||"XXL"===b.label||"XS"===a.label&&"S"===b.label||"XS"===a.label&&"M"===b.label||"XS"===a.label&&"L"===b.label||"XS"===a.label&&"XL"===b.label||"S"===a.label&&"M"===b.label||"S"===a.label&&"L"===b.label||"S"===a.label&&"XL"===b.label||"M"===a.label&&"L"===b.label||"M"===a.label&&"XL"===b.label||"L"===a.label&&"XL"===b.label?-1:"XXL"===a.label||"XXS"===b.label||"XL"===b.label&&"XS"===a.label||"L"===b.label&&"XS"===a.label||"S"===b.label&&"XS"===a.label||"M"===b.label&&"XS"===a.label||"XL"===b.label&&"S"===a.label||"L"===b.label&&"S"===a.label||"XS"===b.label&&"S"===a.label||"M"===b.label&&"S"===a.label||"XL"===b.label&&"M"===a.label||"L"===b.label&&"M"===a.label||"XS"===b.label&&"M"===a.label||"S"===b.label&&"M"===a.label||"XL"===b.label&&"L"===a.label||"XS"===b.label&&"L"===a.label||"S"===b.label&&"L"===a.label||"M"===b.label&&"L"===a.label||"S"===b.label&&"XL"===a.label||"L"===b.label&&"XL"===a.label||"XS"===b.label&&"XL"===a.label||"M"===b.label&&"XL"===a.label?1:0})),"POLARIZED"==facetView.name&&(facetView.entry.length<2&&null!=$scope.currentAppliedFacets&&(null==$scope.currentAppliedFacets[facetView.value]||null!=$scope.currentAppliedFacets[facetView.value]&&$scope.currentAppliedFacets[facetView.value].length<0)&&(polarizedFilterOn=!1),facetView.entry=facetView.entry.filter((function(facetViewEntry,index){return"True"==facetViewEntry.label})),facetView.entry.forEach((function(facetViewEntry,indexFacetViewEntry){"True"==facetViewEntry.label&&($scope.currentFilters.facetView[indexFacetView].entry[indexFacetViewEntry].label="Polarized")}))),"IS_NEW"==facetView.name&&facetView.entry.forEach((function(facetViewEntry,indexFacetViewEntry){"1"==facetViewEntry.label?$scope.currentFilters.facetView[indexFacetView].entry[indexFacetViewEntry].label="True":"0"==facetViewEntry.label&&($scope.currentFilters.facetView[indexFacetView].entry[indexFacetViewEntry].label="False")})),"FRAME_FITTING"==facetView.name&&(facetView.entry=aggregateEntries(facetView.entry,{Narrow:"Narrow fitting",Regular:"Regular fitting",Standard:"Regular fitting",Average:"Regular fitting",Wide:"Wide fitting",Oversized:"Wide fitting"},{"Narrow fitting":"A small lens front designed for those with a more narrow head.","Regular fitting":"A medium lens front designed for those with an average-sized head.","Wide fitting":"A larger lens front designed for those with a wider head."})),"GEOFIT"==facetView.name&&(facetView.entry=aggregateEntries(facetView.entry,{"Adjustable Nosepads":"Adjustable Nosepads","High Bridge Fit":"High Bridge Fit","Low Bridge Fit":"Low Bridge Fit","Universal Fit":"Universal Fit",Asian:"Low Bridge Fit","Asian Design":"Low Bridge Fit","Asian Fitting":"Low Bridge Fit","Full Fitting":"Low Bridge Fit",Global:"Adjustable Nosepads",International:"High Bridge Fit","Universal Fitting":"Universal Fit"},{"Adjustable Nosepads":"Adjustable nosepads can be widened or narrowed to fit your unique nose shape.","High Bridge Fit":"Offers a more secure and comfortable fit for those with a high nose bridge and lower cheekbones. A good choice if the bridge of your nose is above the level of your pupils.","Low Bridge Fit":"Offers a more secure and comfortable fit for those with a low nose bridge and higher cheekbones. A good choice if eyewear tends to slide down your nose, sit too low, or press on your temples or cheeks.","Universal Fit":"This option accommodates most face shapes."})),"HIGH_PRESCRIPTION"==facetView.name&&(0==facetView.entry.length?highPrescriptionFilterOn=!1:(facetView.entry=facetView.entry.filter((function(facetViewEntry,index){return"TRUE"==facetViewEntry.label.toUpperCase()})),facetView.entry.forEach((function(facetViewEntry,indexFacetViewEntry){"TRUE"==facetViewEntry.label.toUpperCase()&&($scope.currentFilters.facetView[indexFacetView].entry[indexFacetViewEntry].label="High prescription")}))))}else $scope.currentFilters.facetView[indexFacetView].label=filtersLabels[facetView.name],"OfferPrice_USD"!=facetView.name&&"OfferPrice_CAD"!=facetView.name&&"OfferPrice_LC_EA_USD"!=facetView.name&&"OfferPrice_LC_EA_CAD"!=facetView.name||facetView.entry.forEach((function(facetViewEntry,indexFacetViewEntry){"({* 100} 100)"==facetViewEntry.label?$scope.currentFilters.facetView[indexFacetView].entry[indexFacetViewEntry].label="Under $100":"({* 200} 200)"==facetViewEntry.label?$scope.currentFilters.facetView[indexFacetView].entry[indexFacetViewEntry].label="$200 and up":"({* 149.99} 149.99)"==facetViewEntry.label?$scope.currentFilters.facetView[indexFacetView].entry[indexFacetViewEntry].label="Under $149.99":"({150 249.99} 249.99)"==facetViewEntry.label?$scope.currentFilters.facetView[indexFacetView].entry[indexFacetViewEntry].label="$150.00 - $240.99":"({250 *})"==facetViewEntry.label&&($scope.currentFilters.facetView[indexFacetView].entry[indexFacetViewEntry].label="$250 and up")})),"ELECTRONICS"==facetView.name&&facetView.entry&&(electronicsEntry=facetView.entry[0]),"OnSale_USD"==facetView.name||"OnSale_CAD"==facetView.name||"OnSale_EA_USD"==facetView.name||facetView.name})),null!=electronicsEntry&&-1!=glassesIndex&&$scope.currentFilters.facetView[glassesIndex].entry.push(electronicsEntry);var enabledFilters=[];if($scope.contactsPLP?enabledFilters=["FRAME_SHAPE","FRAME_SIZE","CL_MATERIAL_PATENTED","OfferPrice_USD","OfferPrice_CAD","CL_BRAND_FAMILY","FRONT_COLOR_FACET","CL_SUPPLIER","CL_MODALITY","CL_CORRECTION_TYPE","FRAME_MATERIAL_FACET"]:(enabledFilters=["FRAME_SIZE","CONTACT_MATERIAL","FRAME_SIZE_DISPLAY","FRAME_SHAPE_FACET","FRAME_MATERIAL_FACET","FRONT_COLOR_FACET","LENS_TREATMENT_FACET","FRAME_MATERIAL_FACET","LENS_COLOR_FACET","EXCLUSIVE","IS_NEW","FRAME_FITTING","GEOFIT"],$scope.isEA&&$scope.isEAOfferPriceEnabled?10851==$scope.storeId?enabledFilters.push("OfferPrice_LC_EA_USD"):enabledFilters.push("OfferPrice_LC_EA_CAD"):(enabledFilters.push("OfferPrice_USD"),enabledFilters.push("OfferPrice_CAD")),genderFilterOn&&enabledFilters.push("GENDER"),productTypeFilterOn&&enabledFilters.push("PRODUCT_TYPE"),polarizedFilterOn&&enabledFilters.push("POLARIZED"),highPrescriptionFilterOn&&enabledFilters.push("HIGH_PRESCRIPTION"),brandFilterOn&&enabledFilters.push("BRAND")),utag_data.Page_Section2.includes("Eyeglasses")||utag_data.Page_Section2.includes("eyeglasses")||utag_data.Page_Section2.includes("Bluelightglasses")||utag_data.Page_Section1.includes("eyeglasses")||utag_data.Page_Section1.includes("Eyeglasses")){var indexRemove=enabledFilters.indexOf("LENS_COLOR_FACET");indexRemove>-1&&enabledFilters.splice(indexRemove,1),(indexRemove=enabledFilters.indexOf("LENS_TREATMENT_FACET"))>-1&&enabledFilters.splice(indexRemove,1),(indexRemove=enabledFilters.indexOf("POLARIZED"))>-1&&enabledFilters.splice(indexRemove,1)}$scope.currentFilters.facetView=response.data.facetView.filter((function(facetView,index){return-1!=enabledFilters.indexOf(facetView.extendedData.attridentifier)||(!(("OfferPrice_USD"!=facetView.name||$scope.isEA&&$scope.isEAOfferPriceEnabled)&&("OfferPrice_CAD"!=facetView.name||$scope.isEA&&$scope.isEAOfferPriceEnabled)&&("OfferPrice_LC_EA_USD"!=facetView.name||!$scope.isEA||!$scope.isEAOfferPriceEnabled||10851!=$scope.storeId)&&("OfferPrice_LC_EA_CAD"!=facetView.name||$scope.isEA&&$scope.isEAOfferPriceEnabled||10852!=$scope.storeId))||("OnSale_USD"==facetView.name&&(!$scope.isEA||!$scope.isEAOfferPriceEnabled)||"OnSale_CAD"==facetView.name&&(!$scope.isEA||!$scope.isEAOfferPriceEnabled)||"OnSale_EA_USD"==facetView.name&&$scope.isEA&&$scope.isEAOfferPriceEnabled&&10851==$scope.storeId||"OnSale_EA_CAD"==facetView.name&&(!$scope.isEA||!$scope.isEAOfferPriceEnabled)&&$scope.storeId,!1))})),$scope.currentFilters.appliedCount=0,angular.forEach($scope.currentAppliedFacets,(function(appFilter,appFilterName){if(appFilter.length>0){var appFilterNameMapped=appFilterName;"ELECTRONICS"==appFilterNameMapped&&(appFilterNameMapped="Glasses"),$scope.currentFilters.facetView.forEach((function(facetView,indexFacetView){var facetName=facetView.value;"OfferPrice_USD"==facetView.name&&(facetName="price_USD"),"OfferPrice_CAD"==facetView.name&&(facetName="price_CAD"),"OfferPrice_LC_EA_USD"==facetView.name&&(facetName="eaprice_LC_USD"),"OfferPrice_LC_EA_CAD"==facetView.name&&(facetName="eaprice_LC_CAD"),"Gender"==facetView.label&&(facetName=appFilterName),facetName==appFilterNameMapped&&facetView.entry.forEach((function(entry,indexEntry){$scope.currentAppliedFacets[appFilterName].forEach((function(appFilterValue,appFilterIndex){var facetValue=entry.value.split("%3A").slice(1).join("%3A").replaceAll("%22","").replaceAll('"',"");facetValue=facetValue.split("&")[0],appFilterValue=appFilterValue.replaceAll("%22","").replaceAll('"',""),""!=facetValue&&appFilterValue==facetValue&&($scope.currentFilters.facetView[indexFacetView].entry[indexEntry].selected=!0,$scope.currentFilters.appliedCount++)}))}))}))}})),0==$scope.currentFilters.appliedCount&&sessionStorage.removeItem("filtersUtag")}}),(function(error){$scope.currentFilter={}}))},$scope.removeFacetsEntry=function(entries){let newEntries=[];for(let e of entries)$scope.labelsToRemove.includes(e.label)||newEntries.push(e);return newEntries},$scope.removeItemByLabel=function(currFacetView,label){let indexToRemove,valToremove,removed;return currFacetView.entry.forEach((function(value,index){currFacetView.entry[index].label.toLowerCase()==label.toLowerCase()&&(indexToRemove=index,valToremove=currFacetView.entry[index].value,removed=value)})),currFacetView.entry.splice(indexToRemove,1),currFacetView.entry,removed},$scope.concatenateFilters=function(currFacetView,entryToConcatenate){return currFacetView.entry.forEach((function(value,index){currFacetView.entry[index].label.toLowerCase()!="Man".toLowerCase()&&currFacetView.entry[index].label.toLowerCase()!="Woman".toLowerCase()||(currFacetView.entry[index].value+="&facet="+entryToConcatenate.value.split("%3A")[0]+"%3A%22"+entryToConcatenate.label+"%22")})),currFacetView.entry},$scope.updateFilter=function(facet,entry){if(0!=entry.count){var filter=entry.value.split("%3A");-1!=entry.value.indexOf("price")&&(filter=entry.value.split("%3A"));var filterName=filter[0],filterValue=filter.slice(1).join("%3A");null==$scope.currentAppliedFacets[filterName]&&($scope.currentAppliedFacets[filterName]=[]);var found=!1,originalArray=JSON.parse(JSON.stringify($scope.currentAppliedFacets));facet.name;"OfferPrice_USD"!=facet.name&&"OfferPrice_CAD"!=facet.name&&"OfferPrice_LC_EA_USD"!=facet.name&&"OfferPrice_LC_EA_CAD"!=facet.name||"Price",null!=$scope.currentAppliedFacets[filterName]&&$scope.currentAppliedFacets[filterName].forEach((function(appFilter,i){var facetValue=entry.value.split("%3A").slice(1).join("%3A").replaceAll("%22","").replaceAll('"',"");facetValue=facetValue.split("&")[0];var appFilterCleaned=appFilter.replaceAll("%22","").replaceAll('"',"");""!=facetValue&&appFilterCleaned==facetValue&&(found=!0,originalArray[filterName].splice(i,1))})),found||originalArray[filterName].push(filterValue),$scope.currentAppliedFacets=originalArray,$scope.getFilters()}},$scope.backToTop=function(){document.body.scrollTop=0,document.documentElement.scrollTop=0},$scope.seeResults=function(){var urlElements=window.location.href.split("?"),baseURL=urlElements[0].split("#")[0],params=[];if(urlElements.length>1)params=urlElements[1].split("&");var parameters="page=1&";angular.forEach(params,(function(param,i){param.startsWith("facet")||param.startsWith("page")||param.startsWith("sku[]")||(parameters=parameters+param+"&")})),"undefined"!=typeof RONACatalogEntryQuickView&&void 0!==RONACatalogEntryQuickView.selectedProduct&&angular.forEach(RONACatalogEntryQuickView.selectedProduct,(function(product,i){parameters=parameters+"sku[]="+product.sku+"&"}));var newUrl=baseURL+"?"+parameters,applyCLCategoryURLRewrite=!0;null!=window.contactLensesCategoriesWithParams&&(applyCLCategoryURLRewrite=window.contactLensesCategoriesWithParams.split(",").indexOf($scope.categoryId)<0);if(applyCLCategoryURLRewrite&&newUrl.indexOf("/contact-lenses")>-1){var contactsBrandToRemove=newUrl.slice(newUrl.indexOf("/contact-lenses"));newUrl=newUrl.replace(contactsBrandToRemove,"/contact-lenses?")}utag_data.Search_FacetValues_String="",angular.forEach($scope.currentAppliedFacets,(function(facetValue,facetName){var facetDisplayName="";for(var facetViewIndex in $scope.currentFilters.facetView)if($scope.currentFilters.facetView[facetViewIndex].value===facetName){facetDisplayName=$scope.currentFilters.facetView[facetViewIndex].label;break}angular.forEach(facetValue,(function(singleFacetValue,i){newUrl=newUrl+"facet="+facetName+"%3A"+singleFacetValue+"&"})),facetValue=facetValue?decodeURI(facetValue).replaceAll('"',""):"",""==utag_data.Search_FacetValues_String?(sessionStorage.setItem("filtersUtag",facetDisplayName+"="+facetValue),utag_data.Search_FacetValues_String=sessionStorage.getItem("filtersUtag")):(sessionStorage.setItem("filtersUtag",utag_data.Search_FacetValues_String+"|"+facetDisplayName+"="+facetValue),utag_data.Search_FacetValues_String=sessionStorage.getItem("filtersUtag"))})),$log.log("plpCtrl - set Events_SearchFiltering"),$window.location=newUrl.slice(0,-1)},$scope.clearFilters=function(){angular.forEach($scope.currentAppliedFacets,(function(filter,i){$scope.currentAppliedFacets[i]=[]})),$scope.getFilters(),sessionStorage.removeItem("filtersUtag"),categoryDisplayJS.clearFacets()},$scope.getUrlFacets=function(){var params={};window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi,(function(m,key,value){if(key.includes("facet")){var facet=value.split("%3A");null==params[facet[0]]&&(params[facet[0]]=[]),params[facet[0]].push(facet.slice(1).join("%3A"))}0}));return params},$scope.$timeout=$timeout,$scope.qnaInitializer=function(){jsonElements=document.querySelectorAll('[type="application/ld+json"]');for(var i=0;i<jsonElements.length;i++)try{if(null!=jsonElements[i].innerHTML&&(qnasObj=JSON.parse(jsonElements[i].innerHTML),$log.log(qnasObj),null!=qnasObj[0]["@type"]&&"FAQPage"==qnasObj[0]["@type"])){qnasObj[0].mainEntity.length>0&&($scope._qnas=qnasObj);break}}catch(error){$log.error("Json does not contain faq")}},$scope.getQNA=function(text,index,type){"question"==type?(elements=document.getElementsByClassName("plp_question"),elements[index].innerHTML=text):"answer"==type&&(elements=document.getElementsByClassName("plp_a"),elements[index].innerHTML=text)},$scope.showAnswer=function($event,isAlwaysOpen){isAlwaysOpen||(questions=document.getElementsByClassName("plp_q"),answers=document.getElementsByClassName("plp_a"),plusIcons=document.getElementsByClassName("plus-icon"),minusIcons=document.getElementsByClassName("minus-icon"),index=Array.prototype.indexOf.call(questions,$event.currentTarget),"block"==answers[index].style.display?answers[index].style.display="none":answers[index].style.display="block","none"==plusIcons[index].style.display?plusIcons[index].style.display="block":plusIcons[index].style.display="none","block"==minusIcons[index].style.display?minusIcons[index].style.display="none":minusIcons[index].style.display="block")}}]).directive("prescriptionSelect",(function($document){return{template:tmplPrescription,scope:{model:"=",positive:"=",negative:"="},link:function(scope,elem,attrs,ctrl){scope.selectVisible=!1,positive=scope.positive,negative=scope.negative,scope.selectItem=function(item){scope.model=item,scope.selectVisible=!1};const handler=function(e){elem===e.target||elem[0].contains(e.target)||scope.$apply((function(){scope.selectVisible=!1}))};$document.on("click",handler),scope.$on("$destroy",(function(){$document.off("click",handler)}))}}}));var tmplPrescription='<div class="prescription-select">\t<div class="prescription-select-value" ng-click="selectVisible = !selectVisible">\t\t{{model == null ? "-" : model}}\t</div>\t<div class="prescription-select-table" ng-show="selectVisible"> \t<div class="prescription-select-row-zero" ng-click="selectItem(0)"> \t\t0 \t</div>     <div class="prescription-col-container">\t\t\t<div class="prescription-select-col">\t\t\t\t<div class="prescription-select-row" ng-click="selectItem(item)" ng-repeat="item in negative">\t\t\t\t\t{{item}}\t\t\t\t</div>\t\t\t</div> \t\t<div class="prescription-select-col">\t\t\t\t<div class="prescription-select-row" ng-click="selectItem(item)" ng-repeat="item in positive">\t\t\t\t\t{{item}} \t\t\t</div>\t\t\t</div>\t\t</div>\t</div></div>';app.controller("GuestOrderTrackerController",["$scope","$rootScope","$http","$window","$cookies","$log","$timeout","$filter","moment","$loader",function($scope,$rootScope,$http,$window,$cookies,$log,$timeout,$filter,moment,$loader){$scope.params={storeId:storeId,langId:langId,catalogId:catalogId,framesImageURL:"",contactsImageURL:""},$scope.orderData=void 0,$scope.data={orderId:"",email:""},$scope.parentCatentryInfo={},$scope.errors={trackOrderError:{msg:"Oops! No order found. Please check your data and try again.",value:!1}},$scope.retreiveOrder=function(){$loader.show("search-order"),$scope.errors.trackOrderError.value=!1,$scope.retreiveOrderURL="/wcs/resources/store/"+$scope.params.storeId+"/ordercst/guest/"+$scope.data.orderId+"?email="+encodeURIComponent($scope.data.email.toLowerCase()),$http.get($scope.retreiveOrderURL).then((function(response){response.data&&200==response.status?($scope.orderData=response.data,angular.forEach($scope.orderData.orderItem,(function(value,key){var productViewURL="/wcs/resources/store/"+$scope.params.storeId+"/productview/"+value.partNumber;$http.get(productViewURL).then((function(response){if(response.data&&200==response.status){if("SUN"!=value.comments&&"EYE"!=value.comments&&"LENS"!=value.comments||"99"==value.partNumber)"LCON"!=value.comments&&"RCON"!=value.comments||(productViewURL="/wcs/resources/store/"+$scope.params.storeId+"/productview/byId/"+response.data.CatalogEntryView[0].parentProductID,$http.get(productViewURL).then((function(response){response.data&&200==response.status?$scope.orderData.orderItem[key].productview=response.data:$log.error("Error getting order item data from service"),$loader.hide("red-button")}),(function(error){$log.error("Error getting order item data from service.\n"+error)})));else if($scope.orderData.orderItem[key].productview=response.data,"SUN"==value.comments||"EYE"==value.comments){var parentProductViewURL="/wcs/resources/store/"+$scope.params.storeId+"/productview/byId/"+response.data.CatalogEntryView[0].parentProductID,partnumber=value.partNumber;$http.get(parentProductViewURL).then((function(parentResponse){parentResponse.data&&200==parentResponse.status?angular.forEach(parentResponse.data.CatalogEntryView[0].Attributes,(function(value,key){"MODEL_NAME"==value.name&&($scope.parentCatentryInfo[partnumber]=value.Values[0].values)})):$log.error("Error getting parent product model name from service")}),(function(error){$log.error("Error getting parent product model name from service.\n"+error)}))}}else $log.error("Error getting order item data from service")}),(function(error){$log.error("Error getting order item data from service.\n"+error)})),$scope.trackOrderItem(key)})),angular.forEach($scope.orderData.orderItem,(function(value,key){"SUN"!=value.comments&&"EYE"!=value.commetns||angular.forEach($scope.orderData.orderItem,(function(item,key2){value.orderItemId==item.xitem_field1&&"99"!=item.partNumber&&($scope.orderData.orderItem[key].lens_object=item)}))}))):response.data&&404==response.status?$scope.errors.trackOrderError.value=!0:$log.error("Error getting order item data from service")}),(function(error){$log.error("Error getting order item data from service.\n"+error),$scope.errors.trackOrderError.value=!0,$loader.hide("search-order")}))},$scope.trackOrderItem=function(itemIndex){var trackingURL="/wcs/resources/store/"+$scope.params.storeId+"/delivery/"+$scope.orderData.orderItem[itemIndex].orderItemId+"/carrierUrl";$http.get(trackingURL).then((function(response){if(response.data&&200==response.status){let oid=$scope.orderData.orderItem[itemIndex].orderItemId;for(let i=0;i<$scope.orderData.orderItem.length;i++)null!=$scope.orderData.orderItem[i].trackingURL&&""!=$scope.orderData.orderItem[i].trackingURL||$scope.orderData.orderItem[i].orderItemId!=oid&&$scope.orderData.orderItem[i].xitem_field1!=oid||($scope.orderData.orderItem[i].trackingURL=response.data.carrierUrl)}else $log.error("Error getting order item data from service")}),(function(error){$log.error("Error getting order item data from service.\n"+error)}))},$scope.parseFloat=function(value){return parseFloat(value)},$scope.translateStatus=function(status){switch(status){case"M":default:return"Open";case"S":return"Shipped";case"D":return"Shipped and settled";case"Z":return"Returned";case"X":return"Cancelled";case"G":case"R":return"In Process";case"E":return"Pending RX";case"F":return"RX Verified";case"U":return"Ready for pickup"}}}]),app.controller("LensCraftersFAQ",["$scope","$filter",function($scope,$filter){$scope.currentPage=0,$scope.pageSize=10,$scope.expanded=-1,$scope.toggleExpandFaq=function(index){$scope.expanded=index},$scope.data=window.FAQ_LIST,-1==window.location.href.indexOf("forgot")?$scope.q="":($scope.q="forgot",$scope.expanded=0),$scope.getData=function(){return $filter("filter")($scope.data,$scope.q)},$scope.numberOfPages=function(){return Math.ceil($scope.getData().length/$scope.pageSize)},$scope.$watch("q",(function(newValue,oldValue){oldValue!=newValue&&($scope.currentPage=0)}),!0)}]),app.filter("unsafe",(function($sce){return $sce.trustAsHtml})),app.filter("startFrom",(function(){return function(input,start){return start=+start,input.slice(start)}})),app.filter("cut",(function(){return function(value,wordwise,max,tail){if(!value)return"";if(!(max=parseInt(max,10)))return value;if(value.length<=max)return value;if(value=value.substr(0,max),wordwise){var lastspace=value.lastIndexOf(" ");-1!==lastspace&&("."!==value.charAt(lastspace-1)&&","!==value.charAt(lastspace-1)||(lastspace-=1),value=value.substr(0,lastspace))}return value+(tail||" ?")}}));var lcInsuranceModule=angular.module("lcInsuranceModule",[]);lcInsuranceModule.factory("lcInsurance",(function($rootScope,$location,$http,$httpParamSerializerJQLike,$q,$cookies,$log,SidebarJS){var params=null,isLoginLoading=!1,isDiscountLoading=!1,INSURANCE_EVENTS={INSURANCE_LOGIN:"insuranceLogin",INSURANCE_LOGIN_LOADING:"isLoginLoading",INSURANCE_LOGIN_ERROR:"insuranceLoginError",INSURANCE_LOGOUT:"insuranceLogout",INSURANCE_ENABLED:"insuranceEnabled",INSURANCE_DISABLED:"insuranceDisabled",INSURANCE_TENTATIVE_UPDATE:"insuranceTentativeUpdate",INSURANCE_TENTATIVE_LIMIT_REACHED:"insuranceTentativeLimitReached",INSURANCE_TENTATIVE_RESET:"insuranceTentativeReset",INSURANCE_DISCOUNT_LOADING:"isDiscountLoading",INSURANCE_DISCOUNT_ERROR:"insuranceDiscountError",INSURANCE_DISCOUNT_LOADED:"insuranceDiscountLoaded"},INSURANCE_ERRORS={INSURANCE_NOT_FOUND:0,INSURANCE_SERVICE_ERROR:1,INSURANCE_TENTATIVE_LIMIT_REACHED:2,INSURANCE_ALREADY_LOGGED:3,INSURANCE_DISABLED:4,INSURANCE_LOGIN_LOADING:5,INSURANCE_DISCOUNT_LOADING:6},INSURANCE_BENEFIT_CATEGORIES={FRAMES:"frames",FRAMES_ADD:"frames_add",LENSES:"lenses",LENSES_ADD:"lenses_add",CONTACT_LENSES:"contact",EXAMS:"exam"};function getCookie(cookieName,parseJSON){var cookieValue=null,cookieValueStr=$cookies.get(cookieName);if(cookieValueStr)if(cookieValueStr=decodeURIComponent(cookieValueStr.trim()),parseJSON)try{cookieValue=JSON.parse(cookieValueStr)}catch(e){$log.error("Unable to parse cookie as JSON")}else cookieValue=cookieValueStr;return cookieValue}function getTentativeCookie(){return getCookie("tentative_user")}function setTentativeCookie(value){if(!isNaN(value)&&value>=0&&value<=4){var now=new Date,time=now.getTime()+36e5;now.setTime(time);var cookieOptions={path:"/"};0==value&&(cookieOptions.expires=now.toUTCString()),$cookies.put("tentative_user",value,cookieOptions),0==value?$rootScope.$broadcast(INSURANCE_EVENTS.INSURANCE_TENTATIVE_LIMIT_REACHED):4==value?$rootScope.$broadcast(INSURANCE_EVENTS.INSURANCE_TENTATIVE_RESET):$rootScope.$broadcast(INSURANCE_EVENTS.INSURANCE_TENTATIVE_UPDATE,value)}}function removeInsuranceCookie(){$cookies.remove("ria_0",{path:"/"}),$cookies.remove("ria_1",{path:"/"}),$cookies.remove("ria_2",{path:"/"}),$cookies.remove("ria_active",{path:"/"})}function removeTentativeCookie(){$cookies.remove("tentative_user",{path:"/"})}var insuranceModule={init:function(_params){this.isInit||(params=_params,this.isInit=!0)},login:function(data){var _defer=$q.defer();if(isLoginLoading)return _defer.reject(INSURANCE_ERRORS.INSURANCE_LOGIN_LOADING),_defer.promise;if(isLoginLoading=!0,$rootScope.$broadcast(INSURANCE_EVENTS.INSURANCE_LOGIN_LOADING),window.dispatchEvent(new CustomEvent(INSURANCE_EVENTS.INSURANCE_LOGIN_LOADING)),this.isLogged())isLoginLoading=!1,$rootScope.$broadcast(INSURANCE_EVENTS.INSURANCE_LOGIN_ERROR,INSURANCE_ERRORS.INSURANCE_ALREADY_LOGGED),window.dispatchEvent(new CustomEvent(INSURANCE_EVENTS.INSURANCE_LOGIN_ERROR,{detail:INSURANCE_ERRORS.INSURANCE_TENTATIVE_LIMIT_REACHED})),_defer.reject(INSURANCE_ERRORS.INSURANCE_ALREADY_LOGGED);else{data.orderId||(data.orderId="."),getTentativeCookie()||this.resetTentative();var _this=this;this.hasTentative()?$http.post(getAbsoluteURL()+"jsonpInsuranceAjax.jsp",$httpParamSerializerJQLike(data),{headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then((function(response){isLoginLoading=!1,response&&response.data&&"ok"==response.data.result?(_this.resetTentative(),function(data){var now=new Date,time=now.getTime()+18e5;function fixInsurancePlanName(riaInsuranceInformation){return riaInsuranceInformation&&riaInsuranceInformation.planName&&(riaInsuranceInformation.planName=riaInsuranceInformation.planName.replace(",",""),riaInsuranceInformation=JSON.stringify(riaInsuranceInformation)),riaInsuranceInformation}if(now.setTime(time),data.plans){if(data.plans&&angular.isArray(data.plans)&&2===data.plans.length&&data.activePlanId){var expireDate=now.toUTCString();document.cookie="ria_active="+data.activePlanId+"; path=/; expires="+expireDate+";";for(var i=0;i<data.plans.length;i++){var plan=data.plans[i];plan.riaInsuranceInformation=fixInsurancePlanName(plan.riaInsuranceInformation),jsonStr=JSON.stringify(plan),0===i?getCookie("ria_0")?document.cookie="ria_0="+jsonStr+"; path=/; expires="+expireDate+";":document.cookie="ria_1="+jsonStr+"; path=/; expires="+expireDate+";":1===i&&(document.cookie="ria_2="+jsonStr+"; path=/; expires="+expireDate+";")}}}else{data.riaInsuranceInformation=fixInsurancePlanName(data.riaInsuranceInformation);var jsonStr=JSON.stringify(data);getCookie("ria_0")?document.cookie="ria_0="+jsonStr+"; path=/; expires="+now.toUTCString()+";":document.cookie="ria_1="+jsonStr+"; path=/; expires="+now.toUTCString()+";"}}(response.data),$rootScope.$broadcast(INSURANCE_EVENTS.INSURANCE_LOGIN,response.data),window.dispatchEvent(new CustomEvent(INSURANCE_EVENTS.INSURANCE_LOGIN,{detail:response.data})),$rootScope.$broadcast(INSURANCE_EVENTS.INSURANCE_ENABLED),window.dispatchEvent(new CustomEvent(INSURANCE_EVENTS.INSURANCE_ENABLED)),_defer.resolve(response.data)):(_this.removeTentative(),$rootScope.$broadcast(INSURANCE_EVENTS.INSURANCE_LOGIN_ERROR,INSURANCE_ERRORS.INSURANCE_NOT_FOUND),window.dispatchEvent(new CustomEvent(INSURANCE_EVENTS.INSURANCE_LOGIN_ERROR,{detail:INSURANCE_ERRORS.INSURANCE_NOT_FOUND})),_defer.reject(INSURANCE_ERRORS.INSURANCE_NOT_FOUND))}),(function(error){_this.removeTentative(),isLoginLoading=!1,$log.error(error),$rootScope.$broadcast(INSURANCE_EVENTS.INSURANCE_LOGIN_ERROR,INSURANCE_ERRORS.INSURANCE_SERVICE_ERROR),window.dispatchEvent(new CustomEvent(INSURANCE_EVENTS.INSURANCE_LOGIN_ERROR,{detail:INSURANCE_ERRORS.INSURANCE_SERVICE_ERROR})),_defer.reject(INSURANCE_ERRORS.INSURANCE_SERVICE_ERROR)})):(isLoginLoading=!1,$rootScope.$broadcast(INSURANCE_EVENTS.INSURANCE_LOGIN_ERROR,INSURANCE_ERRORS.INSURANCE_TENTATIVE_LIMIT_REACHED),window.dispatchEvent(new CustomEvent(INSURANCE_EVENTS.INSURANCE_LOGIN_ERROR,{detail:INSURANCE_ERRORS.INSURANCE_TENTATIVE_LIMIT_REACHED})),_defer.reject(INSURANCE_ERRORS.INSURANCE_TENTATIVE_LIMIT_REACHED))}return _defer.promise},logout:function(){return removeInsuranceCookie(),removeTentativeCookie(),$rootScope.$broadcast(INSURANCE_EVENTS.INSURANCE_LOGOUT),window.dispatchEvent(new CustomEvent(INSURANCE_EVENTS.INSURANCE_LOGOUT)),!0},isLoading:function(){return isLoginLoading||isDiscountLoading},isLogged:function(){return!(!getCookie("ria_1")&&!getCookie("ria_0"))},isEnabled:function(){return!!getCookie("ria_1")},getInsuranceJSON:function(){var insuranceJSON=getCookie("ria_1",!0);return insuranceJSON||getCookie("ria_0",!0)},getAllInsuranceJSON:function(){var plans=[],primaryPlan=getCookie("ria_1",!0);if(primaryPlan||(primaryPlan=getCookie("ria_0",!0)),primaryPlan){plans.push(primaryPlan);var secondaryPlan=getCookie("ria_2",!0);secondaryPlan&&plans.push(secondaryPlan)}return plans},getDiscounts:function(data){var _defer=$q.defer();if(isDiscountLoading=!0,$rootScope.$broadcast(INSURANCE_EVENTS.INSURANCE_DISCOUNT_LOADING),window.dispatchEvent(new CustomEvent(INSURANCE_EVENTS.INSURANCE_DISCOUNT_LOADING)),this.isEnabled()){var insuranceJSON=this.getInsuranceJSON();if(insuranceJSON&&insuranceJSON.riaInsuranceInformation){var riaInsuranceInformation=JSON.parse(insuranceJSON.riaInsuranceInformation);data.orderId||(data.orderId="."),data.__RIA_SYNC_TOKEN=riaInsuranceInformation.token,data.__RIA_SYNC_INFO=insuranceJSON.riaInsuranceInformation;var activePlanId=this.getInsuranceActivePlanId();activePlanId&&(data.__RIA_SYNC_ACTIVE_PLAN=activePlanId),data.__PRICING_ENTRY=[],angular.forEach(data.pricingEntries,(function(value,key){data.__PRICING_ENTRY.push(JSON.stringify({frame:value.frame,lens:value.lens}))})),delete data.pricingEntries;var getInsuranceActivePlanId=this.getInsuranceActivePlanId,setInsuranceActivePlanId=this.setInsuranceActivePlanId;$http({method:"POST",url:"/wcs/resources/store/10851/catalog/22651/ria/benefitpricing",params:data}).then((function(response){if(isDiscountLoading=!1,response.data){var activePlanId=getInsuranceActivePlanId();if(activePlanId&&response.data.response.__RIA_SYNC_ACTIVE_PLAN&&activePlanId!==response.data.response.__RIA_SYNC_ACTIVE_PLAN&&setInsuranceActivePlanId(response.data.response.__RIA_SYNC_ACTIVE_PLAN),response.data.response.__PAIR_DISCOUNT)try{_defer.resolve(response.data.response.__PAIR_DISCOUNT)}catch(error){_defer.reject(INSURANCE_ERRORS.INSURANCE_SERVICE_ERROR)}else if(response.data.response.__PRICING_ENTRY)try{_defer.resolve(response.data.response.__PRICING_ENTRY)}catch(error){_defer.reject(INSURANCE_ERRORS.INSURANCE_SERVICE_ERROR)}else _defer.reject(INSURANCE_ERRORS.INSURANCE_SERVICE_ERROR)}else _defer.reject(INSURANCE_ERRORS.INSURANCE_SERVICE_ERROR)}),(function(error){isDiscountLoading=!1,$rootScope.$broadcast(INSURANCE_EVENTS.INSURANCE_DISCOUNT_ERROR,INSURANCE_ERRORS.INSURANCE_SERVICE_ERROR),window.dispatchEvent(new CustomEvent(INSURANCE_EVENTS.INSURANCE_DISCOUNT_ERROR,{detail:INSURANCE_ERRORS.INSURANCE_SERVICE_ERROR})),_defer.reject(error)}))}else isDiscountLoading=!1,$rootScope.$broadcast(INSURANCE_EVENTS.INSURANCE_DISCOUNT_ERROR,INSURANCE_ERRORS.INSURANCE_DISCOUNT_ERROR),window.dispatchEvent(new CustomEvent(INSURANCE_EVENTS.INSURANCE_DISCOUNT_ERROR,{detail:INSURANCE_ERRORS.INSURANCE_DISCOUNT_ERROR})),_defer.reject(INSURANCE_ERRORS.INSURANCE_DISCOUNT_ERROR)}else isDiscountLoading=!1,$rootScope.$broadcast(INSURANCE_EVENTS.INSURANCE_DISCOUNT_ERROR,INSURANCE_ERRORS.INSURANCE_DISABLED),window.dispatchEvent(new CustomEvent(INSURANCE_EVENTS.INSURANCE_DISCOUNT_ERROR,{detail:INSURANCE_ERRORS.INSURANCE_DISABLED})),_defer.reject(INSURANCE_ERRORS.INSURANCE_DISABLED);return _defer.promise},getQuickInsuranceDiscounts:function(data){var _defer=$q.defer();if(isDiscountLoading=!0,$rootScope.$broadcast(INSURANCE_EVENTS.INSURANCE_DISCOUNT_LOADING),window.dispatchEvent(new CustomEvent(INSURANCE_EVENTS.INSURANCE_DISCOUNT_LOADING)),this.isEnabled()){var insuranceJSON=this.getInsuranceJSON();insuranceJSON&&insuranceJSON.token&&insuranceJSON.riaInsuranceInformation?(data.orderId||(data.orderId="."),data.__RIA_SYNC_TOKEN=insuranceJSON.token,data.__RIA_SYNC_INFO=insuranceJSON.riaInsuranceInformation,data.__PRICING_ENTRY=[],angular.forEach(data.pricingEntries,(function(value,key){data.__PRICING_ENTRY.push(JSON.stringify({frame:null,lens:value.lens}))})),delete data.pricingEntries,$http({method:"POST",url:"/wcs/resources/store/10851/catalog/22651/ria/estimatedbenefitpricing",params:data}).then((function(response){if(isDiscountLoading=!1,response.data&&response.data.response.__PAIR_DISCOUNT)try{_defer.resolve(response.data.response.__PAIR_DISCOUNT)}catch(error){_defer.reject(INSURANCE_ERRORS.INSURANCE_SERVICE_ERROR)}else if(response.data&&response.data.response.__PRICING_ENTRY)try{_defer.resolve(response.data.response.__PRICING_ENTRY)}catch(error){_defer.reject(INSURANCE_ERRORS.INSURANCE_SERVICE_ERROR)}else _defer.reject(INSURANCE_ERRORS.INSURANCE_SERVICE_ERROR)}),(function(error){isDiscountLoading=!1,$rootScope.$broadcast(INSURANCE_EVENTS.INSURANCE_DISCOUNT_ERROR,INSURANCE_ERRORS.INSURANCE_SERVICE_ERROR),window.dispatchEvent(new CustomEvent(INSURANCE_EVENTS.INSURANCE_DISCOUNT_ERROR,{detail:INSURANCE_ERRORS.INSURANCE_SERVICE_ERROR})),_defer.reject(error)}))):(isDiscountLoading=!1,$rootScope.$broadcast(INSURANCE_EVENTS.INSURANCE_DISCOUNT_ERROR,INSURANCE_ERRORS.INSURANCE_DISCOUNT_ERROR),window.dispatchEvent(new CustomEvent(INSURANCE_EVENTS.INSURANCE_DISCOUNT_ERROR,{detail:INSURANCE_ERRORS.INSURANCE_DISCOUNT_ERROR})),_defer.reject(INSURANCE_ERRORS.INSURANCE_DISCOUNT_ERROR))}else isDiscountLoading=!1,$rootScope.$broadcast(INSURANCE_EVENTS.INSURANCE_DISCOUNT_ERROR,INSURANCE_ERRORS.INSURANCE_DISABLED),window.dispatchEvent(new CustomEvent(INSURANCE_EVENTS.INSURANCE_DISCOUNT_ERROR,{detail:INSURANCE_ERRORS.INSURANCE_DISABLED})),_defer.reject(INSURANCE_ERRORS.INSURANCE_DISABLED);return _defer.promise},getInsuranceSettings:function(){if(params&&params.isRiaPricerEnabled)try{var jsonRIACookieContent=getCookie("ria_1");if(""!=jsonRIACookieContent)if("FACETS"==JSON.parse(JSON.parse(jsonRIACookieContent).riaInsuranceInformation).insuranceProviderName)return $log.log("QUICK insurance setting"),{n:1,k:3,method:"QUICK"}}catch(e){$log.error(e)}return $log.log("STANDARD insurance setting"),{n:1,k:3,method:"STANDARD"}},getInsuranceDiscounts:function(_selectedFrame,_selectedPackage){var _defer=$q.defer(),_pricingEntries=[],_selectedFrameUPC=_selectedFrame.upc?_selectedFrame.upc:_selectedFrame.partNumber;angular.forEach(_selectedPackage,(function(currentPackage){if(null==currentPackage.lensPackage.insPrice){const pricingEntry={frame:{price:_selectedFrame.listPrice,quantity:"1",type:"f",upc:_selectedFrameUPC},lens:{price:currentPackage.lensPackage.listPrice,quantity:"1",type:"l",upc:currentPackage.lensPackage.upc}};_pricingEntries.push(pricingEntry)}}));var data={storeId:constants.ajaxParams.storeId,catalogId:constants.ajaxParams.catalogId,langId:constants.ajaxParams.langId,pricingEntries:_pricingEntries},selectedFrameDiscountCachedRiaResponse=null;if(params&&params.isRiaPricerEnabled&&sessionStorage.getItem("_CACHED_RIA_RESPONSE_SELECTED_FRAME_DISCOUNT_LC_"))try{selectedFrameDiscountCachedRiaResponse=JSON.parse(sessionStorage.getItem("_CACHED_RIA_RESPONSE_SELECTED_FRAME_DISCOUNT_LC_"))}catch(e){$log.error(e)}return params&&params.isRiaPricerEnabled&&selectedFrameDiscountCachedRiaResponse&&selectedFrameDiscountCachedRiaResponse.length>0&&_selectedFrameUPC==selectedFrameDiscountCachedRiaResponse[0].frame.upc?insuranceModule.getQuickInsuranceDiscounts(data).then((function(response){if(response)try{var updatedPackages=[];angular.forEach(_selectedPackage,(function(currentPackage){var tempPackage=JSON.parse(JSON.stringify(currentPackage));for(let i=0;i<response.length;i++){let insPackage=response[i];if(tempPackage.lensPackage.upc==insPackage.lens.upc){tempPackage.frame.insPrice=Math.max(parseFloat(_selectedFrame.listPrice-selectedFrameDiscountCachedRiaResponse[0].frameDiscount).toFixed(2),0),tempPackage.lensPackage.insPrice=Math.max(parseFloat(tempPackage.lensPackage.listPrice-insPackage.lensDiscount).toFixed(2),0),console.log("Lens UPC: ",tempPackage.lensPackage.upc),console.log("Frame insurance price: ",tempPackage.frame.insPrice),console.log("Lens insurance price: ",tempPackage.lensPackage.insPrice);break}}updatedPackages.push(tempPackage)})),_defer.resolve(updatedPackages)}catch(error){_defer.reject(INSURANCE_ERRORS.INSURANCE_SERVICE_ERROR)}else _defer.reject(INSURANCE_ERRORS.INSURANCE_SERVICE_ERROR)})).catch((function(error){_defer.reject(INSURANCE_ERRORS.INSURANCE_SERVICE_ERROR)})):(params&&params.isRiaPricerEnabled&&sessionStorage.setItem("_CACHED_RIA_RESPONSE_SELECTED_FRAME_DISCOUNT_LC_",null),insuranceModule.getDiscounts(data).then((function(response){if(response){params&&params.isRiaPricerEnabled&&sessionStorage.setItem("_CACHED_RIA_RESPONSE_SELECTED_FRAME_DISCOUNT_LC_",JSON.stringify(response));try{var updatedPackages=[];angular.forEach(_selectedPackage,(function(currentPackage){var tempPackage=JSON.parse(JSON.stringify(currentPackage));for(let i=0;i<response.length;i++){let insPackage=response[i];if(tempPackage.lensPackage.upc==insPackage.lens.upc){tempPackage.frame.insPrice=Math.max(parseFloat(_selectedFrame.listPrice-insPackage.frameDiscount).toFixed(2),0),tempPackage.lensPackage.insPrice=Math.max(parseFloat(tempPackage.lensPackage.listPrice-insPackage.lensDiscount).toFixed(2),0),console.log("Lens UPC: ",tempPackage.lensPackage.upc),console.log("Frame insurance price: ",tempPackage.frame.insPrice),console.log("Lens insurance price: ",tempPackage.lensPackage.insPrice);break}}updatedPackages.push(tempPackage)})),_defer.resolve(updatedPackages)}catch(error){_defer.reject(INSURANCE_ERRORS.INSURANCE_SERVICE_ERROR)}}else _defer.reject(INSURANCE_ERRORS.INSURANCE_SERVICE_ERROR)})).catch((function(error){_defer.reject(INSURANCE_ERRORS.INSURANCE_SERVICE_ERROR)}))),_defer.promise},toggleInsurance:function(){if(this.isLogged()){var now=new Date,time=now.getTime()+18e5;now.setTime(time);var insuranceJSON=getCookie(this.isEnabled()?"ria_1":"ria_0");$("#cart-insurance-warning").toggleClass("hidden"),this.isEnabled()?(document.cookie="ria_0="+insuranceJSON+"; path=/; expires="+now.toUTCString()+";",$cookies.remove("ria_1",{path:"/"}),$rootScope.$broadcast(INSURANCE_EVENTS.INSURANCE_DISABLED),window.dispatchEvent(new CustomEvent(INSURANCE_EVENTS.INSURANCE_DISABLED))):(document.cookie="ria_1="+insuranceJSON+"; path=/; expires="+now.toUTCString()+";",$cookies.remove("ria_0",{path:"/"}),$rootScope.$broadcast(INSURANCE_EVENTS.INSURANCE_ENABLED),window.dispatchEvent(new CustomEvent(INSURANCE_EVENTS.INSURANCE_ENABLED)))}},getTentative:function(){var tentativeCookie=getTentativeCookie(),tentative=0;try{tentative=parseInt(tentativeCookie)}catch(error){$log.error("Unable to parse tentative cookie")}return tentative},hasTentative:function(){return this.getTentative()>0},removeTentative:function(){var tentative=this.getTentative();tentative>0&&setTentativeCookie(--tentative)},resetTentative:function(){setTentativeCookie(4)},checkAllBenefits:function(){var benefitsAvailable=!1;if(this.isLogged()){for(var i=0,tempBenefitsAvailable=!0,plans=this.getAllInsuranceJSON();i<plans.length&&tempBenefitsAvailable;){var plan=plans[i];if(plan.data)for(var j=0,categoryKeys=Object.keys(plan.data);j<categoryKeys.length&&tempBenefitsAvailable;){var categoryKey=categoryKeys[j];!0!==plan.data[categoryKey][0].available&&(tempBenefitsAvailable=!1),j++}i++}tempBenefitsAvailable&&(benefitsAvailable=tempBenefitsAvailable)}return benefitsAvailable},checkSingleBenefit:function(category){var benefitAvailable=!1;if(this.isLogged()&&category)for(var i=0,plans=this.getAllInsuranceJSON();i<plans.length&&!benefitAvailable;){var plan=plans[i];if(plan.data)for(var j=0,categoryKeys=Object.keys(plan.data);j<categoryKeys.length&&!benefitAvailable;){var categoryKey=categoryKeys[j];categoryKey===category&&!0===plan.data[categoryKey][0].available&&(benefitAvailable=!0),j++}i++}return benefitAvailable},getInsuranceActivePlanId:function(){return getCookie("ria_active")},setInsuranceActivePlanId:function(planId){if(planId){var now=new Date,time=now.getTime()+18e5;now.setTime(time),document.cookie="ria_active="+planId+"; path=/; expires="+now.toUTCString()+";"}},getEvents:function(){return angular.copy(INSURANCE_EVENTS)},getErrors:function(){return angular.copy(INSURANCE_ERRORS)},getBenefitCategories:function(){return angular.copy(INSURANCE_BENEFIT_CATEGORIES)},openInsurancePanel:function(){SidebarJS.toggle()},removeInsuranceBenefits:function(){removeInsuranceCookie(),removeTentativeCookie()}};return insuranceModule}));var lcPrescriptionModule=angular.module("lcPrescriptionModule",[]);lcPrescriptionModule.factory("lcPrescription",(function($cookies,$http,$log){var isInit=!1,storeId=null,catalogId=null,baseurl=window.location.protocol+"//"+window.location.hostname;return{prescriptionType:"FULL",prescriptionFlows:[],hideMoreOptions:!0,fileExtensions:["png","gif","jpeg","tiff","bmp","doc","docx","pdf"],maxFileSize:10,enablePrismComment:!1,enablePrism:!0,init:function(_storeId,_catalogId,_prescriptionFlows,_prismEnabled){isInit||(storeId=_storeId,catalogId=_catalogId,this.prescriptionFlows=_prescriptionFlows||this.prescriptionFlows,this.hideMoreOptions=void 0!==_prismEnabled?"false"===_prismEnabled.toLowerCase():this.hideMoreOptions,isInit=!0),this.prescriptionFlows=_prescriptionFlows,this.hideMoreOptions=null!=_prismEnabled&&"false"===_prismEnabled.toLowerCase(),void 0!==_prismEnabled&&(this.hideMoreOptions="false"===_prismEnabled.toLowerCase()),this.enablePrismComment=null!=_prismEnabled&&"false"===_prismEnabled.toLowerCase(),this.enablePrism=null!=_prismEnabled&&"true"===_prismEnabled.toLowerCase()},getFrameRXValues:function(frameMinTotalPower,frameMaxTotalPower){var rxValues=null;return void 0===frameMinTotalPower||void 0===frameMaxTotalPower||""===frameMinTotalPower||""===frameMaxTotalPower||isNaN(frameMinTotalPower)||isNaN(frameMaxTotalPower)?$log.error("Invalid frame prescription values"):rxValues={powerCombinedMin:frameMinTotalPower,powerCombinedMax:frameMaxTotalPower},rxValues},loadExtendedPrescription:function(_requestObject){return new Promise((function(resolve,reject){var orderitemid=getCookie("prexOI");if(null!=orderitemid&&""!==orderitemid){var url=baseurl+"/wcs/resources/store/"+constants.ajaxParams.storeId+"/rxc/prescription/byOrderItemId/"+orderitemid+"?nocache="+(new Date).getTime().toString();$http.get(url).then((function(response){null!==response.data.prescriptionFlow&&response.data.prescriptionFlow.length>0?(document.cookie="prescriptionObject="+encodeURIComponent(JSON.stringify(response.data))+"; path=/",resolve(response.data)):reject(null)}),(function(response){reject(null)})),$cookies.remove("prexOI",{path:"/"})}else reject(null)}))},downloadExtendedPrescription:function(_requestObject){var downloadURL=window.location.protocol+"//"+window.location.hostname+"/wcs/resources/store/"+constants.ajaxParams.storeId+"/rxc/prescription/download/"+_requestObject.savedFileName;return new Promise((function(resolve,reject){$http.get(downloadURL).then((function(response){var result={},filename=_requestObject.savedFileName,index=filename.lastIndexOf("_RXC_"),ind_ext=filename.lastIndexOf("_RXC_"),file=filename.substring(0,index)+filename.substring(ind_ext);result.filename=file,result.fileData=response.data,resolve(result)}),(function(response){alert("Error during upload."),reject(null)}))}))},saveExtendedPrescription:function(_prescriptionObject){return new Promise((function(resolve,reject){null!==_prescriptionObject||void 0!==_prescriptionObject?(document.cookie="prescriptionObject="+encodeURIComponent(JSON.stringify(_prescriptionObject))+"; path=/",resolve(_prescriptionObject)):reject(_prescriptionObject)}))},checkAvailableFrames:function(_frame,_prescriptionObject){return null},uploadExtendedPrescription:function(_requestObject){return Promise.race([new Promise((function(resolve,reject){var url=baseurl+"/wcs/resources/store/"+constants.ajaxParams.storeId+"/rxc/prescription/upload",body=_requestObject;$http.post(url,body).then((function(response){resolve(response.data)}),(function(error){$log.error(error),reject(null)}))})),new Promise((function(resolve,reject){setTimeout((function(){$log.warn("Prescription file upload timed out"),reject(null)}),6e4)}))])},searchDoctors:function(_requestObject){return new Promise((function(resolve,reject){var search_parm="",name=String(_requestObject.name);name=name.replace(" ","%20");var city=String(_requestObject.city);city=city.replace(" ","_");var searchTermsList=new Array(_requestObject.phone,_requestObject.state,name,city);for(let i=0;i<searchTermsList.length;i++)searchTermsList[i]&&"null"!==searchTermsList[i]&&(""!==search_parm?search_parm+="!"+searchTermsList[i]:search_parm=searchTermsList[i]);if(search_parm=search_parm.replace("+","").replace(" ",""),10852==constants.ajaxParams.storeId){var query={},options={};if("null"!=String(_requestObject.phone)&&""!=String(_requestObject.phone))query={$and:[{phoneSearch:"'"+String(_requestObject.phone)}]},options={includeScore:!0,useExtendedSearch:!0,keys:["phoneSearch"]};else{var shortState="";switch(String(_requestObject.state)){case"Alberta":shortState="AB";break;case"British Columbia":shortState="BC";break;case"Manitoba":shortState="MB";break;case"New Brunswick":shortState="NB";break;case"Newfoundland":shortState="NL";break;case"Northwest Territory":shortState="NT";break;case"Nova Scotia":shortState="NS";break;case"Nunavut":shortState="NU";break;case"Ontario":shortState="ON";break;case"Prince Edward Island":shortState="PE";break;case"Quebec":shortState="QC";break;case"Saskatchewan":shortState="SK";break;case"Yukon":shortState="YT";break;default:shortState=String(_requestObject.state)}query={$and:[{$or:[{clinic:"'"+String(_requestObject.name)},{name:"'"+String(_requestObject.name)}]},{stateSearch:"'"+shortState},{citySearch:"'"+String(_requestObject.city)}]},options={includeScore:!0,useExtendedSearch:!0,keys:["name","clinic","stateSearch","citySearch"]}}var url=baseurl+"/wcs/resources/store/"+constants.ajaxParams.storeId+"/provideprescription/searchdoctor/"+search_parm;$http.get(url).then((function(response){if("Fail"===response.data.response.status)return void reject(null);const doctorsList=response.data.response.data;if(0==doctorsList.length)return void reject(null);const result=new Fuse(doctorsList,options).search(query);var foundDoctors=[];for(const item of result)foundDoctors.push(item.item);resolve({doctors:foundDoctors})}),(function(error){$log.error(error),reject(null)}))}else{url=baseurl+"/wcs/resources/store/"+constants.ajaxParams.storeId+"/provideprescription/searchdoctor/"+search_parm;$http.get(url).then((function(response){if("Fail"===response.data.response.status)return void reject(null);const doctorsList=response.data.response.data;if(0==doctorsList.length)return void reject(null);const newKeys=new Array("name","clinic","phone","fax","address"),oldKeys=new Array("doctorName","officeName","doctorPhoneNumber","doctorFaxNumber","doctorOfficeNumber");new Array("isOpenSaturday","doctorAddress","isValidDoctor");for(let i=0;i<doctorsList.length;i++)for(let j=0;j<newKeys.length;j++)"address"===newKeys[j]?doctorsList[i][newKeys[j]]=doctorsList[i].doctorAddress.address1+", "+doctorsList[i].doctorAddress.zipPostalCode+", "+doctorsList[i].doctorAddress.city+", "+doctorsList[i].doctorAddress.stateProvince+", "+doctorsList[i].doctorAddress.country:(doctorsList[i][newKeys[j]]=doctorsList[i][oldKeys[j]],delete doctorsList[i][oldKeys[j]]);resolve({doctors:doctorsList})}),(function(error){$log.error(error),reject(null)}))}}))},checkAvailableFramesWithCount:function(_frame,_prescriptionObject,_selectedFacets,_returnCount,_searchType){return new Promise((function(resolve,reject){if(storeId&&catalogId&&_frame&&_prescriptionObject){$http({method:"POST",url:"/wcs/resources/store/"+storeId+"/catalog/"+catalogId+"/checkAvailableFrames",data:{frame:_frame,prescriptionObject:_prescriptionObject,selectedFacets:_selectedFacets,searchType:_searchType}}).then((function(response){if(void 0!==response.data&&void 0!==response.data.response.count){var _count=response.data.response.count,_url=response.data.response.url;if(_returnCount){if(_count>=0){var _response={count:_count};void 0!==_url&&(_response.url=_url),resolve(_response)}}else resolve(_count>0&&void 0!==_url?_url:null)}else reject()}),(function(error){reject(error)}))}else{var error="Missing parameters";$log.error(error),reject(error)}}))},clearExtendedPrescription:function(){$cookies.remove("prescriptionObject",{path:"/"})},clearPrescription:function(){$cookies.remove("prescriptionObject",{path:"/"})},retrieveFromMyAccount:function(){var url=baseurl+"/wcs/resources/store/"+constants.ajaxParams.storeId+"/wcs/prescription/user/@self?nocache="+(new Date).getTime().toString();return new Promise((function(resolve,reject){$http.get(url).then((function(response){if(response.data){const prescriptions=response.data.resultList.map((p=>({prescriptionId:p.prescriptionId,SPH:{OD:+(p.rightSphere||"0.0"),OS:+(p.leftSphere||"0.0")},CYL:{OD:+(p.rightCyl||"0.0"),OS:+(p.leftCyl||"0.0")},AX:{OD:+(p.rightAxis||"0.0"),OS:+(p.leftAxis||"0.0")},ADD:{OD:+(p.rightAdd||"0"),OS:+(p.leftAdd||"0")},PD:{OD:+(p.pupillaryDistance||p.rpDistance),OS:null!==p.lpDistance?+p.lpDistance:null},PRISM_ENABLED:"true"===p.prismEnable,VPRISM:{OD:null!==p.odVPrism?+p.odVPrism:null,OS:null!==p.osVPrism?+p.osVPrism:null},VBASEDIR:{OD:p.odVPrismBaseDir,OS:p.osVPrismBaseDir},HPRISM:{OD:null!==p.odHPrism?+p.odHPrism:null,OS:null!==p.osHPrism?+p.osHPrism:null},HBASEDIR:{OD:p.odHPrismBaseDir,OS:p.osHPrismBaseDir},name:p.prescriptionName,lastUpdate:p.lastUpdate,issueDate:p.issue,expireDate:p.expiration})));resolve(prescriptions)}else reject(null)}),(function(response){reject(null)}))}))},saveToMyAccount:function(_prescriptionObject){var prescriptionType="ST";(void 0!==typeof _prescriptionObject.ADD_OS&&null!=_prescriptionObject.ADD_OS||void 0!==typeof _prescriptionObject.ADD_OD&&null!=_prescriptionObject.ADD_OD)&&(prescriptionType="MF");var pupillaryDistance=parseInt(_prescriptionObject.PD_OD),rPDistance=null,lPDistance=null;void 0!==typeof _prescriptionObject.PD_OS&&null!=_prescriptionObject.PD_OS&&(pupillaryDistance=null,rPDistance=parseInt(_prescriptionObject.PD_OD),lPDistance=parseInt(_prescriptionObject.PD_OS));var prescription={prescriptionId:_prescriptionObject.prescriptionId,prescriptionName:_prescriptionObject.name,prescriptionType:prescriptionType,prescriptionOrigin:"MANUAL",prescriptionOriginMode:"rxcPrescription",firstName:"",lastName:"",rightSphere:_prescriptionObject.SPH_OD,leftSphere:_prescriptionObject.SPH_OS,rightCyl:_prescriptionObject.CYL_OD,leftCyl:_prescriptionObject.CYL_OS,rightAxis:_prescriptionObject.AX_OD,leftAxis:_prescriptionObject.AX_OS,rightAdd:_prescriptionObject.ADD_OD,leftAdd:_prescriptionObject.ADD_OS,pupillaryDistance:pupillaryDistance,rPDistance:rPDistance,lPDistance:lPDistance,odHPrism:_prescriptionObject.HPRISM_OD,odVPrism:_prescriptionObject.VPRISM_OD,odHPrismBaseDir:_prescriptionObject.HBASEDIR_OD,odVPrismBaseDir:_prescriptionObject.VBASEDIR_OD,osHPrism:_prescriptionObject.HPRISM_OS,osVPrism:_prescriptionObject.VPRISM_OS,osHPrismBaseDir:_prescriptionObject.HBASEDIR_OS,osVPrismBaseDir:_prescriptionObject.VBASEDIR_OS,prismEnable:_prescriptionObject.PRISM_ENABLED},endpoint="/wcs/resources/store/"+constants.ajaxParams.storeId+"/wcs/prescription/";return void 0!==_prescriptionObject.prescriptionId&&null!==_prescriptionObject.prescriptionId?endpoint+="user/@self/"+_prescriptionObject.prescriptionId:endpoint+="user/@self",$http.post(endpoint,prescription).then((function(response){if(response.data.prescriptionId){var newPrescriptionObject=angular.copy(_prescriptionObject);newPrescriptionObject.prescriptionId=response.data.prescriptionId,document.cookie="prescriptionObject="+encodeURIComponent(JSON.stringify(newPrescriptionObject))+"; path=/"}else $log.error("Couldn't save prescription to my account",response.data)}),(function(error){$log.error(error)})),prescription}}}));var headerModule=angular.module("headerModule",[]);headerModule.factory("headerModule",(function($rootScope,$location,$http,$httpParamSerializerJQLike,$q,$cookies,$log){var params={storeId:"",catalogId:"",langId:""};function getUserDataURL(){return"/wcs/resources/store/"+params.storeId+"/usercontext/@self/contextdata"}return{init:function(_params){_params&&(params=_params)},getDeviceType:function(width){width<414?$rootScope.deviceType="M":width<=1024?$rootScope.deviceType="T":width>1024&&($rootScope.deviceType="D")},getCartItems:function(){var _defer=$q.defer();return $http.get("/wcs/resources/store/"+params.storeId+"/cart/@self").then((function(response){if(response&&response.data.recordSetTotal>0){var items=response.data.orderItem.filter((function(item){return"EYE"==item.comments||"SUN"==item.comments||"LCON"==item.comments||"RCON"==item.comments}));_defer.resolve(items.length)}}),(function(error){_defer.resolve(0)})),_defer.promise},getWishListItems:function(){var _defer=$q.defer();return $http.get("/wcs/resources/store/"+params.storeId+"/catalog/"+params.catalogId+"/saveditems/@self/count?nocache="+(new Date).getTime()).then((function(response){response&&response.data.response&&_defer.resolve(response.data.response)}),(function(error){_defer.resolve(0)})),_defer.promise},getUserType:function(){var _defer=$q.defer();return $http.get(getUserDataURL()).then((function(response){response&&response.data&&response.data.basicInfo&&_defer.resolve(response)}),(function(error){_defer.resolve("G")})),_defer.promise},getUserId:function(){var _defer=$q.defer();return $http.get(getUserDataURL()).then((function(response){response&&response.data&&_defer.resolve(response.data.basicInfo.callerId)}),(function(error){_defer.resolve(-1002)})),_defer.promise}}})),app.controller("loginController",["$scope","$rootScope","$http","$window","$log","$loader","$timeout","$httpParamSerializer",function($scope,$rootScope,$http,$window,$log,$loader,$timeout,$httpParamSerializer){function retryUntilSuccess(callback,delay){delay=delay||250;var interval=setInterval((function(){try{callback(),clearInterval(interval)}catch(error){}}),delay)}$scope.modalLogin=!1,$scope.errorMember=!1,$scope.errorGuest=!1,$scope.errorMailMember=!1,$scope.errorPswMember=!1,$scope.errorMessageMember=!1,$scope.isLoading=!1,$scope.errorMessage="",retryUntilSuccess((function(){gapi.load("auth2",(function(){var element;auth2=gapi.auth2.init({client_id:"533440147216-movcp87bjdk395bi3bi2aqmrm1tl91o1.apps.googleusercontent.com"}),element=document.getElementById("customBtn"),console.log(element.id),auth2.attachClickHandler(element,{},(function(googleUser){$scope.loginGoogle(googleUser)}),(function(error){obj={id:"Error",Error_Source:"Server",Error_Code:"Login",Error_Message:"Login Request Failed with Google"},tealium_data2track.push(obj),console.log("Login error with Google")}))}))})),retryUntilSuccess((function(){return FB.Event.subscribe("auth.statusChange",(function(response){"connected"===response.status&&$scope.loginFB(response)})),!0})),$scope.logoutFB=function(){FB.logout((function(response){console.log("User signed out - FB.")}))},$scope.signOut=function(){gapi.auth2.getAuthInstance().signOut().then((function(){console.log("User signed out - Google.")}))},$scope.loginFB=function(responseLogin){FB.api("/me?fields=name,email",(function(response){var data=JSON.stringify({authorizationProvider:responseLogin.loginSource,accessToken:responseLogin.authResponse.accessToken,name:response.name,email:response.email,logonId:response.email});$scope.loginBE(data)}))},$scope.loginGoogle=function(googleUser){var profile=googleUser.getBasicProfile(),access=googleUser.getAuthResponse(),data=JSON.stringify({authorizationProvider:access.idpId,accessToken:access.id_token,name:profile.getName(),email:profile.getEmail(),logonId:profile.getEmail()});$scope.loginBE(data)},$scope.loginBE=function(data){$scope.url="https://"+window.location.host+"/wcs/resources/store/"+storeId+"/loginidentity/oauth_validate?updateCookies=true",$scope.loginCheckout=document.getElementById("loginCheckout"),$http({method:"POST",url:$scope.url,headers:{"Content-Type":"application/json"},data:data}).then((function(response){$scope.isCheckout?$scope.afterLogin():null!=$scope.loginCheckout?location.reload():window.location.href=response.data.redirectURL}),(function(response){obj={id:"Error",Error_Source:"Server",Error_Code:"Login",Error_Message:"Login Request Failed with Social Login"},tealium_data2track.push(obj),$scope.errorMessageMember=!0,$scope.errorMessage="Error with social login",$scope.$digest()}))},$scope.openModalLogin=function(){$scope.userType=document.getElementById("userType").value,"R"===$scope.userType||sessionStorage.getItem("mail_checkout")&&""!==sessionStorage.getItem("mail_checkout")?$scope.goToCheckout():(document.querySelector(".nav-links").style.zIndex="unset",$scope.modalLogin=!0,$scope.toggleLockPageScroll(!0),$scope.isCheckout=!0)},$scope.closeModalLogin=function(){$scope.modalLogin=!1,$scope.toggleLockPageScroll(!1),$scope.errorMember=!1,$scope.errorGuest=!1,$scope.errorMailMember=!1,$scope.errorPswMember=!1,$scope.errorMessageMember=!1,$scope.loginGuestValue="",$scope.errorMessage="",$scope.loginMemberMailValue="",$scope.loginMemberPswValue="",document.querySelector(".nav-links").style.zIndex=999},$scope.toggleLockPageScroll=function(lock){document.querySelectorAll("html,body").forEach((elem=>{elem.style.overflow=lock?"hidden":"",elem.style.position=lock?"fixed":"",elem.style.height=lock?"100%":""}))},$scope.$watch("loginGuestValue",(function(){$scope.errorGuest&&($scope.errorGuest=!1)})),$scope.loginGuest=function(){$loader.show("login-guest"),$scope.loginGuestValue&&$scope.validateEmail($scope.loginGuestValue)?(sessionStorage.setItem("mail_checkout",$scope.loginGuestValue),$scope.goToCheckout()):($scope.errorGuest=!0,$loader.hide())},$scope.FBLoginCustom=function(){FB.login((function(response){}),{scope:"public_profile,email"})},$scope.validateEmail=function(email){return/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(email)},$scope.$watch("loginMemberMailValue",(function(){$scope.errorMailMember?$scope.errorMailMember=!1:$scope.errorMessageMember&&($scope.errorMessageMember=!1)})),$scope.$watch("loginMemberPswValue",(function(){$scope.errorPswMember?$scope.errorPswMember=!1:$scope.errorMessageMember&&($scope.errorMessageMember=!1)})),$scope.loginMember=function(){if($scope.loginMemberMailValue&&$scope.validateEmail($scope.loginMemberMailValue)&&$scope.loginMemberPswValue){var f=$("#LogonFormModal");utag_data.form_name="logon modal",utag_data.form_field=error_list;for(var data=f.serializeArray(),newData=[],i=0;i<data.length;i++){var d=data[i];"receiveEmail"==d.name&&"on"==d.value&&(d.value=!0,!0),"URL"==d.name?(d.value,newData.push({name:"URL",value:"LogonAjaxView"})):newData.push(d)}0==$scope.isLoading&&($loader.show("login-member"),$scope.isLoading=!0),$.ajax({url:getAbsoluteURL(!0)+"LogonAjax",data:newData,type:"POST",dataType:"json",success:function(data){if(null==data||data.passwordExpired&&"1"==data.passwordExpired)$scope.errorMessageMember=!0,$scope.errorMessage="Your password has expired. Please click below to receive an email with a link to reset your password.",$scope.$digest(),obj={id:"Error",Error_Source:"User",Error_Code:"Login",Error_Message:"Your password has expired"},tealium_data2track.push(obj);else if(data.success){var User_Email_MD5="",User_Email_SHA256="",trimmedLowerMail="";data.email&&(trimmedLowerMail=data.email.trim().toLowerCase(),User_Email_MD5=MD5(data.email),User_Email_SHA256=sha256(trimmedLowerMail)),"true"===data.hasPrescriptions?(sessionStorage.setItem("User_HasPrescription","1"),utag_data.User_HasPrescription="1"):sessionStorage.removeItem("User_HasPrescription"),$scope.closeModalLogin(),sessionStorage.setItem("Events_UserAccountLogin","1"),sessionStorage.setItem("Events_UserAccountLogin_userLogin","1"),sessionStorage.setItem("User_Email_MD5",User_Email_MD5),sessionStorage.setItem("User_Email_SHA256",User_Email_SHA256),$scope.isCheckout&&$scope.afterLogin()}else if(data.errorMessage.includes("PSW_RST")){showLogonModal()||$(".header-update-reset-password-modal").css("display","block"),$(".thank-you-page-overlay")&&$(".thank-you-page-overlay").removeClass("hidden"),$("#myaccount-rectangle > .backdrop").removeClass("hide"),$(".header-sign-in-modal").css("display","none"),$("#myaccount-rectangle").removeClass("hide"),$("#passwordUpdateEmailInput").val(data.errorMessage.split("PSW_RST:")[1]),$scope.closeModalLogin()}else obj={id:"Error",Error_Source:"User",Error_Code:"Form Filling Error - Login",Error_Details:"Wrong Email, Wrong Password - "+data.errorMessage,Error_Message:"We couldnt find a member account associated with your email address. If you use this email with a social account, please use social login to proceed."},tealium_data2track.push(obj),$scope.errorMessageMember=!0,$scope.errorMessage="We couldnt find a member account associated with your email address. If you use this email with a social account, please use social login to proceed.",$scope.$digest();$loader.hide(),$scope.isLoading=!1},error:function(jqXHR,textStatus,errorThrown){$scope.errorMessageMember=!0,$scope.errorMessage=textStatus,$loader.hide(),obj={id:"Error",Error_Source:"Server",Error_Code:"Login",Error_Message:"Login Request Failed"},tealium_data2track.push(obj)}})}else $scope.loginMemberMailValue&&$scope.validateEmail($scope.loginMemberMailValue)||($scope.errorMailMember=!0),$scope.loginMemberPswValue||($scope.errorPswMember=!0)},$scope.afterLogin=function(){$scope.goToCheckout()},$scope.goToCheckout=function(){$scope.userType=document.getElementById("userType").value,$scope.nextStepURL=document.getElementById("nextStepURL").value,$scope.PhysicalStoreSelectionURL=document.getElementById("PhysicalStoreSelectionURL").value,$timeout((function(){CheckoutHelperJS.canCheckoutContinue($scope.userType)&&CheckoutHelperJS.updateShoppingCart(document.ShopCartForm,!0)&&ShipmodeSelectionExtJS.guestShopperContinue($scope.nextStepURL,$scope.PhysicalStoreSelectionURL)}),500)},$scope.loginFormSubmit=!1,$scope.loginError=null,document.getElementsByClassName("login-error").length&&(document.getElementsByClassName("login-error")[0].style.display="none"),$scope.passwordExpired,$scope.submitLoginForm=function(){if(angular.forEach($scope.loginForm.$$controls,(function(field){field.$setTouched()})),$scope.loginForm.$valid&&$scope.loginFormData&&!$scope.loginFormSubmit){$scope.loginFormSubmit=!0,$scope.loginError=null,document.getElementsByClassName("login-error").length&&document.getElementById("loginErrorHtml")&&(document.getElementsByClassName("login-error")[0].style.display="none",document.getElementById("loginErrorHtml").innerHTML="");var loginFormDataCopy=angular.copy($scope.loginFormData),originalURL=loginFormDataCopy.URL;loginFormDataCopy.URL=getAbsoluteURL(!0)+"LogonAjaxView",$http.post(getAbsoluteURL(!0)+"LogonAjax",$httpParamSerializer(loginFormDataCopy),{headers:{"Content-Type":"application/x-www-form-urlencoded"},responseType:"json"}).then((function(response){if($log.info(response),!response.data)throw new Error;if(response.data.passwordExpired&&"1"==response.data.passwordExpired){document.getElementsByClassName("login-error").length&&document.getElementById("loginErrorHtml")&&(document.getElementsByClassName("login-error")[0].style.display="block",document.getElementById("loginErrorHtml").innerHTML="Your password has expired. Please click below to receive an email with a link to reset your password.");try{var obj={id:"Error",Error_Source:"User",Error_Code:"Login",Error_Message:"Your password has expired"};tealium_data2track.push(obj)}catch(e){$log.error(e)}}else if(loginFormDataCopy.fromSubmitReview)$window.location=ReviewSuccessURL;else if(response.data.success){$log.info("insert eaactivity cookie from logonFormSubmit"),document.cookie="eaactivity=true; max-age=2592000; path=/";var User_Email_MD5="",User_Email_SHA256="",trimmedLowerMail="";$scope.loginFormData.logonId&&(trimmedLowerMail=$scope.loginFormData.logonId.trim().toLowerCase(),User_Email_MD5=MD5(trimmedLowerMail),User_Email_SHA256=sha256(trimmedLowerMail)),"true"===response.data.hasPrescriptions?sessionStorage.setItem("User_HasPrescription","1"):sessionStorage.removeItem("User_HasPrescription"),$scope.closeModalLogin(),sessionStorage.setItem("Events_UserAccountLogin","1"),sessionStorage.setItem("Events_UserAccountLogin_userLogin","1"),sessionStorage.setItem("User_Email_MD5",User_Email_MD5),sessionStorage.setItem("User_Email_SHA256",User_Email_SHA256),$scope.isCheckout&&$scope.afterLogin();try{callTrackAnalytics({site_events:{authentication_complete:!0},authentication_status:"authenticated",registration_status:"registered"})}catch(e){$log.error(e)}try{obj={id:"WCS-D-Login"};tealium_data2track.push(obj)}catch(e){$log.error(e)}var nextUrl=originalURL;nextUrl.length&&"#"==nextUrl.charAt(nextUrl.length-1)&&(nextUrl=nextUrl.substring(0,x.length-1)),$window.location=nextUrl}else{if("EXIST_IN_US"==response.data.errorMessage)document.getElementsByClassName("login-error").length&&document.getElementById("loginErrorHtml")&&(document.getElementsByClassName("login-error")[0].style.display="block",document.getElementById("loginErrorHtml").innerHTML=MessageHelper.messages.ERR_MSG_DID_YOU_MEAN+"&nbsp;<a target='_blank' href='"+MessageHelper.messages.RediectHomePageURL+"'>"+MessageHelper.messages.LenscrafterUS+"</a>?");else if("EXIST_IN_CA"==response.data.errorMessage)document.getElementsByClassName("login-error").length&&document.getElementById("loginErrorHtml")&&(document.getElementsByClassName("login-error")[0].style.display="block",document.getElementById("loginErrorHtml").innerHTML=MessageHelper.messages.ERR_MSG_DID_YOU_MEAN+"&nbsp;<a target='_blank' href='"+MessageHelper.messages.RediectHomePageURL+"'>"+MessageHelper.messages.LenscrafterCA+"</a>?");else if(response.data.errorMessage.includes("PSW_RST")){showLogonModal()||$(".header-update-reset-password-modal").css("display","block"),$(".thank-you-page-overlay")&&$(".thank-you-page-overlay").removeClass("hidden"),$("#myaccount-rectangle > .backdrop").removeClass("hide"),$(".header-sign-in-modal").css("display","none"),$("#myaccount-rectangle").removeClass("hide"),$("#passwordUpdateEmailInput").val(response.data.errorMessage.split("PSW_RST:")[1])}else"2030"==response.data.errorCode?document.getElementsByClassName("login-error").length&&document.getElementById("loginErrorHtml")&&(document.getElementsByClassName("login-error")[0].style.display="block",document.getElementById("loginErrorHtml").innerHTML="Your email and/or password is incorrect.<br>If you feel that this is an error, please contact customer service."):document.getElementsByClassName("login-error").length&&document.getElementById("loginErrorHtml")&&(document.getElementsByClassName("login-error")[0].style.display="block",document.getElementById("loginErrorHtml").innerHTML=response.data.errorMessage);try{obj={id:"Error",Error_Source:"User",Error_Code:"Login",Error_Message:"Wrong Email, Wrong Password"};tealium_data2track.push(obj)}catch(e){$log.error(e)}}})).catch((function(error){$log.error(error),document.getElementsByClassName("login-error").length&&document.getElementById("loginErrorHtml")&&(document.getElementsByClassName("login-error")[0].style.display="block",document.getElementById("loginErrorHtml").innerHTML="An error occurred while logging into the account")})).finally((function(){$scope.loginFormSubmit=!1}))}}}]);var lcActionsModule=angular.module("lcActionsModule",[]);lcActionsModule.factory("lcActionsModule",(function($rootScope,$http,$httpParamSerializerJQLike,$q,$log,$cookies){var actionsModule={CALLERID_PDP:"PDP",CALLERID_CART:"CART",CLOSE_ACTION_CANCEL:"cancel",CLOSE_ACTION_SAVE:"save",CLOSE_ACTION_ADDTOCART:"addtocart",CLOSE_ACTION_APPLY:"apply",isVisible:!1,isAddingToCart:!1,callerId:null,selectedPerkCode:null,open:function(_params,_callerId,_context){$rootScope.$broadcast("lenspanel:opened",_params,_callerId,_context),actionsModule.callerId=_callerId,actionsModule.isVisible=!0},close:function(_action,_params){actionsModule.isVisible=!1,$rootScope.$broadcast("lenspanel:closed",actionsModule.callerId,_action||actionsModule.CLOSE_ACTION_CANCEL,_params),actionsModule.callerId=null},addToCart:function(_params){var _defer=$q.defer();return actionsModule.isAddingToCart?(_defer.reject(),_defer):(actionsModule.isAddingToCart=!0,$http.post(getAbsoluteURL()+"LCOrderItemAddGlassesCmd",$httpParamSerializerJQLike(_params),{headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then((function(response){var _data=response.data;"string"==typeof _data&&(_data=_data?_data.replace("/*","").replace("*/",""):{},_data=JSON.parse(_data)),actionsModule.isAddingToCart=!1,_data.errorMessage?_defer.reject(_data.errorMessage):_defer.resolve(response.data)}),(function(error){$log.error(error),actionsModule.isAddingToCart=!1,_defer.reject("Cannot add to cart")})),_defer.promise)},genericAddToCart:function(_selectedFrame,_selectedLens,_selectedWarranty){var _params={frameCatentryId:_selectedFrame.catEntryId,lensColor:_selectedLens.lensPackage.color||"",lens:""+_selectedLens.lensPackage.catEntryId,orderId:".",URL:"",addOns:"",includeLens:!0,tah:!1};if($cookies.put("cookie_last_selected_lens",_selectedLens.lensPackage.upc,{path:"/"}),_selectedLens.lensPackage.type){const lensType=_selectedLens.lensPackage.type.toLowerCase().replaceAll(" ","_").replaceAll("-","_").trim();"non_prescription"!==lensType&&"frame_only"!==lensType||$cookies.remove("prescriptionObject",{path:"/"})}_selectedWarranty&&(_params.warrantyCatentryId=_selectedWarranty.id,_params.addWarranty=!0);var _defer=$q.defer();return actionsModule.isAddingToCart?(_defer.reject(),_defer):(actionsModule.isAddingToCart=!0,$http.post(getAbsoluteURL()+"LCOrderItemAddGlassesCmd",$httpParamSerializerJQLike(_params),{headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then((function(response){var _data=response.data;"string"==typeof _data&&(_data=_data?_data.replace("/*","").replace("*/",""):{},_data=JSON.parse(_data));var orderItemId=_data.frameOrderItemId,url=window.location.protocol+"//"+window.location.hostname+"/wcs/resources/store/"+constants.ajaxParams.storeId+"/rxc/prescription/insert/"+orderItemId,body=getCookie("prescriptionObject");if($cookies.remove("prescriptionObject",{path:"/"}),null!=body&&""!==body&&$http.post(url,body).then((function(response){}),(function(response){})),actionsModule.isAddingToCart=!1,_data.errorMessage)_defer.reject(_data.errorMessage);else{_defer.resolve(response.data);var _cartParams="storeId="+constants.ajaxParams.storeId+"&catalogId="+constants.ajaxParams.catalogId+"&langId="+(constants.ajaxParams.langId||"-1")+"&URL=AjaxOrderItemDisplayView&errorViewName=AjaxOrderItemDisplayView&orderId=.&updatePrices=1&calculationUsageId=-1&chooseBenefit=false";window.location=getAbsoluteURL()+"OrderCalculate?"+_cartParams}}),(function(error){$log.error(error),actionsModule.isAddingToCart=!1;_defer.reject("Cannot add to cart")})),_defer.promise)},genericSaveLensSelection:function(_selectedFrame,_selectedLens,_selectedWarranty,_selectedFrameBrandImage){$rootScope.$apply((function(){$rootScope.rxc.selectedLens=_selectedLens,$rootScope.rxc.selectedWarranty=_selectedWarranty,$rootScope.rxc.selectedFrame=_selectedFrame,$rootScope.rxc.selectedFrameBrandImage=_selectedFrameBrandImage,$rootScope.genericCalculatePrices()})),$cookies.put("cookie_last_selected_lens",_selectedLens.upc,{path:"/"})},genericExit:function(){$cookies.remove("prescriptionObject",{path:"/"}),document.getElementById("header_wrapper").style.zIndex="",document.querySelector(".nav-links").style.zIndex="999";var chatButtonElem=document.getElementsByClassName("cx-side-button-group");chatButtonElem&&chatButtonElem.length&&!/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)&&(chatButtonElem=chatButtonElem[0]).style.setProperty("right","0","important"),window.history.replaceState(null,"",window.location.pathname),$rootScope.$apply((function(){delete $rootScope.rxc.rxcWidget,window.history.go($rootScope.oldHistoryLength-history.length),setTimeout((function(){window.history.pushState(null,"")}),100),setTimeout((function(){window.history.back()}),200)}))},genericSaveEditFromCart:function(_selectedFrame,_selectedLens,_selectedWarranty,_cartData){var params={orderId:".",lensCatentryId:""+_selectedLens.lensPackage.catEntryId,lensColor:_selectedLens.lensPackage.color||"",lens:""+_selectedLens.lensPackage.catEntryId,addOns:"",URL:"",includeLens:!0,orderItemId:_cartData.orderItemId,fromPage:"ShopCart",addRxLenses:!0};const lensType=_selectedLens.lensPackage.type.toLowerCase().replaceAll(" ","_").replaceAll("-","_").trim();"non_prescription"!==lensType&&"frame_only"!==lensType||$cookies.remove("prescriptionObject",{path:"/"}),_selectedWarranty&&(params.addWarranty=!0,params.warrantyCatentryId=_selectedWarranty.id),$.ajax({type:"POST",url:getAbsoluteURL()+"LCUpdateOrderItemLensDataCmd",traditional:!0,data:params,success:function(data,textStatus,jqXHR){var toCartParams=$.param({storeId:constants.ajaxParams.storeId,catalogId:constants.ajaxParams.catalogId,langId:constants.ajaxParams.langId,URL:"AjaxOrderItemDisplayView",errorViewName:"AjaxOrderItemDisplayView",orderId:".",updatePrices:"1",calculationUsageId:"-1"});var orderItemId=_cartData.orderItemId,url=window.location.protocol+"//"+window.location.hostname+"/wcs/resources/store/"+constants.ajaxParams.storeId+"/rxc/prescription/insert/"+orderItemId,body=getCookie("prescriptionObject");$cookies.remove("prescriptionObject",{path:"/"}),null!=body&&""!==body&&$http.post(url,body).then((function(response){}),(function(response){})),window.location=getAbsoluteURL()+"OrderCalculate?"+toCartParams},error:function(xhr,text,error){console.log(xhr)}})},loadContent:function(contentName){var _defer=$q.defer(),urlPrefix="";return-1!=window.location.href.indexOf("127.0.0.1")&&(urlPrefix="https://localhost:8000"),"DESK_PromoBanner"!=contentName&&"MOB_PromoBanner"!=contentName||!$rootScope.isGVPFrameAndLens||(contentName+="_GVP"),$http.get(urlPrefix+"/wcs/resources/store/"+constants.ajaxParams.storeId+"/espot/"+contentName).then((function(res){res.data.MarketingSpotData&&res.data.MarketingSpotData.length>0&&res.data.MarketingSpotData[0].baseMarketingSpotActivityData&&res.data.MarketingSpotData[0].baseMarketingSpotActivityData.length>0&&res.data.MarketingSpotData[0].baseMarketingSpotActivityData[0].marketingContentDescription&&res.data.MarketingSpotData[0].baseMarketingSpotActivityData[0].marketingContentDescription.length>0&&res.data.MarketingSpotData[0].baseMarketingSpotActivityData[0].marketingContentDescription[0].marketingText&&_defer.resolve(res.data.MarketingSpotData[0].baseMarketingSpotActivityData[0].marketingContentDescription[0].marketingText)})),_defer.promise},loadLearnMoreContent:function(contentName){return actionsModule.loadContent(contentName)}};return actionsModule})),app.factory("PromoPopupService",["$timeout","$http","$httpParamSerializer",function($timeout,$http,$httpParamSerializer){function getCookieValueByName(name){var matches=document.cookie.match("(^|;)\\s*"+name+"\\s*=\\s*([^;]+)");return matches?matches.pop():""}function getMininmizedCookie(){return getCookieValueByName("promo_minimized")}function getPromoAcceptedCookie(){return getCookieValueByName("promo_accepted")}function getSubscribedCookie(){return getCookieValueByName("promo_subscribed")}function setPromoAcceptedCookie(code){var cookie="promo_accepted="+String(code)+";max-age=2592000;path=/";document.cookie=cookie,updatePopupExists(),updatePromoCodeIsValid()}function setSubscribedCookie(code){var cookie="promo_subscribed="+String(code)+";max-age=2592000;path=/";document.cookie=cookie,updateSubscribed()}function updatePopupExists(){var acceptedCookieValue=getPromoAcceptedCookie(),eaactivity=getCookieValueByName("eaactivity"),promoParam=new URLSearchParams(window.location.search).get("promo"),cidParam=new URLSearchParams(window.location.search).get("cid");service.popupExists="invalid"!==acceptedCookieValue&&!eaactivity&&"eaccess"!==promoParam&&null===cidParam}function updatePromoCodeIsValid(){var acceptedCookieValue=getPromoAcceptedCookie();service.promoCodeIsValid=acceptedCookieValue&&"invalid"!==acceptedCookieValue}function updateSubscribed(){var subscribedCookieValue=getSubscribedCookie();service.alreadySubscribeIsValid=subscribedCookieValue&&"invalid"!==subscribedCookieValue}service={};var steps_form="form",steps_success="success",steps_exist="exist";updatePopupExists(),updatePromoCodeIsValid(),updateSubscribed(),service.storeId=10851;var host=window.location.href;-1!==host.indexOf("lenscrafters.com")&&-1===host.indexOf("en-ca")?service.storeId=10851:-1===host.indexOf("lenscrafters.ca")&&-1===host.indexOf("en-ca")||(service.storeId=10852),service.subscribe={preregister:!0,addressType:"M",lcGeneralEmailOptIn:!0,ageCheck:!0,canAddOrigin:!0,optinStatus:!0,URL:"SuccessView",storeId:service.storeId,langId:"-1",emailType:"PromoPopup",showRegister:!0},service.popupOpen=!1,service.waiting=!1,service.promoCode=getPromoAcceptedCookie(),service.promoCodeSub=getSubscribedCookie(),service.promoMinimized=!!getMininmizedCookie(),service.alreadySubscribeIsValid?(service.step=steps_exist,"refresh"===service.promoCodeSub&&(service.popupOpen=!0,setSubscribedCookie("valid"),setPromoAcceptedCookie("valid"))):service.promoCodeIsValid?(service.step=steps_success,"refresh"===service.promoCode&&(service.popupOpen=!0,setPromoAcceptedCookie("valid"))):service.step=steps_form;var showNLPopupTriggered=!1;function showNLPopupEventHandler(){showNLPopupTriggered||($timeout((function(){var rxcApp=document.getElementById("rxcApp");null!=rxcApp&&rxcApp.hasChildNodes()?console.log("RXPANEL show"):(console.log("RXPANEL not show"),service.popupOpen=!0,document.removeEventListener("scroll",showNLPopupEventHandler,!0))}),3e3),showNLPopupTriggered=!0)}return!service.popupExists||service.promoCode||service.promoMinimized||$timeout((function(){document.addEventListener("scroll",showNLPopupEventHandler,!0)}),1e3),service.closePopup=function(){service.popupOpen=!1,"invalid"===service.promoCode&&setPromoAcceptedCookie("invalid"),getMininmizedCookie()||(document.cookie="promo_minimized=true;max-age=86400;path=/",service.promoMinimized=!0)},service.removeMinimizedPopup=function(){setPromoAcceptedCookie("invalid")},service.show=function(){service.popupOpen=!0},window.showPromoPopup=function(){$timeout(service.show,0)},service.submitData=function(){var submitURL=getAbsoluteURL()+"LCEmailSubscription";if(service.errorMessage="",service.subscribe.enteredEmail){var data={preregister:service.subscribe.preregister,addressType:service.subscribe.addressType,canAddOrigin:service.subscribe.canAddOrigin,optinStatus:service.subscribe.optinStatus,URL:service.subscribe.URL,storeId:service.subscribe.storeId,langId:service.subscribe.langId,emailType:service.subscribe.emailType,showRegister:service.subscribe.showRegister,email:service.subscribe.enteredEmail};data["lcGeneralEmailOptIn_"+service.storeId+"_r_1"]=service.subscribe.lcGeneralEmailOptIn,data["ageCheck_"+service.storeId+"_r_1"]=service.subscribe.ageCheck,service.waiting=!0,$http.post(submitURL,$httpParamSerializer(data),{headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then((function(response){if(200==response.status&&300==response.data.status)return console.log(response.data.message),service.registeredEmail=data.email,setSubscribedCookie("refresh"),document.cookie="eaactivity=true; max-age=2592000; path=/",void location.reload();if(200==response.status&&"Success"==response.data.message){var trimmedLowerMail="";return data.email&&(trimmedLowerMail=data.email.trim().toLowerCase()),tealium_data2track.push({id:"SignupForm",User_Email_MD5:MD5(data.email),User_Email_SHA256:sha256(trimmedLowerMail)}),setPromoAcceptedCookie("refresh"),document.cookie="eaactivity=true; max-age=2592000; path=/",void location.reload()}void 0===service.subscribe.enteredEmail&&(console.log(response.data.message),service.errorMessage="E-mail subscription error, try later"),service.waiting=!1}))}},service}]),app.controller("PromoPopupController",["PromoPopupService","$scope",function(PromoPopupService,$scope){$scope.PromoPopupService=PromoPopupService,$scope.$watch("PromoPopupService.popupOpen",(function(value){angular.element([document.body,document.documentElement]).css({overflow:value?"hidden":""})}))}]);var frameAdvisorModule=angular.module("frameAdvisorModule",["ngCookies"]);frameAdvisorModule.factory("frameAdvisorFactory",(function($http,$rootScope,$log,$window,$timeout,$cookies){function openFrameAdvisor(startMinimized){const config=angular.merge({startMinimized:startMinimized,selector:"#frameadv-wrapper",resultCallback:data=>(frameAdvisorWidget.getUserData().then((data=>window.localStorage.setItem("fa-user-data",JSON.stringify(data)))),new Promise((function(resolve,reject){const baseQueryParams=$.param({storeId:constants.ajaxParams.storeId,catalogId:constants.ajaxParams.catalogId,langId:constants.ajaxParams.langId,responseFormat:"json",currency:"",profileName:"RONA_findProductByPartNumber_Details"},!0);let productsMap={},searchByUpcFirst=!0;data.products.forEach((product=>{const key=product.moco?product.moco.replaceAll("/","_"):product.upc;searchByUpcFirst=key===product.upc,productsMap[key]=product}));let queryParams=baseQueryParams;for(const key of Object.keys(productsMap))queryParams+="&partNumber="+key;function getAttributeValue(product,attribute){var value="";return product.ad_attribute.forEach(((row,j)=>{row.split("/")[2]==attribute&&(value=row.split("/")[12])})),value}const searchByMoco=(queryParams,productsMap)=>{$http.get("/search/resources/store/"+constants.ajaxParams.storeId+"/productview/byPartNumbers?"+queryParams).then((function(response){response.data&&response.data.catalogEntryView?resolve(((productsData,productsMap)=>productsData.catalogEntryView.map((product=>Object.assign({brandName:getAttributeValue(product,"BRAND"),brandlogoUrl:"https://assets.lenscrafters.com/extra/image/LensCrafters/brands/LC_"+getAttributeValue(product,"BRAND")+"_Logo.png",price:""!=product.price[1].value?"$"+Number(product.price[1].value).toFixed(2):"",priceFull:""!=product.price[0].value&&""!=product.price[1].value&&product.price[1].value!=product.price[0].value?"$ "+Number(product.price[0].value).toFixed(2):"",productName:getAttributeValue(product,"MODEL_NAME"),frameColor:getAttributeValue(product,"FRONT_COLOR"),lensColor:getAttributeValue(product,"LENS_COLOR"),rxAvailable:"true",imageUrl:"https://assets.lenscrafters.com/is/image/LensCrafters/"+productsMap[product.partNumber].upc+"__002.png?imwidth=600",url:$window.location.origin+"/"+(-1==constants.ajaxParams.langId?"lc-us":"en-ca")+"/"+getAttributeValue(product,"BRAND").toLowerCase().replaceAll(" ","-")+"/"+productsMap[product.partNumber].upc},productsMap[product.partNumber]))))(response.data,productsMap)):reject("No product were returned")}),(function(error){$log.error(error)}))};searchByUpcFirst?((queryParams,productsMap)=>{$http.get("/search/resources/store/"+constants.ajaxParams.storeId+"/productview/byPartNumbers?"+queryParams).then((function(response){if(response.data&&response.data.catalogEntryView){response.data.catalogEntryView.forEach((product=>{let moco=getAttributeValue(product,"SKU").split(" ");moco=moco[0]+"__"+moco[2],productsMap[product.partNumber]=Object.assign({upc:product.partNumber},productsMap[product.partNumber]),productsMap[moco]=productsMap[product.partNumber],delete productsMap[product.partNumber]}));let queryParams=baseQueryParams;for(const key of Object.keys(productsMap))queryParams+="&partNumber="+key;searchByMoco(queryParams,productsMap)}else reject("No product were returned")}),(function(error){$log.error(error)}))})(queryParams,productsMap):searchByMoco(queryParams,productsMap)}))),addToBagCallback:product=>{window.location.href.includes(product.url)?(document.getElementsByClassName("fa__close-button")[0].click(),document.getElementsByClassName("add-to-cart")[0].click()):(window.sessionStorage.setItem("fa-add-to-bag-clicked","true"),window.location.href=product.url)},openRXConfigurator:product=>{window.location.href.includes(product.url)?(document.getElementsByClassName("fa__close-button")[0].click(),document.getElementsByClassName("select-edit-lens")[0].click()):(window.sessionStorage.setItem("fa-rxc-clicked","true"),window.location.href=product.url)}},baseConfig),frameAdvisorWidget=frameAdvisor.FrameAdvisorWidget.new(config);frameAdvisorWidget.render(),window.frameAdvisorWidget=frameAdvisorWidget,oldUrl="",window.onGetSuggestedSizes=e=>{e&&e.preventDefault(),frameAdvisorWidget.getSuggestedSizes({S:128,M:131,XL:135}).then((data=>console.log(data))).catch((e=>console.error(e)))},document.body.addEventListener("fa-maximize",(()=>{oldUrl=window.location.href,newUrl=window.location.href.slice(0,window.location.href.indexOf("#")+1),window.history.replaceState({},null,newUrl),$timeout((function(){state.fa.isOpen=!0}),0)})),document.body.addEventListener("fa-minimize",(()=>{$timeout((function(){state.fa.isOpen=!1,window.history.replaceState({},null,oldUrl)}),0)})),document.body.addEventListener("fa-close",(()=>{$timeout((function(){state.fa.isOpen=!1,document.body.style.overflow="",document.body.style.height=""}),0),newUrl=window.location.href.slice(0,window.location.href.indexOf("#")+1),window.history.replaceState({},null,newUrl),frameAdvisorWidget.closeApp()}))}function init(){state.ready=!0;const saSizeProfile=window.localStorage.getItem("sa-size-data");saSizeProfile&&(state.sa.sizeData=JSON.parse(saSizeProfile)),pendingQueue.forEach((f=>$timeout(f,0)))}function loadFrameAdvisorScripts(caller){pendingQueue.add(caller);const scripts=[...document.querySelector("#frame-advisor-scripts").content.children];0!=scripts.length&&(scripts.at(-1).onload=init,scripts.forEach((s=>document.head.append(s))))}const state={ready:!1,fa:{},sa:{}},pendingQueue=new Set,baseConfig={locale:($cookies.get("lcLocale")||"en_US").replace("_","-"),facescanSource:"FASA_LCCOM",facescanRegion:"-1"===constants.ajaxParams.langId?"US":"EU",frameAdvAPICore:"fa_catalog",frameAdvAPIStore:"-1"===constants.ajaxParams.langId?"LC@USA":"LC@CA",frameAdvKey:"22615c4d-cd81-4799-8cc2-206eff25eaed",enableSizeAdvisor:!0,enableVideoMode:!1,productTypes:["sunglasses","eyeglasses"],productRequestRowsLimit:24,facescanPrivacy:{privacyPolicy:"https://www.lenscrafters.com/lc-us/privacy-policy",termsAndConditions:"https://www.lenscrafters.com/lc-us/terms-and-conditions"},resetProfileDataCallback:userId=>{if("-1002"!=constants.ajaxParams.userId){var userObj={accessToken:null,refreshToken:null,userUUID:null,callerId:constants.ajaxParams.userId,storeId:constants.ajaxParams.storeId};$http.post("/wcs/resources/frameAdvisorServices/saveUserProfile",userObj).then((function(response){}),(function(error){$log.error(error)}))}},saveProfileDataCallback:data=>{if("-1002"==constants.ajaxParams.userId)window.location.href=$window.location.origin+"/"+(-1==constants.ajaxParams.langId?"lc-us":"en-ca")+"/account";else{var userObj={accessToken:data.accessToken,refreshToken:data.refreshToken,userUUID:data.userUUID,callerId:constants.ajaxParams.userId,storeId:constants.ajaxParams.storeId};$http.post("/wcs/resources/frameAdvisorServices/saveUserProfile",userObj).then((function(response){openFrameAdvisor(!1)}),(function(error){$log.error(error)}))}},getProfileDataCallback:()=>{if("-1002"!=constants.ajaxParams.userId)return new Promise((function(resolve,reject){$http.get("/wcs/resources/frameAdvisorServices/getUserProfile/"+constants.ajaxParams.userId).then((function(response){null!=response.data.result&&resolve({accessToken:response.data.result.accessToken,refreshToken:response.data.result.refreshToken,userUUID:response.data.result.userUUID})}),(function(error){$log.error(error)}))}))}};return $rootScope.$watch((function(){return state.fa.isOpen||state.sa.isOpen}),(function(value){angular.element([document.body,document.documentElement]).css({overflow:value?"hidden":""})})),{state:state,openFrameAdvisor:function openFrameAdvisorWrapper(){state.ready?(state.fa.isOpen=!0,localStorage.getItem("fa-user-id")?document.getElementsByClassName("fa__floating-button-button")[0].click():openFrameAdvisor(!1)):loadFrameAdvisorScripts(openFrameAdvisorWrapper)},openSizeAdvisor:function openSizeAdvisorWrapper(){state.ready?function(){const config=angular.merge({handleResults:data=>{window.localStorage.setItem("sa-size-data",JSON.stringify(data)),$timeout((function(){state.sa.sizeData=data}),0)},selector:"#sizeadv-wrapper"},baseConfig);startingHistoryLength=window.history.length;const sizeAdvisorWidget=frameAdvisor.SizeAdvisorWidget.new(config);sizeAdvisorWidget.render(),window.sizeAdvisorWidget=sizeAdvisorWidget,document.body.addEventListener("sa-close",(()=>{$timeout((function(){closingHistoryLength=window.history.length,state.sa.isOpen=!1,startingHistoryLength-closingHistoryLength!=0&&window.history.go(startingHistoryLength-closingHistoryLength)}),0)})),state.sa.isOpen=!0}():loadFrameAdvisorScripts(openSizeAdvisorWrapper)},setUtagFrameAdvisor:function setUtagFrameAdvisorWrapper(){state.ready?function(){if(faUserData=window.localStorage.getItem("fa-user-data"),faUserData){faUserData=JSON.parse(faUserData);const dataString=Object.entries(faUserData).map((([key,value])=>{switch(value.constructor){case String:return`${key}=${value}`;case Array:return value.map((v=>`${key}=${v}`)).join(",");default:return""}})).filter((s=>s.length>0));utag_data.Page_UserStyle=dataString.join(",")}if($("input[name=framePartNumber]").val()){const upc=$("input[name=framePartNumber]").val();utag_data.Products={},utag_data.Products[upc]={Fg_BestMatch:"0"}}utag_data.Fg_Release=frameAdvisor.FrameAdvisorWidget.version()}():loadFrameAdvisorScripts(setUtagFrameAdvisorWrapper)},setUtagSizeAdvisor:function setUtagSizeAdvisorWrapper(){state.ready?utag_data.Sg_Release=frameAdvisor.SizeAdvisorWidget.version():loadFrameAdvisorScripts(setUtagSizeAdvisorWrapper)},openFrameAdvisorFAB:function openFrameAdvisorFABWrapper(){state.ready?localStorage.getItem("fa-user-id")&&openFrameAdvisor(!0):loadFrameAdvisorScripts(openFrameAdvisorFABWrapper)},getSizeSuggestion:function(hingeWidthMap){if(state.sa.sizeData)return frameAdvisor.SizeAdvisorWidget.getSuggestedSizes(state.sa.sizeData.optimalHinge,hingeWidthMap)}}})),frameAdvisorModule.directive("frameAdvisor",["frameAdvisorFactory","$cookies",function(frameAdvisorFactory,$cookies){return{restrict:"E",scope:{},transclude:!0,template:function(){switch($cookies.get("lcLocale")){case"fr_CA":return'<div ng-cloak class="underlay" ng-if="faState.fa.isOpen"> </div><div ng-cloak id="frameadv-wrapper" data-analytics_available_call="0" class="fr" ng-class="faState.fa.isOpen ? \'frameadv-wrapper\' : \'hidden-wrapper\'"> </div>';case"es_US":return'<div ng-cloak class="underlay" ng-if="faState.fa.isOpen"> </div><div ng-cloak id="frameadv-wrapper" data-analytics_available_call="0" class="es" ng-class="faState.fa.isOpen ? \'frameadv-wrapper\' : \'hidden-wrapper\'"> </div>';default:return'<div ng-cloak class="underlay" ng-if="faState.fa.isOpen"> </div><div ng-cloak id="frameadv-wrapper" data-analytics_available_call="0" ng-class="faState.fa.isOpen ? \'frameadv-wrapper\' : \'hidden-wrapper\'"> </div>'}}(),controller:function($scope,frameAdvisorFactory){$scope.faState=frameAdvisorFactory.state,localStorage.getItem("fa-user-id")&&(frameAdvisorFactory.openFrameAdvisorFAB(),frameAdvisorFactory.setUtagFrameAdvisor())}}}]),frameAdvisorModule.directive("sizeAdvisor",["frameAdvisorFactory",function(frameAdvisorFactory){return{restrict:"E",scope:{},transclude:!0,template:'<div ng-cloak class="underlay" ng-if="faState.sa.isOpen"> </div><div ng-cloak id="sizeadv-wrapper" data-analytics_available_call="0" ng-class="faState.sa.isOpen ? \'frameadv-wrapper\' : \'hidden-wrapper\'"> </div>',controller:function($scope,frameAdvisorFactory){$scope.faState=frameAdvisorFactory.state;var unregister=$scope.$watch("faState.ready",(function(ready){ready&&(unregister(),frameAdvisorFactory.setUtagSizeAdvisor())}))}}}]),app.controller("scheduleExamController",(function($scope,$rootScope,lcActionsModule){$rootScope.insuranceProviders=window.insuranceProviders,$rootScope.selectedInsurancesProvider=void 0,$rootScope.isUnselected=!1,$scope.singleConfig={openOnFocus:!0,valueField:"text",maxItems:1,onChange:function(value){$scope.selectizeIsFocused=!1,$scope.insuranceProvider=value,$("#insurance-carrier").attr("value",$scope.insuranceProvider),$rootScope.isUnselected=""===value},onDropdownOpen:function(){$scope.$apply((function(){$scope.selectizeIsFocused=!0}))},onDropdownClose:function(){$scope.$apply((function(){$scope.selectizeIsFocused=!1}))},plugins:{no_results:{},clear_button:{className:"selectize-clear-button",label:'<svg class="icon close"><use xlink:href="#clear-input"></use></svg>'}}},$scope.asyncSVGLoader=function(){var isLocalStorage="localStorage"in window&&null!==window.localStorage,insertIT=function(data){document.body.insertAdjacentHTML("beforeend",data)};lcActionsModule.loadContent("X_SVG_Icons").then((function(data){!function(data){document.body?insertIT(data):document.addEventListener("DOMContentLoaded",insertIT)}(data),isLocalStorage&&(localStorage.setItem("inlineSVGdata",data),localStorage.setItem("inlineSVGrev",1))}))}}));